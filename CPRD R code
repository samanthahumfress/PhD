#################################packages######################################################
#install.packages("tidyverse")

require(tidyverse)
require(ggplot2)
require(stringr)
require(data.table)
require(scales)
require(dplyr)
require(readxl)
require(table1)
require(sqldf)
library(tictoc)
require(lubridate)
require(stringr)
library(tidyr)
#install.packages("table1")
#install.packages("rmarkdown")
install.packages("data.table")
require(data.table)
require(table1)
require(epitools)
require(vcd)
require(Hmisc)
require(gmodels)
require(xtable)
require(hwriter)
require(surveillance)
require(ISOweek)
library(scales)
require(Gmisc)
require(mondate)
require(xlsx)
require(openxlsx)
require(car)
require(glarma)
library(readxl)
require(grid)
require(gridExtra)
require(epiDisplay)
require(FedData)
require(ggfortify)
require(lubridate)
install.packages("ggsurvfit")
library(survival)
require(ggsurvfit)
install.packages("gtsummary")
require(gtsummary)
install.packages("survminer")
require(survminer)
install.packages("viridis")
library(viridis)
install.packages("comorbidity")
library(comorbidity)
install.packages("tableone")
library(tableone)
install.packages("sandwich")
library(sandwich)
install.packages("lmtest")
library(lmtest)
install.packages("broom")
library(broom)



#type 1 req data

##dummy data frames
#mydata1 <- data.frame(patid=c(45,46,46,43,44,47,47,48),x=c("a","a","a","b","c","d","e","d"))
#mydata2 <- data.frame(patid=c(54,55,55,55,51,45,47,49),x=c("a","a","a","b","c","d","e","d"))

##combine all the patids from both files in to one
#allids<-data.frame(patid=c(mydata1$patid,mydata2$patid))

##deduplicate
#allidsdedup<-data.frame(patid=allids[!duplicated(allids$patid),])

##save as text file
#write.table(row.names = F,allidsdedup,file="patidforpieta.txt")

#attach data frames
#Pregnant_women <- fread("P:/Kilada/20_000278_Type_1_request/20_000278_Type_1_request/Pregnant_women.txt")
Pregnant_women <- fread("P:/20_000278_Type_1_request/20_000278_Type_1_request/Pregnant_women.txt")
##MBL <- fread("P:/Kilada/20_000278_Type_1_request/20_000278_Type_1_request/MBL.txt")
MBL <- fread("P:/20_000278_Type_1_request/20_000278_Type_1_request/MBL.txt")

#real data frames
PregMBLids <- data.frame(patid=c(Pregnant_women$patid,MBL$mumpatid,MBL$babypatid))

#deduplicate (yields 1,195,196 obs)
PregMBLidsdepdup <- data.frame(patid=PregMBLids[!duplicated(PregMBLids$patid),])

#save text file
#write.table(row.names = F,PregMBLidsdepdup,file="patidforpieta.txt")


#preg register test (yields 661,581)
test1 <- data.frame(patid=c(Pregnant_women$patid))
test2 <- data.frame(patid=test1[!duplicated(test1$patid),])

#type 2 req data

#read in data
#Pregnancy_register <- fread("P:/Kilada/20_000278_Type_2_request/GOLD_linked/Final/pregnancy_register_20_000278_DM.txt")
Pregnancy_register <- fread("P:/20_000278_Type_2_request/GOLD_linked/Final/pregnancy_register_20_000278_DM.txt")

#deduplicate (yields 1,186,559; mum dedup yields 661,782 which is different from pregnant women dataset given
#for type 1)
PregRegMumdedup <- data.frame(patid=Pregnancy_register[!duplicated(Pregnancy_register$patid),])
PregRegBabydedup <- data.frame(babypatid=Pregnancy_register[!duplicated(Pregnancy_register$babypatid),])


#convert to data.table
class(Pregnant_women)
library("data.table")
setDT(Pregnant_women)

class(PregRegMumdedup)
setDT(PregRegMumdedup)

#see if start dates same (can see that in Mum dedup data that there are dates earlier than 2011. the earliest comes
#up as 1979, which i thought might be an error but just through scrolling briefly, i can see some dates in the late
#1990s and early 2000s so i assume there must be even earlier dates within the dataset)
library(lubridate)
  Pregnant_women$pregstart2 <- as.character(Pregnant_women$pregstart)
  Pregnant_women$pregstart2 <- dmy(Pregnant_women$pregstart)
  min(pregstart2 = c(Pregnant_women$pregstart2))
  PregRegMumdedup$patid.pregstart2 <- as.character(PregRegMumdedup$patid.pregstart)
  PregRegMumdedup$patid.pregstart2 <- dmy(PregRegMumdedup$patid.pregstart)
  min(patid.pregstart2 = c(PregRegMumdedup$patid.pregstart2))

Pregnancy_register$pregstart2 <- dmy(Pregnancy_register$pregstart)

#compare dataframes (didn't work because selects to left and right don't have same number of result columns/ second
#try gives error message that no such table)
#install.packages("sqldf")
#WomenNotInRegister <- sqldf('SELECT * FROM Pregnant_women EXCEPT SELECT * FROM PregRegMumdedup')
#WomenNotInRegister <- sqldf('SELECT * FROM Pregnant_women$patid EXCEPT SELECT * FROM PregRegMumdedup$patid.patid')

#pulled patids from both dataframes into one table (gives error message that no such table)
#OnlyMumPatids<- cbind(Pregnant_women$patid, PregRegMumdedup$patid.patid)
#WomenNotInRegister <- sqldf('SELECT * FROM OnlyMumPatids$V1 EXCEPT SELECT * FROM OnlyMumPatids$V2')

#check to make sure ids in both datasets (all there)
Pregnant_women$patid <- as.factor(Pregnant_women$patid)
PregRegMumdedup$patid.patid <- as.factor(PregRegMumdedup$patid.patid)
  Pregnant_women_oneline <- subset(Pregnant_women, select=c("patid"))
    Pregnant_women_oneline$present <- 1
  PregRegMumdedup_oneline <- subset(PregRegMumdedup, select=c("patid.patid"))
    PregRegMumdedup_oneline$present <- 1
  Testmerge<- merge(Pregnant_women_oneline, PregRegMumdedup_oneline, by.x = "patid", by.y="patid.patid", all=T)
  Testmerge_preg <- subset(Testmerge, is.na(Testmerge$present.x))
  Testmerge_preg2 <- subset(Testmerge, is.na(Testmerge$present.y))
      


#__________________________________________________________________________________________________________


#read in type 2 preg register and mbl for creating patid list for pieta
#MBLType2Mum <- fread("P:/Kilada/20_000278_Type_2_request/GOLD_linked/Final/MBL_Mum_20_000278_DM.txt")
MBLType2Mum <- fread("P:/20_000278_Type_2_request/GOLD_linked/Final/MBL_Mum_20_000278_DM.txt")
#MBLType2Baby <- fread("P:/Kilada/20_000278_Type_2_request/GOLD_linked/Final/MBL_Baby_20_000278_DM.txt")
MBLType2Baby <- fread("P:/20_000278_Type_2_request/GOLD_linked/Final/MBL_Baby_20_000278_DM.txt")

#combine into data frame
Type2PregMBLids <- data.frame(patid=c(Pregnancy_register$patid,MBLType2Mum$mumpatid,MBLType2Mum$babypatid,
MBLType2Baby$mumpatid,MBLType2Baby$babypatid))

#deduplicate (yields 1,217,411)
Type2PregMBLidsdedup <- data.frame(patid=Type2PregMBLids[!duplicated(Type2PregMBLids$patid),])


#check to make sure that mum ids are in both sets (all there)
MBLType2Mum$mumpatid <- as.factor(MBLType2Mum$mumpatid)
PregMBLidsdepdup$patid <- as.factor(PregMBLidsdepdup$patid)
  Type2Mum_oneline <- subset(MBLType2Mum, select = c("mumpatid"))
    Type2Mum_oneline$present <- 1
  PregMBLidsdedup_oneline <- subset(PregMBLidsdepdup, select = c("patid"))
    PregMBLidsdedup_oneline$present <- 1
  TestmergeType2 <- merge(Type2Mum_oneline, PregMBLidsdedup_oneline, by.x = "mumpatid", by.y = "patid", all = T)
  TestmergeType2_1 <- subset(TestmergeType2, is.na(TestmergeType2$present.x))
  TestmergeType2_2 <- subset(TestmergeType2, is.na(TestmergeType2$present.y))


#save text file
#write.table(row.names = F,Type2PregMBLidsdedup,file="patidforpieta2.txt")
  

#_____________________________________________________________________________________________________________
  
#########################descriptive stats#########################################

#read in IMD
IMD <- fread("P:/20_000278_Type_2_request/GOLD_linked/Final/patient_2019_imd_20_000278.txt")
IMD$patid <- as.factor(IMD$patid)

#read in urban/rural
UrbanRural <- fread("P:/20_000278_Type_2_request/GOLD_linked/Final/patient_urban_rural_20_000278.txt")
UrbanRural$patid <- as.factor(UrbanRural$patid)

Descr_Stats <- merge(PregRegMumdedup, IMD, by.x = "patid.patid", by.y = "patid", all.x = T)
Descr_Stats1 <- merge(Descr_Stats, UrbanRural, by.x = "patid.patid", by.y = "patid", all.x = T)

#hes data
HESMat <- fread("P:/20_000278_Type_2_request/GOLD_linked/Final/hes_maternity_20_000278_DM.txt")
HESMatdedup <- data.frame(patid=HESMat[!duplicated(HESMat$patid),])
HESIMDMerge <- merge(HESMatdedup, IMD, by.x = "patid.patid",by.y = "patid", all.x = T)
#merge
HESMatdedup$patid.patid <- as.factor(HESMatdedup$patid.patid)
Descr_Stats2 <- merge(Descr_Stats1, HESMatdedup, by = "patid.patid", all.x = T)

#Bob <- data.frame(table(IMD$patid))
length(unique(IMD$patid))
length(unique(UrbanRural$patid))
length(unique(PregRegMumdedup$patid.patid))
table(Descr_Stats2$e2011_urban_rural)
table(HESIMDMerge$e2019_imd_5)

#find the na's
NAs <- subset(HESIMDMerge, is.na(e2019_imd_5))

#mother age
Descr_Stats2$MumAge <- NA
Descr_Stats2$MumAge <- as.numeric(Descr_Stats2$patid.matage.x)
hist(Descr_Stats2$MumAge)

#total number pregs
Descr_Stats2$NumOfPregs <- NA
Descr_Stats2$NumOfPregs <- as.numeric(Descr_Stats2$patid.totalpregs)
hist(Descr_Stats2$NumOfPregs)

#pregnancy gestation days
Descr_Stats2$GestDays <- NA
Descr_Stats2$GestDays <- as.numeric(Descr_Stats2$patid.gestdays)
hist(Descr_Stats2$GestDays)

#pregnancy outcome
Descr_Stats2$PregOutcome <- NA
Descr_Stats2$PregOutcome <- as.numeric(Descr_Stats2$patid.outcome)
Descr_Stats2$PregOutcome[Descr_Stats2$PregOutcome=="1"] <- "Live Birth"
  Descr_Stats2$PregOutcome[Descr_Stats2$PregOutcome=="2"] <- "Stillbirth"
  Descr_Stats2$PregOutcome[Descr_Stats2$PregOutcome=="3"] <- "Live Birth and Stillbirth"
  Descr_Stats2$PregOutcome[Descr_Stats2$PregOutcome=="4"] <- "Miscarriage"
  Descr_Stats2$PregOutcome[Descr_Stats2$PregOutcome=="5"] <- "Termination of Pregnancy (TOP)"
  Descr_Stats2$PregOutcome[Descr_Stats2$PregOutcome=="6"] <- "Probable TOP"
  Descr_Stats2$PregOutcome[Descr_Stats2$PregOutcome=="7"] <- "Ectopic"
  Descr_Stats2$PregOutcome[Descr_Stats2$PregOutcome=="8"] <- "Molar"
  Descr_Stats2$PregOutcome[Descr_Stats2$PregOutcome=="9"] <- "Blighted Ovum"
  Descr_Stats2$PregOutcome[Descr_Stats2$PregOutcome=="10"] <- "Unspecified Loss"
  Descr_Stats2$PregOutcome[Descr_Stats2$PregOutcome=="11"] <- "Delivery Based on a 3rd Trimester Pregnancy Record"
  Descr_Stats2$PregOutcome[Descr_Stats2$PregOutcome=="12"] <- "Delivery Based on a Late Pregnancy Record"
  Descr_Stats2$PregOutcome[Descr_Stats2$PregOutcome=="13"] <- "Outcome Unknown"

Descr_Stats2$PregOutcome <- factor(Descr_Stats2$PregOutcome, levels = c("Live Birth", "Stillbirth", 
"Live Birth and Stillbirth", "Miscarriage", "Termination of Pregnancy (TOP)", "Probable TOP", "Ectopic", "Molar", 
"Blighted Ovum", "Unspecified Loss", "Delivery Based on a 3rd Trimester Pregnancy Record", 
"Delivery Based on a Late Pregnancy Record", "Outcome Unknown"))

table1(~PregOutcome, data = Descr_Stats2)

#IMD
Descr_Stats2$IMD <- NA
Descr_Stats2$IMD <- as.numeric(Descr_Stats2$e2019_imd_5)
Descr_Stats2$IMD <- as.factor(Descr_Stats2$IMD)

table1(~IMD, data = Descr_Stats2)

#Urban/Rural
Descr_Stats2$UrbanRural <- NA
Descr_Stats2$UrbanRural <- as.numeric(Descr_Stats2$e2011_urban_rural)
Descr_Stats2$UrbanRural[Descr_Stats2$UrbanRural=="1"] <- "Urban"
  Descr_Stats2$UrbanRural[Descr_Stats2$UrbanRural=="2"] <- "Rural"

Descr_Stats2$UrbanRural <- factor(Descr_Stats2$UrbanRural, levels = c("Urban", "Rural"))

table1(~UrbanRural, data = Descr_Stats2)

#preterm pregs
Descr_Stats2$Preterm <- NA
Descr_Stats2$Preterm <- as.numeric(Descr_Stats2$patid.preterm_ev)
  Descr_Stats2$Preterm[Descr_Stats2$Preterm=="0"] <- "No evidence of preterm"
  Descr_Stats2$Preterm[Descr_Stats2$Preterm=="1"] <- "Preterm"
  Descr_Stats2$Preterm[Descr_Stats2$Preterm=="9"] <- "Not Applicable (Outcome not a delivery)"

Descr_Stats2$Preterm <- factor(Descr_Stats2$Preterm, levels = c("Preterm", "No evidence of preterm", 
                                                                "Not Applicable (Outcome not a delivery)"))
  
table1(~Preterm, data = Descr_Stats2)

#postterm pregs
Descr_Stats2$Postterm <- NA
Descr_Stats2$Postterm <- as.numeric(Descr_Stats2$patid.postterm_ev)
  Descr_Stats2$Postterm[Descr_Stats2$Postterm=="0"] <- "No evidence of post-term"
  Descr_Stats2$Postterm[Descr_Stats2$Postterm=="1"] <- "Post-term"
  Descr_Stats2$Postterm[Descr_Stats2$Postterm=="9"] <- "Not Applicable (Outcome not a delivery)"

Descr_Stats2$Postterm <- factor(Descr_Stats2$Postterm, levels = c("Post-term", "No evidence of post-term",
                                                                  "Not Applicable (Outcome not a delivery)"))

table1(~Postterm, data = Descr_Stats2)

#multiple pregs (Missing = pregnancy loss)
Descr_Stats2$Multiple <- NA
Descr_Stats2$Multiple <- as.numeric(Descr_Stats2$patid.multiple_ev)
  Descr_Stats2$Multiple[Descr_Stats2$Multiple=="0"] <- "No evidence of multiple pregnancy"
  Descr_Stats2$Multiple[Descr_Stats2$Multiple=="1"] <- "Multiple pregnancy"
  
table1(~Multiple, data = Descr_Stats2)

#table of pre and post together
table1(~Preterm + Postterm, data = Descr_Stats2)

#table of pre/post/multiple
table1(~Preterm + Postterm + Multiple, data = Descr_Stats2)

#####is there a MBL baby?
#Descr_Stats2$MBLbaby <- NA
#Descr_Stats$MBLbaby <- as.numeric(Descr_Stats2$patid.mblbabies)
#  Descr_Stats2$MBLbaby[Descr_Stats2$MBLbaby=="1"] <- "1"
#table1(~MBLbaby, data = Descr_Stats2)
                         
#see summary (view NA's)
summary(IMD$e2019_imd_5)
#NROW(is.na(IMD$e2019_imd_5))
#str(IMD$e2019_imd_5)
#class(IMD)
sum(is.na(IMD$e2019_imd_5))

#view conflicts
table(Descr_Stats2$patid.conflict)

#create field for patids in IMD
Descr_Stats2$inIMD <- NA
  Descr_Stats2$inIMD <- as.numeric(Descr_Stats2$IMD)
#assign variables for whether in IMD or not
Descr_Stats2$inIMD[is.na(Descr_Stats2$inIMD)] <- "No"
  Descr_Stats2$inIMD[Descr_Stats2$inIMD=="1"] <- "Yes"
  Descr_Stats2$inIMD[Descr_Stats2$inIMD=="2"] <- "Yes"
  Descr_Stats2$inIMD[Descr_Stats2$inIMD=="3"] <- "Yes"
  Descr_Stats2$inIMD[Descr_Stats2$inIMD=="4"] <- "Yes"
  Descr_Stats2$inIMD[Descr_Stats2$inIMD=="5"] <- "Yes"
Descr_Stats2$inIMD <- factor(Descr_Stats2$inIMD, levels = c( "Yes", "No"))
#create field for patids in urban/rural
Descr_Stats2$inUrbanRural <- NA
  Descr_Stats2$inUrbanRural <- as.numeric(Descr_Stats2$UrbanRural)
#assign variables for whether in Urban/Rural or not
Descr_Stats2$inUrbanRural[is.na(Descr_Stats2$inUrbanRural)] <- "No"
  Descr_Stats2$inUrbanRural[Descr_Stats2$inUrbanRural=="1"] <- "Yes"
  Descr_Stats2$inUrbanRural[Descr_Stats2$inUrbanRural=="2"] <- "Yes"
  Descr_Stats2$inUrbanRural[Descr_Stats2$inUrbanRural=="3"] <- "Yes"
  Descr_Stats2$inUrbanRural[Descr_Stats2$inUrbanRural=="4"] <- "Yes"
  Descr_Stats2$inUrbanRural[Descr_Stats2$inUrbanRural=="5"] <- "Yes"
Descr_Stats2$inUrbanRural <- factor(Descr_Stats2$inUrbanRural, levels = c("Yes", "No"))

#table for IMD and urban rural
table1(~inIMD + inUrbanRural, data = Descr_Stats2)

#convert pracid to factor
Descr_Stats2$pracid.x <- as.factor(Descr_Stats2$pracid.x)


#remove pregnancies outside of inclusion criteria (make sure pregnancies within dates we want)
Descr_Stats3 <- Descr_Stats2[Descr_Stats2$patid.pregstart2 >= "2011-04-01" & Descr_Stats2$patid.pregstart2 <= "2020-03-31"]

gc()
#####################################descriptive tables#############################################################

#all in one table
table1(~MumAge + NumOfPregs + GestDays + PregOutcome + IMD + UrbanRural + Preterm + Postterm + Multiple, data = Descr_Stats2)

#descriptive table for linked vs. unlinked (IMD)
table1(~MumAge + NumOfPregs + GestDays + PregOutcome + Preterm + Postterm + Multiple | inIMD, data = Descr_Stats2)
#descriptive table for linked vs. unlinked (urban/rural)
table1(~MumAge + NumOfPregs + GestDays + PregOutcome + Preterm + Postterm + Multiple | inUrbanRural, data = Descr_Stats2)

#descriptive table for outcome unknown
table1(~MumAge + NumOfPregs + GestDays + inIMD + inUrbanRural | PregOutcome, data = Descr_Stats2)

t(table1(~MumAge + NumOfPregs + GestDays + inIMD + inUrbanRural | PregOutcome, data = Descr_Stats2))

table1(~MumAge + NumOfPregs + GestDays + inIMD + inUrbanRural | PregOutcome, data = Descr_Stats2)

#descriptive table for pracid vs. linked and pregnancy outcome
table1(~pracid.x | PregOutcome, data = Descr_Stats2)
table1(~pracid.x | inIMD, data = Descr_Stats2)
table1(~pracid.x | inUrbanRural, data = Descr_Stats2)

##################descriptives after make sure patients fit inclusion criteria##############################

#histogram of mum's age
hist(Descr_Stats3$MumAge)

#histogram of number of pregnancies
hist(Descr_Stats3$NumOfPregs)

#histogram of gestation days
hist(Descr_Stats3$GestDays)

#table of pregnancy outcomes
table1(~PregOutcome, data = Descr_Stats3)

#table of IMD
table1(~IMD, data = Descr_Stats3)

#table of urban/rural and together
table1(~UrbanRural, data = Descr_Stats3)
table1(~inIMD + inUrbanRural, data = Descr_Stats2)

#table of preterm, postterm, and multiple pregs & with them together
table1(~Preterm, data = Descr_Stats3)
table1(~Postterm, data = Descr_Stats3)
table1(~Multiple, data = Descr_Stats3)
table1(~Preterm + Postterm + Multiple, data = Descr_Stats3)



#all in one table
table1(~MumAge + NumOfPregs + GestDays + PregOutcome + IMD + UrbanRural + Preterm + Postterm + Multiple, data = Descr_Stats3)

#descriptive table for linked vs. unlinked (IMD)
table1(~MumAge + NumOfPregs + GestDays + PregOutcome + Preterm + Postterm + Multiple | inIMD, data = Descr_Stats3)
#descriptive table for linked vs. unlinked (urban/rural)
table1(~MumAge + NumOfPregs + GestDays + PregOutcome + Preterm + Postterm + Multiple | inUrbanRural, data = Descr_Stats3)

#descriptive table for outcome unknown
table1(~MumAge + NumOfPregs + GestDays + inIMD + inUrbanRural | PregOutcome, data = Descr_Stats3)

t(table1(~MumAge + NumOfPregs + GestDays + inIMD + inUrbanRural | PregOutcome, data = Descr_Stats3))

table1(~MumAge + NumOfPregs + GestDays + inIMD + inUrbanRural | PregOutcome, data = Descr_Stats3)

#descriptive table for pracid vs. linked and pregnancy outcome
table1(~pracid.x | PregOutcome, data = Descr_Stats3)
table1(~pracid.x | inIMD, data = Descr_Stats3)
table1(~pracid.x | inUrbanRural, data = Descr_Stats3)



############################look at GP data######################################################

#immunisation files

#read in immunisation files
#Ext1_Imm001 <- read.delim("ext1_Extract_Immunisation_001.txt")
#Ext1_Imm001 <- read.delim("ext1_Extract_Immunisation_002.txt")
#Ext2_Imm001 <- read.delim("ext2_Extract_Immunisation_001.txt")
#Ext2_Imm002 <- read.delim("ext2_Extract_Immunisation_002.txt")
#Ext3_Imm001 <- read.delim("ext3_Extract_Immunisation_001.txt")
#Ext3_Imm002 <- read.delim("ext3_Extract_Immunisation_002.txt")
#Ext4_Imm001 <- read.delim("ext4_Extract_Immunisation_001.txt")
#Ext4_Imm002 <- read.delim("ext4_Extract_Immunisation_002.txt")
#Ext5_Imm001 <- read.delim("ext5_Extract_Immunisation_001.txt")
#Ext5_Imm002 <- read.delim("ext5_Extract_Immunisation_002.txt")

#convert datasets to matrices
Ext1_Imm001 <- fread("P:/Kilada/CPRD_mother_baby_GOLD/Immunisation files/ext1_Extract_Immunisation_001.txt")
Ext1_Imm002 <- fread("P:/Kilada/CPRD_mother_baby_GOLD/Immunisation files/ext1_Extract_Immunisation_002.txt")
Ext2_Imm001 <- fread("P:/Kilada/CPRD_mother_baby_GOLD/Immunisation files/ext2_Extract_Immunisation_001.txt")
Ext2_Imm002 <- fread("P:/Kilada/CPRD_mother_baby_GOLD/Immunisation files/ext2_Extract_Immunisation_002.txt")
Ext3_Imm001 <- fread("P:/Kilada/CPRD_mother_baby_GOLD/Immunisation files/ext3_Extract_Immunisation_001.txt")
Ext3_Imm002 <- fread("P:/Kilada/CPRD_mother_baby_GOLD/Immunisation files/ext3_Extract_Immunisation_002.txt")
Ext4_Imm001 <- fread("P:/Kilada/CPRD_mother_baby_GOLD/Immunisation files/ext4_Extract_Immunisation_001.txt")
Ext4_Imm002 <- fread("P:/Kilada/CPRD_mother_baby_GOLD/Immunisation files/ext4_Extract_Immunisation_002.txt")
Ext5_Imm001 <- fread("P:/Kilada/CPRD_mother_baby_GOLD/Immunisation files/ext5_Extract_Immunisation_001.txt")
Ext5_Imm002 <- fread("P:/Kilada/CPRD_mother_baby_GOLD/Immunisation files/ext5_Extract_Immunisation_002.txt")


#read in immunsation file
library(data.table)
Imms <- fread("P:/Kilada/CPRD_mother_baby_GOLD/Immunisation files/study_imms.csv")



############################vaccine uptake##########################################################



################################functions

#define season
season_def <- function(df) {
  df <- df %>%
    mutate(
      season = case_when(
        between(eventdate, as.Date("2010-09-01"), as.Date("2011-08-31")) ~ "2010/2011",
        between(eventdate, as.Date("2011-09-01"), as.Date("2012-08-31")) ~ "2011/2012",
        between(eventdate, as.Date("2012-09-01"), as.Date("2013-08-31")) ~ "2012/2013",
        between(eventdate, as.Date("2013-09-01"), as.Date("2014-08-31")) ~ "2013/2014",
        between(eventdate, as.Date("2014-09-01"), as.Date("2015-08-31")) ~ "2014/2015",
        between(eventdate, as.Date("2015-09-01"), as.Date("2016-08-31")) ~ "2015/2016",
        between(eventdate, as.Date("2016-09-01"), as.Date("2017-08-31")) ~ "2016/2017",
        between(eventdate, as.Date("2017-09-01"), as.Date("2018-08-31")) ~ "2017/2018",
        between(eventdate, as.Date("2018-09-01"), as.Date("2019-08-31")) ~ "2018/2019",
        between(eventdate, as.Date("2019-09-01"), as.Date("2020-08-31")) ~ "2019/2020",
        TRUE ~ ""  # Default case, if none of the conditions are met
      )
    )
  return(df)
}

#define registration
season_def_den <- function(df) {
  df <- df %>%
    mutate(
      season2010 = case_when(
        crd <= "2010-09-01" & (is.na(tod) | tod > "2011-01-31") & (is.na(deathdate) | deathdate > "2011-01-31") ~ 1,
        TRUE ~ 0),
      season2011 = case_when(
        crd <= "2011-09-01" & (is.na(tod) | tod > "2012-01-31") & (is.na(deathdate) | deathdate > "2012-01-31") ~ 1,
        TRUE ~ 0),
      season2012 = case_when(
        crd <= "2012-09-01" & (is.na(tod) | tod > "2013-01-31") & (is.na(deathdate) | deathdate > "2013-01-31") ~ 1,
        TRUE ~ 0),
      season2013 = case_when(
        crd <= "2013-09-01" & (is.na(tod) | tod > "2014-01-31") & (is.na(deathdate) | deathdate > "2014-01-31") ~ 1,
        TRUE ~ 0),
      season2014 = case_when(
        crd <= "2014-09-01" & (is.na(tod) | tod > "2015-01-31") & (is.na(deathdate) | deathdate > "2015-01-31") ~ 1,
        TRUE ~ 0),
      season2015 = case_when(
        crd <= "2015-09-01" & (is.na(tod) | tod > "2016-01-31") & (is.na(deathdate) | deathdate > "2016-01-31") ~ 1,
        TRUE ~ 0),
      season2016 = case_when(
        crd <= "2016-09-01" & (is.na(tod) | tod > "2017-01-31") & (is.na(deathdate) | deathdate > "2017-01-31") ~ 1,
        TRUE ~ 0),
      season2017 = case_when(
        crd <= "2017-09-01" & (is.na(tod) | tod > "2018-01-31") & (is.na(deathdate) | deathdate > "2018-01-31") ~ 1,
        TRUE ~ 0),
      season2018 = case_when(
        crd <= "2018-09-01" & (is.na(tod) | tod > "2019-01-31") & (is.na(deathdate) | deathdate > "2019-01-31") ~ 1,
        TRUE ~ 0),
      season2019 = case_when(
        crd <= "2019-09-01" & (is.na(tod) | tod > "2020-01-31") & (is.na(deathdate) | deathdate > "2020-01-31") ~ 1,
        TRUE ~ 0),
    )
  return(df)
}

#define eligibility for vaccine because preg
season_def_preg <- function(df) {
  df <- df %>%
    mutate(
      season2011 = case_when(
        pregend >= "2011-09-01" & (pregstart <= "2012-01-31") ~ 1, TRUE ~ 0),
      season2012 = case_when(
        pregend >= "2012-09-01" & (pregstart <= "2013-01-31") ~ 1, TRUE ~ 0),
      season2013 = case_when(
        pregend >= "2013-09-01" & (pregstart <= "2014-01-31") ~ 1, TRUE ~ 0),
      season2014 = case_when(
        pregend >= "2014-09-01" & (pregstart <= "2015-01-31") ~ 1, TRUE ~ 0),
      season2015 = case_when(
        pregend >= "2015-09-01" & (pregstart <= "2016-01-31") ~ 1, TRUE ~ 0),
      season2016 = case_when(
        pregend >= "2016-09-01" & (pregstart <= "2017-01-31") ~ 1, TRUE ~ 0),
      season2017 = case_when(
        pregend >= "2017-09-01" & (pregstart <= "2018-01-31") ~ 1, TRUE ~ 0),
      season2018 = case_when(
        pregend >= "2018-09-01" & (pregstart <= "2019-02-28") ~ 1, TRUE ~ 0),
      season2019 = case_when(
        pregend >= "2019-09-01" & (pregstart <= "2020-02-28") ~ 1, TRUE ~ 0),
      season2020 = case_when(
        pregend >= "2020-09-01" & (pregstart <= "2021-02-28") ~ 1, TRUE ~ 0),
    )
  return(df)
}

#identify practice
identify_practice <- function(x) {
  le <- nchar(x)  #calculate the length of the input string
  return(substr(x, le-4, le))  #return a substring from the fourth character from the end to the last character
}




############################read in data

#read in product codes and make all columns into character
prodcodelist <- fread("P:/FLUVUE/prodcodelist_flu UPDATED.csv")[,lapply(.SD, as.character)]
#prodcodelist2 <- fread("P:/FLUVUE/prodcodelist_flu NEW.csv")[,lapply(.SD, as.character)]


#read in medcodes and make all columns into character
medcodelist <- fread("P:/FLUVUE/medcodelist_flu UPDATED.csv")[,lapply(.SD, as.character)]
#medcodelist2 <- fread("P:/FLUVUE/medcodelist_flu NEW.csv")[,lapply(.SD, as.character)]

#Remove duplicated medcodes
wi <- which(medcodelist$medcode =="6" & !(medcodelist$medcodeid.ds %in% "142934010" ))
medcodelist <- medcodelist[-wi,]
wi <- which(medcodelist$medcode =="94301" & !(medcodelist$medcodeid.ds %in% "308411000000113") )
medcodelist <- medcodelist[-wi,]
wi <- which(medcodelist$medcode == "21123" & medcodelist$medcodeid.ds %in% "12458061000006110")
medcodelist <- medcodelist[-wi,]
wi <- which(medcodelist$medcode == "10821" & medcodelist$medcodeid.ds %in% "4642561000006114")
medcodelist <- medcodelist[-wi,]
medcodelist[medcode %in% 107315][1,21:28] <- medcodelist[medcode %in% 107315][2,21:28]
medcodelist[medcode %in% 107315]$source <- "LSHTM_DS_PRIMIS"
wi <- which(medcodelist$medcode == "107315" & is.na(medcodelist$recLSHTM))
medcodelist <- medcodelist[-wi,]
wi <- which(medcodelist$medcode == "109363" & !(medcodelist$medcodeid.ds %in% "1756791000000118"))
medcodelist <- medcodelist[-wi,]
rm(wi)

#read in flu codes and create vector by selecting immstype
flu_x <- fread("P:/FLUVUE/flu_x NEW.csv")[,lapply(.SD, as.character)]
flu_newcodes <- flu_x %>% select(immstype) %>% pull()

#read in medcodes from lookups and rename 3rd column to "readterm"
medical <- fread("R:/Lookups/GOLD_Lookups_2021_11/medical.txt")[,lapply(.SD, as.character)]
names(medical)[3] <- "readterm"

#read in practice regions
regionlist <- fread("R:/Lookups/GOLD_Lookups_2021_11/TXTFILES/PRG.txt")[,lapply(.SD, as.character)]
names(regionlist) <- c("region", "practice_region" )

#read in immunisation, therapy, and clinical tables (merged 2 flu clinical files)
df_imms <-fread("P:/FLUVUE/Data Import/flu_imms.csv")[,lapply(.SD, as.character)]
df_ther <- fread("P:/FLUVUE/Data Import/flu_ther.csv")[,lapply(.SD, as.character)]

df_clinPT1 <- fread("P:/FLUVUE/Data Import/flu_clin.csv")[,lapply(.SD, as.character)]
df_clinPT2 <- fread("P:/FLUVUE/Data Import/flu_clin10584.csv")[,lapply(.SD, as.character)]
df_clin <- rbind(df_clinPT1,df_clinPT2)

#read in all patients
df_pat <- fread("P:/FLUVUE/Data Import/patientsNEW.csv")[,lapply(.SD, as.character)]

#read in cleaned pregnancy register
preg <- fread("P:/FLUVUE/Data Import/preg_clean.csv")[,lapply(.SD, as.character)]

#read in all practices
df_prac <- fread("P:/FLUVUE/Data Import/practice.csv")[,lapply(.SD, as.character)]

#read in batch numbers
batchnumber <- fread("R:/Lookups/GOLD_Lookups_2021_11/batchnumber.txt")[,lapply(.SD, as.character)]



##################################investigations

#dimensions of dataframes
dim(df_imms); dim(df_ther); dim(df_clin); dim(df_pat); dim(preg)

#date conversions
df_imms <- df_imms %>% mutate(eventdate = dmy(eventdate), sysdate = dmy(sysdate))
df_ther <- df_ther %>% mutate(eventdate = dmy(eventdate), sysdate = dmy(sysdate))
df_clin <- df_clin %>% mutate(eventdate = dmy(eventdate), sysdate = dmy(sysdate))

#set constant column
df_imms$rec <- df_ther$rec <- df_clin$rec <- 1

#more date conversions
df_pat <- df_pat %>% mutate(frd = dmy(frd), crd = dmy(crd), tod=dmy(tod), deathdate=dmy(deathdate) )
df_prac <- df_prac %>% mutate( lcd = dmy(lcd), uts = dmy(uts) )

#define seasons
df_imms <- season_def(df_imms)
df_ther <- season_def(df_ther)
df_clin <- season_def(df_clin)
df_pat <- season_def_den(df_pat)
preg <- season_def_preg(preg)

#check common patid values between preg and df_pat and display dimensions
table(preg$patid %in% df_pat$patid)
table(df_pat$patid %in% preg$patid)
dim(df_imms); dim(df_ther); dim(df_clin); dim(df_pat); dim(preg)

#remove records outside of practice up-to-std+6months
#add new column for pracid to each dataframe, leftjoins by pracid, and adding new columns "include" based on conditions uts, lcd, eventdate, pregstart, and pregend
df_imms <- df_imms %>% mutate( pracid = identify_practice(patid) )
df_ther <- df_ther %>% mutate( pracid = identify_practice(patid) )
df_clin <- df_clin %>% mutate( pracid = identify_practice(patid) )
preg <- preg %>% mutate( pracid = identify_practice(patid) )
df_imms <- df_imms %>% left_join( df_prac, by="pracid" )
df_ther <- df_ther %>% left_join( df_prac, by="pracid" )
df_clin <- df_clin %>% left_join( df_prac, by="pracid" )
preg <- preg %>% left_join( df_prac, by="pracid" )
df_imms <- df_imms %>% mutate( include = if_else( eventdate>=uts+183 & eventdate<=lcd, 1, 0 ) )
df_ther <- df_ther %>% mutate( include = if_else( eventdate>=uts+183 & eventdate<=lcd, 1, 0 ) )
df_clin <- df_clin %>% mutate( include = if_else( eventdate>=uts+183 & eventdate<=lcd, 1, 0 ) )
preg <- preg %>% mutate( include = if_else( pregstart>=uts+183 & pregend<=lcd, 1, 0 ) )

#add columns for pre_uts and post_lcd and tabulate and calculate means
df_imms <- df_imms %>% mutate( pre_uts = if_else( eventdate<uts , 1, 0 ) )
df_ther <- df_ther %>% mutate( pre_uts = if_else( eventdate<uts , 1, 0 ) )
df_clin <- df_clin %>% mutate( pre_uts = if_else( eventdate<uts , 1, 0 ) )
preg <- preg %>% mutate( pre_uts = if_else( pregstart<uts , 1, 0 ) )
df_imms <- df_imms %>% mutate( post_lcd = if_else( eventdate>lcd , 1, 0 ) )
df_ther <- df_ther %>% mutate( post_lcd = if_else( eventdate>lcd , 1, 0 ) )
df_clin <- df_clin %>% mutate( post_lcd = if_else( eventdate>lcd , 1, 0 ) )
preg <- preg %>% mutate( post_lcd = if_else( pregend>lcd , 1, 0 ) )
table(df_imms$pre_uts, useNA='always'); mean(df_imms$pre_uts)
table(df_ther$pre_uts, useNA='always'); mean(df_ther$pre_uts)
table(df_clin$pre_uts, useNA='always'); mean(df_clin$pre_uts)
table(preg$pre_uts, useNA='always'); mean(preg$pre_uts)
table(df_imms$post_lcd, useNA='always'); mean(df_imms$post_lcd)
table(df_ther$post_lcd, useNA='always'); mean(df_ther$post_lcd)
table(df_clin$post_lcd, useNA='always'); mean(df_clin$post_lcd)
table(preg$post_lcd, useNA='always'); mean(preg$post_lcd)
mean(df_imms$pre_uts)
mean(df_ther$pre_uts)
mean(df_clin$pre_uts)
mean(preg$pre_uts)
mean(df_imms$post_lcd)
mean(df_ther$post_lcd)
mean(df_clin$post_lcd)
mean(preg$post_lcd)

#filter data and include columns only where "include" = 1, remove columns pracid, region, uts, lcd, include, pre_uts, and post_lcd
df_imms <- df_imms[include==1,]
df_ther <- df_ther[include==1,]
df_clin <- df_clin[include==1,]
preg <- preg[include==1,]
df_imms <- df_imms[, c("pracid", "region", "uts", "lcd", "include" , "pre_uts", "post_lcd") :=NULL]
df_ther <- df_ther[, c("pracid", "region", "uts", "lcd", "include" , "pre_uts", "post_lcd") :=NULL]
df_clin <- df_clin[, c("pracid", "region", "uts", "lcd", "include" , "pre_uts", "post_lcd") :=NULL]
preg <- preg[, c("pracid", "region", "uts", "lcd", "include" , "pre_uts", "post_lcd") :=NULL]

#add pracid column and join with df_prac
df_pat <- df_pat %>% mutate( pracid = identify_practice(patid) )
df_pat <- df_pat %>% left_join( df_prac, by="pracid" )

#create test columns based on crd, tod, deathdate, uts, and lcd
df_pat <- df_pat %>% mutate( test = if_else( ( crd<uts )  , 1, 0) )
df_pat <- df_pat %>% mutate( test1 = if_else(  !is.na(tod) ,  if_else( tod<uts, 1, 0), 0 ) )
df_pat <- df_pat %>% mutate( test2 = if_else(  !is.na(deathdate) ,  if_else( deathdate<uts, 1, 0), 0 ) )
df_pat <- df_pat %>% mutate( teste = if_else( ( crd>lcd )  , 1, 0) )
df_pat <- df_pat %>% mutate( teste1 = if_else(  !is.na(tod) ,  if_else( tod>lcd, 1, 0), 0 ) )
df_pat <- df_pat %>% mutate( teste2 = if_else(  !is.na(deathdate) ,  if_else( deathdate>lcd, 1, 0), 0 ) )

#check frequencies
table(df_pat$test, useNA='always') #ok
table(df_pat$test1, useNA='always') # 24146 have tod<uts (2%)
table(df_pat$test2, useNA='always') # 43 have deathdate<uts
table(df_pat$teste, useNA='always') # ok
table(df_pat$teste1, useNA='always') # ok
table(df_pat$teste2, useNA='always') # ok

#display 100th row where test2 is 1
w=which(df_pat$test2==1)
df_pat[ w[100] ] #lcd==uts

#create include columns and filter rows
df_pat <- df_pat %>% mutate( include = if_else( ( test1==0 & test2==0 )  , 1, 0) ) #still registered at uts
df_pat <- df_pat[include==1,]
df_pat <- df_pat[, c("test", "test1", "test2", "teste", "teste1", "teste2", "include"):=NULL]

#identify and keep those registered in England only
df_pat <- df_pat %>% mutate( include = if_else( region %in% c(1:10) , 1, 0) ) #regions in England

#keep patids registered at uts & in England
df_imms <- df_imms[df_imms$patid %in% df_pat$patid,]
df_ther <- df_ther[df_ther$patid %in% df_pat$patid,]
df_clin <- df_clin[df_clin$patid %in% df_pat$patid,]
preg  <- preg[preg$patid %in% df_pat$patid,]
dim(df_imms); dim(df_ther); dim(df_clin); dim(df_pat); dim(preg)

#Keep status==1 or 9
df_imms <- df_imms[df_imms$status %in% c(1,9),]

#remove children: keep patids present in pregnancy registry
df_imms <- df_imms[df_imms$patid %in% preg$patid,]
df_ther <- df_ther[df_ther$patid %in% preg$patid,]
df_clin <- df_clin[df_clin$patid %in% preg$patid,]
df_pat  <- df_pat[df_pat$patid %in% preg$patid,]
dim(df_imms); dim(df_ther); dim(df_clin); dim(df_pat); dim(preg)


#extract information about earliest and latest pregnancy dates for each patid within a season
seasons <- sort(unique(df_imms$season))
for (si in seasons[3:12]) {
  gi <- strsplit(si, split="/")[[1]][1]
  gii <- paste("season", gi, sep="")
  
  #check if the column exists in preg
  if (gii %in% colnames(preg)) {
    wi <- which(as.data.frame(preg)[gii] == 1)
    
    #extract earliest and latest pregnancy dates
    sub <- as.data.frame(preg)[c("patid", "pregend", "pregstart")][wi,]
    sub <- sub %>% mutate(pregstart_min = min(pregstart, na.rm = TRUE), .by = c(patid))
    sub <- sub %>% mutate(pregend_end = max(pregend, na.rm = TRUE), .by = c(patid))
    sub <- sub[c("patid", "pregstart_min", "pregend_end")]
    sub <- unique(sub)  # Keep first and last pregnancy dates within season.
    names(sub) <- c("patid", "pregstart", "pregend")
    sub$season <- si
    
    #left join the extracted pregnancy information to the main data frames
    df_imms <- df_imms %>% left_join(sub, by = c("patid", "season"))
    df_imms <- df_imms %>% filter((season == si & !is.na(pregstart) & !is.na(pregend) & eventdate >= pregstart & eventdate <= pregend) | (season != si))
    df_imms <- df_imms[, c("pregend", "pregstart") := NULL]
    
    df_ther <- df_ther %>% left_join(sub, by = c("patid", "season"))
    df_ther <- df_ther %>% filter((season == si & !is.na(pregstart) & !is.na(pregend) & eventdate >= pregstart & eventdate <= pregend) | (season != si))
    df_ther <- df_ther[, c("pregend", "pregstart") := NULL]
    
    df_clin <- df_clin %>% left_join(sub, by = c("patid", "season"))
    df_clin <- df_clin %>% filter((season == si & !is.na(pregstart) & !is.na(pregend) & eventdate >= pregstart & eventdate <= pregend) | (season != si))
    df_clin <- df_clin[, c("pregend", "pregstart") := NULL]
    
    rm(sub)
  }
}

#print dimensions of the resulting dataframes
dim(df_imms); dim(df_ther); dim(df_clin); dim(df_pat); dim(preg)


#make unique record for each season and focus on sept-feb
subimms <- data.table(df_imms)
subther <- data.table(df_ther)
subclin <- data.table(df_clin)
subimms <- subimms %>% filter(!(month(eventdate) %in% c(3, 4,5,6,7,8)))
subther <- subther %>% filter(!(month(eventdate) %in% c(3, 4,5,6,7,8)))
subclin <- subclin %>% filter(!(month(eventdate) %in% c(3, 4,5,6,7,8)))

#continue to filter with a focus of sept-jan for earlier seasons
subimms <- subimms %>% filter(!(month(eventdate) %in% c(2) & season %in% c("2010/2011", "2011/2012", "2012/2013", "2013/2014", "2014/2015", "2015/2016", "2016/2017", "2017/2018" ) )) #focus of Sept-Jan for earlier seasons
subther <- subther %>% filter(!(month(eventdate) %in% c(2) & season %in% c("2010/2011", "2011/2012", "2012/2013", "2013/2014", "2014/2015", "2015/2016", "2016/2017", "2017/2018" ) ))
subclin <- subclin %>% filter(!(month(eventdate) %in% c(2) & season %in% c("2010/2011", "2011/2012", "2012/2013", "2013/2014", "2014/2015", "2015/2016", "2016/2017", "2017/2018" ) ))

#check dimensions
dim(subimms); dim(subther); dim(subclin)


dim(subimms); dim(subther); dim(subclin)
subimms$medcode <- as.character(subimms$medcode)
subimms$batch <- as.character(subimms$batch)
subimms <- subimms[j=c( "season", "patid","eventdate","consid", "batch", "medcode", "immstype", "rec")]
subimms <- unique(subimms)
subimms <- merge(subimms, medcodelist[j=c("medcode", "readterm", "level" )], all.x=TRUE)
subimms <- subimms %>% rename(levelmed =level) #169 records NA
subimms <- subimms %>% left_join(flu_x, by="immstype") #merge not working
subimms <- subimms %>% left_join(batchnumber, by= "batch") #merge not working
subther <- subther[j=c( "season", "patid","eventdate","consid", "prodcode", "rec")]
subther <- unique(subther)
subther <- merge(subther, prodcodelist[j=c("prodcode", "productname",   "drugsubstance", "havebrand", "brand", "level" )], all.x=TRUE)
subclin <- subclin[j= c( "season", "patid","eventdate","consid", "medcode", "constype","episode", "rec")]
subclin <- merge(subclin, medcodelist[j=c("medcode", "readterm", "level" )], all.x=TRUE)
subclin <- subclin %>% rename(levelmed =level) #70403 NA
dim(subimms); dim(subther); dim(subclin)


#add batch identification
subimms <- subimms %>% mutate(nonflu_batch = grepl("Hep|Typhoid|Revaxis|WARFARIN|hepatyrix|pneumovax|Prevenar|mENITORIX|PEDIACEL|pedicel|Engerix|Meningcoccal|priorix|ambirix|Infanrix|Typhrix|Typherix|ROTARIX|Meningitec|menbjugate|menjugate|viatim|Rabipur|MENJUGATE|repevax|BEXSERO|Mumps|Rubella|Havrix|dukoral|stamaril", batch_number, ignore.case=TRUE ) )
subimms <- subimms %>% mutate(brand_batch = grepl("sanofi|aventis|pasteur|pfizer|wyeth|baxter|novartis|astra|Zeneca|glaxo|gsk|san past|seqirus|merieux|chiron|viatris", batch_number, ignore.case=TRUE ) )
subimms <- subimms %>% mutate(flu_batch = grepl("AFLU|viroflu|viruflu|virroflu|fluarix|Flurax|fluvirin|fluviri|fluviron|fluvirn|influvac|INFLUV|imfluvac|fluad|fluaad|optaflu|Fluenztetra|
fluenz|Fluenaz|flumist|Flucelvax|Flucerlvax|flublok|flubl|preflucel|intanza", batch_number, ignore.case=TRUE ) )
brandlist <- c("sanofi", "aventis", "pasteur", "pfizer", "wyeth", "baxter", "novartis", "astra", "Zeneca", "glaxo", "gsk", "san past", "seqirus", "merieux", "chiron", "viatris")
whichbrand_fct <- function(wrd, b) return( ifelse( grepl(wrd, b, ignore.case=TRUE ), wrd, "") )
test <- sapply( brandlist, whichbrand_fct , subimms$batch_number) #returns matrix with 15 columns
test2 <- apply(test, 1, paste, collapse="")
test2[test2 %in% c("pasteursan past", "san past", "sanofi")] <- "sanofipasteur"
test2[test2 %in% c("glaxo")] <- "gsk"
test2[test2 %in% c("astra", "Zeneca", "astraZeneca")] <- "AstraZeneca"
test2[test2 %in% c("aventis")] <- "aventispasteur"
subimms$whichbrand <- test2
rm(test, test2)
flulist <- c("AFLU", "viroflu", "viruflu", "virroflu", "fluarix", "Flurax", "fluvir", "INFLUV", "imfluvac", "fluad", "fluaad", "optaflu", "Fluen", "flumist", "Flucelvax", "Flucerlvax", "flublok", "preflucel", "intanza")
test <- sapply( flulist, whichbrand_fct , subimms$batch_number) #returns matrix with 26 columns
test2 <- apply(test, 1, paste, collapse="")
test2[test2 %in% c("viruflu", "virroflu")] <- "viroflu"
test2[test2 %in% c("AFLUfluarix", "AFLUFlurax")] <- "fluarix"
test2[test2 %in% c("fluvir", "fluvirINFLUV")] <- "fluvirin"
test2[test2 %in% c("INFLUV", "imfluvac")] <- "influvac"
test2[test2 %in% c("fluaad")] <- "fluad"
test2[test2 %in% c("Fluen")] <- "Fluenztetra"
test2[test2 %in% c("Flucerlvax")] <- "Flucelvax"
test2[test2 %in% c("flubl")] <- "flublok"
test2[test2 %in% c("AFLUoptaflu")] <- "optaflu"
subimms$whichflu <- test2
rm(test, test2)


#reorder
subimms <- subimms[order(patid, eventdate, immstype, batch)]
subther <- subther[order(patid, eventdate, prodcode)]
subclin <- subclin[order(patid, eventdate, medcode)]


#merge imms, ther and clin
submg <- merge(subimms, subther, by=c("patid", "eventdate", "season", "consid", "level"), all=TRUE, suffixes=c(".i", ".t"))
submg <- merge(submg, subclin, by=c("patid", "eventdate", "season", "consid",  "medcode", "levelmed", "readterm"), all=TRUE, suffixes=c(".it", ".c"))

submg <- submg %>% rename(levelimmsprod = level)
submg <- submg %>% mutate(level = levelmed )
submg <- submg %>% mutate(level = if_else(is.na(level) & !is.na(levelimmsprod),levelimmsprod, level ) )

#handle missing levels
#create binary for missing levels in "level" column
submg <- submg %>% mutate(levelmis = if_else(is.na(level), 1, 0))

#impute missing levels based on "season" variable
submg <- submg %>% mutate(level = if_else(levelmis==1 & season=="2009/2010","Pandemic", level))
submg <- submg %>% mutate(level = if_else(levelmis==1 & season!="2009/2010","Seasonal", level))

#add variables for rec and brand
submg <- submg %>% mutate(recid=paste(patid, season, level, sep="_")); length(unique(submg$recid))
submg <- submg %>% mutate(recitc = paste(rec.i, rec.t, rec, sep="_")) #which record from which table
submg <- data.table(submg)

submg <- submg %>% mutate(havebrandmore = if_else(havebrand %in% 1 | flu_batch %in% TRUE | brand_batch %in% TRUE, 1, 0))
submg <- submg %>% mutate(havebrandRank = if_else(havebrand %in% 1, 1, if_else(flu_batch %in% TRUE, 2, if_else( brand_batch %in% TRUE, 3, 0 ) ) ))


#keep if havebrandmore or first occurring event of season
#create order variable
submg <- submg[,myorder :=1:.N, by= .(patid, season, level)]
submg <- submg[,myorder2 :=1:.N, keyby= .(patid, season, eventdate, level, consid, medcode, batch)]
#initialise a keep variable, update it, and calculate maximum keep value
submg$keep <- 0
submg <- submg %>% mutate(keep = if_else(havebrandmore %in% 1 , 1, keep ))
submg <- submg %>% mutate(keep = if_else(havebrandmore %in% 0 & myorder==1 , 1, keep ))
submg <- submg %>% mutate(maxkeep= max(keep), .by=c(patid, season, level)); table(submg$maxkeep)
#further update keep and filter rows where keep = 1
submg <- submg %>% mutate(keep = if_else(maxkeep==0 & myorder==1, 1, keep ))
submg <- submg %>% mutate(maxkeep= max(keep), .by=c(patid, season, level)); table(submg$maxkeep)
table(submg$keep)
submg <- submg[keep==1]
#print dimensions
dim(submg)[1]; length(unique(submg$recid)); dim(submg)[1]-length(unique(submg$recid))


#remove multiples within havebrand status and prioritise brands from therapy file
#create order variables
submg <- submg[,myorder :=1:.N, by= .(patid, season, level)]
submg <- submg[,myorder2 :=1:.N, keyby= .(patid, season, eventdate, level, consid, medcode, batch)]
submg <- submg[,myorder3 :=1:.N, by= .(patid, season, level, havebrandRank)]
submg <- submg[,myorder4 :=1:.N, by= .(patid, season, level, havebrandmore)]
#initialise keep variable, update it, and calculate maximum keep value
submg$keep <- 0
submg <- submg %>% mutate(keep = if_else( myorder3==1 , 1, keep ))
submg <- submg %>% mutate(maxkeep= max(keep), .by=c(patid, season, level)); table(submg$maxkeep)
table(submg$keep)
#filter rows where keep = 1
submg <- submg[keep==1]
#print dimensions
dim(submg)[1]; length(unique(submg$recid)); dim(submg)[1]-length(unique(submg$recid))

#continuation of previous steps
#create order variables
submg <- submg[,myorder :=1:.N, by= .(patid, season, level)]
submg <- submg[,myorder2 :=1:.N, keyby= .(patid, season, eventdate, level, consid, medcode, batch)]
submg <- submg[order(patid, season, level, havebrandRank)]
submg <- submg[,myorder3 :=1:.N, by= .(patid, season, level, havebrandmore)]
#initialise keep variable, update it, and calculate maximum keep value
submg$keep <- 0
submg <- submg %>% mutate(keep = if_else( myorder3==1 , 1, keep ))
submg <- submg %>% mutate(maxkeep= max(keep), .by=c(patid, season, level)); table(submg$maxkeep)
table(submg$keep)
#filter rows where keep = 1
submg <- submg[keep==1]
#print dimensions
dim(submg)[1]; length(unique(submg$recid)); dim(submg)[1]-length(unique(submg$recid)) #6309 remaining

#remove duplicates with same recid, some have&havent brand
#create order variable
submg <- submg[,myorder :=1:.N, by= .(patid, season, level)]
#identify records with "recid" occurences greater than 1
rec44 <- submg$recid[ which(submg$myorder %in% 2) ]
#print tablew with occurences of "recid" in both columns
table( submg$recid %in% rec44,  submg$havebrandmore, useNA='always')
#initialise keep variable to 1
submg$keep <- 1
#update keep variable, remove records with "recid" occurences in "rec44" and "havebrandmore"
submg <- submg %>% mutate(keep = if_else( recid %in% rec44 & havebrandmore==0 , 0, keep ))
#print table of keep values
table(submg$keep)
#filter rows where keep = 1
submg <- submg[keep==1]
#print dimensions
dim(submg)[1]; length(unique(submg$recid)); dim(submg)[1]-length(unique(submg$recid))

#subset columns
submg <- subset(submg, select = -c(myorder, myorder2, myorder3, myorder4, keep, maxkeep )) #submg <- submg %>% select(-c(myorder, myorder2, keep, maxkeep, myorder3 )); submg <- submg %>% select(-c(myorder:myorder3 ))



#focus on season 2018/2019
submg1819 <- submg[season=="2018/2019" & level=="Seasonal"]
#women eligible for vaccination in 2018/19 season
preg1819 <- unique(preg[season2018==1]$patid)
submgpreg1819 <- submg1819[ (submg1819$patid %in% preg1819) & (submg1819$level %in% "Seasonal") ]
#calculate uptake percentage (37% uptake)
dim(submgpreg1819)[1] / length(preg1819)



### vaccination uptake per season (error message)
seasons <- sort(unique(submg$season))
for (si in seasons[3:11]) {
  gi <- strsplit(si, split="/")[[1]][1]
  tempnum <- submg[season==si]
  tempnum <- tempnum[,myorder :=1:.N, by= .(patid)]
  gii <- paste("season", gi, sep="")
  wi <-  which( as.data.frame(preg)[gii] ==1 )
  tempden <- unique(preg[wi,j=c("patid")])
  tempden$eligible <- "eligible"
  tempnum <- tempnum[order(patid, level)]
  tempnum <- tempnum[level %in% "Seasonal"]
  tempdata <- tempnum %>% full_join(tempden, by=c("patid"))
  print(table(tempdata$eligible, tempdata$level, useNA='always'))
  print(paste( "Season", si, round( 100*dim( filter(tempdata, eligible=="eligible" & level=="Seasonal" ))[1] / dim( filter(tempdata, eligible=="eligible" ) )[1] , 2) , "% vaccination uptake (Seasonal)", sep=" "))
  rm(gi, gii, wi, tempden, tempnum, tempdata )
}



#write csv files for unique records and by season
fwrite(preg, paste("P:/FLUVUE/fluvacc_eligibility.csv"))
fwrite(submg, paste("P:/FLUVUE/fluvacc_uniquerecords_byseason.csv"))



#######################explore unique vaccination records file################################################

#read in unique records (shows who is eligible in the season)
df_eligibility <- fread("P:/FLUVUE/fluvacc_eligibility.csv")[,lapply(.SD, as.character)]
#read in unique records by season
df_uniquevaxrecords_byseason <- fread("P:/FLUVUE/fluvacc_uniquerecords_byseason.csv")[,lapply(.SD, as.character)]

#date conversion
Descr_Stats3 <- Descr_Stats3 %>% mutate(patid.pregstart = dmy(patid.pregstart))
Descr_Stats3 <- Descr_Stats3 %>% mutate(patid.pregend = dmy(patid.pregend))

#convert date to date instead of character
#df_eligibility <- df_eligibility %>% mutate(pregstart = dmy(pregstart))
Descr_Stats3$patid.pregstart <- as.character(Descr_Stats3$patid.pregstart)
Descr_Stats3$patid.pregend <- as.character(Descr_Stats3$patid.pregend)

#merge descpritive stats table with eligibility
#Descr_Stats4 <- merge(Descr_Stats3, df_eligibility[,j=c("patid", "pregstart", "pregend", "season2011", "season2012")], by.x = c("patid.patid", "patid.pregstart", "patid.pregend"), by.y = c("patid", "pregstart", "pregend"), all.x = TRUE)


#add seasons to descriptive stats
#season for pregnancies
season_def_preg2 <- function(df) {
  df <- df %>%
    mutate(
      season2011 = case_when(
        patid.pregend >= "2011-09-01" & (patid.pregstart <= "2012-01-31") ~ 1, TRUE ~ 0),
      season2012 = case_when(
        patid.pregend >= "2012-09-01" & (patid.pregstart <= "2013-01-31") ~ 1, TRUE ~ 0),
      season2013 = case_when(
        patid.pregend >= "2013-09-01" & (patid.pregstart <= "2014-01-31") ~ 1, TRUE ~ 0),
      season2014 = case_when(
        patid.pregend >= "2014-09-01" & (patid.pregstart <= "2015-01-31") ~ 1, TRUE ~ 0),
      season2015 = case_when(
        patid.pregend >= "2015-09-01" & (patid.pregstart <= "2016-01-31") ~ 1, TRUE ~ 0),
      season2016 = case_when(
        patid.pregend >= "2016-09-01" & (patid.pregstart <= "2017-01-31") ~ 1, TRUE ~ 0),
      season2017 = case_when(
        patid.pregend >= "2017-09-01" & (patid.pregstart <= "2018-01-31") ~ 1, TRUE ~ 0),
      season2018 = case_when(
        patid.pregend >= "2018-09-01" & (patid.pregstart <= "2019-02-28") ~ 1, TRUE ~ 0),
      season2019 = case_when(
        patid.pregend >= "2019-09-01" & (patid.pregstart <= "2020-02-28") ~ 1, TRUE ~ 0),
      season2020 = case_when(
        patid.pregend >= "2020-09-01" & (patid.pregstart <= "2021-02-28") ~ 1, TRUE ~ 0),
    )
  return(df)
}


Descr_Stats3 <- season_def_preg2(Descr_Stats3)


#create binary for if eligible during pregnancy
library(dplyr)

Descr_Stats3 <- Descr_Stats3 %>%
  mutate(eligible_during_preg = ifelse(rowSums(.[, 41:50] == 1, na.rm = TRUE) > 0, 1, 0))

#view the result
print(Descr_Stats3)


#list of seasons and corresponding date ranges
seasons <- c("2011/2012", "2012/2013", "2013/2014", "2014/2015", "2015/2016", "2016/2017", "2017/2018", "2018/2019", "2019/2020")
date_ranges <- list(
  list(start = "2011-09-01", end = "2012-01-31"),
  list(start = "2012-09-01", end = "2013-01-31"),
  list(start = "2013-09-01", end = "2014-01-31"),
  list(start = "2014-09-01", end = "2015-01-31"),
  list(start = "2015-09-01", end = "2016-01-31"),
  list(start = "2016-09-01", end = "2017-01-31"),
  list(start = "2017-09-01", end = "2018-01-31"),
  list(start = "2018-09-01", end = "2019-02-28"),
  list(start = "2019-09-01", end = "2020-02-28")
)

# Create an empty list to store results for each season
result_list <- list()


#merge by each season and remove merge column after each season

#2011
i <- 1
season <- seasons[i]
date_range <- date_ranges[[i]]

Descr_Stats3$merge[Descr_Stats3$season2011 == 1] <- substr(x = season, start = 1, stop = 4)
df_uniquevaxrecords_byseason$merge <- substr(x = df_uniquevaxrecords_byseason$season, start = 1, stop = 4) 

result <- left_join(
  Descr_Stats3,
  df_uniquevaxrecords_byseason,
  by = c("patid.patid" = "patid", "merge" = "merge")
) %>%
  select(-merge)  #remove the 'merge' column

#append the result to the list
result_list[[i]] <- result

#2012
i <- 2
season <- seasons[i]
date_range <- date_ranges[[i]]

Descr_Stats3$merge[Descr_Stats3$season2012 == 1] <- substr(x = season, start = 1, stop = 4)
df_uniquevaxrecords_byseason$merge <- substr(x = df_uniquevaxrecords_byseason$season, start = 1, stop = 4) 

result <- left_join(
  Descr_Stats3,
  df_uniquevaxrecords_byseason,
  by = c("patid.patid" = "patid", "merge" = "merge")
) %>%
  select(-merge)  #remove the 'merge' column

#append the result to the list
result_list[[i]] <- result

#2013
i <- 3
season <- seasons[i]
date_range <- date_ranges[[i]]

Descr_Stats3$merge[Descr_Stats3$season2013 == 1] <- substr(x = season, start = 1, stop = 4)
df_uniquevaxrecords_byseason$merge <- substr(x = df_uniquevaxrecords_byseason$season, start = 1, stop = 4) 

result <- left_join(
  Descr_Stats3,
  df_uniquevaxrecords_byseason,
  by = c("patid.patid" = "patid", "merge" = "merge")
) %>%
  select(-merge)  #remove the 'merge' column

#append the result to the list
result_list[[i]] <- result

#2014
i <- 4
season <- seasons[i]
date_range <- date_ranges[[i]]

Descr_Stats3$merge[Descr_Stats3$season2014 == 1] <- substr(x = season, start = 1, stop = 4)
df_uniquevaxrecords_byseason$merge <- substr(x = df_uniquevaxrecords_byseason$season, start = 1, stop = 4) 

result <- left_join(
  Descr_Stats3,
  df_uniquevaxrecords_byseason,
  by = c("patid.patid" = "patid", "merge" = "merge")
) %>%
  select(-merge)  #remove the 'merge' column

#append the result to the list
result_list[[i]] <- result

#2015
i <- 5
season <- seasons[i]
date_range <- date_ranges[[i]]

Descr_Stats3$merge[Descr_Stats3$season2015 == 1] <- substr(x = season, start = 1, stop = 4)
df_uniquevaxrecords_byseason$merge <- substr(x = df_uniquevaxrecords_byseason$season, start = 1, stop = 4) 

result <- left_join(
  Descr_Stats3,
  df_uniquevaxrecords_byseason,
  by = c("patid.patid" = "patid", "merge" = "merge")
) %>%
  select(-merge)  #remove the 'merge' column

#append the result to the list
result_list[[i]] <- result

#2016
i <- 6
season <- seasons[i]
date_range <- date_ranges[[i]]

Descr_Stats3$merge[Descr_Stats3$season2016 == 1] <- substr(x = season, start = 1, stop = 4)
df_uniquevaxrecords_byseason$merge <- substr(x = df_uniquevaxrecords_byseason$season, start = 1, stop = 4) 

result <- left_join(
  Descr_Stats3,
  df_uniquevaxrecords_byseason,
  by = c("patid.patid" = "patid", "merge" = "merge")
) %>%
  select(-merge)  #remove the 'merge' column

#append the result to the list
result_list[[i]] <- result

#2017
i <- 7
season <- seasons[i]
date_range <- date_ranges[[i]]

Descr_Stats3$merge[Descr_Stats3$season2017 == 1] <- substr(x = season, start = 1, stop = 4)
df_uniquevaxrecords_byseason$merge <- substr(x = df_uniquevaxrecords_byseason$season, start = 1, stop = 4) 

result <- left_join(
  Descr_Stats3,
  df_uniquevaxrecords_byseason,
  by = c("patid.patid" = "patid", "merge" = "merge")
) %>%
  select(-merge)  #remove the 'merge' column

#append the result to the list
result_list[[i]] <- result

#2018
i <- 8
season <- seasons[i]
date_range <- date_ranges[[i]]

Descr_Stats3$merge[Descr_Stats3$season2018 == 1] <- substr(x = season, start = 1, stop = 4)
df_uniquevaxrecords_byseason$merge <- substr(x = df_uniquevaxrecords_byseason$season, start = 1, stop = 4) 

result <- left_join(
  Descr_Stats3,
  df_uniquevaxrecords_byseason,
  by = c("patid.patid" = "patid", "merge" = "merge")
) %>%
  select(-merge)  #remove the 'merge' column

#append the result to the list
result_list[[i]] <- result

#2019
i <- 9
season <- seasons[i]
date_range <- date_ranges[[i]]

Descr_Stats3$merge[Descr_Stats3$season2019 == 1] <- substr(x = season, start = 1, stop = 4)
df_uniquevaxrecords_byseason$merge <- substr(x = df_uniquevaxrecords_byseason$season, start = 1, stop = 4) 

result <- left_join(
  Descr_Stats3,
  df_uniquevaxrecords_byseason,
  by = c("patid.patid" = "patid", "merge" = "merge")
) %>%
  select(-merge)  #remove the 'merge' column

#append the result to the list
result_list[[i]] <- result


#create binary for had a vaccine during pregnancy
Descr_Stats3$had_flu_vax_during_preg <- ifelse(!is.na(Descr_Stats3[, 52]), 1, 0)


#see table of those who had vaccine by eligibility (this is inccorrect)
#recode and reorder
Descr_Stats3$eligible_during_preg2 <- NA
Descr_Stats3$eligible_during_preg2[Descr_Stats3$eligible_during_preg=="1"]<-"Yes"
Descr_Stats3$eligible_during_preg2[Descr_Stats3$eligible_during_preg=="0"]<-"No"

Descr_Stats3$eligible_during_preg2<-as.factor(Descr_Stats3$eligible_during_preg2)
levels(Descr_Stats3$eligible_during_preg2)
Descr_Stats3$eligible_during_preg2<-factor(Descr_Stats3$eligible_during_preg2,levels(Descr_Stats3$eligible_during_preg2)[c(2,1)])
levels(Descr_Stats3$eligible_during_preg2)

Descr_Stats3$had_flu_vax_during_preg2 <- NA
Descr_Stats3$had_flu_vax_during_preg2[Descr_Stats3$had_flu_vax_during_preg=="1"]<- "Yes"
Descr_Stats3$had_flu_vax_during_preg2[Descr_Stats3$had_flu_vax_during_preg=="0"]<- "No"

Descr_Stats3$had_flu_vax_during_preg2<-as.factor(Descr_Stats3$had_flu_vax_during_preg2)
levels(Descr_Stats3$had_flu_vax_during_preg2)
Descr_Stats3$had_flu_vax_during_preg2<-factor(Descr_Stats3$had_flu_vax_during_preg2,levels(Descr_Stats3$had_flu_vax_during_preg2)[c(2,1)])
levels(Descr_Stats3$had_flu_vax_during_preg2)

table1(~had_flu_vax_during_preg2 | eligible_during_preg2, data = Descr_Stats3)


#table of demographics by those who had vaccine (makes it 100% uptake-definite error)
#all in one table
table1(~MumAge + NumOfPregs + GestDays + PregOutcome + IMD + UrbanRural + Preterm + Postterm + Multiple | had_flu_vax_during_preg2 , data = Descr_Stats3)


#rename seasons
Descr_Stats3$Season <- NA
Descr_Stats3$Season[Descr_Stats3$merge=="2011"]<-"2011/2012"
Descr_Stats3$Season[Descr_Stats3$merge=="2012"]<-"2012/2013"
Descr_Stats3$Season[Descr_Stats3$merge=="2013"]<-"2013/2014"
Descr_Stats3$Season[Descr_Stats3$merge=="2014"]<-"2014/2015"
Descr_Stats3$Season[Descr_Stats3$merge=="2015"]<-"2015/2016"
Descr_Stats3$Season[Descr_Stats3$merge=="2016"]<-"2016/2017"
Descr_Stats3$Season[Descr_Stats3$merge=="2017"]<-"2017/2018"
Descr_Stats3$Season[Descr_Stats3$merge=="2018"]<-"2018/2019"
Descr_Stats3$Season[Descr_Stats3$merge=="2019"]<-"2019/2020"


#merge data frames
Descr_Stats4 <- left_join(
  Descr_Stats3,
  df_uniquevaxrecords_byseason,
  by = c("patid.patid" = "patid", "Season" = "season")
)
#view the result
print(Descr_Stats4)


#fix had flu vax during pregnancy so it's by event date instead of season
Descr_Stats4 <- Descr_Stats4 %>%
  mutate(had_flu_vax_during_preg = ifelse(!is.na(eventdate), 1, 0))

#see table of those who had vaccine during pregnancy and eligibility (error message)
#Descr_Stats4$had_flu_vax_during_preg2 <- NA
#Descr_Stats4$had_flu_vax_during_preg2[Descr_Stats4$had_flu_vax_during_preg=="1"]<- "Yes"
#Descr_Stats4$had_flu_vax_during_preg2[Descr_Stats4$had_flu_vax_during_preg=="0"]<- "No"

#Descr_Stats4$had_flu_vax_during_preg4<-as.factor(Descr_Stats3$had_flu_vax_during_preg4)
#levels(Descr_Stats4$had_flu_vax_during_preg2)

#table1(~had_flu_vax_during_preg2 | eligible_during_preg2, data = Descr_Stats4)

#flu vax during pregnancy by event date
Descr_Stats4 <- Descr_Stats4 %>%
  mutate(
    had_flu_vax_during_preg2 = if_else(had_flu_vax_during_preg == "1", "Yes", "No")
  )

table1(~had_flu_vax_during_preg2 | eligible_during_preg2, data = Descr_Stats4)

Descr_Stats4$had_flu_vax_during_preg2<-as.factor(Descr_Stats4$had_flu_vax_during_preg2)
levels(Descr_Stats4$had_flu_vax_during_preg2)
Descr_Stats4$had_flu_vax_during_preg2<-factor(Descr_Stats4$had_flu_vax_during_preg2,levels(Descr_Stats4$had_flu_vax_during_preg2)[c(2,1)])
levels(Descr_Stats4$had_flu_vax_during_preg2)


#table of demographics by those who had vaccine
#all in one table
table1(~MumAge + NumOfPregs + GestDays + PregOutcome + IMD + UrbanRural + Preterm + Postterm + Multiple | had_flu_vax_during_preg2 , data = Descr_Stats4)


#remove outcome unknown
Descr_Stats4 <- Descr_Stats4 %>%
  filter(PregOutcome != "Outcome Unknown")

table1(~had_flu_vax_during_preg2 | eligible_during_preg2, data = Descr_Stats4)

table1(~MumAge + NumOfPregs + GestDays + PregOutcome + IMD + UrbanRural + Preterm + Postterm + Multiple | had_flu_vax_during_preg2 , data = Descr_Stats4)

table1(~MumAge + NumOfPregs + GestDays + PregOutcome + IMD + UrbanRural + Preterm + Postterm + Multiple | had_flu_vax_during_preg2 + eligible_during_preg2, data = Descr_Stats4)

#split no column into no and eligiible and no and not eligible
Descr_Stats4$had_flu_vax_during_preg3 <- NA
Descr_Stats4$had_flu_vax_during_preg3[Descr_Stats4$had_flu_vax_during_preg=="1"]<- "Yes"
Descr_Stats4$had_flu_vax_during_preg3[Descr_Stats4$had_flu_vax_during_preg=="0" & Descr_Stats4$eligible_during_preg2=="Yes"]<- "No and Eligible"
Descr_Stats4$had_flu_vax_during_preg3[Descr_Stats4$had_flu_vax_during_preg=="0" & Descr_Stats4$eligible_during_preg2=="No"] <- "No and Ineligible"

Descr_Stats4$had_flu_vax_during_preg3<-as.factor(Descr_Stats4$had_flu_vax_during_preg3)
levels(Descr_Stats4$had_flu_vax_during_preg3)
Descr_Stats4$had_flu_vax_during_preg3<-factor(Descr_Stats4$had_flu_vax_during_preg3,levels(Descr_Stats4$had_flu_vax_during_preg3)[c(3,1,2)])
levels(Descr_Stats4$had_flu_vax_during_preg3)


table1(~had_flu_vax_during_preg3, data = Descr_Stats4)

table1(~MumAge + NumOfPregs + GestDays + PregOutcome + IMD + UrbanRural + Preterm + Postterm + Multiple | had_flu_vax_during_preg3 , data = Descr_Stats4)


#check for overlapping episodes
Descr_Stats4$patid.conflict <- as.factor(Descr_Stats4$patid.conflict)
summary(Descr_Stats4$patid.conflict)
#remove overlapping episodes
Descr_Stats4 <- Descr_Stats4 %>%
  filter(patid.conflict != "1")


#vaccination by trimester

#date conversion
Descr_Stats4$SecTri <- dmy(Descr_Stats4$patid.secondtrim)
Descr_Stats4$ThirdTri <- dmy(Descr_Stats4$patid.thirdtrim)

#vaccination in first trimester
Descr_Stats4$Tri_of_vax <- NA
Descr_Stats4$Tri_of_vax[Descr_Stats4$had_flu_vax_during_preg3 == "Yes" & Descr_Stats4$eventdate < Descr_Stats4$SecTri] <- "First Trimester Vaccination"
Descr_Stats4$Tri_of_vax[Descr_Stats4$had_flu_vax_during_preg3 == "Yes" & Descr_Stats4$eventdate >= Descr_Stats4$SecTri & Descr_Stats4$eventdate < Descr_Stats4$ThirdTri] <- "Second Trimester Vaccination"
Descr_Stats4$Tri_of_vax[Descr_Stats4$had_flu_vax_during_preg3 == "Yes" & Descr_Stats4$eventdate >= Descr_Stats4$ThirdTri] <- "Third Trimester Vaccination"

#table for trimester (247786 missing trimester dates)
table1(~Tri_of_vax, data = Descr_Stats4)

#table of trimester vax info using a data frame that removed NA's
TrimVaxData <- Descr_Stats4[!is.na(Descr_Stats4$Tri_of_vax), ]
table1(~Tri_of_vax, data = TrimVaxData)


#table of vaccination by season
table1(~Season | had_flu_vax_during_preg3, data = Descr_Stats4)


#who had flu vaccine, only for those who were eligible
Descr_Stats5 <- Descr_Stats4[Descr_Stats4$had_flu_vax_during_preg3 %in% c("Yes", "No and Eligible"), ]
table1(~had_flu_vax_during_preg3, data = Descr_Stats5)


#test that those who are missing HES data
Descr_StatsHESIMDtest <- Descr_Stats5[!is.na(Descr_Stats5$patid.epikey), ]
table1(~IMD + UrbanRural, data = Descr_StatsHESIMDtest)


#read in linkage eligibility
LinkageEligibility <- fread("P:/20_000278_Type_2_request/GOLD_linked/Final/20_000278_linkage_eligibility_gold.txt")
LinkageEligibilityDedup <- data.frame(patid=LinkageEligibility[!duplicated(LinkageEligibility$patid),])
LinkageEligibility2 <- LinkageEligibilityDedup[!is.na(LinkageEligibilityDedup$patid.hes_apc_e), ]

#merge to descriptive stats (this is new cohort)
LinkageEligibility2$patid.patid <- as.factor(LinkageEligibility2$patid.patid)
Descr_Stats6 <- merge(Descr_Stats5, LinkageEligibility2, by = "patid.patid", all.x = T)
#test
Descr_Stats7 <- Descr_Stats6[!is.na(Descr_Stats6$patid.hes_apc_e), ]
table1(~IMD + UrbanRural, data = Descr_Stats7)


#trimester of vaccination for new cohort
TrimVaxData2 <- Descr_Stats7[!is.na(Descr_Stats7$Tri_of_vax), ]
table1(~Tri_of_vax, data = TrimVaxData2)


#write csv files for descriptive stats and trimester so don't need to rerun all code before this point
fwrite(Descr_Stats7, paste("P:/Descr_Stats7.csv"))
fwrite(TrimVaxData2, paste("P:/TrimVaxData2.csv"))


#######################read back in descriptive stats 7 and trimester data and reformat################

Descr_Stats7<-fread("P:/Descr_Stats7.csv")[,lapply(.SD, as.character)]
Descr_Stats7$MumAge<-as.numeric(Descr_Stats7$MumAge)
Descr_Stats7$NumOfPregs<-as.numeric(Descr_Stats7$NumOfPregs)
Descr_Stats7$GestDays<-as.numeric(Descr_Stats7$GestDays)

#reformat
Descr_Stats7$had_flu_vax_during_preg3<-as.factor(Descr_Stats7$had_flu_vax_during_preg3)
levels(Descr_Stats7$had_flu_vax_during_preg3)
Descr_Stats7$had_flu_vax_during_preg3<-factor(Descr_Stats7$had_flu_vax_during_preg3, levels(Descr_Stats7$had_flu_vax_during_preg3)[c(2,1)])
levels(Descr_Stats7$had_flu_vax_during_preg3)

Descr_Stats7$PregOutcome<-as.factor(Descr_Stats7$PregOutcome)
levels(Descr_Stats7$PregOutcome)
Descr_Stats7$PregOutcome<-factor(Descr_Stats7$PregOutcome, levels(Descr_Stats7$PregOutcome)[c(5,10,6,7,11,9,4,8,1,12,2,3)])
levels(Descr_Stats7$PregOutcome)

Descr_Stats7$UrbanRural<-as.factor(Descr_Stats7$UrbanRural)
levels(Descr_Stats7$UrbanRural)
Descr_Stats7$UrbanRural<-factor(Descr_Stats7$UrbanRural, levels(Descr_Stats7$UrbanRural)[c(3,2,1)])
levels(Descr_Stats7$UrbanRural)

Descr_Stats7$Preterm<-as.factor(Descr_Stats7$Preterm)
levels(Descr_Stats7$Preterm)
Descr_Stats7$Preterm<-factor(Descr_Stats7$Preterm, levels(Descr_Stats7$Preterm)[c(3,1,2)])
levels(Descr_Stats7$Preterm)

Descr_Stats7$Postterm<-as.factor(Descr_Stats7$Postterm)
levels(Descr_Stats7$Postterm)
Descr_Stats7$Postterm<-factor(Descr_Stats7$Postterm, levels(Descr_Stats7$Postterm)[c(3,1,2)])
levels(Descr_Stats7$Postterm)

Descr_Stats7$Multiple<-as.factor(Descr_Stats7$Multiple)
levels(Descr_Stats7$Multiple)
Descr_Stats7$Multiple<-factor(Descr_Stats7$Multiple, levels(Descr_Stats7$Multiple)[c(2,3,1)])
levels(Descr_Stats7$Multiple)


TrimVaxData2<-fread("P:/TrimVaxData2.csv")[,lapply(.SD, as.character)]


#date conversions
Descr_Stats7$patid.pregstart2<-as.Date(Descr_Stats7$patid.pregstart2)
Descr_Stats7$patid.pregend2<-as.Date(Descr_Stats7$patid.pregend2)


#subset stillbirths so can plot stillbirths by gestation days
Stillbirth_data <- Descr_Stats7[Descr_Stats7$PregOutcome == "Stillbirth", ]
hist(Stillbirth_data$GestDays)


#subset miscarriages so can plot miscarriages by gestation days
Miscarriage_data <- Descr_Stats7[Descr_Stats7$PregOutcome == "Miscarriage"]
hist(Miscarriage_data$GestDays)


#create column for baby's DOB
Descr_Stats7$babyDOB <- as.Date(paste(Descr_Stats7$patid.babyyob, Descr_Stats7$patid.babymob, 15, sep = "-"), format = "%Y-%m-%d")


#create column for 6 months post birth of baby
Descr_Stats7$SixMonthsPost<-Descr_Stats7$babyDOB + months(6)




#####################################HES extraction###########################################################



#read in HES episodes and hospitalisations
HESEpi<-fread("P:/20_000278_Type_2_request/GOLD_linked/Final/hes_diagnosis_epi_20_000278_DM.txt")
HESHosp<-fread("P:/20_000278_Type_2_request/GOLD_linked/Final/hes_diagnosis_hosp_20_000278_DM.txt")


#read in other HES data sets
HESEpi2<-fread("P:/20_000278_Type_2_request/GOLD_linked/Final/hes_episodes_20_000278_DM.txt")
HESHosp2<-fread("P:/20_000278_Type_2_request/GOLD_linked/Final/hes_hospital_20_000278_DM.txt")
HESPat<-fread("P:/20_000278_Type_2_request/GOLD_linked/Final/hes_patient_20_000278_DM.txt")
HESPrimDiag<-fread("P:/20_000278_Type_2_request/GOLD_linked/Final/hes_primary_diag_hosp_20_000278_DM.txt")
HESCritCare<-fread("P:/20_000278_Type_2_request/GOLD_linked/Final/hes_ccare_20_000278_DM.txt")


#read in respiratory illness codes
# Read the file and convert it to UTF-8
RespIllCodes <- fread("M:/Code lists/respcodes.csv")


#refine data for only those who had respiratory infections
RespIllCodesIDs<-RespIllCodes$code

HESEpiResp<-HESEpi[HESEpi$ICD %in% RespIllCodesIDs, ]
HESHospResp<-HESHosp[HESHosp$ICD %in% RespIllCodesIDs, ]
HESPrimDiagResp <- HESPrimDiag[HESPrimDiag$ICD_PRIMARY %in% RespIllCodesIDs, ]

#merges for HES data
#merge episodes
HESEpiMerge <- merge(HESEpiResp, HESEpi2, by = c("patid", "spno", "epikey"))
#merge hospitalisations
HESHospMerge <- merge(HESHospResp, HESHosp2, by = c("patid", "spno"))
#merge episodes and hospitalisations
HESEpiHosp <- merge(HESEpiMerge, HESHospMerge, by = c("patid", "spno"), all = T)
#merge with primary diagnosis
HESEpiHospPrim <- merge(HESEpiHosp, HESPrimDiagResp, by = c("patid", "spno"), all = T)
#merge with critical care
HESdata <- merge(HESEpiHospPrim, HESCritCare, by = c("patid", "spno", "epikey"), all = T)

#save data frame
fwrite(HESdata, paste("P:/HESdata.csv"))




######################read back in new merged HES data frame######################

HESdata<-fread("P:/HESdata.csv")



#subset that only has first episode
HESdata2 <- HESdata[HESdata$eorder == "1"]


#save data frame that only has first episode
fwrite(HESdata2, paste("P:/HESdata2.csv"))


#date conversions
HESdata2$EpiStart2 <- dmy(HESdata2$epistart.x)
HESdata2$EpiEnd2 <- dmy(HESdata2$epiend.x)
HESdata2$CritEpiStart <- dmy(HESdata2$epistart)
HESdata2$CritEpiStart <- dmy(HESdata2$epiend)
HESdata2$AdmitDate <- dmy(HESdata2$admidate)
HESdata2$DischargeDate <- dmy(HESdata2$discharged)


#events only within study period + 6 months
HESdata3 <- HESdata2[HESdata2$EpiStart2 >= "2011-04-01" & HESdata2$EpiStart2 <= "2020-09-30"]


#save data frame for only episodes within study period
fwrite(HESdata3, paste("P:/HESdata3.csv"))

#read back in HESdata3
HESdata3 <- fread("P:/HESdata3.csv")


#make column for HES event year
HESdata3$EventYear <- substr(HESdata3$EpiStart2, 1, 4)

#make binary column for if there was a critical care episode
HESdata3$CritCare <-  ifelse(!is.na(HESdata3$CritEpiStart), 1, 0)


#test with spread function
#HESwidetest <- spread(HESdata3, key = EventYear, value = AdmitDate) #error

# Create a new variable combining patid and EventYear
#HESdata3 <- HESdata3 %>%
 # mutate(patid_EventYear = paste(patid, EventYear, sep = "_"))

# Use spread on the new variable
#HESwidetest <- spread(HESdata3, key = patid_EventYear, value = AdmitDate) #error
#HESwidetest <- spread(HESdata3, key = patid, value = AdmitDate) #error






############merge descriptives with HES patient data####################################


#merge descriptive stats with hes patient data
HESPat$patid <- as.character(HESPat$patid)
Descr_Stats8 <- left_join(Descr_Stats7, HESPat, by = c("patid.patid" = "patid"))


#write csv
fwrite(Descr_Stats8, paste("P:/Descr_Stats8.csv"))




###########################read back in descriptives 8############################################

#read back in Descr_Stats8
Descr_Stats8<-fread("P:/Descr_Stats8.csv")


#recode ethnicity
Descr_Stats8$Ethnicity <- Descr_Stats8$gen_ethnicity
Descr_Stats8$Ethnicity[Descr_Stats8$Ethnicity == ""] <- NA


#reorder ethnicity
Descr_Stats8$Ethnicity<-as.factor(Descr_Stats8$Ethnicity)
levels(Descr_Stats8$Ethnicity)
Descr_Stats8$Ethnicity<-factor(Descr_Stats8$Ethnicity, levels(Descr_Stats8$Ethnicity)[c(12,3,2,4,6,10,1,8,5,7,9,11)])
levels(Descr_Stats8$Ethnicity)

#recode eventdate
Descr_Stats8$VaxDate <- Descr_Stats8$eventdate

#recode sex of baby
Descr_Stats8$SexBaby <- Descr_Stats8$patid.sexbaby
Descr_Stats8$SexBaby2[Descr_Stats8$SexBaby=="1"] <- "Male"
Descr_Stats8$SexBaby2[Descr_Stats8$SexBaby=="2"] <- "Female"



######################make small data frames with just the essentials #################################

#HES just with patid, admit date, duration, CC
HESessentials <- subset(HESdata3, select = c(patid, AdmitDate, epidur, CritCare))

#order episodes by chronology for each patid
HESessentials2 <- data.table(HESessentials) #%>% group_by(patid) %>% mutate(adminNo = row_number())
HESessentials2[, id:=order(AdmitDate), by = patid]

#take first row for each patid on a particular date
HESessentials3 <- HESessentials2[, .SD[1], by = .(patid, AdmitDate)]

#save csv for HESessentials
fwrite(HESessentials3, paste("P:/HESessentials3.csv"))

#read back in HES essentials
HESessentials3 <- fread("P:/HESessentials3.csv")


#long to wide
#HESwide <- dcast(setDT(HESessentials3)[], patid~id, value.var = "AdmitDate")



#create wide-format dataframes for each column
HESwide_AdmitDate <- dcast(setDT(HESessentials3)[], patid ~ id, value.var = "AdmitDate")
HESwide_epidur <- dcast(setDT(HESessentials3)[], patid ~ id, value.var = "epidur")
HESwide_CritCare <- dcast(setDT(HESessentials3)[], patid ~ id, value.var = "CritCare")

#merge them together based on patid
HESwide <- merge(HESwide_AdmitDate, HESwide_epidur, by = "patid", all = TRUE)
HESwide <- merge(HESwide, HESwide_CritCare, by = "patid", all = TRUE)


#convert fields to date for 2-46
HESwide[, 2:47] <- lapply(HESwide[, 2:47], as.Date, origin = "1970-01-01")


#save file
fwrite(HESwide, paste("P:/HESwide.csv"))
#read back in
HESwide <- fread("P:/HESwide.csv")


#create Descr Stats essentials
Descr_Stats9 <-subset(Descr_Stats8, select = c(patid.patid, pracid, patid.pregid, patid.mblbabies, patid.babypatid, patid.babymob, patid.babyyob, SexBaby, SexBaby2, patid.pregnumber, patid.totalpregs, patid.pregstart, SecTri, ThirdTri, patid.pregend, babyDOB, SixMonthsPost, patid.neocare, patid.wellbaby, patid.birweit, MumAge, Ethnicity, NumOfPregs, GestDays, PregOutcome, IMD, UrbanRural, Preterm, Postterm, Multiple, had_flu_vax_during_preg3, Tri_of_vax, VaxDate))

#save file
fwrite(Descr_Stats9, paste("P:/Descr_Stats9.csv"))

#test to see what happens if inclusion criteria changed to only include babies who are born within 30 days of mother's pregnancy end
#Baby_Descr_Stats2$Within30Days <- ifelse(abs(difftime(Baby_Descr_Stats2$babyDOB, Baby_Descr_Stats2$patid.pregend, units = "days")) <= 30, 1, 0)

#Baby_Descr_StatsTest <- Baby_Descr_Stats2[Baby_Descr_Stats2$Within30Days == 1, ]

#test for 60 days
#Baby_Descr_Stats2$Within60Days <- ifelse(abs(difftime(Baby_Descr_Stats2$babyDOB, Baby_Descr_Stats2$patid.pregend, units = "days")) <= 60, 1, 0)

#Baby_Descr_StatsTest2 <- Baby_Descr_Stats2[Baby_Descr_Stats2$Within60Days == 1, ]

#test for 90?
#Baby_Descr_Stats2$Within90Days <- ifelse(abs(difftime(Baby_Descr_Stats2$babyDOB, Baby_Descr_Stats2$patid.pregend, units = "days")) <= 90, 1, 0)

#Baby_Descr_StatsTest3 <- Baby_Descr_Stats2[Baby_Descr_Stats2$Within90Days == 1, ]


#test demographics
#table1(~Preterm + Postterm, data = Baby_Descr_Stats2)
#table1(~Preterm + Postterm, data = Baby_Descr_StatsTest)
#table1(~Preterm + Postterm, data = Baby_Descr_StatsTest2)
#table1(~Preterm + Postterm, data = Baby_Descr_StatsTest3)



######################read back in descriptive essentials############################################

Descr_Stats9<-fread("P:/Descr_Stats9.csv")

#recode multiple
Descr_Stats9$Multiple[Descr_Stats9$Multiple==""]<-"Missing (pregnancy loss)"


#merge HES and descriptives on patid
HESwide$patid <- as.character(HESwide$patid)
Descr_Stats9$patid.patid <- as.character(Descr_Stats9$patid.patid)
DescrHESmerge <- merge(Descr_Stats9, HESwide, by.x = "patid.patid", by.y = "patid", all.x = T)





str(HESessentials3)
str(HESwide)


#create binary for if HES episode occurred during pregnancy
#convert columns 34 to 79 to Date objects
for (i in 34:79) {
  DescrHESmerge[[i]] <- as.Date(DescrHESmerge[[i]])
}

#create a binary column to indicate if any date falls within the specified range
DescrHESmerge$HESduringPreg <- rowSums(sapply(34:79, function(i) {
  DescrHESmerge[[i]] >= DescrHESmerge$patid.pregstart & DescrHESmerge[[i]] <= DescrHESmerge$patid.pregend
}), na.rm = TRUE) > 0

#convert TRUE/FALSE to 1/0
DescrHESmerge$HESduringPreg <- as.integer(DescrHESmerge$HESduringPreg)

DescrHESmerge$HESduringPreg2 <- as.character(DescrHESmerge$HESduringPreg)
hist(DescrHESmerge$HESduringPreg)
table1(~HESduringPreg2, data = DescrHESmerge)






####################create subset for only women who had episode during pregnancy##########################
OnlyEpiDuringPreg <- DescrHESmerge[DescrHESmerge$HESduringPreg == 1, ]



#create admit date column
OnlyEpiDuringPreg$AdmitDate <- NA


#function to find the date between patid.pregstart and patid.pregend
find_date <- function(row) {
  # Find index of the first date that falls between patid.pregstart and patid.pregend
  date_index <- which(row[34:79] >= row["patid.pregstart"] & row[34:79] <= row["patid.pregend"])[1]
  # If date is found, return it, otherwise return NA
  if (!is.na(date_index)) {
    return(row[date_index + 33]) # +33 to adjust for column index
  } else {
    return(NA)
  }
}


#apply the function to each row of OnlyEpiDuringPreg data frame
OnlyEpiDuringPreg$AdmitDate <- apply(OnlyEpiDuringPreg, 1, find_date)


#merge duration and crit care
str(HESessentials3$patid)
HESessentials3$patid <- as.character(HESessentials3$patid)
str(OnlyEpiDuringPreg$patid.patid)
OnlyEpiDuringPreg$AdmitDate <- as.Date(OnlyEpiDuringPreg$AdmitDate)
HESessentials3$AdmitDate <- as.Date(HESessentials3$AdmitDate)

OnlyEpiDuringPreg2 <- merge(OnlyEpiDuringPreg, HESessentials3, by.x = c("patid.patid", "AdmitDate"), by.y = c("patid", "AdmitDate"), all.x = FALSE)

#save csv
fwrite(OnlyEpiDuringPreg2, paste("P:/OnlyEpiDuringPreg2.csv"))
#read back in
OnlyEpiDuringPreg2 <- fread("P:/OnlyEpiDuringPreg2.csv")

# Add a new column "NumEpi" to count the number of non-NA or non-empty values in columns 35 to 80
OnlyEpiDuringPreg2$NumEpi <- rowSums(
  apply(OnlyEpiDuringPreg2[, 35:80], 2, function(x) !is.na(x) & x != "")
)

table1(~NumEpi, data = OnlyEpiDuringPreg2)

#make column for if one or multiple HES admissions
OnlyEpiDuringPreg2$MultiEpi <- ifelse(OnlyEpiDuringPreg2$NumEpi > 1, "Yes", "No")
OnlyEpiDuringPreg2$MultiEpi <- factor(OnlyEpiDuringPreg2$MultiEpi, levels= c("Yes", "No"))

table1(~MultiEpi, data = OnlyEpiDuringPreg2)

#check for duplicate rows in the merged data frame
#duplicated_rows <- OnlyEpiDuringPreg2[duplicated(OnlyEpiDuringPreg2), ]

#added_rows <- anti_join(OnlyEpiDuringPreg2, OnlyEpiDuringPreg, by = c("patid.patid", "AdmitDate"))
#added_patids <- setdiff(OnlyEpiDuringPreg2$patid.patid, OnlyEpiDuringPreg$patid.patid)

#unique_patids_in_OnlyEpiDuringPreg <- unique(OnlyEpiDuringPreg$patid.patid)
#unique_patids_in_OnlyEpiDuringPreg2 <- unique(OnlyEpiDuringPreg2$patid.patid)

#length(unique_patids_in_OnlyEpiDuringPreg)
#length(unique_patids_in_OnlyEpiDuringPreg2)

#merged_data <- merge(OnlyEpiDuringPreg2, OnlyEpiDuringPreg, by = c("patid.patid", "AdmitDate"), all.x = TRUE)
#added_rows <- merged_data[is.na(merged_data$patid.patid.y), ]


#manually remove duplicate rows (keep first of each)
#rows_to_remove <- c(54, 57, 58, 59, 60, 61, 79, 156, 173, 174, 175, 182, 197, 198, 199, 239, 240, 241)
#OnlyEpiDuringPreg3 <- OnlyEpiDuringPreg2[-rows_to_remove, ]


#tables for duration and critical care
OnlyEpiDuringPreg2$CritCare <- as.character(OnlyEpiDuringPreg2$CritCare)
table1(~CritCare, data = OnlyEpiDuringPreg2)
table1(~epidur, data = OnlyEpiDuringPreg2)
hist(OnlyEpiDuringPreg2$epidur)




#####################make smaller dataset for only essentials#####################

#make essentials dataset for descriptives HES merge
DescrHESmerge2 <- subset(DescrHESmerge, select = c(patid.patid, pracid, patid.pregid, patid.mblbabies, patid.babypatid, patid.babymob, patid.babyyob, patid.pregnumber, patid.totalpregs, SexBaby, SexBaby2, patid.pregstart, SecTri, ThirdTri, patid.pregend, babyDOB, SixMonthsPost, patid.neocare, patid.wellbaby, patid.birweit, MumAge, Ethnicity, NumOfPregs, GestDays, PregOutcome, IMD, UrbanRural, Preterm, Postterm, Multiple, had_flu_vax_during_preg3, Tri_of_vax, VaxDate, HESduringPreg2))
#save data frame
fwrite(DescrHESmerge2, paste("P:/DescrHESmerge2.csv"))
#read back in
DescrHESmerge2 <- fread("P:/DescrHESmerge2.csv")

#make essentials for only those with episodes during pregnancy
OnlyEpiDuringPreg3 <- subset(OnlyEpiDuringPreg2, select = c(patid.patid, pracid, patid.pregid, patid.mblbabies, patid.babypatid, patid.babymob, patid.babyyob, patid.pregnumber, patid.totalpregs, SexBaby, SexBaby2, patid.pregstart, SecTri, ThirdTri, patid.pregend, babyDOB, SixMonthsPost, patid.neocare, patid.wellbaby, patid.birweit, MumAge, Ethnicity, NumOfPregs, GestDays, PregOutcome, IMD, UrbanRural, Preterm, Postterm, Multiple, had_flu_vax_during_preg3, Tri_of_vax, VaxDate, HESduringPreg2, epidur, CritCare, NumEpi, MultiEpi))
#save data drame
fwrite(OnlyEpiDuringPreg3, paste("P:/OnlyEpiDuringPreg3.csv"))
##read back in
OnlyEpiDuringPreg3 <- fread("P:/OnlyEpiDuringPreg3.csv")

#recode and reorder
DescrHESmerge2$PregOutcome <- factor(DescrHESmerge2$PregOutcome, levels = c("Live Birth", "Stillbirth","Live Birth and Stillbirth", "Miscarriage", "Termination of Pregnancy (TOP)", "Probable TOP", "Ectopic", "Molar", "Blighted Ovum", "Unspecified Loss", "Delivery Based on a 3rd Trimester Pregnancy Record", "Delivery Based on a Late Pregnancy Record", "Outcome Unknown"))
DescrHESmerge2$Ethnicity <- factor(DescrHESmerge2$Ethnicity, levels = c("White", "Bl_Carib", "Bl_Afric", "Bl_Other", "Indian", "Pakistani", "Bangladeshi", "Oth_Asian", "Chinese", "Mixed", "Other", "Unknown"))
DescrHESmerge2$IMD <- as.factor(DescrHESmerge2$IMD)
DescrHESmerge2$UrbanRural <- factor(DescrHESmerge2$UrbanRural, levels = c("Urban", "Rural"))
DescrHESmerge2$Preterm <- factor(DescrHESmerge2$Preterm, levels = c("Preterm", "No evidence of preterm", "Not Applicable (Outcome not a delivery)"))
DescrHESmerge2$Postterm <- factor(DescrHESmerge2$Postterm, levels = c("Post-term", "No evidence of post-term", "Not Applicable (Outcome not a delivery)"))
DescrHESmerge2$Multiple <- factor(DescrHESmerge2$Multiple, levels = c("Multiple pregnancy", "No evidence of multiple pregnancy", "Missing (pregnancy loss)"))
DescrHESmerge2$had_flu_vax_during_preg3 <- factor(DescrHESmerge2$had_flu_vax_during_preg3, levels = c("Yes", "No and Eligible"))
DescrHESmerge2$HESduringPreg2[DescrHESmerge2$HESduringPreg2=="0"] <- "No"
DescrHESmerge2$HESduringPreg2[DescrHESmerge2$HESduringPreg2=="1"] <- "Yes"
DescrHESmerge2$HESduringPreg2 <- factor(DescrHESmerge2$HESduringPreg2, levels = c("Yes", "No"))




OnlyEpiDuringPreg3$PregOutcome <- factor(OnlyEpiDuringPreg3$PregOutcome, levels = c("Live Birth", "Stillbirth","Live Birth and Stillbirth", "Miscarriage", "Termination of Pregnancy (TOP)", "Probable TOP", "Ectopic", "Molar", "Blighted Ovum", "Unspecified Loss", "Delivery Based on a 3rd Trimester Pregnancy Record", "Delivery Based on a Late Pregnancy Record", "Outcome Unknown"))
OnlyEpiDuringPreg3$Ethnicity <- factor(OnlyEpiDuringPreg3$Ethnicity, levels = c("White", "Bl_Carib", "Bl_Afric", "Bl_Other", "Indian", "Pakistani", "Bangladeshi", "Oth_Asian", "Chinese", "Mixed", "Other", "Unknown"))
OnlyEpiDuringPreg3$IMD <- as.factor(OnlyEpiDuringPreg3$IMD)
OnlyEpiDuringPreg3$UrbanRural <- factor(OnlyEpiDuringPreg3$UrbanRural, levels = c("Urban", "Rural"))
OnlyEpiDuringPreg3$Preterm <- factor(OnlyEpiDuringPreg3$Preterm, levels = c("Preterm", "No evidence of preterm", "Not Applicable (Outcome not a delivery)"))
OnlyEpiDuringPreg3$Postterm <- factor(OnlyEpiDuringPreg3$Postterm, levels = c("Post-term", "No evidence of post-term", "Not Applicable (Outcome not a delivery)"))
OnlyEpiDuringPreg3$Multiple <- factor(OnlyEpiDuringPreg3$Multiple, levels = c("Multiple pregnancy", "No evidence of multiple pregnancy", "Missing (pregnancy loss)"))
OnlyEpiDuringPreg3$had_flu_vax_during_preg3 <- factor(OnlyEpiDuringPreg3$had_flu_vax_during_preg3, levels = c("Yes", "No and Eligible"))
OnlyEpiDuringPreg3$HESduringPreg2[OnlyEpiDuringPreg3$HESduringPreg2=="0"] <- "No"
OnlyEpiDuringPreg3$HESduringPreg2[OnlyEpiDuringPreg3$HESduringPreg2=="1"] <- "Yes"
OnlyEpiDuringPreg3$HESduringPreg2 <- factor(OnlyEpiDuringPreg3$HESduringPreg2, levels = c("Yes", "No"))
OnlyEpiDuringPreg3$CritCare[OnlyEpiDuringPreg3$CritCare=="0"] <- "No"
OnlyEpiDuringPreg3$CritCare[OnlyEpiDuringPreg3$CritCare=="1"] <- "Yes"
OnlyEpiDuringPreg3$CritCare <- factor(OnlyEpiDuringPreg3$CritCare, levels = c("Yes", "No"))
OnlyEpiDuringPreg3$MultiEpi <- factor(OnlyEpiDuringPreg3$MultiEpi, levels= c("Yes", "No"))




#tables
table1(~HESduringPreg2, data = DescrHESmerge2)
table1(~ MumAge + Ethnicity + NumOfPregs + GestDays + PregOutcome + IMD + UrbanRural + Preterm + Postterm + Multiple + had_flu_vax_during_preg3 + HESduringPreg2, data = DescrHESmerge2)
table1(~ MumAge + Ethnicity + NumOfPregs + GestDays + PregOutcome + IMD + UrbanRural + Preterm + Postterm + Multiple + had_flu_vax_during_preg3 + epidur + CritCare, data = OnlyEpiDuringPreg3)
table1(~ MumAge + Ethnicity + NumOfPregs + GestDays + PregOutcome + IMD + UrbanRural + Preterm + Postterm + Multiple + HESduringPreg2 | had_flu_vax_during_preg3, data = DescrHESmerge2)
table1(~ MumAge + Ethnicity + NumOfPregs + GestDays + PregOutcome + IMD + UrbanRural + Preterm + Postterm + Multiple + epidur + CritCare | had_flu_vax_during_preg3, data = OnlyEpiDuringPreg3)
table1(~MumAge + Ethnicity + IMD + UrbanRural + patid.totalpregs | had_flu_vax_during_preg3, data = DescrHESmerge2)
table1(~PregOutcome | had_flu_vax_during_preg3, data = DescrHESmerge2)
table1( ~ HESduringPreg2 | had_flu_vax_during_preg3, data = DescrHESmerge2)
table1(~ epidur + CritCare | had_flu_vax_during_preg3, data = OnlyEpiDuringPreg3)
table1(~epidur + CritCare + MultiEpi + NumEpi | had_flu_vax_during_preg3, data = OnlyEpiDuringPreg3)
hist(OnlyEpiDuringPreg3$NumEpi)

# Create the VaxPriorPreg column
DescrHESmerge2$VaxPriorPreg <- ifelse(DescrHESmerge2$VaxDate < DescrHESmerge2$patid.pregstart, 1, 0)



#####################subset babies############################################################################
Baby_Descr_Stats <- subset(Descr_Stats9, !is.na(patid.babypatid))
Baby_Descr_Stats2 <- subset(Baby_Descr_Stats, select = c(patid.patid, pracid, patid.pregid, patid.babypatid, patid.babymob, patid.babyyob, patid.pregnumber, patid.totalpregs, patid.pregstart, patid.pregend, babyDOB, SexBaby, SexBaby2, SixMonthsPost, patid.neocare, patid.wellbaby, patid.birweit, GestDays, IMD, UrbanRural, Preterm, Postterm, Multiple, had_flu_vax_during_preg3, Tri_of_vax, VaxDate))

#only include babies who's date of birth occurs within 60 days of mother's end of pregnancy
#Baby_Descr_Stats2$Within60Days <- ifelse(abs(difftime(Baby_Descr_Stats2$babyDOB, Baby_Descr_Stats2$patid.pregend, units = "days")) <= 60, 1, 0)

#Baby_Descr_Stats3 <- Baby_Descr_Stats2[Baby_Descr_Stats2$Within60Days == 1, ]


#recode and reorder
Baby_Descr_Stats2$BirthWeight <- NA
Baby_Descr_Stats2$BirthWeight <- Baby_Descr_Stats2$patid.birweit
Baby_Descr_Stats2$NeoCare <- NA
Baby_Descr_Stats2$NeoCare[Baby_Descr_Stats2$patid.neocare=="0"] <- "Normal Care"
Baby_Descr_Stats2$NeoCare[Baby_Descr_Stats2$patid.neocare=="1"] <- "Special Care"
Baby_Descr_Stats2$NeoCare[Baby_Descr_Stats2$patid.neocare=="2"] <- "Level 2 Intensive Care (high dependency intensive care)"
Baby_Descr_Stats2$NeoCare[Baby_Descr_Stats2$patid.neocare=="3"] <- "Level 1 Intensive Care (maximal intensive care"
Baby_Descr_Stats2$NeoCare[Baby_Descr_Stats2$patid.neocare=="8"] <- "Not Applicable"
Baby_Descr_Stats2$NeoCare[Baby_Descr_Stats2$patid.neocare=="9"] <- "Not Known"
Baby_Descr_Stats2$NeoCare <- factor(Baby_Descr_Stats2$NeoCare, levels = c("Normal Care", "Special Care", "Level 2 Intensive Care (high dependency intensive care)", "Level 1 Intensive Care (maximal intensive care", "Not Applicable", "Not Known"))
Baby_Descr_Stats2$WellBaby <- NA
Baby_Descr_Stats2$WellBaby <- Baby_Descr_Stats2$patid.wellbaby
Baby_Descr_Stats2$WellBaby[Baby_Descr_Stats2$WellBaby=="Y"] <- "Yes"
Baby_Descr_Stats2$WellBaby[Baby_Descr_Stats2$WellBaby=="N"] <- "No"
Baby_Descr_Stats2$WellBaby[Baby_Descr_Stats2$WellBaby==""] <- "Missing"
Baby_Descr_Stats2$WellBaby <- factor(Baby_Descr_Stats2$WellBaby, levels = c("Yes", "No", "Missing"))
Baby_Descr_Stats2$IMD <- as.character(Baby_Descr_Stats2$IMD)
Baby_Descr_Stats2$UrbanRural[Baby_Descr_Stats2$UrbanRural==""] <- "Missing"
Baby_Descr_Stats2$UrbanRural <- factor(Baby_Descr_Stats2$UrbanRural, levels = c("Urban", "Rural", "Missing"))
Baby_Descr_Stats2$had_flu_vax_during_preg3 <- factor(Baby_Descr_Stats2$had_flu_vax_during_preg3, levels = c("Yes", "No and Eligible"))

#save file
fwrite(Baby_Descr_Stats2, paste("P:/Baby_Descr_Stats2.csv"))
#read back in
Baby_Descr_Stats2 <- fread("P:/Baby_Descr_Stats2.csv")



#merge with HES
HESwide$patid <- as.character(HESwide$patid)
Baby_Descr_Stats2$patid.babypatid <- as.character(Baby_Descr_Stats2$patid.babypatid)
BabyHESmerge <- merge(Baby_Descr_Stats2, HESwide, by.x = "patid.babypatid", by.y = "patid", all.x = T)

BabyHESmerge$patid.pregstart<-as.Date(BabyHESmerge$patid.pregstart)
BabyHESmerge$patid.pregend<-as.Date(BabyHESmerge$patid.pregend)
BabyHESmerge$SixMonthsPost<-as.Date(BabyHESmerge$SixMonthsPost)

#save file
fwrite(BabyHESmerge, paste("P:/BabyHESmerge.csv"))
#read back in
BabyHESmerge <- fread("P:/BabyHESmerge.csv")


#create binary for if HES episode occurred during 6 months post birth
#convert columns 30 to 75 to Date objects
for (i in 30:75) {
  BabyHESmerge[[i]] <- as.Date(BabyHESmerge[[i]], format = "%Y-%m-%d")
}

#ensure patid.pregend, babyDOB, and SixMonthsPost are Date objects
BabyHESmerge$patid.pregend <- as.Date(BabyHESmerge$patid.pregend, format = "%Y-%m-%d")
BabyHESmerge$babyDOB <- as.Date(BabyHESmerge$babyDOB, format = "%Y-%m-%d")
BabyHESmerge$SixMonthsPost <- as.Date(BabyHESmerge$SixMonthsPost, format = "%Y-%m-%d")

#create the function to check the condition
check_dates_within_range <- function(row) {
  #get the pregend and SixMonthsPost dates
  babyDOB <- row["babyDOB"]
  sixmonthspost <- row["SixMonthsPost"]
  
  #check if any date in columns 30 to 75 falls within the specified range
  any_dates_in_range <- any(row[30:75] >= babyDOB & row[30:75] <= sixmonthspost, na.rm = TRUE)
  
  #return 1 if any date is within the range, otherwise 0
  return(as.integer(any_dates_in_range))
}

#apply the function to each row of BabyHESmerge data frame
BabyHESmerge$BabyHESPost <- apply(BabyHESmerge, 1, check_dates_within_range)
#convert to factor
BabyHESmerge$BabyHESPost <- as.factor(BabyHESmerge$BabyHESPost)



#recode and reorder
BabyHESmerge$BabyHESPost2[BabyHESmerge$BabyHESPost=="0"] <- "No"
BabyHESmerge$BabyHESPost2[BabyHESmerge$BabyHESPost=="1"] <- "Yes"
BabyHESmerge$BabyHESPost2 <- factor(BabyHESmerge$BabyHESPost2, levels = c("Yes", "No"))


table1(~BabyHESPost2, data = BabyHESmerge)



#tables
table1(~ GestDays + IMD + UrbanRural + NeoCare + WellBaby + BirthWeight, data = Baby_Descr_Stats2)
table1(~ GestDays + IMD + UrbanRural + NeoCare + WellBaby + BirthWeight | had_flu_vax_during_preg3, Baby_Descr_Stats2)
table1(~ patid.birweit | HESduringPreg2, data = DescrHESmerge2)


###############################subset only babies with HES episodes#################################
OnlyBabiesWithEpi <- BabyHESmerge[BabyHESmerge$BabyHESPost2 == "Yes", ]

#recode birth weight
OnlyBabiesWithEpi$BirthWeight <- as.integer(OnlyBabiesWithEpi$BirthWeight)


#find admit date for HES episode
#create admit date column
OnlyBabiesWithEpi$AdmitDate <- NA

#function to find the date between baby DOB and SixMonthsPost
find_date <- function(row) {
    #find index of the first date that falls between birth and SixMonthsPost
    date_index <- which(row[30:75] >= row["babyDOB"] & row[30:75] <= row["SixMonthsPost"])[1]
    #if date is found, return it, otherwise return NA
    if (!is.na(date_index)) {
      return(row[date_index + 29]) # +29 to adjust for column index
    } else {
      return(NA)
    }
}

#apply function to OnlyBabiesWithEpi
OnlyBabiesWithEpi$AdmitDate <- apply(OnlyBabiesWithEpi, 1, find_date)


#merge duration and crit care
str(HESessentials3$patid)
HESessentials3$patid <- as.character(HESessentials3$patid)
str(OnlyBabiesWithEpi$patid.babypatid)
OnlyBabiesWithEpi$patid.babypatid <- as.character(OnlyBabiesWithEpi$patid.babypatid)
OnlyBabiesWithEpi$AdmitDate <- as.Date(OnlyBabiesWithEpi$AdmitDate)
HESessentials3$AdmitDate <- as.Date(HESessentials3$AdmitDate)


OnlyBabiesWithEpi2 <- merge(OnlyBabiesWithEpi, HESessentials3, by.x = c("patid.babypatid", "AdmitDate"), by.y = c("patid", "AdmitDate"), all.x = FALSE)



#############################make smaller dataset for only BabyHES essentials##################################

OnlyBabiesWithEpi3 <- subset(OnlyBabiesWithEpi2, select = c(patid.babypatid, pracid, patid.babymob, patid.babyyob, patid.pregnumber, patid.totalpregs, patid.pregstart, patid.pregend, babyDOB, SexBaby, SexBaby2, SixMonthsPost, GestDays, IMD, UrbanRural, had_flu_vax_during_preg3, Tri_of_vax, VaxDate, BirthWeight, NeoCare, WellBaby, BabyHESPost2, epidur, CritCare))


#recode and reorder
OnlyBabiesWithEpi3$CritCare[OnlyBabiesWithEpi3$CritCare=="0"] <- "No"
OnlyBabiesWithEpi3$CritCare[OnlyBabiesWithEpi3$CritCare=="1"] <- "Yes"
OnlyBabiesWithEpi3$CritCare <- factor(OnlyBabiesWithEpi3$CritCare, levels = c("Yes", "No"))


#save file
fwrite(OnlyBabiesWithEpi3, paste("P:/OnlyBabiesWithEpi3.csv"))
#read back in
OnlyBabiesWithEpi3 <- fread("P:/OnlyBabiesWithEpi3.csv")



#tables
table1(~BabyHESPost2, data = BabyHESmerge)
table1(~ GestDays + IMD + UrbanRural + NeoCare + WellBaby + BirthWeight, data = Baby_Descr_Stats2)
table1(~ GestDays + IMD + UrbanRural + NeoCare + WellBaby + BirthWeight + had_flu_vax_during_preg3 + BabyHESPost2, data = BabyHESmerge)
table1(~ GestDays + IMD + UrbanRural + NeoCare + WellBaby + BirthWeight + epidur + CritCare, data = OnlyBabiesWithEpi3)
table1(~ GestDays + IMD + UrbanRural + NeoCare + WellBaby + BirthWeight | had_flu_vax_during_preg3, Baby_Descr_Stats2)
table1(~ GestDays + IMD + UrbanRural + NeoCare + WellBaby + BirthWeight + BabyHESPost2 | had_flu_vax_during_preg3, BabyHESmerge)
table1(~ GestDays + IMD + UrbanRural + NeoCare + WellBaby + BirthWeight + epidur + CritCare | had_flu_vax_during_preg3, OnlyBabiesWithEpi3)

BabyHESmerge4$IMD <- as.factor(BabyHESmerge4$IMD)

#tables from BabyHESmerge4
table1(~BabyHESPost2, data = BabyHESmerge4)
table1(~ GestDays + IMD + UrbanRural + NeoCare + WellBaby + BirthWeight, data = BabyHESmerge4)
table1(~ GestDays + IMD + UrbanRural + NeoCare + WellBaby + BirthWeight + had_flu_vax_during_preg3 + BabyHESPost2, data = BabyHESmerge4)
table1(~ GestDays + IMD + UrbanRural + NeoCare + WellBaby + BirthWeight + epidur + CritCare, data = OnlyBabiesWithEpi3)
table1(~ GestDays + IMD + UrbanRural + NeoCare + WellBaby + BirthWeight | had_flu_vax_during_preg3, BabyHESmerge4)
table1(~ GestDays + IMD + UrbanRural + NeoCare + WellBaby + BirthWeight + BabyHESPost2 | had_flu_vax_during_preg3, BabyHESmerge4)
table1(~ GestDays + IMD + UrbanRural + NeoCare + WellBaby + BirthWeight + epidur + CritCare | had_flu_vax_during_preg3, OnlyBabiesWithEpi3)

table1(~ GestDays + IMD + UrbanRural + BirthWeight | had_flu_vax_during_preg3, data = BabyHESmerge4)
table1(~ epidur + CritCare + SexBaby2 | had_flu_vax_during_preg3, OnlyBabiesWithEpi3)

table1(~patid.totalpregs | had_flu_vax_during_preg3, data = DescrHESmerge2)


#################################survival analysis#######################################################

#test
#BabyHESmerge$babyDOB <- as.Date(paste(BabyHESmerge$patid.babyyob, BabyHESmerge$patid.babymob, 15, sep = "-"), format = "%Y-%m-%d")

#BabyHESmerge$Within30Days <- ifelse(abs(difftime(BabyHESmerge$babyDOB, BabyHESmerge$patid.pregend, units = "days")) <= 30, 1, 0)

#BabyHESTest <- BabyHESmerge[BabyHESmerge$Within30Days == 1, ]
#BabyHESTest_WO <- BabyHESmerge[BabyHESmerge$Within30Days == 0, ]

#test for 60 days
#BabyHESmerge$Within60Days <- ifelse(abs(difftime(BabyHESmerge$babyDOB, BabyHESmerge$patid.pregend, units = "days")) <= 60, 1, 0)

#BabyHESTest2 <- BabyHESmerge[BabyHESmerge$Within60Days == 1, ]

#test for 90?
#BabyHESmerge$Within90Days <- ifelse(abs(difftime(BabyHESmerge$babyDOB, BabyHESmerge$patid.pregend, units = "days")) <= 90, 1, 0)

#BabyHESTest3 <- BabyHESmerge[BabyHESmerge$Within90Days == 1, ]


#table1(~had_flu_vax_during_preg3 + BabyHESPost2, data = BabyHESmerge)
#table1(~had_flu_vax_during_preg3 + BabyHESPost2, data = BabyHESTest)
#table1(~had_flu_vax_during_preg3 + BabyHESPost2, data = BabyHESTest2)
#table1(~had_flu_vax_during_preg3 + BabyHESPost2, data = BabyHESTest3)

#table1(~had_flu_vax_during_preg3 + BabyHESPost2, data = BabyHESTest_WO)


#BabyHESTest_WO$babyDOB <- as.Date(BabyHESTest_WO$babyDOB, format = "%Y-%m-%d")
#BabyHESTest_WO$Month <- month(BabyHESTest_WO$babyDOB)
#BabyHESTest_WO$Day <- day(BabyHESTest_WO$babyDOB)

#June15babies <- (BabyHESTest_WO[BabyHESTest_WO$Month == 6 & BabyHESTest_WO$Day == 15, ])


#add in admit date column
BabyHESmerge$AdmitDate <- NA

#function to find the date between baby DOB and SixMonthsPost
find_date2 <- function(row) {
  #find index of the first date that falls between birth and SixMonthsPost
  date_index <- which(row[30:75] >= row["babyDOB"] & row[30:75] <= row["SixMonthsPost"])[1]
  #if date is found, return it, otherwise return NA
  if (!is.na(date_index)) {
    return(row[date_index + 29]) # +29 to adjust for column index
  } else {
    return(NA)
  }
}

#apply function to OnlyBabiesWithEpi
BabyHESmerge$AdmitDate <- apply(BabyHESmerge, 1, find_date2)



#create BabyHESmerge dataset with only essentials
BabyHESmerge2 <- subset(BabyHESmerge, select = c(patid.babypatid, pracid, patid.pregid, patid.babymob, patid.babyyob, patid.pregnumber, patid.totalpregs, patid.pregstart, patid.pregend, babyDOB, SexBaby, SexBaby2, SixMonthsPost, GestDays, IMD, UrbanRural, Preterm, Postterm, Multiple, had_flu_vax_during_preg3, Tri_of_vax, VaxDate, BirthWeight, NeoCare, WellBaby, BabyHESPost, BabyHESPost2, AdmitDate))

#save file
fwrite(BabyHESmerge2, paste("P:/BabyHESmerge2.csv"))
#read back in
BabyHESmerge2 <- fread("P:/BabyHESmerge2.csv")


#date conversions
BabyHESmerge2$babyDOB <- as.Date(BabyHESmerge2$babyDOB)
BabyHESmerge2$SixMonthsPost <- as.Date(BabyHESmerge2$SixMonthsPost)
BabyHESmerge2$patid.pregstart <- as.Date(BabyHESmerge2$patid.pregstart)
BabyHESmerge2$patid.pregend <- as.Date(BabyHESmerge2$patid.pregend)
BabyHESmerge2$AdmitDate <- as.Date(BabyHESmerge2$AdmitDate)


#create column for censor date
BabyHESmerge2$CensorDate <- BabyHESmerge2$SixMonthsPost

#read in practice data
patients <- fread("P:/FLUVUE/Data Import/patientsNEW.csv")
pregnancy <- fread("P:/FLUVUE/Data Import/preg_clean.csv")
practice <- fread("P:/FLUVUE/Data Import/practice.csv")


#change lcd to date
practice$lcd2 <- as.Date(practice$lcd, format = "%d/%m/%Y")
patients$tod2 <- as.Date(patients$tod, format = "%d/%m/%Y")


#merge in lcd
BabyHESmerge3 <- merge(BabyHESmerge2, practice, by.x = "pracid", by.y = "pracid", all.x = TRUE)
#merge in tod
BabyHESmerge3$patid.babypatid <- as.character(BabyHESmerge3$patid.babypatid)
patients$patid <- as.character(patients$patid)
BabyHESmerge4 <- merge(BabyHESmerge3, patients, by.x = "patid.babypatid", by.y = "patid", all.x = TRUE)


#fix sex columns
BabyHESmerge4$SexBaby <- BabyHESmerge4$gender
BabyHESmerge4$SexBaby2[BabyHESmerge4$SexBaby == "1"] <- "Male"
BabyHESmerge4$SexBaby2[BabyHESmerge4$SexBaby == "2"] <- "Female"


#populate censor date with dates for lcd, tod, and HES Admit Date
BabyHESmerge4$CensorDate2 <- BabyHESmerge4$CensorDate

BabyHESmerge4 <- BabyHESmerge4 %>%
  mutate(CensorDate2 = if_else(!is.na(lcd2) & lcd2 >= babyDOB & lcd2 <= SixMonthsPost, lcd2, CensorDate2))

BabyHESmerge4$CensorDate3 <- BabyHESmerge4$CensorDate2

BabyHESmerge4 <- BabyHESmerge4 %>%
  mutate(CensorDate3 = if_else(!is.na(tod2) & tod2 >= babyDOB & tod2 <= SixMonthsPost, tod2, CensorDate3))

BabyHESmerge4$CensorDate4 <- BabyHESmerge4$CensorDate3

BabyHESmerge4 <- BabyHESmerge4 %>%
  mutate(CensorDate4 = ifelse(!is.na(AdmitDate) & AdmitDate >= babyDOB & AdmitDate <= SixMonthsPost, AdmitDate,
  CensorDate4))
BabyHESmerge4$CensorDate4 <- as.Date(BabyHESmerge4$CensorDate4, origin = "1970-01-01")


#create baby dob column
#BabyHESmerge3$DOB <- NA
#BabyHESmerge3$DOB <- as.Date(paste(BabyHESmerge3$patid.babyyob, BabyHESmerge3$patid.babymob, 15, sep = "-"), format = "%Y-%m-%d")


#create PersonTime column which is populated by number of days from DOB to censor date
#birthdate + 183
##hesdate - birthdate if hes = 1

BabyHESmerge4 <- BabyHESmerge4 %>%
  mutate(PersonTime = as.integer(difftime(CensorDate4, babyDOB, units = "days")))

#create smaller dataset of essentials
#BabyHESmerge4 <- subset(BabyHESmerge3, select = c(patid.babypatid, pracid, patid.patid, patid.pregid, patid.babymob, patid.babyyob, patid.pregstart, patid.pregend, SixMonthsPost, GestDays, IMD, UrbanRural, had_flu_vax_during_preg3, Tri_of_vax, VaxDate, BirthWeight, gender, NeoCare, WellBaby, BabyHESPost, BabyHESPost2, CensorDate, lcd2, tod2, CensorDate2, CensorDate3, DOB, PersonTime))



#save file
fwrite(BabyHESmerge4, paste("P:/BabyHESmerge4.csv"))
#read back in
BabyHESmerge4 <- fread("P:/BabyHESmerge4.csv")

#date conversions
BabyHESmerge4$babyDOB <- as.Date(BabyHESmerge4$babyDOB)
BabyHESmerge4$SixMonthsPost <- as.Date(BabyHESmerge4$SixMonthsPost)
BabyHESmerge4$patid.pregstart <- as.Date(BabyHESmerge4$patid.pregstart)
BabyHESmerge4$patid.pregend <- as.Date(BabyHESmerge4$patid.pregend)
BabyHESmerge4$AdmitDate <- as.Date(BabyHESmerge4$AdmitDate)
BabyHESmerge4$CensorDate4 <- as.Date(BabyHESmerge4$CensorDate4)


#create survival object
#install.packages("survival")


#combine parity variables
BabyHESmerge4$totalpregs[BabyHESmerge4$patid.totalpregs=="1"]<-"1"
BabyHESmerge4$totalpregs[BabyHESmerge4$patid.totalpregs=="2"]<-"2"
BabyHESmerge4$totalpregs[BabyHESmerge4$patid.totalpregs=="3"]<-"3"
BabyHESmerge4$totalpregs[BabyHESmerge4$patid.totalpregs=="4"]<-"4"
BabyHESmerge4$totalpregs <- ifelse(BabyHESmerge4$patid.totalpregs >= 5, "5+", BabyHESmerge4$patid.totalpregs)


#remove missing urban rural 
BabyHESmerge4 <- BabyHESmerge4[BabyHESmerge4$UrbanRural != "Missing", ]
DescrHESmerge2 <- DescrHESmerge2[DescrHESmerge2$UrbanRural != "Missing", ]

#combine pregnancy outcomes to make less variables
table1(~PregOutcome, data = DescrHESmerge2)

DescrHESmerge2$PregOutcome2 <- NA
DescrHESmerge2$PregOutcome2 <- as.character(DescrHESmerge2$PregOutcome2)
DescrHESmerge2$PregOutcome2[DescrHESmerge2$PregOutcome=="Live Birth"]<-"Live Birth"
DescrHESmerge2$PregOutcome2[DescrHESmerge2$PregOutcome=="Stillbirth"]<-"Stillbirth"
DescrHESmerge2$PregOutcome2[DescrHESmerge2$PregOutcome=="Live Birth and Stillbirth"]<-"Live Birth and Stillbirth"
DescrHESmerge2$PregOutcome2[DescrHESmerge2$PregOutcome=="Miscarriage"]<-"Loss of Pregnancy"
DescrHESmerge2$PregOutcome2[DescrHESmerge2$PregOutcome=="Ectopic"]<-"Loss of Pregnancy"
DescrHESmerge2$PregOutcome2[DescrHESmerge2$PregOutcome=="Molar"]<-"Loss of Pregnancy"
DescrHESmerge2$PregOutcome2[DescrHESmerge2$PregOutcome=="Blighted Ovum"]<-"Loss of Pregnancy"
DescrHESmerge2$PregOutcome2[DescrHESmerge2$PregOutcome=="Unspecified Loss"]<-"Loss of Pregnancy"
DescrHESmerge2$PregOutcome2[DescrHESmerge2$PregOutcome=="Termination of Pregnancy (TOP)"]<-"Termination/Probable Termination of Pregnancy (TOP)"
DescrHESmerge2$PregOutcome2[DescrHESmerge2$PregOutcome=="Probable TOP"]<-"Termination/Probable Termination of Pregnancy (TOP)"
DescrHESmerge2$PregOutcome2[DescrHESmerge2$PregOutcome=="Delivery Based on a 3rd Trimester Pregnancy Record"]<-"Delivery Based on a 3rd Trimester Pregnancy Record"
DescrHESmerge2$PregOutcome2[DescrHESmerge2$PregOutcome=="Delivery Based on a Late Pregnancy Record"]<-"Delivery Based on a Late Pregnancy Record"

#reorder
DescrHESmerge2$PregOutcome2 <- factor(DescrHESmerge2$PregOutcome2, levels = c("Live Birth", "Stillbirth", "Live Birth and Stillbirth", "Loss of Pregnancy", "Termination/Probable Termination of Pregnancy (TOP)", "Delivery Based on a 3rd Trimester Pregnancy Record", "Delivery Based on a Late Pregnancy Record"))

table1(~PregOutcome2, data = DescrHESmerge2)

table1(~totalpregs, data = BabyHESmerge4)

table1(~Tri_of_vax, data = BabyHESmerge4)


#recode IMD for clarity
DescrHESmerge2$IMD2[DescrHESmerge2$IMD=="1"]<- "IMD quintile 1 - Least Deprived"
DescrHESmerge2$IMD2[DescrHESmerge2$IMD=="2"]<- "IMD quintile 2"
DescrHESmerge2$IMD2[DescrHESmerge2$IMD=="3"]<- "IMD quintile 3"
DescrHESmerge2$IMD2[DescrHESmerge2$IMD=="4"]<- "IMD quintile 4"
DescrHESmerge2$IMD2[DescrHESmerge2$IMD=="5"]<- "IMD quintile 5 - Most Deprived"

table1(~IMD2, data = DescrHESmerge2)


#trimester of vax
OnlyVaxMums <- DescrHESmerge2[DescrHESmerge2$had_flu_vax_during_preg3 == "Yes", ]
OnlyVaxMums$Tri_of_vax[OnlyVaxMums$Tri_of_vax == ""] <- "Missing"
OnlyVaxMums$Tri_of_vax <- factor(OnlyVaxMums$Tri_of_vax, levels = c("First Trimester Vaccination","Second Trimester Vaccination", "Third Trimester Vaccination"))
table1(~Tri_of_vax, data = OnlyVaxMums)



############################co-morbidities############################

#extraction clinical

#ext1
ext1clin1 <- fread("P:/CPRD_mother_baby_GOLD/ext1/Clinical/ext1_Extract_Clinical_001.txt")
ext1clin2 <- fread("P:/CPRD_mother_baby_GOLD/ext1/Clinical/ext1_Extract_Clinical_002.txt")
ext1clin3 <- fread("P:/CPRD_mother_baby_GOLD/ext1/Clinical/ext1_Extract_Clinical_003.txt")
ext1clin4 <- fread("P:/CPRD_mother_baby_GOLD/ext1/Clinical/ext1_Extract_Clinical_004.txt")
ext1clin5 <- fread("P:/CPRD_mother_baby_GOLD/ext1/Clinical/ext1_Extract_Clinical_005.txt")
ext1clin6 <- fread("P:/CPRD_mother_baby_GOLD/ext1/Clinical/ext1_Extract_Clinical_006.txt")
ext1clin7 <- fread("P:/CPRD_mother_baby_GOLD/ext1/Clinical/ext1_Extract_Clinical_007.txt")
ext1clin8 <- fread("P:/CPRD_mother_baby_GOLD/ext1/Clinical/ext1_Extract_Clinical_008.txt")
ext1clin9 <- fread("P:/CPRD_mother_baby_GOLD/ext1/Clinical/ext1_Extract_Clinical_009.txt")
ext1clin10 <- fread("P:/CPRD_mother_baby_GOLD/ext1/Clinical/ext1_Extract_Clinical_010.txt")
ext1clin11 <- fread("P:/CPRD_mother_baby_GOLD/ext1/Clinical/ext1_Extract_Clinical_011.txt")

ext1clin <- rbindlist(list(ext1clin1, ext1clin2, ext1clin3, ext1clin4, ext1clin5, ext1clin6, ext1clin7, ext1clin8, ext1clin9, ext1clin10, ext1clin11), use.names = TRUE, fill = TRUE)

#resp ext1
ext1clinRESP<-subset(ext1clin, medcode=="10461"|	medcode=="96578"|	medcode=="93713"|	medcode=="73743"|	medcode=="38011"|	medcode=="15693"|	medcode=="65117"|	medcode=="100742"|	medcode=="33980"|	medcode=="58841"|	medcode=="93380"|	medcode=="29966"|	medcode=="6220"|	medcode=="65344"|	medcode=="69017"|	medcode=="18914"|	medcode=="18905"|	medcode=="100610"|	medcode=="103224"|	medcode=="110454"|	medcode=="102922"|	medcode=="106432"|	medcode=="73065"|	medcode=="49770"|	medcode=="1001"|	medcode=="148"|	medcode=="152"|	medcode=="3480"|	medcode=="3243"|	medcode=="25603"|	medcode=="15626"|	medcode=="61118"|	medcode=="11150"|	medcode=="40159"|	medcode=="37959"|	medcode=="61513"|	medcode=="27819"|	medcode=="5798"|	medcode=="14798"|	medcode=="1446"|	medcode=="26125"|	medcode=="44525"|	medcode=="24248"|	medcode=="66043"|	medcode=="45089"|	medcode=="68066"|	medcode=="15157"|	medcode=="794"|	medcode=="26306"|	medcode=="56860"|	medcode=="68662"|	medcode=="60188"|	medcode=="99536"|	medcode=="23492"|	medcode=="46578"|	medcode=="10980"|	medcode=="40788"|	medcode=="92955"|	medcode=="70787"|	medcode=="63479"|	medcode=="16410"|	medcode=="33450"|	medcode=="106805"|	medcode=="2195"|	medcode=="20364"|	medcode=="41491"|	medcode=="32679"|	medcode=="10863"|	medcode=="10802"|	medcode=="9876"|	medcode=="93568"|	medcode=="104608"|	medcode=="12166"|	medcode=="21061"|	medcode=="7884"|	medcode=="5710"|	medcode=="19492"|	medcode=="8303"|	medcode=="51410"|	medcode=="46460"|	medcode=="60805"|	medcode=="62233"|	medcode=="71853"|	medcode=="89206"|	medcode=="23446"|	medcode=="65376"|	medcode=="94894"|	medcode=="49194"|	medcode=="94575"|	medcode=="30235"|	medcode=="93577"|	medcode=="23461"|	medcode=="37365"|	medcode=="26442"|	medcode=="31423"|	medcode=="63172"|	medcode=="54830"|	medcode=="49025"|	medcode=="55758"|	medcode=="62227"|	medcode=="47142"|	medcode=="64721"|	medcode=="63216"|	medcode=="47782"|	medcode=="70815"|	medcode=="104557"|	medcode=="9711"|	medcode=="3847"|	medcode=="41781"|	medcode=="59083"|	medcode=="66104"|	medcode=="45948"|	medcode=="33837"|	medcode=="56647"|	medcode=="41015"|	medcode=="66773"|	medcode=="50876"|	medcode=="47504"|	medcode=="54252"|	medcode=="46066"|	medcode=="43285"|	medcode=="18130"|	medcode=="69914"|	medcode=="22536"|	medcode=="50374"|	medcode=="44015"|	medcode=="53205"|	medcode=="43417"|	medcode=="30214"|	medcode=="38297"|	medcode=="46405"|	medcode=="26082"|	medcode=="7321"|	medcode=="61229"|	medcode=="7791"|	medcode=="31806"|	medcode=="61119"|	medcode=="27348"|	medcode=="68814"|	medcode=="6837"|	medcode=="94136"|	medcode=="6051"|	medcode=="103472"|	medcode=="103559"|	medcode=="28229"|	medcode=="22835"|	medcode=="54308"|	medcode=="61991"|	medcode=="33830"|	medcode=="15815"|	medcode=="64799"|	medcode=="94996"|	medcode=="58791"|	medcode=="54010"|	medcode=="42940"|	medcode=="3859"|	medcode=="47364"|	medcode=="31564"|	medcode=="96655"|	medcode=="63912"|	medcode=="22905"|	medcode=="54893"|	medcode=="22915"|	medcode=="31319"|	medcode=="106650"|	medcode=="20269"|	medcode=="558"|	medcode=="39706"|	medcode=="5293"|	medcode=="65000"|	medcode=="93880"|	medcode=="72221"|	medcode=="96754"|	medcode=="24848"|	medcode=="24466"|	medcode=="99158"|	medcode=="8317"|	medcode=="103785"|	medcode=="109815"|	medcode=="104915"|	medcode=="24814"|	medcode=="94946"|	medcode=="94486"|	medcode=="59188"|	medcode=="66058"|	medcode=="65733"|	medcode=="105939"|	medcode=="106515"|	medcode=="99232"|	medcode=="105628"|	medcode=="54706"|	medcode=="65060"|	medcode=="91912"|	medcode=="71906"|	medcode=="56427"|	medcode=="38298"|	medcode=="94925"|	medcode=="6883"|	medcode=="93098"|	medcode=="13563")

fwrite(ext1clinRESP, paste("P:/Comorbidities/ext1clinRESP.csv"))
ext1clinRESP <- fread("P:/Comorbidities/ext1clinRESP.csv")

#heart ext1
ext1clinHEART1<-subset(ext1clin, medcode=="11284"|	medcode=="19066"|	medcode=="51214"|	medcode=="250"|	medcode=="53626"|	medcode=="61073"|	medcode=="4438"|	medcode=="242"|	medcode=="72939"|	medcode=="58529"|	medcode=="107416"|	medcode=="70105"|	medcode=="93844"|	medcode=="69734"|	medcode=="41495"|	medcode=="22262"|	medcode=="16292"|	medcode=="50157"|	medcode=="95334"|	medcode=="72668"|	medcode=="103046"|	medcode=="52427"|	medcode=="61660"|	medcode=="52127"|	medcode=="105938"|	medcode=="31464"|	medcode=="61166"|	medcode=="62718"|	medcode=="16173"|	medcode=="240"|	medcode=="241"|	medcode=="12139"|	medcode=="5387"|	medcode=="40429"|	medcode=="17872"|	medcode=="14897"|	medcode=="8935"|	medcode=="29643"|	medcode=="23892"|	medcode=="14898"|	medcode=="63467"|	medcode=="3704"|	medcode=="9507"|	medcode=="10562"|	medcode=="1678"|	medcode=="30330"|	medcode=="32854"|	medcode=="29758"|	medcode=="12229"|	medcode=="34803"|	medcode=="28736"|	medcode=="62626"|	medcode=="41221"|	medcode=="46017"|	medcode=="14658"|	medcode=="27951"|	medcode=="36523"|	medcode=="61072"|	medcode=="7347"|	medcode=="17307"|	medcode=="34328"|	medcode=="18118"|	medcode=="11983"|	medcode=="54251"|	medcode=="39449"|	medcode=="9413"|	medcode=="9276"|	medcode=="68357"|	medcode=="39693"|	medcode=="21844"|	medcode=="27977"|	medcode=="4017"|	medcode=="1430"|	medcode=="20095"|	medcode=="18125"|	medcode=="29902"|	medcode=="25842"|	medcode=="66388"|	medcode=="54535"|	medcode=="7696"|	medcode=="1414"|	medcode=="32450"|	medcode=="9555"|	medcode=="26863"|	medcode=="12804"|	medcode=="28554"|	medcode=="28138"|	medcode=="5413"|	medcode=="3999"|	medcode=="5254"|	medcode=="36609"|	medcode=="7320"|	medcode=="29421"|	medcode=="34633"|	medcode=="24540"|	medcode=="23078"|	medcode=="35713"|	medcode=="15754"|	medcode=="18889"|	medcode=="18842"|	medcode=="45809"|	medcode=="38609"|	medcode=="72562"|	medcode=="46166"|	medcode=="32272"|	medcode=="46112"|	medcode=="46276"|	medcode=="106812"|	medcode=="41835"|	medcode=="68748"|	medcode=="105479"|	medcode=="1676"|	medcode=="2062"|	medcode=="398"|	medcode=="23707"|	medcode=="32671"|	medcode=="27884"|	medcode=="11424"|	medcode=="94870"|	medcode=="884"|	medcode=="5255"|	medcode=="27964"|	medcode=="101138"|	medcode=="104275"|	medcode=="4024"|	medcode=="8966"|	medcode=="107397"|	medcode=="52517"|	medcode=="39546"|	medcode=="68401"|	medcode=="47637"|	medcode=="96838"|	medcode=="109035"|	medcode=="99991"|	medcode=="31518"|	medcode=="4964"|	medcode=="72604"|	medcode=="45505"|	medcode=="66245"|	medcode=="94344"|	medcode=="2816"|	medcode=="69858"|	medcode=="1778"|	medcode=="23988"|	medcode=="102980"|	medcode=="40025"|	medcode=="65318"|	medcode=="63390"|	medcode=="62169"|	medcode=="73539"|	medcode=="4864"|	medcode=="38967"|	medcode=="51649"|	medcode=="63046"|	medcode=="19969"|	medcode=="246"|	medcode=="42132"|	medcode=="56575"|	medcode=="67657"|	medcode=="9011"|	medcode=="51897"|	medcode=="20153"|	medcode=="54772"|	medcode=="34067"|	medcode=="7474"|	medcode=="3255"|	medcode=="3625"|	medcode=="37816"|	medcode=="59144"|	medcode=="53088"|	medcode=="54243"|	medcode=="63340"|	medcode=="51053"|	medcode=="101393"|	medcode=="49702"|	medcode=="55535"|	medcode=="43049"|	medcode=="44896"|	medcode=="73816"|	medcode=="46117"|	medcode=="9361"|	medcode=="48205"|	medcode=="66401"|	medcode=="54196"|	medcode=="5621"|	medcode=="39992"|	medcode=="69940"|	medcode=="3862"|	medcode=="54488"|	medcode=="93561"|	medcode=="22778"|	medcode=="112420"|	medcode=="45452"|	medcode=="33919"|	medcode=="21851"|	medcode=="44478"|	medcode=="107150"|	medcode=="52607"|	medcode=="70880"|	medcode=="12752"|	medcode=="21272"|	medcode=="69169"|	medcode=="100065"|	medcode=="23709"|	medcode=="6886"|	medcode=="8636"|	medcode=="58734"|	medcode=="3300"|	medcode=="6843"|	medcode=="57091"|	medcode=="90551"|	medcode=="73592"|	medcode=="63069")
ext1clinHEART2<-subset(ext1clin, medcode=="100291"|	medcode=="61651"|	medcode=="20772"|	medcode=="89256"|	medcode=="108457"|	medcode=="46825"|	medcode=="50529"|	medcode=="24789"|	medcode=="16539"|	medcode=="34668"|	medcode=="9401"|	medcode=="99128"|	medcode=="32748"|	medcode=="104266"|	medcode=="97818"|	medcode=="25481"|	medcode=="71956"|	medcode=="62163"|	medcode=="103894"|	medcode=="31373"|	medcode=="49901"|	medcode=="103412"|	medcode=="53546"|	medcode=="24533"|	medcode=="68097"|	medcode=="52310"|	medcode=="102167"|	medcode=="70992"|	medcode=="71678"|	medcode=="3774"|	medcode=="72259"|	medcode=="72405"|	medcode=="50284"|	medcode=="103584"|	medcode=="92426"|	medcode=="52615"|	medcode=="98061"|	medcode=="24854"|	medcode=="93089"|	medcode=="68063"|	medcode=="34007"|	medcode=="49133"|	medcode=="50362"|	medcode=="68894"|	medcode=="108193"|	medcode=="37451"|	medcode=="23752"|	medcode=="95785"|	medcode=="111360"|	medcode=="98317"|	medcode=="24714"|	medcode=="247"|	medcode=="26626"|	medcode=="109236"|	medcode=="103432"|	medcode=="64778"|	medcode=="38968"|	medcode=="3863"|	medcode=="11982"|	medcode=="3301"|	medcode=="57932"|	medcode=="72295"|	medcode=="70853"|	medcode=="37323"|	medcode=="59907"|	medcode=="50220"|	medcode=="62230"|	medcode=="30725"|	medcode=="67286"|	medcode=="30949"|	medcode=="46530"|	medcode=="49731"|	medcode=="44334"|	medcode=="90486"|	medcode=="70691"|	medcode=="34176"|	medcode=="68198"|	medcode=="59298"|	medcode=="37515"|	medcode=="63768"|	medcode=="53964"|	medcode=="62376"|	medcode=="58076"|	medcode=="44781"|	medcode=="49474"|	medcode=="56200"|	medcode=="11945"|	medcode=="11127"|	medcode=="63187"|	medcode=="67928"|	medcode=="31112"|	medcode=="18982"|	medcode=="54487"|	medcode=="2670"|	medcode=="96225"|	medcode=="65029"|	medcode=="32508"|	medcode=="52411"|	medcode=="42127"|	medcode=="42684"|	medcode=="45291"|	medcode=="74890"|	medcode=="50886"|	medcode=="51941"|	medcode=="105037"|	medcode=="103039"|	medcode=="68784"|	medcode=="46176"|	medcode=="101307"|	medcode=="99649"|	medcode=="73663"|	medcode=="101520"|	medcode=="72655"|	medcode=="51675"|	medcode=="41197"|	medcode=="110026"|	medcode=="36606"|	medcode=="71874"|	medcode=="51911"|	medcode=="73554"|	medcode=="101322"|	medcode=="109008"|	medcode=="110047"|	medcode=="106644"|	medcode=="107639"|	medcode=="110418"|	medcode=="107496"|	medcode=="107710"|	medcode=="9384"|	medcode=="25089"|	medcode=="22383"|	medcode=="21966")

ext1clinHEART <- rbindlist(list(ext1clinHEART1, ext1clinHEART2), use.names = TRUE, fill = TRUE)

fwrite(ext1clinHEART, paste("P:/Comorbidities/ext1clinHEART.csv"))
ext1clinHEART <- fread("P:/Comorbidities/ext1clinHEART.csv")

#renal ext1
ext1clinRENAL<-subset(ext1clin, medcode=="12479"|	medcode=="12585"|	medcode=="95122"|	medcode=="95406"|	medcode=="95508"|	medcode=="95405"|	medcode=="2997"|	medcode=="55151"|	medcode=="11745"|	medcode=="24361"|	medcode=="89924"|	medcode=="96133"|	medcode=="109455"|	medcode=="105787"|	medcode=="70874"|	medcode=="5504"|	medcode=="31549"|	medcode=="20073"|	medcode=="2994"|	medcode=="2996"|	medcode=="71124"|	medcode=="88597"|	medcode=="30756"|	medcode=="64828"|	medcode=="48022"|	medcode=="64636"|	medcode=="56760"|	medcode=="8037"|	medcode=="23773"|	medcode=="104586"|	medcode=="59194"|	medcode=="83513"|	medcode=="30709"|	medcode=="107901"|	medcode=="65089"|	medcode=="102210"|	medcode=="30323"|	medcode=="26054"|	medcode=="26860"|	medcode=="109840"|	medcode=="2999"|	medcode=="9840"|	medcode=="1803"|	medcode=="99644"|	medcode=="29634"|	medcode=="23913"|	medcode=="22852"|	medcode=="19316"|	medcode=="21947"|	medcode=="50472"|	medcode=="21989"|	medcode=="56987"|	medcode=="17365"|	medcode=="63786"|	medcode=="72303"|	medcode=="108591"|	medcode=="110749"|	medcode=="111370"|	medcode=="108816"|	medcode=="47922"|	medcode=="2471"|	medcode=="99201"|	medcode=="58750"|	medcode=="94373"|	medcode=="27427"|	medcode=="65064"|	medcode=="512"|	medcode=="6712"|	medcode=="104963"|	medcode=="105151"|	medcode=="350"|	medcode=="105302"|	medcode=="61814"|	medcode=="71174"|	medcode=="97734"|	medcode=="41285"|	medcode=="58060"|	medcode=="109945"|	medcode=="50200"|	medcode=="62320"|	medcode=="8330"|	medcode=="100205"|	medcode=="61930"|	medcode=="11554"|	medcode=="5911"|	medcode=="53940"|	medcode=="108494")

fwrite(ext1clinRENAL, paste("P:/Comorbidities/ext1clinRENAL.csv"))
ext1clinRENAL <- fread("P:/Comorbidities/ext1clinRENAL.csv")

#liver ext1
ext1clinLIVER<-subset(ext1clin, medcode=="4405"|	medcode=="32025"|	medcode=="71422"|	medcode=="69194"|	medcode=="105506"|	medcode=="97157"|	medcode=="99250"|	medcode=="27319"|	medcode=="26367"|	medcode=="24813"|	medcode=="41096"|	medcode=="30586"|	medcode=="106642"|	medcode=="32277"|	medcode=="108343"|	medcode=="107896"|	medcode=="110454"|	medcode=="102922"|	medcode=="48211"|	medcode=="6863"|	medcode=="4743"|	medcode=="21713"|	medcode=="17330"|	medcode=="1754"|	medcode=="23578"|	medcode=="9029"|	medcode=="1755"|	medcode=="53480"|	medcode=="66534"|	medcode=="53877"|	medcode=="15489"|	medcode=="16725"|	medcode=="69204"|	medcode=="3450"|	medcode=="44676"|	medcode=="92909"|	medcode=="40567"|	medcode=="27438"|	medcode=="96664"|	medcode=="100253"|	medcode=="73482"|	medcode=="112044"|	medcode=="109540"|	medcode=="48928"|	medcode=="55454"|	medcode=="16455"|	medcode=="9494"|	medcode=="5638"|	medcode=="15424"|	medcode=="91591"|	medcode=="58630"|	medcode=="7602"|	medcode=="42843"|	medcode=="25383"|	medcode=="60104"|	medcode=="100592"|	medcode=="33597"|	medcode=="10539"|	medcode=="5129"|	medcode=="10636"|	medcode=="24901"|	medcode=="48102"|	medcode=="17219"|	medcode=="64750"|	medcode=="39351"|	medcode=="44120"|	medcode=="26405"|	medcode=="18652"|	medcode=="15425"|	medcode=="6015"|	medcode=="25597"|	medcode=="16417"|	medcode=="38389"|	medcode=="48269"|	medcode=="50400"|	medcode=="50444"|	medcode=="40029"|	medcode=="10721"|	medcode=="71422"|	medcode=="4405"|	medcode=="32025"|	medcode=="69194")

fwrite(ext1clinLIVER, paste("P:/Comorbidities/ext1clinLIVER.csv"))
ext1clinLIVER <- fread("P:/Comorbidities/ext1clinLIVER.csv")

#diabetes ext1
ext1clinDIABETES<-subset(ext1clin, medcode=="711"|	medcode=="43453"|	medcode=="36695"|	medcode=="1549"|	medcode=="47582"|	medcode=="47649"|	medcode=="42831"|	medcode=="47650"|	medcode=="43921"|	medcode=="18683"|	medcode=="69993"|	medcode=="18387"|	medcode=="35288"|	medcode=="40682"|	medcode=="69676"|	medcode=="68105"|	medcode=="46301"|	medcode=="10418"|	medcode=="39070"|	medcode=="49554"|	medcode=="93468"|	medcode=="18642"|	medcode=="54008"|	medcode=="30323"|	medcode=="30294"|	medcode=="10692"|	medcode=="40837"|	medcode=="22871"|	medcode=="55239"|	medcode=="95636"|	medcode=="758"|	medcode=="18777"|	medcode=="47321"|	medcode=="34268"|	medcode=="65267"|	medcode=="49074"|	medcode=="12736"|	medcode=="18496"|	medcode=="25627"|	medcode=="47954"|	medcode=="62674"|	medcode=="18425"|	medcode=="12640"|	medcode=="46917"|	medcode=="44982"|	medcode=="37806"|	medcode=="59253"|	medcode=="35385"|	medcode=="1407"|	medcode=="34450"|	medcode=="26054"|	medcode=="18390"|	medcode=="32627"|	medcode=="51756"|	medcode=="25591"|	medcode=="63690"|	medcode=="95539"|	medcode=="51697"|	medcode=="96506"|	medcode=="61122"|	medcode=="67212"|	medcode=="43857"|	medcode=="22487"|	medcode=="94383"|	medcode=="93380"|	medcode=="52212"|	medcode=="106927"|	medcode=="53200"|	medcode=="42567"|	medcode=="54856"|	medcode=="6791"|	medcode=="31310"|	medcode=="60499"|	medcode=="52104"|	medcode=="52283"|	medcode=="49276"|	medcode=="46963"|	medcode=="6509"|	medcode=="44443"|	medcode=="8403"|	medcode=="40401"|	medcode=="68843"|	medcode=="62146"|	medcode=="55842"|	medcode=="50429"|	medcode=="52303"|	medcode=="17262"|	medcode=="34912")

fwrite(ext1clinDIABETES, paste("P:/Comorbidities/ext1clinDIABETES.csv"))
ext1clinDIABETES <- fread("P:/Comorbidities/ext1clinDIABETES.csv")

#immunosuppression ext1
ext1clinIMMUNO1<-subset(ext1clin, medcode=="47106"|	medcode=="22307"|	medcode=="34310"|	medcode=="108246"|	medcode=="27514"|	medcode=="1393"|	medcode=="31041"|	medcode=="102966"|	medcode=="59784"|	medcode=="106015"|	medcode=="32133"|	medcode=="23770"|	medcode=="58857"|	medcode=="58859"|	medcode=="69766"|	medcode=="70869"|	medcode=="53636"|	medcode=="70528"|	medcode=="101836"|	medcode=="47632"|	medcode=="111979"|	medcode=="67575"|	medcode=="71450"|	medcode=="62891"|	medcode=="36294"|	medcode=="44303"|	medcode=="37006"|	medcode=="66368"|	medcode=="23951"|	medcode=="27641"|	medcode=="50076"|	medcode=="27853"|	medcode=="44617"|	medcode=="66367"|	medcode=="105324"|	medcode=="65117"|	medcode=="8281"|	medcode=="51708"|	medcode=="62854"|	medcode=="112030"|	medcode=="107807"|	medcode=="112031"|	medcode=="102117"|	medcode=="104134"|	medcode=="112032"|	medcode=="69767"|	medcode=="112034"|	medcode=="112035"|	medcode=="112036"|	medcode=="112037"|	medcode=="96751"|	medcode=="102252"|	medcode=="100769"|	medcode=="65460"|	medcode=="108667"|	medcode=="72224"|	medcode=="93778"|	medcode=="12323"|	medcode=="41369"|	medcode=="1481"|	medcode=="60242"|	medcode=="71031"|	medcode=="70374"|	medcode=="95058"|	medcode=="99240"|	medcode=="27416"|	medcode=="71625"|	medcode=="71238"|	medcode=="62380"|	medcode=="64670"|	medcode=="100352"|	medcode=="103245"|	medcode=="104790"|	medcode=="63723"|	medcode=="21402"|	medcode=="59115"|	medcode=="100006"|	medcode=="97577"|	medcode=="92380"|	medcode=="71304"|	medcode=="99887"|	medcode=="99951"|	medcode=="2462"|	medcode=="65489"|	medcode=="100423"|	medcode=="98840"|	medcode=="44196"|	medcode=="98909"|	medcode=="64036"|	medcode=="68039"|	medcode=="38939"|	medcode=="71142"|	medcode=="68330"|	medcode=="92245"|	medcode=="73532"|	medcode=="93951"|	medcode=="95338"|	medcode=="106911"|	medcode=="104743"|	medcode=="29876"|	medcode=="29178"|	medcode=="57225"|	medcode=="55303"|	medcode=="67506"|	medcode=="61149"|	medcode=="65483"|	medcode=="105472"|	medcode=="19140"|	medcode=="63054"|	medcode=="49605"|	medcode=="97863"|	medcode=="94407"|	medcode=="58684"|	medcode=="108886"|	medcode=="94005"|	medcode=="67703"|	medcode=="95049"|	medcode=="111942"|	medcode=="63625"|	medcode=="110563"|	medcode=="101715"|	medcode=="107032"|	medcode=="101530"|	medcode=="104895"|	medcode=="105841"|	medcode=="108775"|	medcode=="106597"|	medcode=="104484"|	medcode=="53397"|	medcode=="61662"|	medcode=="59778"|	medcode=="59755"|	medcode=="107804"|	medcode=="91900"|	medcode=="99012"|	medcode=="94279"|	medcode=="97746"|	medcode=="42461"|	medcode=="5179"|	medcode=="66327"|	medcode=="45264"|	medcode=="105203"|	medcode=="92068"|	medcode=="111766"|	medcode=="94995"|	medcode=="58082"|	medcode=="65701"|	medcode=="12006"|	medcode=="95949"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="38005"|	medcode=="35014"|	medcode=="100532"|	medcode=="27330"|	medcode=="65122"|	medcode=="65123"|	medcode=="73777"|	medcode=="34926"|	medcode=="102715"|	medcode=="102158"|	medcode=="54083"|	medcode=="47204"|	medcode=="15036"|	medcode=="103900"|	medcode=="100615"|	medcode=="31324"|	medcode=="89657"|	medcode=="3604"|	medcode=="28639"|	medcode=="70842"|	medcode=="49262"|	medcode=="50668"|	medcode=="108182"|	medcode=="50695"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="95715"|	medcode=="101114"|	medcode=="31576"|	medcode=="21549"|	medcode=="70509"|	medcode=="102594"|	medcode=="105966"|	medcode=="105038"|	medcode=="31794"|	medcode=="39798"|	medcode=="104152"|	medcode=="105889"|	medcode=="105095"|	medcode=="107166"|	medcode=="105020"|	medcode=="107973"|	medcode=="106969"|	medcode=="108719"|	medcode=="106063"|	medcode=="105792"|	medcode=="105335"|	medcode=="105559"|	medcode=="105955"|	medcode=="109780"|	medcode=="107949"|	medcode=="105709"|	medcode=="105925"|	medcode=="105375")
ext1clinIMMUNO2<-subset(ext1clin, medcode=="105636"|	medcode=="105286"|	medcode=="104934"|	medcode=="106884"|	medcode=="104386"|	medcode=="104620"|	medcode=="104412"|	medcode=="111682"|	medcode=="17887"|	medcode=="90201"|	medcode=="57737"|	medcode=="12464"|	medcode=="44318"|	medcode=="12335"|	medcode=="57427"|	medcode=="50696"|	medcode=="72725"|	medcode=="42579"|	medcode=="34089"|	medcode=="63105"|	medcode=="71262"|	medcode=="60092"|	medcode=="15504"|	medcode=="15027"|	medcode=="65434"|	medcode=="37182"|	medcode=="4944"|	medcode=="22158"|	medcode=="19028"|	medcode=="21329"|	medcode=="46042"|	medcode=="104418"|	medcode=="39187"|	medcode=="64567"|	medcode=="43450"|	medcode=="19372"|	medcode=="4251"|	medcode=="104325"|	medcode=="8625"|	medcode=="104328"|	medcode=="107052"|	medcode=="106924"|	medcode=="107163"|	medcode=="72774"|	medcode=="49725"|	medcode=="31586"|	medcode=="37461"|	medcode=="108656"|	medcode=="107643"|	medcode=="104939"|	medcode=="38331"|	medcode=="38914"|	medcode=="7176"|	medcode=="4413"|	medcode=="10726"|	medcode=="100786"|	medcode=="105957"|	medcode=="102783"|	medcode=="107236"|	medcode=="27520"|	medcode=="63475"|	medcode=="70724"|	medcode=="52327"|	medcode=="39629"|	medcode=="104788"|	medcode=="112440"|	medcode=="27664"|	medcode=="66089"|	medcode=="33344"|	medcode=="35875"|	medcode=="19974"|	medcode=="27458"|	medcode=="101606"|	medcode=="108424"|	medcode=="99015"|	medcode=="103645"|	medcode=="93342"|	medcode=="37272"|	medcode=="42539"|	medcode=="37468"|	medcode=="57671"|	medcode=="65721"|	medcode=="50858"|	medcode=="28276"|	medcode=="110838"|	medcode=="104273"|	medcode=="94174"|	medcode=="72197"|	medcode=="99413"|	medcode=="30632"|	medcode=="25191"|	medcode=="4072"|	medcode=="16416"|	medcode=="54793"|	medcode=="34692"|	medcode=="4250"|	medcode=="20440"|	medcode=="61500"|	medcode=="22050"|	medcode=="104475"|	medcode=="105069"|	medcode=="30646"|	medcode=="6115"|	medcode=="39336"|	medcode=="49301"|	medcode=="25493"|	medcode=="2481"|	medcode=="11950"|	medcode=="106993"|	medcode=="104740"|	medcode=="105915"|	medcode=="45285"|	medcode=="46444"|	medcode=="70935"|	medcode=="40740"|	medcode=="43415"|	medcode=="67518"|	medcode=="98596"|	medcode=="64336"|	medcode=="102688"|	medcode=="67029"|	medcode=="61693"|	medcode=="89762"|	medcode=="89329"|	medcode=="65165"|	medcode=="105025"|	medcode=="72500"|	medcode=="64515"|	medcode=="109714"|	medcode=="63375"|	medcode=="8649"|	medcode=="45143"|	medcode=="69545"|	medcode=="15883"|	medcode=="106381"|	medcode=="3451"|	medcode=="12306"|	medcode=="12386"|	medcode=="16527"|	medcode=="10411"|	medcode=="101350"|	medcode=="99067"|	medcode=="108102"|	medcode=="71994"|	medcode=="18486"|	medcode=="51041"|	medcode=="27934"|	medcode=="104554"|	medcode=="110183"|	medcode=="44147"|	medcode=="15137"|	medcode=="8548"|	medcode=="18701"|	medcode=="18700"|	medcode=="68440"|	medcode=="57161"|	medcode=="69373"|	medcode=="57322"|	medcode=="92569"|	medcode=="62598"|	medcode=="69184"|	medcode=="60026"|	medcode=="69854"|	medcode=="16295"|	medcode=="48307"|	medcode=="50665"|	medcode=="31322"|	medcode=="62236"|	medcode=="48293"|	medcode=="31541"|	medcode=="66073"|	medcode=="49542"|	medcode=="50526"|	medcode=="103977"|	medcode=="62328"|	medcode=="3129"|	medcode=="65617"|	medcode=="56108"|	medcode=="54203"|	medcode=="21975"|	medcode=="93892"|	medcode=="66857"|	medcode=="36408"|	medcode=="109671"|	medcode=="54904"|	medcode=="63204"|	medcode=="32141"|	medcode=="91911"|	medcode=="66049"|	medcode=="40950"|	medcode=="18781"| medcode=="38306"|	medcode=="39034"|	medcode=="34150"|	medcode=="5572"|	medcode=="2337"|	medcode=="41185"|	medcode=="73583"|	medcode=="12699"|	medcode=="5655"|	medcode=="66740"|	medcode=="27515"|	medcode=="51640"|	medcode=="32270"|	medcode=="57551"|	medcode=="95005"|	medcode=="39420"|	medcode=="61069"|	medcode=="56973"|	medcode=="47695"|	medcode=="65825")
ext1clinIMMUNO3<-subset(ext1clin, medcode=="63323"|	medcode=="53317"|	medcode=="20261"|	medcode=="11346"|	medcode=="100043"|	medcode=="52604"|	medcode=="57525"|	medcode=="40406"|	medcode=="70236"|	medcode=="62041"|	medcode=="22319"|	medcode=="101375"|	medcode=="101075"|	medcode=="4072"|	medcode=="4251"|	medcode=="19974"|	medcode=="4413"|	medcode=="50858"|	medcode=="27664"|	medcode=="37461"|	medcode=="52327"|	medcode=="100786"|	medcode=="16416"|	medcode=="8625"|	medcode=="27458"|	medcode=="10726"|	medcode=="27520"|	medcode=="22050"|	medcode=="102783"|	medcode=="50668"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="21549"|	medcode=="70842"|	medcode=="99067"|	medcode=="39629"|	medcode=="27330"|	medcode=="53397"|	medcode=="107804"|	medcode=="59755"|	medcode=="91900"|	medcode=="59778"|	medcode=="99012"|	medcode=="97746"|	medcode=="94279"|	medcode=="61662"|	medcode=="67703"|	medcode=="101530"|	medcode=="63625"|	medcode=="111942"|	medcode=="110563"|	medcode=="107032"|	medcode=="101715"|	medcode=="73532"|	medcode=="95338"|	medcode=="92245"|	medcode=="68330"|	medcode=="93951"|	medcode=="104743"|	medcode=="71142"|	medcode=="49605"|	medcode=="94005"|	medcode=="58684"|	medcode=="94407"|	medcode=="108886"|	medcode=="97863"|	medcode=="29178"|	medcode=="63054"|	medcode=="61149"|	medcode=="67506"|	medcode=="65483"|	medcode=="55303"|	medcode=="19140"|	medcode=="105472"|	medcode=="57225"|	medcode=="95049"|	medcode=="64036"|	medcode=="68039"|	medcode=="29876"|	medcode=="106911"|	medcode=="43450"|	medcode=="34926"|	medcode=="47204"|	medcode=="102158"|	medcode=="54083"|	medcode=="102715"|	medcode=="4250"|	medcode=="25191"|	medcode=="73777"|	medcode=="65123"|	medcode=="65122"|	medcode=="38939"|	medcode=="19372"|	medcode=="38914"|	medcode=="72197"|	medcode=="16527"|	medcode=="71994"|	medcode=="50695"|	medcode=="108182"|	medcode=="12335"|	medcode=="42579"|	medcode=="71262"|	medcode=="72725"|	medcode=="34089"|	medcode=="50696"|	medcode=="63105"|	medcode=="15504"|	medcode=="60092"|	medcode=="57427"|	medcode=="17887"|	medcode=="89657"|	medcode=="15036"|	medcode=="49301"|	medcode=="30646"|	medcode=="65434"|	medcode=="22158"|	medcode=="65721"|	medcode=="100615"|	medcode=="31324"|	medcode=="103900"|	medcode=="57671"|	medcode=="15883"|	medcode=="35875"|	medcode=="93342"|	medcode=="37182"|	medcode=="12006"|	medcode=="38005"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="95949"|	medcode=="7176"|	medcode=="33344"|	medcode=="70724"|	medcode=="4944"|	medcode=="20440"|	medcode=="25493"|	medcode=="65701"|	medcode=="92068"|	medcode=="105203"|	medcode=="111766"|	medcode=="45264"|	medcode=="94995"|	medcode=="58082"|	medcode=="66327"|	medcode=="3604"|	medcode=="94174"|	medcode=="99413"|	medcode=="64567"|	medcode=="34692"|	medcode=="49725"|	medcode=="38331"|	medcode=="99015"|	medcode=="103645"|	medcode=="112440"|	medcode=="66089"|	medcode=="3451"|	medcode=="37272"|	medcode=="30632"|	medcode=="31576"|	medcode=="12386"|	medcode=="2481"|	medcode=="31586"|	medcode=="35014"|	medcode=="100532"|	medcode=="54793"|	medcode=="72774"|	medcode=="101606"|	medcode=="63475"|	medcode=="104475"|	medcode=="10411"|	medcode=="5019"|	medcode=="102559"|	medcode=="59610"|	medcode=="105256"|	medcode=="31489"|	medcode=="10505")

ext1clinIMMUNO <- rbindlist(list(ext1clinIMMUNO1, ext1clinIMMUNO2, ext1clinIMMUNO3), use.names = TRUE, fill = TRUE)

fwrite(ext1clinIMMUNO, paste("P:/Comorbidities/ext1clinIMMUNO.csv"))
ext1clinIMMUNO <- fread("P:/Comorbidities/ext1clinIMMUNO.csv")

#csf leaks and cochear ext1
ext1clinCSF<-subset(ext1clin, medcode=="30525"|	medcode=="43643"|	medcode=="42441"|	medcode=="36513"|	medcode=="20641"|	medcode=="26158"|	medcode=="40348"|	medcode=="20488"|	medcode=="27295"|	medcode=="35762"|	medcode=="16172"|	medcode=="9300"|	medcode=="17957"|	medcode=="36424"|	medcode=="97074"|	medcode=="55931"|	medcode=="33396"|	medcode=="48851"|	medcode=="71772"|	medcode=="41393"|	medcode=="54342"|	medcode=="10708"|	medcode=="61980"|	medcode=="98472"|	medcode=="57642"|	medcode=="74897")

fwrite(ext1clinCSF, paste("P:/Comorbidities/ext1clinCSF.csv"))
ext1clinCSF <- fread("P:/Comorbidities/ext1clinCSF.csv")

#bind all
ext1clinALL <- rbindlist(list(ext1clinRESP, ext1clinHEART, ext1clinRENAL, ext1clinLIVER, ext1clinDIABETES, ext1clinIMMUNO, ext1clinCSF), use.names = TRUE, fill = TRUE)

fwrite(ext1clinALL, paste("P:/Comorbidities/ext1clinALL.csv"))
ext1clinALL <- fread("P:/Comorbidities/ext1clinALL.csv")


#ext2
ext2clin1 <- fread("P:/CPRD_mother_baby_GOLD/ext2/Clinical/ext2_Extract_Clinical_001.txt")
ext2clin2 <- fread("P:/CPRD_mother_baby_GOLD/ext2/Clinical/ext2_Extract_Clinical_002.txt")
ext2clin3 <- fread("P:/CPRD_mother_baby_GOLD/ext2/Clinical/ext2_Extract_Clinical_003.txt")
ext2clin4 <- fread("P:/CPRD_mother_baby_GOLD/ext2/Clinical/ext2_Extract_Clinical_004.txt")
ext2clin5 <- fread("P:/CPRD_mother_baby_GOLD/ext2/Clinical/ext2_Extract_Clinical_005.txt")
ext2clin6 <- fread("P:/CPRD_mother_baby_GOLD/ext2/Clinical/ext2_Extract_Clinical_006.txt")
ext2clin7 <- fread("P:/CPRD_mother_baby_GOLD/ext2/Clinical/ext2_Extract_Clinical_007.txt")

ext2clin <- rbindlist(list(ext2clin1, ext2clin2, ext2clin3, ext2clin4, ext2clin5, ext2clin6, ext2clin7), use.names = TRUE, fill = TRUE)

#resp ext2
ext2clinRESP<-subset(ext2clin, medcode=="10461"|	medcode=="96578"|	medcode=="93713"|	medcode=="73743"|	medcode=="38011"|	medcode=="15693"|	medcode=="65117"|	medcode=="100742"|	medcode=="33980"|	medcode=="58841"|	medcode=="93380"|	medcode=="29966"|	medcode=="6220"|	medcode=="65344"|	medcode=="69017"|	medcode=="18914"|	medcode=="18905"|	medcode=="100610"|	medcode=="103224"|	medcode=="110454"|	medcode=="102922"|	medcode=="106432"|	medcode=="73065"|	medcode=="49770"|	medcode=="1001"|	medcode=="148"|	medcode=="152"|	medcode=="3480"|	medcode=="3243"|	medcode=="25603"|	medcode=="15626"|	medcode=="61118"|	medcode=="11150"|	medcode=="40159"|	medcode=="37959"|	medcode=="61513"|	medcode=="27819"|	medcode=="5798"|	medcode=="14798"|	medcode=="1446"|	medcode=="26125"|	medcode=="44525"|	medcode=="24248"|	medcode=="66043"|	medcode=="45089"|	medcode=="68066"|	medcode=="15157"|	medcode=="794"|	medcode=="26306"|	medcode=="56860"|	medcode=="68662"|	medcode=="60188"|	medcode=="99536"|	medcode=="23492"|	medcode=="46578"|	medcode=="10980"|	medcode=="40788"|	medcode=="92955"|	medcode=="70787"|	medcode=="63479"|	medcode=="16410"|	medcode=="33450"|	medcode=="106805"|	medcode=="2195"|	medcode=="20364"|	medcode=="41491"|	medcode=="32679"|	medcode=="10863"|	medcode=="10802"|	medcode=="9876"|	medcode=="93568"|	medcode=="104608"|	medcode=="12166"|	medcode=="21061"|	medcode=="7884"|	medcode=="5710"|	medcode=="19492"|	medcode=="8303"|	medcode=="51410"|	medcode=="46460"|	medcode=="60805"|	medcode=="62233"|	medcode=="71853"|	medcode=="89206"|	medcode=="23446"|	medcode=="65376"|	medcode=="94894"|	medcode=="49194"|	medcode=="94575"|	medcode=="30235"|	medcode=="93577"|	medcode=="23461"|	medcode=="37365"|	medcode=="26442"|	medcode=="31423"|	medcode=="63172"|	medcode=="54830"|	medcode=="49025"|	medcode=="55758"|	medcode=="62227"|	medcode=="47142"|	medcode=="64721"|	medcode=="63216"|	medcode=="47782"|	medcode=="70815"|	medcode=="104557"|	medcode=="9711"|	medcode=="3847"|	medcode=="41781"|	medcode=="59083"|	medcode=="66104"|	medcode=="45948"|	medcode=="33837"|	medcode=="56647"|	medcode=="41015"|	medcode=="66773"|	medcode=="50876"|	medcode=="47504"|	medcode=="54252"|	medcode=="46066"|	medcode=="43285"|	medcode=="18130"|	medcode=="69914"|	medcode=="22536"|	medcode=="50374"|	medcode=="44015"|	medcode=="53205"|	medcode=="43417"|	medcode=="30214"|	medcode=="38297"|	medcode=="46405"|	medcode=="26082"|	medcode=="7321"|	medcode=="61229"|	medcode=="7791"|	medcode=="31806"|	medcode=="61119"|	medcode=="27348"|	medcode=="68814"|	medcode=="6837"|	medcode=="94136"|	medcode=="6051"|	medcode=="103472"|	medcode=="103559"|	medcode=="28229"|	medcode=="22835"|	medcode=="54308"|	medcode=="61991"|	medcode=="33830"|	medcode=="15815"|	medcode=="64799"|	medcode=="94996"|	medcode=="58791"|	medcode=="54010"|	medcode=="42940"|	medcode=="3859"|	medcode=="47364"|	medcode=="31564"|	medcode=="96655"|	medcode=="63912"|	medcode=="22905"|	medcode=="54893"|	medcode=="22915"|	medcode=="31319"|	medcode=="106650"|	medcode=="20269"|	medcode=="558"|	medcode=="39706"|	medcode=="5293"|	medcode=="65000"|	medcode=="93880"|	medcode=="72221"|	medcode=="96754"|	medcode=="24848"|	medcode=="24466"|	medcode=="99158"|	medcode=="8317"|	medcode=="103785"|	medcode=="109815"|	medcode=="104915"|	medcode=="24814"|	medcode=="94946"|	medcode=="94486"|	medcode=="59188"|	medcode=="66058"|	medcode=="65733"|	medcode=="105939"|	medcode=="106515"|	medcode=="99232"|	medcode=="105628"|	medcode=="54706"|	medcode=="65060"|	medcode=="91912"|	medcode=="71906"|	medcode=="56427"|	medcode=="38298"|	medcode=="94925"|	medcode=="6883"|	medcode=="93098"|	medcode=="13563")

fwrite(ext2clinRESP, paste("P:/Comorbidities/ext2clinRESP.csv"))
ext2clinRESP <- fread("P:/Comorbidities/ext2clinRESP.csv")

#heart ext2
ext2clinHEART1<-subset(ext2clin, medcode=="11284"|	medcode=="19066"|	medcode=="51214"|	medcode=="250"|	medcode=="53626"|	medcode=="61073"|	medcode=="4438"|	medcode=="242"|	medcode=="72939"|	medcode=="58529"|	medcode=="107416"|	medcode=="70105"|	medcode=="93844"|	medcode=="69734"|	medcode=="41495"|	medcode=="22262"|	medcode=="16292"|	medcode=="50157"|	medcode=="95334"|	medcode=="72668"|	medcode=="103046"|	medcode=="52427"|	medcode=="61660"|	medcode=="52127"|	medcode=="105938"|	medcode=="31464"|	medcode=="61166"|	medcode=="62718"|	medcode=="16173"|	medcode=="240"|	medcode=="241"|	medcode=="12139"|	medcode=="5387"|	medcode=="40429"|	medcode=="17872"|	medcode=="14897"|	medcode=="8935"|	medcode=="29643"|	medcode=="23892"|	medcode=="14898"|	medcode=="63467"|	medcode=="3704"|	medcode=="9507"|	medcode=="10562"|	medcode=="1678"|	medcode=="30330"|	medcode=="32854"|	medcode=="29758"|	medcode=="12229"|	medcode=="34803"|	medcode=="28736"|	medcode=="62626"|	medcode=="41221"|	medcode=="46017"|	medcode=="14658"|	medcode=="27951"|	medcode=="36523"|	medcode=="61072"|	medcode=="7347"|	medcode=="17307"|	medcode=="34328"|	medcode=="18118"|	medcode=="11983"|	medcode=="54251"|	medcode=="39449"|	medcode=="9413"|	medcode=="9276"|	medcode=="68357"|	medcode=="39693"|	medcode=="21844"|	medcode=="27977"|	medcode=="4017"|	medcode=="1430"|	medcode=="20095"|	medcode=="18125"|	medcode=="29902"|	medcode=="25842"|	medcode=="66388"|	medcode=="54535"|	medcode=="7696"|	medcode=="1414"|	medcode=="32450"|	medcode=="9555"|	medcode=="26863"|	medcode=="12804"|	medcode=="28554"|	medcode=="28138"|	medcode=="5413"|	medcode=="3999"|	medcode=="5254"|	medcode=="36609"|	medcode=="7320"|	medcode=="29421"|	medcode=="34633"|	medcode=="24540"|	medcode=="23078"|	medcode=="35713"|	medcode=="15754"|	medcode=="18889"|	medcode=="18842"|	medcode=="45809"|	medcode=="38609"|	medcode=="72562"|	medcode=="46166"|	medcode=="32272"|	medcode=="46112"|	medcode=="46276"|	medcode=="106812"|	medcode=="41835"|	medcode=="68748"|	medcode=="105479"|	medcode=="1676"|	medcode=="2062"|	medcode=="398"|	medcode=="23707"|	medcode=="32671"|	medcode=="27884"|	medcode=="11424"|	medcode=="94870"|	medcode=="884"|	medcode=="5255"|	medcode=="27964"|	medcode=="101138"|	medcode=="104275"|	medcode=="4024"|	medcode=="8966"|	medcode=="107397"|	medcode=="52517"|	medcode=="39546"|	medcode=="68401"|	medcode=="47637"|	medcode=="96838"|	medcode=="109035"|	medcode=="99991"|	medcode=="31518"|	medcode=="4964"|	medcode=="72604"|	medcode=="45505"|	medcode=="66245"|	medcode=="94344"|	medcode=="2816"|	medcode=="69858"|	medcode=="1778"|	medcode=="23988"|	medcode=="102980"|	medcode=="40025"|	medcode=="65318"|	medcode=="63390"|	medcode=="62169"|	medcode=="73539"|	medcode=="4864"|	medcode=="38967"|	medcode=="51649"|	medcode=="63046"|	medcode=="19969"|	medcode=="246"|	medcode=="42132"|	medcode=="56575"|	medcode=="67657"|	medcode=="9011"|	medcode=="51897"|	medcode=="20153"|	medcode=="54772"|	medcode=="34067"|	medcode=="7474"|	medcode=="3255"|	medcode=="3625"|	medcode=="37816"|	medcode=="59144"|	medcode=="53088"|	medcode=="54243"|	medcode=="63340"|	medcode=="51053"|	medcode=="101393"|	medcode=="49702"|	medcode=="55535"|	medcode=="43049"|	medcode=="44896"|	medcode=="73816"|	medcode=="46117"|	medcode=="9361"|	medcode=="48205"|	medcode=="66401"|	medcode=="54196"|	medcode=="5621"|	medcode=="39992"|	medcode=="69940"|	medcode=="3862"|	medcode=="54488"|	medcode=="93561"|	medcode=="22778"|	medcode=="112420"|	medcode=="45452"|	medcode=="33919"|	medcode=="21851"|	medcode=="44478"|	medcode=="107150"|	medcode=="52607"|	medcode=="70880"|	medcode=="12752"|	medcode=="21272"|	medcode=="69169"|	medcode=="100065"|	medcode=="23709"|	medcode=="6886"|	medcode=="8636"|	medcode=="58734"|	medcode=="3300"|	medcode=="6843"|	medcode=="57091"|	medcode=="90551"|	medcode=="73592"|	medcode=="63069")
ext2clinHEART2<-subset(ext2clin, medcode=="100291"|	medcode=="61651"|	medcode=="20772"|	medcode=="89256"|	medcode=="108457"|	medcode=="46825"|	medcode=="50529"|	medcode=="24789"|	medcode=="16539"|	medcode=="34668"|	medcode=="9401"|	medcode=="99128"|	medcode=="32748"|	medcode=="104266"|	medcode=="97818"|	medcode=="25481"|	medcode=="71956"|	medcode=="62163"|	medcode=="103894"|	medcode=="31373"|	medcode=="49901"|	medcode=="103412"|	medcode=="53546"|	medcode=="24533"|	medcode=="68097"|	medcode=="52310"|	medcode=="102167"|	medcode=="70992"|	medcode=="71678"|	medcode=="3774"|	medcode=="72259"|	medcode=="72405"|	medcode=="50284"|	medcode=="103584"|	medcode=="92426"|	medcode=="52615"|	medcode=="98061"|	medcode=="24854"|	medcode=="93089"|	medcode=="68063"|	medcode=="34007"|	medcode=="49133"|	medcode=="50362"|	medcode=="68894"|	medcode=="108193"|	medcode=="37451"|	medcode=="23752"|	medcode=="95785"|	medcode=="111360"|	medcode=="98317"|	medcode=="24714"|	medcode=="247"|	medcode=="26626"|	medcode=="109236"|	medcode=="103432"|	medcode=="64778"|	medcode=="38968"|	medcode=="3863"|	medcode=="11982"|	medcode=="3301"|	medcode=="57932"|	medcode=="72295"|	medcode=="70853"|	medcode=="37323"|	medcode=="59907"|	medcode=="50220"|	medcode=="62230"|	medcode=="30725"|	medcode=="67286"|	medcode=="30949"|	medcode=="46530"|	medcode=="49731"|	medcode=="44334"|	medcode=="90486"|	medcode=="70691"|	medcode=="34176"|	medcode=="68198"|	medcode=="59298"|	medcode=="37515"|	medcode=="63768"|	medcode=="53964"|	medcode=="62376"|	medcode=="58076"|	medcode=="44781"|	medcode=="49474"|	medcode=="56200"|	medcode=="11945"|	medcode=="11127"|	medcode=="63187"|	medcode=="67928"|	medcode=="31112"|	medcode=="18982"|	medcode=="54487"|	medcode=="2670"|	medcode=="96225"|	medcode=="65029"|	medcode=="32508"|	medcode=="52411"|	medcode=="42127"|	medcode=="42684"|	medcode=="45291"|	medcode=="74890"|	medcode=="50886"|	medcode=="51941"|	medcode=="105037"|	medcode=="103039"|	medcode=="68784"|	medcode=="46176"|	medcode=="101307"|	medcode=="99649"|	medcode=="73663"|	medcode=="101520"|	medcode=="72655"|	medcode=="51675"|	medcode=="41197"|	medcode=="110026"|	medcode=="36606"|	medcode=="71874"|	medcode=="51911"|	medcode=="73554"|	medcode=="101322"|	medcode=="109008"|	medcode=="110047"|	medcode=="106644"|	medcode=="107639"|	medcode=="110418"|	medcode=="107496"|	medcode=="107710"|	medcode=="9384"|	medcode=="25089"|	medcode=="22383"|	medcode=="21966")

ext2clinHEART <- rbindlist(list(ext2clinHEART1, ext2clinHEART2), use.names = TRUE, fill = TRUE)

fwrite(ext2clinHEART, paste("P:/Comorbidities/ext2clinHEART.csv"))
ext2clinHEART <- fread("P:/Comorbidities/ext2clinHEART.csv")

#renal ext2
ext2clinRENAL<-subset(ext2clin, medcode=="12479"|	medcode=="12585"|	medcode=="95122"|	medcode=="95406"|	medcode=="95508"|	medcode=="95405"|	medcode=="2997"|	medcode=="55151"|	medcode=="11745"|	medcode=="24361"|	medcode=="89924"|	medcode=="96133"|	medcode=="109455"|	medcode=="105787"|	medcode=="70874"|	medcode=="5504"|	medcode=="31549"|	medcode=="20073"|	medcode=="2994"|	medcode=="2996"|	medcode=="71124"|	medcode=="88597"|	medcode=="30756"|	medcode=="64828"|	medcode=="48022"|	medcode=="64636"|	medcode=="56760"|	medcode=="8037"|	medcode=="23773"|	medcode=="104586"|	medcode=="59194"|	medcode=="83513"|	medcode=="30709"|	medcode=="107901"|	medcode=="65089"|	medcode=="102210"|	medcode=="30323"|	medcode=="26054"|	medcode=="26860"|	medcode=="109840"|	medcode=="2999"|	medcode=="9840"|	medcode=="1803"|	medcode=="99644"|	medcode=="29634"|	medcode=="23913"|	medcode=="22852"|	medcode=="19316"|	medcode=="21947"|	medcode=="50472"|	medcode=="21989"|	medcode=="56987"|	medcode=="17365"|	medcode=="63786"|	medcode=="72303"|	medcode=="108591"|	medcode=="110749"|	medcode=="111370"|	medcode=="108816"|	medcode=="47922"|	medcode=="2471"|	medcode=="99201"|	medcode=="58750"|	medcode=="94373"|	medcode=="27427"|	medcode=="65064"|	medcode=="512"|	medcode=="6712"|	medcode=="104963"|	medcode=="105151"|	medcode=="350"|	medcode=="105302"|	medcode=="61814"|	medcode=="71174"|	medcode=="97734"|	medcode=="41285"|	medcode=="58060"|	medcode=="109945"|	medcode=="50200"|	medcode=="62320"|	medcode=="8330"|	medcode=="100205"|	medcode=="61930"|	medcode=="11554"|	medcode=="5911"|	medcode=="53940"|	medcode=="108494")

fwrite(ext2clinRENAL, paste("P:/Comorbidities/ext2clinRENAL.csv"))
ext2clinRENAL <- fread("P:/Comorbidities/ext2clinRENAL.csv")

#liver ext2
ext2clinLIVER<-subset(ext2clin, medcode=="4405"|	medcode=="32025"|	medcode=="71422"|	medcode=="69194"|	medcode=="105506"|	medcode=="97157"|	medcode=="99250"|	medcode=="27319"|	medcode=="26367"|	medcode=="24813"|	medcode=="41096"|	medcode=="30586"|	medcode=="106642"|	medcode=="32277"|	medcode=="108343"|	medcode=="107896"|	medcode=="110454"|	medcode=="102922"|	medcode=="48211"|	medcode=="6863"|	medcode=="4743"|	medcode=="21713"|	medcode=="17330"|	medcode=="1754"|	medcode=="23578"|	medcode=="9029"|	medcode=="1755"|	medcode=="53480"|	medcode=="66534"|	medcode=="53877"|	medcode=="15489"|	medcode=="16725"|	medcode=="69204"|	medcode=="3450"|	medcode=="44676"|	medcode=="92909"|	medcode=="40567"|	medcode=="27438"|	medcode=="96664"|	medcode=="100253"|	medcode=="73482"|	medcode=="112044"|	medcode=="109540"|	medcode=="48928"|	medcode=="55454"|	medcode=="16455"|	medcode=="9494"|	medcode=="5638"|	medcode=="15424"|	medcode=="91591"|	medcode=="58630"|	medcode=="7602"|	medcode=="42843"|	medcode=="25383"|	medcode=="60104"|	medcode=="100592"|	medcode=="33597"|	medcode=="10539"|	medcode=="5129"|	medcode=="10636"|	medcode=="24901"|	medcode=="48102"|	medcode=="17219"|	medcode=="64750"|	medcode=="39351"|	medcode=="44120"|	medcode=="26405"|	medcode=="18652"|	medcode=="15425"|	medcode=="6015"|	medcode=="25597"|	medcode=="16417"|	medcode=="38389"|	medcode=="48269"|	medcode=="50400"|	medcode=="50444"|	medcode=="40029"|	medcode=="10721"|	medcode=="71422"|	medcode=="4405"|	medcode=="32025"|	medcode=="69194")

fwrite(ext2clinLIVER, paste("P:/Comorbidities/ext2clinLIVER.csv"))
ext2clinLIVER <- fread("P:/Comorbidities/ext2clinLIVER.csv")

#diabetes ext2
ext2clinDIABETES<-subset(ext2clin, medcode=="711"|	medcode=="43453"|	medcode=="36695"|	medcode=="1549"|	medcode=="47582"|	medcode=="47649"|	medcode=="42831"|	medcode=="47650"|	medcode=="43921"|	medcode=="18683"|	medcode=="69993"|	medcode=="18387"|	medcode=="35288"|	medcode=="40682"|	medcode=="69676"|	medcode=="68105"|	medcode=="46301"|	medcode=="10418"|	medcode=="39070"|	medcode=="49554"|	medcode=="93468"|	medcode=="18642"|	medcode=="54008"|	medcode=="30323"|	medcode=="30294"|	medcode=="10692"|	medcode=="40837"|	medcode=="22871"|	medcode=="55239"|	medcode=="95636"|	medcode=="758"|	medcode=="18777"|	medcode=="47321"|	medcode=="34268"|	medcode=="65267"|	medcode=="49074"|	medcode=="12736"|	medcode=="18496"|	medcode=="25627"|	medcode=="47954"|	medcode=="62674"|	medcode=="18425"|	medcode=="12640"|	medcode=="46917"|	medcode=="44982"|	medcode=="37806"|	medcode=="59253"|	medcode=="35385"|	medcode=="1407"|	medcode=="34450"|	medcode=="26054"|	medcode=="18390"|	medcode=="32627"|	medcode=="51756"|	medcode=="25591"|	medcode=="63690"|	medcode=="95539"|	medcode=="51697"|	medcode=="96506"|	medcode=="61122"|	medcode=="67212"|	medcode=="43857"|	medcode=="22487"|	medcode=="94383"|	medcode=="93380"|	medcode=="52212"|	medcode=="106927"|	medcode=="53200"|	medcode=="42567"|	medcode=="54856"|	medcode=="6791"|	medcode=="31310"|	medcode=="60499"|	medcode=="52104"|	medcode=="52283"|	medcode=="49276"|	medcode=="46963"|	medcode=="6509"|	medcode=="44443"|	medcode=="8403"|	medcode=="40401"|	medcode=="68843"|	medcode=="62146"|	medcode=="55842"|	medcode=="50429"|	medcode=="52303"|	medcode=="17262"|	medcode=="34912")

fwrite(ext2clinDIABETES, paste("P:/Comorbidities/ext2clinDIABETES.csv"))
ext2clinDIABETES <- fread("P:/Comorbidities/ext2clinDIABETES.csv")

#immunosuppression ext2
ext2clinIMMUNO1<-subset(ext2clin, medcode=="47106"|	medcode=="22307"|	medcode=="34310"|	medcode=="108246"|	medcode=="27514"|	medcode=="1393"|	medcode=="31041"|	medcode=="102966"|	medcode=="59784"|	medcode=="106015"|	medcode=="32133"|	medcode=="23770"|	medcode=="58857"|	medcode=="58859"|	medcode=="69766"|	medcode=="70869"|	medcode=="53636"|	medcode=="70528"|	medcode=="101836"|	medcode=="47632"|	medcode=="111979"|	medcode=="67575"|	medcode=="71450"|	medcode=="62891"|	medcode=="36294"|	medcode=="44303"|	medcode=="37006"|	medcode=="66368"|	medcode=="23951"|	medcode=="27641"|	medcode=="50076"|	medcode=="27853"|	medcode=="44617"|	medcode=="66367"|	medcode=="105324"|	medcode=="65117"|	medcode=="8281"|	medcode=="51708"|	medcode=="62854"|	medcode=="112030"|	medcode=="107807"|	medcode=="112031"|	medcode=="102117"|	medcode=="104134"|	medcode=="112032"|	medcode=="69767"|	medcode=="112034"|	medcode=="112035"|	medcode=="112036"|	medcode=="112037"|	medcode=="96751"|	medcode=="102252"|	medcode=="100769"|	medcode=="65460"|	medcode=="108667"|	medcode=="72224"|	medcode=="93778"|	medcode=="12323"|	medcode=="41369"|	medcode=="1481"|	medcode=="60242"|	medcode=="71031"|	medcode=="70374"|	medcode=="95058"|	medcode=="99240"|	medcode=="27416"|	medcode=="71625"|	medcode=="71238"|	medcode=="62380"|	medcode=="64670"|	medcode=="100352"|	medcode=="103245"|	medcode=="104790"|	medcode=="63723"|	medcode=="21402"|	medcode=="59115"|	medcode=="100006"|	medcode=="97577"|	medcode=="92380"|	medcode=="71304"|	medcode=="99887"|	medcode=="99951"|	medcode=="2462"|	medcode=="65489"|	medcode=="100423"|	medcode=="98840"|	medcode=="44196"|	medcode=="98909"|	medcode=="64036"|	medcode=="68039"|	medcode=="38939"|	medcode=="71142"|	medcode=="68330"|	medcode=="92245"|	medcode=="73532"|	medcode=="93951"|	medcode=="95338"|	medcode=="106911"|	medcode=="104743"|	medcode=="29876"|	medcode=="29178"|	medcode=="57225"|	medcode=="55303"|	medcode=="67506"|	medcode=="61149"|	medcode=="65483"|	medcode=="105472"|	medcode=="19140"|	medcode=="63054"|	medcode=="49605"|	medcode=="97863"|	medcode=="94407"|	medcode=="58684"|	medcode=="108886"|	medcode=="94005"|	medcode=="67703"|	medcode=="95049"|	medcode=="111942"|	medcode=="63625"|	medcode=="110563"|	medcode=="101715"|	medcode=="107032"|	medcode=="101530"|	medcode=="104895"|	medcode=="105841"|	medcode=="108775"|	medcode=="106597"|	medcode=="104484"|	medcode=="53397"|	medcode=="61662"|	medcode=="59778"|	medcode=="59755"|	medcode=="107804"|	medcode=="91900"|	medcode=="99012"|	medcode=="94279"|	medcode=="97746"|	medcode=="42461"|	medcode=="5179"|	medcode=="66327"|	medcode=="45264"|	medcode=="105203"|	medcode=="92068"|	medcode=="111766"|	medcode=="94995"|	medcode=="58082"|	medcode=="65701"|	medcode=="12006"|	medcode=="95949"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="38005"|	medcode=="35014"|	medcode=="100532"|	medcode=="27330"|	medcode=="65122"|	medcode=="65123"|	medcode=="73777"|	medcode=="34926"|	medcode=="102715"|	medcode=="102158"|	medcode=="54083"|	medcode=="47204"|	medcode=="15036"|	medcode=="103900"|	medcode=="100615"|	medcode=="31324"|	medcode=="89657"|	medcode=="3604"|	medcode=="28639"|	medcode=="70842"|	medcode=="49262"|	medcode=="50668"|	medcode=="108182"|	medcode=="50695"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="95715"|	medcode=="101114"|	medcode=="31576"|	medcode=="21549"|	medcode=="70509"|	medcode=="102594"|	medcode=="105966"|	medcode=="105038"|	medcode=="31794"|	medcode=="39798"|	medcode=="104152"|	medcode=="105889"|	medcode=="105095"|	medcode=="107166"|	medcode=="105020"|	medcode=="107973"|	medcode=="106969"|	medcode=="108719"|	medcode=="106063"|	medcode=="105792"|	medcode=="105335"|	medcode=="105559"|	medcode=="105955"|	medcode=="109780"|	medcode=="107949"|	medcode=="105709"|	medcode=="105925"|	medcode=="105375")
ext2clinIMMUNO2<-subset(ext2clin, medcode=="105636"|	medcode=="105286"|	medcode=="104934"|	medcode=="106884"|	medcode=="104386"|	medcode=="104620"|	medcode=="104412"|	medcode=="111682"|	medcode=="17887"|	medcode=="90201"|	medcode=="57737"|	medcode=="12464"|	medcode=="44318"|	medcode=="12335"|	medcode=="57427"|	medcode=="50696"|	medcode=="72725"|	medcode=="42579"|	medcode=="34089"|	medcode=="63105"|	medcode=="71262"|	medcode=="60092"|	medcode=="15504"|	medcode=="15027"|	medcode=="65434"|	medcode=="37182"|	medcode=="4944"|	medcode=="22158"|	medcode=="19028"|	medcode=="21329"|	medcode=="46042"|	medcode=="104418"|	medcode=="39187"|	medcode=="64567"|	medcode=="43450"|	medcode=="19372"|	medcode=="4251"|	medcode=="104325"|	medcode=="8625"|	medcode=="104328"|	medcode=="107052"|	medcode=="106924"|	medcode=="107163"|	medcode=="72774"|	medcode=="49725"|	medcode=="31586"|	medcode=="37461"|	medcode=="108656"|	medcode=="107643"|	medcode=="104939"|	medcode=="38331"|	medcode=="38914"|	medcode=="7176"|	medcode=="4413"|	medcode=="10726"|	medcode=="100786"|	medcode=="105957"|	medcode=="102783"|	medcode=="107236"|	medcode=="27520"|	medcode=="63475"|	medcode=="70724"|	medcode=="52327"|	medcode=="39629"|	medcode=="104788"|	medcode=="112440"|	medcode=="27664"|	medcode=="66089"|	medcode=="33344"|	medcode=="35875"|	medcode=="19974"|	medcode=="27458"|	medcode=="101606"|	medcode=="108424"|	medcode=="99015"|	medcode=="103645"|	medcode=="93342"|	medcode=="37272"|	medcode=="42539"|	medcode=="37468"|	medcode=="57671"|	medcode=="65721"|	medcode=="50858"|	medcode=="28276"|	medcode=="110838"|	medcode=="104273"|	medcode=="94174"|	medcode=="72197"|	medcode=="99413"|	medcode=="30632"|	medcode=="25191"|	medcode=="4072"|	medcode=="16416"|	medcode=="54793"|	medcode=="34692"|	medcode=="4250"|	medcode=="20440"|	medcode=="61500"|	medcode=="22050"|	medcode=="104475"|	medcode=="105069"|	medcode=="30646"|	medcode=="6115"|	medcode=="39336"|	medcode=="49301"|	medcode=="25493"|	medcode=="2481"|	medcode=="11950"|	medcode=="106993"|	medcode=="104740"|	medcode=="105915"|	medcode=="45285"|	medcode=="46444"|	medcode=="70935"|	medcode=="40740"|	medcode=="43415"|	medcode=="67518"|	medcode=="98596"|	medcode=="64336"|	medcode=="102688"|	medcode=="67029"|	medcode=="61693"|	medcode=="89762"|	medcode=="89329"|	medcode=="65165"|	medcode=="105025"|	medcode=="72500"|	medcode=="64515"|	medcode=="109714"|	medcode=="63375"|	medcode=="8649"|	medcode=="45143"|	medcode=="69545"|	medcode=="15883"|	medcode=="106381"|	medcode=="3451"|	medcode=="12306"|	medcode=="12386"|	medcode=="16527"|	medcode=="10411"|	medcode=="101350"|	medcode=="99067"|	medcode=="108102"|	medcode=="71994"|	medcode=="18486"|	medcode=="51041"|	medcode=="27934"|	medcode=="104554"|	medcode=="110183"|	medcode=="44147"|	medcode=="15137"|	medcode=="8548"|	medcode=="18701"|	medcode=="18700"|	medcode=="68440"|	medcode=="57161"|	medcode=="69373"|	medcode=="57322"|	medcode=="92569"|	medcode=="62598"|	medcode=="69184"|	medcode=="60026"|	medcode=="69854"|	medcode=="16295"|	medcode=="48307"|	medcode=="50665"|	medcode=="31322"|	medcode=="62236"|	medcode=="48293"|	medcode=="31541"|	medcode=="66073"|	medcode=="49542"|	medcode=="50526"|	medcode=="103977"|	medcode=="62328"|	medcode=="3129"|	medcode=="65617"|	medcode=="56108"|	medcode=="54203"|	medcode=="21975"|	medcode=="93892"|	medcode=="66857"|	medcode=="36408"|	medcode=="109671"|	medcode=="54904"|	medcode=="63204"|	medcode=="32141"|	medcode=="91911"|	medcode=="66049"|	medcode=="40950"|	medcode=="18781"| medcode=="38306"|	medcode=="39034"|	medcode=="34150"|	medcode=="5572"|	medcode=="2337"|	medcode=="41185"|	medcode=="73583"|	medcode=="12699"|	medcode=="5655"|	medcode=="66740"|	medcode=="27515"|	medcode=="51640"|	medcode=="32270"|	medcode=="57551"|	medcode=="95005"|	medcode=="39420"|	medcode=="61069"|	medcode=="56973"|	medcode=="47695"|	medcode=="65825")
ext2clinIMMUNO3<-subset(ext2clin, medcode=="63323"|	medcode=="53317"|	medcode=="20261"|	medcode=="11346"|	medcode=="100043"|	medcode=="52604"|	medcode=="57525"|	medcode=="40406"|	medcode=="70236"|	medcode=="62041"|	medcode=="22319"|	medcode=="101375"|	medcode=="101075"|	medcode=="4072"|	medcode=="4251"|	medcode=="19974"|	medcode=="4413"|	medcode=="50858"|	medcode=="27664"|	medcode=="37461"|	medcode=="52327"|	medcode=="100786"|	medcode=="16416"|	medcode=="8625"|	medcode=="27458"|	medcode=="10726"|	medcode=="27520"|	medcode=="22050"|	medcode=="102783"|	medcode=="50668"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="21549"|	medcode=="70842"|	medcode=="99067"|	medcode=="39629"|	medcode=="27330"|	medcode=="53397"|	medcode=="107804"|	medcode=="59755"|	medcode=="91900"|	medcode=="59778"|	medcode=="99012"|	medcode=="97746"|	medcode=="94279"|	medcode=="61662"|	medcode=="67703"|	medcode=="101530"|	medcode=="63625"|	medcode=="111942"|	medcode=="110563"|	medcode=="107032"|	medcode=="101715"|	medcode=="73532"|	medcode=="95338"|	medcode=="92245"|	medcode=="68330"|	medcode=="93951"|	medcode=="104743"|	medcode=="71142"|	medcode=="49605"|	medcode=="94005"|	medcode=="58684"|	medcode=="94407"|	medcode=="108886"|	medcode=="97863"|	medcode=="29178"|	medcode=="63054"|	medcode=="61149"|	medcode=="67506"|	medcode=="65483"|	medcode=="55303"|	medcode=="19140"|	medcode=="105472"|	medcode=="57225"|	medcode=="95049"|	medcode=="64036"|	medcode=="68039"|	medcode=="29876"|	medcode=="106911"|	medcode=="43450"|	medcode=="34926"|	medcode=="47204"|	medcode=="102158"|	medcode=="54083"|	medcode=="102715"|	medcode=="4250"|	medcode=="25191"|	medcode=="73777"|	medcode=="65123"|	medcode=="65122"|	medcode=="38939"|	medcode=="19372"|	medcode=="38914"|	medcode=="72197"|	medcode=="16527"|	medcode=="71994"|	medcode=="50695"|	medcode=="108182"|	medcode=="12335"|	medcode=="42579"|	medcode=="71262"|	medcode=="72725"|	medcode=="34089"|	medcode=="50696"|	medcode=="63105"|	medcode=="15504"|	medcode=="60092"|	medcode=="57427"|	medcode=="17887"|	medcode=="89657"|	medcode=="15036"|	medcode=="49301"|	medcode=="30646"|	medcode=="65434"|	medcode=="22158"|	medcode=="65721"|	medcode=="100615"|	medcode=="31324"|	medcode=="103900"|	medcode=="57671"|	medcode=="15883"|	medcode=="35875"|	medcode=="93342"|	medcode=="37182"|	medcode=="12006"|	medcode=="38005"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="95949"|	medcode=="7176"|	medcode=="33344"|	medcode=="70724"|	medcode=="4944"|	medcode=="20440"|	medcode=="25493"|	medcode=="65701"|	medcode=="92068"|	medcode=="105203"|	medcode=="111766"|	medcode=="45264"|	medcode=="94995"|	medcode=="58082"|	medcode=="66327"|	medcode=="3604"|	medcode=="94174"|	medcode=="99413"|	medcode=="64567"|	medcode=="34692"|	medcode=="49725"|	medcode=="38331"|	medcode=="99015"|	medcode=="103645"|	medcode=="112440"|	medcode=="66089"|	medcode=="3451"|	medcode=="37272"|	medcode=="30632"|	medcode=="31576"|	medcode=="12386"|	medcode=="2481"|	medcode=="31586"|	medcode=="35014"|	medcode=="100532"|	medcode=="54793"|	medcode=="72774"|	medcode=="101606"|	medcode=="63475"|	medcode=="104475"|	medcode=="10411"|	medcode=="5019"|	medcode=="102559"|	medcode=="59610"|	medcode=="105256"|	medcode=="31489"|	medcode=="10505")

ext2clinIMMUNO <- rbindlist(list(ext2clinIMMUNO1, ext2clinIMMUNO2, ext2clinIMMUNO3), use.names = TRUE, fill = TRUE)

fwrite(ext2clinIMMUNO, paste("P:/Comorbidities/ext2clinIMMUNO.csv"))
ext2clinIMMUNO <- fread("P:/Comorbidities/ext2clinIMMUNO.csv")

#csf leaks and cochear ext2
ext2clinCSF<-subset(ext2clin, medcode=="30525"|	medcode=="43643"|	medcode=="42441"|	medcode=="36513"|	medcode=="20641"|	medcode=="26158"|	medcode=="40348"|	medcode=="20488"|	medcode=="27295"|	medcode=="35762"|	medcode=="16172"|	medcode=="9300"|	medcode=="17957"|	medcode=="36424"|	medcode=="97074"|	medcode=="55931"|	medcode=="33396"|	medcode=="48851"|	medcode=="71772"|	medcode=="41393"|	medcode=="54342"|	medcode=="10708"|	medcode=="61980"|	medcode=="98472"|	medcode=="57642"|	medcode=="74897")

fwrite(ext2clinCSF, paste("P:/Comorbidities/ext2clinCSF.csv"))
ext2clinCSF <- fread("P:/Comorbidities/ext2clinCSF.csv")

#bind all
ext2clinALL <- rbindlist(list(ext2clinRESP, ext2clinHEART, ext2clinRENAL, ext2clinLIVER, ext2clinDIABETES, ext2clinIMMUNO, ext2clinCSF), use.names = TRUE, fill = TRUE)

fwrite(ext2clinALL, paste("P:/Comorbidities/ext2clinALL.csv"))
ext2clinALL <- fread("P:/Comorbidities/ext2clinALL.csv")


#ext3
ext3clin1 <- fread("P:/CPRD_mother_baby_GOLD/ext3/Clinical/ext3_Extract_Clinical_001.txt")
ext3clin2 <- fread("P:/CPRD_mother_baby_GOLD/ext3/Clinical/ext3_Extract_Clinical_002.txt")
ext3clin3 <- fread("P:/CPRD_mother_baby_GOLD/ext3/Clinical/ext3_Extract_Clinical_003.txt")
ext3clin4 <- fread("P:/CPRD_mother_baby_GOLD/ext3/Clinical/ext3_Extract_Clinical_004.txt")
ext3clin5 <- fread("P:/CPRD_mother_baby_GOLD/ext3/Clinical/ext3_Extract_Clinical_005.txt")
ext3clin6 <- fread("P:/CPRD_mother_baby_GOLD/ext3/Clinical/ext3_Extract_Clinical_006.txt")

ext3clin <- rbindlist(list(ext3clin1, ext3clin2, ext3clin3, ext3clin4, ext3clin5, ext3clin6), use.names = TRUE, fill = TRUE)

#resp ext3
ext3clinRESP<-subset(ext3clin, medcode=="10461"|	medcode=="96578"|	medcode=="93713"|	medcode=="73743"|	medcode=="38011"|	medcode=="15693"|	medcode=="65117"|	medcode=="100742"|	medcode=="33980"|	medcode=="58841"|	medcode=="93380"|	medcode=="29966"|	medcode=="6220"|	medcode=="65344"|	medcode=="69017"|	medcode=="18914"|	medcode=="18905"|	medcode=="100610"|	medcode=="103224"|	medcode=="110454"|	medcode=="102922"|	medcode=="106432"|	medcode=="73065"|	medcode=="49770"|	medcode=="1001"|	medcode=="148"|	medcode=="152"|	medcode=="3480"|	medcode=="3243"|	medcode=="25603"|	medcode=="15626"|	medcode=="61118"|	medcode=="11150"|	medcode=="40159"|	medcode=="37959"|	medcode=="61513"|	medcode=="27819"|	medcode=="5798"|	medcode=="14798"|	medcode=="1446"|	medcode=="26125"|	medcode=="44525"|	medcode=="24248"|	medcode=="66043"|	medcode=="45089"|	medcode=="68066"|	medcode=="15157"|	medcode=="794"|	medcode=="26306"|	medcode=="56860"|	medcode=="68662"|	medcode=="60188"|	medcode=="99536"|	medcode=="23492"|	medcode=="46578"|	medcode=="10980"|	medcode=="40788"|	medcode=="92955"|	medcode=="70787"|	medcode=="63479"|	medcode=="16410"|	medcode=="33450"|	medcode=="106805"|	medcode=="2195"|	medcode=="20364"|	medcode=="41491"|	medcode=="32679"|	medcode=="10863"|	medcode=="10802"|	medcode=="9876"|	medcode=="93568"|	medcode=="104608"|	medcode=="12166"|	medcode=="21061"|	medcode=="7884"|	medcode=="5710"|	medcode=="19492"|	medcode=="8303"|	medcode=="51410"|	medcode=="46460"|	medcode=="60805"|	medcode=="62233"|	medcode=="71853"|	medcode=="89206"|	medcode=="23446"|	medcode=="65376"|	medcode=="94894"|	medcode=="49194"|	medcode=="94575"|	medcode=="30235"|	medcode=="93577"|	medcode=="23461"|	medcode=="37365"|	medcode=="26442"|	medcode=="31423"|	medcode=="63172"|	medcode=="54830"|	medcode=="49025"|	medcode=="55758"|	medcode=="62227"|	medcode=="47142"|	medcode=="64721"|	medcode=="63216"|	medcode=="47782"|	medcode=="70815"|	medcode=="104557"|	medcode=="9711"|	medcode=="3847"|	medcode=="41781"|	medcode=="59083"|	medcode=="66104"|	medcode=="45948"|	medcode=="33837"|	medcode=="56647"|	medcode=="41015"|	medcode=="66773"|	medcode=="50876"|	medcode=="47504"|	medcode=="54252"|	medcode=="46066"|	medcode=="43285"|	medcode=="18130"|	medcode=="69914"|	medcode=="22536"|	medcode=="50374"|	medcode=="44015"|	medcode=="53205"|	medcode=="43417"|	medcode=="30214"|	medcode=="38297"|	medcode=="46405"|	medcode=="26082"|	medcode=="7321"|	medcode=="61229"|	medcode=="7791"|	medcode=="31806"|	medcode=="61119"|	medcode=="27348"|	medcode=="68814"|	medcode=="6837"|	medcode=="94136"|	medcode=="6051"|	medcode=="103472"|	medcode=="103559"|	medcode=="28229"|	medcode=="22835"|	medcode=="54308"|	medcode=="61991"|	medcode=="33830"|	medcode=="15815"|	medcode=="64799"|	medcode=="94996"|	medcode=="58791"|	medcode=="54010"|	medcode=="42940"|	medcode=="3859"|	medcode=="47364"|	medcode=="31564"|	medcode=="96655"|	medcode=="63912"|	medcode=="22905"|	medcode=="54893"|	medcode=="22915"|	medcode=="31319"|	medcode=="106650"|	medcode=="20269"|	medcode=="558"|	medcode=="39706"|	medcode=="5293"|	medcode=="65000"|	medcode=="93880"|	medcode=="72221"|	medcode=="96754"|	medcode=="24848"|	medcode=="24466"|	medcode=="99158"|	medcode=="8317"|	medcode=="103785"|	medcode=="109815"|	medcode=="104915"|	medcode=="24814"|	medcode=="94946"|	medcode=="94486"|	medcode=="59188"|	medcode=="66058"|	medcode=="65733"|	medcode=="105939"|	medcode=="106515"|	medcode=="99232"|	medcode=="105628"|	medcode=="54706"|	medcode=="65060"|	medcode=="91912"|	medcode=="71906"|	medcode=="56427"|	medcode=="38298"|	medcode=="94925"|	medcode=="6883"|	medcode=="93098"|	medcode=="13563")

fwrite(ext3clinRESP, paste("P:/Comorbidities/ext3clinRESP.csv"))
ext3clinRESP <- fread("P:/Comorbidities/ext3clinRESP.csv")

#heart ext3
ext3clinHEART1<-subset(ext3clin, medcode=="11284"|	medcode=="19066"|	medcode=="51214"|	medcode=="250"|	medcode=="53626"|	medcode=="61073"|	medcode=="4438"|	medcode=="242"|	medcode=="72939"|	medcode=="58529"|	medcode=="107416"|	medcode=="70105"|	medcode=="93844"|	medcode=="69734"|	medcode=="41495"|	medcode=="22262"|	medcode=="16292"|	medcode=="50157"|	medcode=="95334"|	medcode=="72668"|	medcode=="103046"|	medcode=="52427"|	medcode=="61660"|	medcode=="52127"|	medcode=="105938"|	medcode=="31464"|	medcode=="61166"|	medcode=="62718"|	medcode=="16173"|	medcode=="240"|	medcode=="241"|	medcode=="12139"|	medcode=="5387"|	medcode=="40429"|	medcode=="17872"|	medcode=="14897"|	medcode=="8935"|	medcode=="29643"|	medcode=="23892"|	medcode=="14898"|	medcode=="63467"|	medcode=="3704"|	medcode=="9507"|	medcode=="10562"|	medcode=="1678"|	medcode=="30330"|	medcode=="32854"|	medcode=="29758"|	medcode=="12229"|	medcode=="34803"|	medcode=="28736"|	medcode=="62626"|	medcode=="41221"|	medcode=="46017"|	medcode=="14658"|	medcode=="27951"|	medcode=="36523"|	medcode=="61072"|	medcode=="7347"|	medcode=="17307"|	medcode=="34328"|	medcode=="18118"|	medcode=="11983"|	medcode=="54251"|	medcode=="39449"|	medcode=="9413"|	medcode=="9276"|	medcode=="68357"|	medcode=="39693"|	medcode=="21844"|	medcode=="27977"|	medcode=="4017"|	medcode=="1430"|	medcode=="20095"|	medcode=="18125"|	medcode=="29902"|	medcode=="25842"|	medcode=="66388"|	medcode=="54535"|	medcode=="7696"|	medcode=="1414"|	medcode=="32450"|	medcode=="9555"|	medcode=="26863"|	medcode=="12804"|	medcode=="28554"|	medcode=="28138"|	medcode=="5413"|	medcode=="3999"|	medcode=="5254"|	medcode=="36609"|	medcode=="7320"|	medcode=="29421"|	medcode=="34633"|	medcode=="24540"|	medcode=="23078"|	medcode=="35713"|	medcode=="15754"|	medcode=="18889"|	medcode=="18842"|	medcode=="45809"|	medcode=="38609"|	medcode=="72562"|	medcode=="46166"|	medcode=="32272"|	medcode=="46112"|	medcode=="46276"|	medcode=="106812"|	medcode=="41835"|	medcode=="68748"|	medcode=="105479"|	medcode=="1676"|	medcode=="2062"|	medcode=="398"|	medcode=="23707"|	medcode=="32671"|	medcode=="27884"|	medcode=="11424"|	medcode=="94870"|	medcode=="884"|	medcode=="5255"|	medcode=="27964"|	medcode=="101138"|	medcode=="104275"|	medcode=="4024"|	medcode=="8966"|	medcode=="107397"|	medcode=="52517"|	medcode=="39546"|	medcode=="68401"|	medcode=="47637"|	medcode=="96838"|	medcode=="109035"|	medcode=="99991"|	medcode=="31518"|	medcode=="4964"|	medcode=="72604"|	medcode=="45505"|	medcode=="66245"|	medcode=="94344"|	medcode=="2816"|	medcode=="69858"|	medcode=="1778"|	medcode=="23988"|	medcode=="102980"|	medcode=="40025"|	medcode=="65318"|	medcode=="63390"|	medcode=="62169"|	medcode=="73539"|	medcode=="4864"|	medcode=="38967"|	medcode=="51649"|	medcode=="63046"|	medcode=="19969"|	medcode=="246"|	medcode=="42132"|	medcode=="56575"|	medcode=="67657"|	medcode=="9011"|	medcode=="51897"|	medcode=="20153"|	medcode=="54772"|	medcode=="34067"|	medcode=="7474"|	medcode=="3255"|	medcode=="3625"|	medcode=="37816"|	medcode=="59144"|	medcode=="53088"|	medcode=="54243"|	medcode=="63340"|	medcode=="51053"|	medcode=="101393"|	medcode=="49702"|	medcode=="55535"|	medcode=="43049"|	medcode=="44896"|	medcode=="73816"|	medcode=="46117"|	medcode=="9361"|	medcode=="48205"|	medcode=="66401"|	medcode=="54196"|	medcode=="5621"|	medcode=="39992"|	medcode=="69940"|	medcode=="3862"|	medcode=="54488"|	medcode=="93561"|	medcode=="22778"|	medcode=="112420"|	medcode=="45452"|	medcode=="33919"|	medcode=="21851"|	medcode=="44478"|	medcode=="107150"|	medcode=="52607"|	medcode=="70880"|	medcode=="12752"|	medcode=="21272"|	medcode=="69169"|	medcode=="100065"|	medcode=="23709"|	medcode=="6886"|	medcode=="8636"|	medcode=="58734"|	medcode=="3300"|	medcode=="6843"|	medcode=="57091"|	medcode=="90551"|	medcode=="73592"|	medcode=="63069")
ext3clinHEART2<-subset(ext3clin, medcode=="100291"|	medcode=="61651"|	medcode=="20772"|	medcode=="89256"|	medcode=="108457"|	medcode=="46825"|	medcode=="50529"|	medcode=="24789"|	medcode=="16539"|	medcode=="34668"|	medcode=="9401"|	medcode=="99128"|	medcode=="32748"|	medcode=="104266"|	medcode=="97818"|	medcode=="25481"|	medcode=="71956"|	medcode=="62163"|	medcode=="103894"|	medcode=="31373"|	medcode=="49901"|	medcode=="103412"|	medcode=="53546"|	medcode=="24533"|	medcode=="68097"|	medcode=="52310"|	medcode=="102167"|	medcode=="70992"|	medcode=="71678"|	medcode=="3774"|	medcode=="72259"|	medcode=="72405"|	medcode=="50284"|	medcode=="103584"|	medcode=="92426"|	medcode=="52615"|	medcode=="98061"|	medcode=="24854"|	medcode=="93089"|	medcode=="68063"|	medcode=="34007"|	medcode=="49133"|	medcode=="50362"|	medcode=="68894"|	medcode=="108193"|	medcode=="37451"|	medcode=="23752"|	medcode=="95785"|	medcode=="111360"|	medcode=="98317"|	medcode=="24714"|	medcode=="247"|	medcode=="26626"|	medcode=="109236"|	medcode=="103432"|	medcode=="64778"|	medcode=="38968"|	medcode=="3863"|	medcode=="11982"|	medcode=="3301"|	medcode=="57932"|	medcode=="72295"|	medcode=="70853"|	medcode=="37323"|	medcode=="59907"|	medcode=="50220"|	medcode=="62230"|	medcode=="30725"|	medcode=="67286"|	medcode=="30949"|	medcode=="46530"|	medcode=="49731"|	medcode=="44334"|	medcode=="90486"|	medcode=="70691"|	medcode=="34176"|	medcode=="68198"|	medcode=="59298"|	medcode=="37515"|	medcode=="63768"|	medcode=="53964"|	medcode=="62376"|	medcode=="58076"|	medcode=="44781"|	medcode=="49474"|	medcode=="56200"|	medcode=="11945"|	medcode=="11127"|	medcode=="63187"|	medcode=="67928"|	medcode=="31112"|	medcode=="18982"|	medcode=="54487"|	medcode=="2670"|	medcode=="96225"|	medcode=="65029"|	medcode=="32508"|	medcode=="52411"|	medcode=="42127"|	medcode=="42684"|	medcode=="45291"|	medcode=="74890"|	medcode=="50886"|	medcode=="51941"|	medcode=="105037"|	medcode=="103039"|	medcode=="68784"|	medcode=="46176"|	medcode=="101307"|	medcode=="99649"|	medcode=="73663"|	medcode=="101520"|	medcode=="72655"|	medcode=="51675"|	medcode=="41197"|	medcode=="110026"|	medcode=="36606"|	medcode=="71874"|	medcode=="51911"|	medcode=="73554"|	medcode=="101322"|	medcode=="109008"|	medcode=="110047"|	medcode=="106644"|	medcode=="107639"|	medcode=="110418"|	medcode=="107496"|	medcode=="107710"|	medcode=="9384"|	medcode=="25089"|	medcode=="22383"|	medcode=="21966")

ext3clinHEART <- rbindlist(list(ext3clinHEART1, ext3clinHEART2), use.names = TRUE, fill = TRUE)

fwrite(ext3clinHEART, paste("P:/Comorbidities/ext3clinHEART.csv"))
ext3clinHEART <- fread("P:/Comorbidities/ext3clinHEART.csv")

#renal ext3
ext3clinRENAL<-subset(ext3clin, medcode=="12479"|	medcode=="12585"|	medcode=="95122"|	medcode=="95406"|	medcode=="95508"|	medcode=="95405"|	medcode=="2997"|	medcode=="55151"|	medcode=="11745"|	medcode=="24361"|	medcode=="89924"|	medcode=="96133"|	medcode=="109455"|	medcode=="105787"|	medcode=="70874"|	medcode=="5504"|	medcode=="31549"|	medcode=="20073"|	medcode=="2994"|	medcode=="2996"|	medcode=="71124"|	medcode=="88597"|	medcode=="30756"|	medcode=="64828"|	medcode=="48022"|	medcode=="64636"|	medcode=="56760"|	medcode=="8037"|	medcode=="23773"|	medcode=="104586"|	medcode=="59194"|	medcode=="83513"|	medcode=="30709"|	medcode=="107901"|	medcode=="65089"|	medcode=="102210"|	medcode=="30323"|	medcode=="26054"|	medcode=="26860"|	medcode=="109840"|	medcode=="2999"|	medcode=="9840"|	medcode=="1803"|	medcode=="99644"|	medcode=="29634"|	medcode=="23913"|	medcode=="22852"|	medcode=="19316"|	medcode=="21947"|	medcode=="50472"|	medcode=="21989"|	medcode=="56987"|	medcode=="17365"|	medcode=="63786"|	medcode=="72303"|	medcode=="108591"|	medcode=="110749"|	medcode=="111370"|	medcode=="108816"|	medcode=="47922"|	medcode=="2471"|	medcode=="99201"|	medcode=="58750"|	medcode=="94373"|	medcode=="27427"|	medcode=="65064"|	medcode=="512"|	medcode=="6712"|	medcode=="104963"|	medcode=="105151"|	medcode=="350"|	medcode=="105302"|	medcode=="61814"|	medcode=="71174"|	medcode=="97734"|	medcode=="41285"|	medcode=="58060"|	medcode=="109945"|	medcode=="50200"|	medcode=="62320"|	medcode=="8330"|	medcode=="100205"|	medcode=="61930"|	medcode=="11554"|	medcode=="5911"|	medcode=="53940"|	medcode=="108494")

fwrite(ext3clinRENAL, paste("P:/Comorbidities/ext3clinRENAL.csv"))
ext3clinRENAL <- fread("P:/Comorbidities/ext3clinRENAL.csv")

#liver ext3
ext3clinLIVER<-subset(ext3clin, medcode=="4405"|	medcode=="32025"|	medcode=="71422"|	medcode=="69194"|	medcode=="105506"|	medcode=="97157"|	medcode=="99250"|	medcode=="27319"|	medcode=="26367"|	medcode=="24813"|	medcode=="41096"|	medcode=="30586"|	medcode=="106642"|	medcode=="32277"|	medcode=="108343"|	medcode=="107896"|	medcode=="110454"|	medcode=="102922"|	medcode=="48211"|	medcode=="6863"|	medcode=="4743"|	medcode=="21713"|	medcode=="17330"|	medcode=="1754"|	medcode=="23578"|	medcode=="9029"|	medcode=="1755"|	medcode=="53480"|	medcode=="66534"|	medcode=="53877"|	medcode=="15489"|	medcode=="16725"|	medcode=="69204"|	medcode=="3450"|	medcode=="44676"|	medcode=="92909"|	medcode=="40567"|	medcode=="27438"|	medcode=="96664"|	medcode=="100253"|	medcode=="73482"|	medcode=="112044"|	medcode=="109540"|	medcode=="48928"|	medcode=="55454"|	medcode=="16455"|	medcode=="9494"|	medcode=="5638"|	medcode=="15424"|	medcode=="91591"|	medcode=="58630"|	medcode=="7602"|	medcode=="42843"|	medcode=="25383"|	medcode=="60104"|	medcode=="100592"|	medcode=="33597"|	medcode=="10539"|	medcode=="5129"|	medcode=="10636"|	medcode=="24901"|	medcode=="48102"|	medcode=="17219"|	medcode=="64750"|	medcode=="39351"|	medcode=="44120"|	medcode=="26405"|	medcode=="18652"|	medcode=="15425"|	medcode=="6015"|	medcode=="25597"|	medcode=="16417"|	medcode=="38389"|	medcode=="48269"|	medcode=="50400"|	medcode=="50444"|	medcode=="40029"|	medcode=="10721"|	medcode=="71422"|	medcode=="4405"|	medcode=="32025"|	medcode=="69194")

fwrite(ext3clinLIVER, paste("P:/Comorbidities/ext3clinLIVER.csv"))
ext3clinLIVER <- fread("P:/Comorbidities/ext3clinLIVER.csv")

#diabetes ext3
ext3clinDIABETES<-subset(ext3clin, medcode=="711"|	medcode=="43453"|	medcode=="36695"|	medcode=="1549"|	medcode=="47582"|	medcode=="47649"|	medcode=="42831"|	medcode=="47650"|	medcode=="43921"|	medcode=="18683"|	medcode=="69993"|	medcode=="18387"|	medcode=="35288"|	medcode=="40682"|	medcode=="69676"|	medcode=="68105"|	medcode=="46301"|	medcode=="10418"|	medcode=="39070"|	medcode=="49554"|	medcode=="93468"|	medcode=="18642"|	medcode=="54008"|	medcode=="30323"|	medcode=="30294"|	medcode=="10692"|	medcode=="40837"|	medcode=="22871"|	medcode=="55239"|	medcode=="95636"|	medcode=="758"|	medcode=="18777"|	medcode=="47321"|	medcode=="34268"|	medcode=="65267"|	medcode=="49074"|	medcode=="12736"|	medcode=="18496"|	medcode=="25627"|	medcode=="47954"|	medcode=="62674"|	medcode=="18425"|	medcode=="12640"|	medcode=="46917"|	medcode=="44982"|	medcode=="37806"|	medcode=="59253"|	medcode=="35385"|	medcode=="1407"|	medcode=="34450"|	medcode=="26054"|	medcode=="18390"|	medcode=="32627"|	medcode=="51756"|	medcode=="25591"|	medcode=="63690"|	medcode=="95539"|	medcode=="51697"|	medcode=="96506"|	medcode=="61122"|	medcode=="67212"|	medcode=="43857"|	medcode=="22487"|	medcode=="94383"|	medcode=="93380"|	medcode=="52212"|	medcode=="106927"|	medcode=="53200"|	medcode=="42567"|	medcode=="54856"|	medcode=="6791"|	medcode=="31310"|	medcode=="60499"|	medcode=="52104"|	medcode=="52283"|	medcode=="49276"|	medcode=="46963"|	medcode=="6509"|	medcode=="44443"|	medcode=="8403"|	medcode=="40401"|	medcode=="68843"|	medcode=="62146"|	medcode=="55842"|	medcode=="50429"|	medcode=="52303"|	medcode=="17262"|	medcode=="34912")

fwrite(ext3clinDIABETES, paste("P:/Comorbidities/ext3clinDIABETES.csv"))
ext3clinDIABETES <- fread("P:/Comorbidities/ext3clinDIABETES.csv")

#immunosuppression ext3
ext3clinIMMUNO1<-subset(ext3clin, medcode=="47106"|	medcode=="22307"|	medcode=="34310"|	medcode=="108246"|	medcode=="27514"|	medcode=="1393"|	medcode=="31041"|	medcode=="102966"|	medcode=="59784"|	medcode=="106015"|	medcode=="32133"|	medcode=="23770"|	medcode=="58857"|	medcode=="58859"|	medcode=="69766"|	medcode=="70869"|	medcode=="53636"|	medcode=="70528"|	medcode=="101836"|	medcode=="47632"|	medcode=="111979"|	medcode=="67575"|	medcode=="71450"|	medcode=="62891"|	medcode=="36294"|	medcode=="44303"|	medcode=="37006"|	medcode=="66368"|	medcode=="23951"|	medcode=="27641"|	medcode=="50076"|	medcode=="27853"|	medcode=="44617"|	medcode=="66367"|	medcode=="105324"|	medcode=="65117"|	medcode=="8281"|	medcode=="51708"|	medcode=="62854"|	medcode=="112030"|	medcode=="107807"|	medcode=="112031"|	medcode=="102117"|	medcode=="104134"|	medcode=="112032"|	medcode=="69767"|	medcode=="112034"|	medcode=="112035"|	medcode=="112036"|	medcode=="112037"|	medcode=="96751"|	medcode=="102252"|	medcode=="100769"|	medcode=="65460"|	medcode=="108667"|	medcode=="72224"|	medcode=="93778"|	medcode=="12323"|	medcode=="41369"|	medcode=="1481"|	medcode=="60242"|	medcode=="71031"|	medcode=="70374"|	medcode=="95058"|	medcode=="99240"|	medcode=="27416"|	medcode=="71625"|	medcode=="71238"|	medcode=="62380"|	medcode=="64670"|	medcode=="100352"|	medcode=="103245"|	medcode=="104790"|	medcode=="63723"|	medcode=="21402"|	medcode=="59115"|	medcode=="100006"|	medcode=="97577"|	medcode=="92380"|	medcode=="71304"|	medcode=="99887"|	medcode=="99951"|	medcode=="2462"|	medcode=="65489"|	medcode=="100423"|	medcode=="98840"|	medcode=="44196"|	medcode=="98909"|	medcode=="64036"|	medcode=="68039"|	medcode=="38939"|	medcode=="71142"|	medcode=="68330"|	medcode=="92245"|	medcode=="73532"|	medcode=="93951"|	medcode=="95338"|	medcode=="106911"|	medcode=="104743"|	medcode=="29876"|	medcode=="29178"|	medcode=="57225"|	medcode=="55303"|	medcode=="67506"|	medcode=="61149"|	medcode=="65483"|	medcode=="105472"|	medcode=="19140"|	medcode=="63054"|	medcode=="49605"|	medcode=="97863"|	medcode=="94407"|	medcode=="58684"|	medcode=="108886"|	medcode=="94005"|	medcode=="67703"|	medcode=="95049"|	medcode=="111942"|	medcode=="63625"|	medcode=="110563"|	medcode=="101715"|	medcode=="107032"|	medcode=="101530"|	medcode=="104895"|	medcode=="105841"|	medcode=="108775"|	medcode=="106597"|	medcode=="104484"|	medcode=="53397"|	medcode=="61662"|	medcode=="59778"|	medcode=="59755"|	medcode=="107804"|	medcode=="91900"|	medcode=="99012"|	medcode=="94279"|	medcode=="97746"|	medcode=="42461"|	medcode=="5179"|	medcode=="66327"|	medcode=="45264"|	medcode=="105203"|	medcode=="92068"|	medcode=="111766"|	medcode=="94995"|	medcode=="58082"|	medcode=="65701"|	medcode=="12006"|	medcode=="95949"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="38005"|	medcode=="35014"|	medcode=="100532"|	medcode=="27330"|	medcode=="65122"|	medcode=="65123"|	medcode=="73777"|	medcode=="34926"|	medcode=="102715"|	medcode=="102158"|	medcode=="54083"|	medcode=="47204"|	medcode=="15036"|	medcode=="103900"|	medcode=="100615"|	medcode=="31324"|	medcode=="89657"|	medcode=="3604"|	medcode=="28639"|	medcode=="70842"|	medcode=="49262"|	medcode=="50668"|	medcode=="108182"|	medcode=="50695"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="95715"|	medcode=="101114"|	medcode=="31576"|	medcode=="21549"|	medcode=="70509"|	medcode=="102594"|	medcode=="105966"|	medcode=="105038"|	medcode=="31794"|	medcode=="39798"|	medcode=="104152"|	medcode=="105889"|	medcode=="105095"|	medcode=="107166"|	medcode=="105020"|	medcode=="107973"|	medcode=="106969"|	medcode=="108719"|	medcode=="106063"|	medcode=="105792"|	medcode=="105335"|	medcode=="105559"|	medcode=="105955"|	medcode=="109780"|	medcode=="107949"|	medcode=="105709"|	medcode=="105925"|	medcode=="105375")
ext3clinIMMUNO2<-subset(ext3clin, medcode=="105636"|	medcode=="105286"|	medcode=="104934"|	medcode=="106884"|	medcode=="104386"|	medcode=="104620"|	medcode=="104412"|	medcode=="111682"|	medcode=="17887"|	medcode=="90201"|	medcode=="57737"|	medcode=="12464"|	medcode=="44318"|	medcode=="12335"|	medcode=="57427"|	medcode=="50696"|	medcode=="72725"|	medcode=="42579"|	medcode=="34089"|	medcode=="63105"|	medcode=="71262"|	medcode=="60092"|	medcode=="15504"|	medcode=="15027"|	medcode=="65434"|	medcode=="37182"|	medcode=="4944"|	medcode=="22158"|	medcode=="19028"|	medcode=="21329"|	medcode=="46042"|	medcode=="104418"|	medcode=="39187"|	medcode=="64567"|	medcode=="43450"|	medcode=="19372"|	medcode=="4251"|	medcode=="104325"|	medcode=="8625"|	medcode=="104328"|	medcode=="107052"|	medcode=="106924"|	medcode=="107163"|	medcode=="72774"|	medcode=="49725"|	medcode=="31586"|	medcode=="37461"|	medcode=="108656"|	medcode=="107643"|	medcode=="104939"|	medcode=="38331"|	medcode=="38914"|	medcode=="7176"|	medcode=="4413"|	medcode=="10726"|	medcode=="100786"|	medcode=="105957"|	medcode=="102783"|	medcode=="107236"|	medcode=="27520"|	medcode=="63475"|	medcode=="70724"|	medcode=="52327"|	medcode=="39629"|	medcode=="104788"|	medcode=="112440"|	medcode=="27664"|	medcode=="66089"|	medcode=="33344"|	medcode=="35875"|	medcode=="19974"|	medcode=="27458"|	medcode=="101606"|	medcode=="108424"|	medcode=="99015"|	medcode=="103645"|	medcode=="93342"|	medcode=="37272"|	medcode=="42539"|	medcode=="37468"|	medcode=="57671"|	medcode=="65721"|	medcode=="50858"|	medcode=="28276"|	medcode=="110838"|	medcode=="104273"|	medcode=="94174"|	medcode=="72197"|	medcode=="99413"|	medcode=="30632"|	medcode=="25191"|	medcode=="4072"|	medcode=="16416"|	medcode=="54793"|	medcode=="34692"|	medcode=="4250"|	medcode=="20440"|	medcode=="61500"|	medcode=="22050"|	medcode=="104475"|	medcode=="105069"|	medcode=="30646"|	medcode=="6115"|	medcode=="39336"|	medcode=="49301"|	medcode=="25493"|	medcode=="2481"|	medcode=="11950"|	medcode=="106993"|	medcode=="104740"|	medcode=="105915"|	medcode=="45285"|	medcode=="46444"|	medcode=="70935"|	medcode=="40740"|	medcode=="43415"|	medcode=="67518"|	medcode=="98596"|	medcode=="64336"|	medcode=="102688"|	medcode=="67029"|	medcode=="61693"|	medcode=="89762"|	medcode=="89329"|	medcode=="65165"|	medcode=="105025"|	medcode=="72500"|	medcode=="64515"|	medcode=="109714"|	medcode=="63375"|	medcode=="8649"|	medcode=="45143"|	medcode=="69545"|	medcode=="15883"|	medcode=="106381"|	medcode=="3451"|	medcode=="12306"|	medcode=="12386"|	medcode=="16527"|	medcode=="10411"|	medcode=="101350"|	medcode=="99067"|	medcode=="108102"|	medcode=="71994"|	medcode=="18486"|	medcode=="51041"|	medcode=="27934"|	medcode=="104554"|	medcode=="110183"|	medcode=="44147"|	medcode=="15137"|	medcode=="8548"|	medcode=="18701"|	medcode=="18700"|	medcode=="68440"|	medcode=="57161"|	medcode=="69373"|	medcode=="57322"|	medcode=="92569"|	medcode=="62598"|	medcode=="69184"|	medcode=="60026"|	medcode=="69854"|	medcode=="16295"|	medcode=="48307"|	medcode=="50665"|	medcode=="31322"|	medcode=="62236"|	medcode=="48293"|	medcode=="31541"|	medcode=="66073"|	medcode=="49542"|	medcode=="50526"|	medcode=="103977"|	medcode=="62328"|	medcode=="3129"|	medcode=="65617"|	medcode=="56108"|	medcode=="54203"|	medcode=="21975"|	medcode=="93892"|	medcode=="66857"|	medcode=="36408"|	medcode=="109671"|	medcode=="54904"|	medcode=="63204"|	medcode=="32141"|	medcode=="91911"|	medcode=="66049"|	medcode=="40950"|	medcode=="18781"| medcode=="38306"|	medcode=="39034"|	medcode=="34150"|	medcode=="5572"|	medcode=="2337"|	medcode=="41185"|	medcode=="73583"|	medcode=="12699"|	medcode=="5655"|	medcode=="66740"|	medcode=="27515"|	medcode=="51640"|	medcode=="32270"|	medcode=="57551"|	medcode=="95005"|	medcode=="39420"|	medcode=="61069"|	medcode=="56973"|	medcode=="47695"|	medcode=="65825")
ext3clinIMMUNO3<-subset(ext3clin, medcode=="63323"|	medcode=="53317"|	medcode=="20261"|	medcode=="11346"|	medcode=="100043"|	medcode=="52604"|	medcode=="57525"|	medcode=="40406"|	medcode=="70236"|	medcode=="62041"|	medcode=="22319"|	medcode=="101375"|	medcode=="101075"|	medcode=="4072"|	medcode=="4251"|	medcode=="19974"|	medcode=="4413"|	medcode=="50858"|	medcode=="27664"|	medcode=="37461"|	medcode=="52327"|	medcode=="100786"|	medcode=="16416"|	medcode=="8625"|	medcode=="27458"|	medcode=="10726"|	medcode=="27520"|	medcode=="22050"|	medcode=="102783"|	medcode=="50668"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="21549"|	medcode=="70842"|	medcode=="99067"|	medcode=="39629"|	medcode=="27330"|	medcode=="53397"|	medcode=="107804"|	medcode=="59755"|	medcode=="91900"|	medcode=="59778"|	medcode=="99012"|	medcode=="97746"|	medcode=="94279"|	medcode=="61662"|	medcode=="67703"|	medcode=="101530"|	medcode=="63625"|	medcode=="111942"|	medcode=="110563"|	medcode=="107032"|	medcode=="101715"|	medcode=="73532"|	medcode=="95338"|	medcode=="92245"|	medcode=="68330"|	medcode=="93951"|	medcode=="104743"|	medcode=="71142"|	medcode=="49605"|	medcode=="94005"|	medcode=="58684"|	medcode=="94407"|	medcode=="108886"|	medcode=="97863"|	medcode=="29178"|	medcode=="63054"|	medcode=="61149"|	medcode=="67506"|	medcode=="65483"|	medcode=="55303"|	medcode=="19140"|	medcode=="105472"|	medcode=="57225"|	medcode=="95049"|	medcode=="64036"|	medcode=="68039"|	medcode=="29876"|	medcode=="106911"|	medcode=="43450"|	medcode=="34926"|	medcode=="47204"|	medcode=="102158"|	medcode=="54083"|	medcode=="102715"|	medcode=="4250"|	medcode=="25191"|	medcode=="73777"|	medcode=="65123"|	medcode=="65122"|	medcode=="38939"|	medcode=="19372"|	medcode=="38914"|	medcode=="72197"|	medcode=="16527"|	medcode=="71994"|	medcode=="50695"|	medcode=="108182"|	medcode=="12335"|	medcode=="42579"|	medcode=="71262"|	medcode=="72725"|	medcode=="34089"|	medcode=="50696"|	medcode=="63105"|	medcode=="15504"|	medcode=="60092"|	medcode=="57427"|	medcode=="17887"|	medcode=="89657"|	medcode=="15036"|	medcode=="49301"|	medcode=="30646"|	medcode=="65434"|	medcode=="22158"|	medcode=="65721"|	medcode=="100615"|	medcode=="31324"|	medcode=="103900"|	medcode=="57671"|	medcode=="15883"|	medcode=="35875"|	medcode=="93342"|	medcode=="37182"|	medcode=="12006"|	medcode=="38005"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="95949"|	medcode=="7176"|	medcode=="33344"|	medcode=="70724"|	medcode=="4944"|	medcode=="20440"|	medcode=="25493"|	medcode=="65701"|	medcode=="92068"|	medcode=="105203"|	medcode=="111766"|	medcode=="45264"|	medcode=="94995"|	medcode=="58082"|	medcode=="66327"|	medcode=="3604"|	medcode=="94174"|	medcode=="99413"|	medcode=="64567"|	medcode=="34692"|	medcode=="49725"|	medcode=="38331"|	medcode=="99015"|	medcode=="103645"|	medcode=="112440"|	medcode=="66089"|	medcode=="3451"|	medcode=="37272"|	medcode=="30632"|	medcode=="31576"|	medcode=="12386"|	medcode=="2481"|	medcode=="31586"|	medcode=="35014"|	medcode=="100532"|	medcode=="54793"|	medcode=="72774"|	medcode=="101606"|	medcode=="63475"|	medcode=="104475"|	medcode=="10411"|	medcode=="5019"|	medcode=="102559"|	medcode=="59610"|	medcode=="105256"|	medcode=="31489"|	medcode=="10505")

ext3clinIMMUNO <- rbindlist(list(ext3clinIMMUNO1, ext3clinIMMUNO2, ext3clinIMMUNO3), use.names = TRUE, fill = TRUE)

fwrite(ext3clinIMMUNO, paste("P:/Comorbidities/ext3clinIMMUNO.csv"))
ext3clinIMMUNO <- fread("P:/Comorbidities/ext3clinIMMUNO.csv")

#csf leaks and cochear ext3
ext3clinCSF<-subset(ext3clin, medcode=="30525"|	medcode=="43643"|	medcode=="42441"|	medcode=="36513"|	medcode=="20641"|	medcode=="26158"|	medcode=="40348"|	medcode=="20488"|	medcode=="27295"|	medcode=="35762"|	medcode=="16172"|	medcode=="9300"|	medcode=="17957"|	medcode=="36424"|	medcode=="97074"|	medcode=="55931"|	medcode=="33396"|	medcode=="48851"|	medcode=="71772"|	medcode=="41393"|	medcode=="54342"|	medcode=="10708"|	medcode=="61980"|	medcode=="98472"|	medcode=="57642"|	medcode=="74897")

fwrite(ext3clinCSF, paste("P:/Comorbidities/ext3clinCSF.csv"))
ext3clinCSF <- fread("P:/Comorbidities/ext3clinCSF.csv")

#bind all
ext3clinALL <- rbindlist(list(ext3clinRESP, ext3clinHEART, ext3clinRENAL, ext3clinLIVER, ext3clinDIABETES, ext3clinIMMUNO, ext3clinCSF), use.names = TRUE, fill = TRUE)

fwrite(ext3clinALL, paste("P:/Comorbidities/ext3clinALL.csv"))
ext3clinALL <- fread("P:/Comorbidities/ext3clinALL.csv")


#ext4
ext4clin1 <- fread("P:/CPRD_mother_baby_GOLD/ext4/Clinical/ext4_Extract_Clinical_001.txt")
ext4clin2 <- fread("P:/CPRD_mother_baby_GOLD/ext4/Clinical/ext4_Extract_Clinical_002.txt")
ext4clin3 <- fread("P:/CPRD_mother_baby_GOLD/ext4/Clinical/ext4_Extract_Clinical_003.txt")
ext4clin4 <- fread("P:/CPRD_mother_baby_GOLD/ext4/Clinical/ext4_Extract_Clinical_004.txt")
ext4clin5 <- fread("P:/CPRD_mother_baby_GOLD/ext4/Clinical/ext4_Extract_Clinical_005.txt")

ext4clin <- rbindlist(list(ext4clin1, ext4clin2, ext4clin3, ext4clin4, ext4clin5), use.names = TRUE, fill = TRUE)

#resp ext4
ext4clinRESP<-subset(ext4clin, medcode=="10461"|	medcode=="96578"|	medcode=="93713"|	medcode=="73743"|	medcode=="38011"|	medcode=="15693"|	medcode=="65117"|	medcode=="100742"|	medcode=="33980"|	medcode=="58841"|	medcode=="93380"|	medcode=="29966"|	medcode=="6220"|	medcode=="65344"|	medcode=="69017"|	medcode=="18914"|	medcode=="18905"|	medcode=="100610"|	medcode=="103224"|	medcode=="110454"|	medcode=="102922"|	medcode=="106432"|	medcode=="73065"|	medcode=="49770"|	medcode=="1001"|	medcode=="148"|	medcode=="152"|	medcode=="3480"|	medcode=="3243"|	medcode=="25603"|	medcode=="15626"|	medcode=="61118"|	medcode=="11150"|	medcode=="40159"|	medcode=="37959"|	medcode=="61513"|	medcode=="27819"|	medcode=="5798"|	medcode=="14798"|	medcode=="1446"|	medcode=="26125"|	medcode=="44525"|	medcode=="24248"|	medcode=="66043"|	medcode=="45089"|	medcode=="68066"|	medcode=="15157"|	medcode=="794"|	medcode=="26306"|	medcode=="56860"|	medcode=="68662"|	medcode=="60188"|	medcode=="99536"|	medcode=="23492"|	medcode=="46578"|	medcode=="10980"|	medcode=="40788"|	medcode=="92955"|	medcode=="70787"|	medcode=="63479"|	medcode=="16410"|	medcode=="33450"|	medcode=="106805"|	medcode=="2195"|	medcode=="20364"|	medcode=="41491"|	medcode=="32679"|	medcode=="10863"|	medcode=="10802"|	medcode=="9876"|	medcode=="93568"|	medcode=="104608"|	medcode=="12166"|	medcode=="21061"|	medcode=="7884"|	medcode=="5710"|	medcode=="19492"|	medcode=="8303"|	medcode=="51410"|	medcode=="46460"|	medcode=="60805"|	medcode=="62233"|	medcode=="71853"|	medcode=="89206"|	medcode=="23446"|	medcode=="65376"|	medcode=="94894"|	medcode=="49194"|	medcode=="94575"|	medcode=="30235"|	medcode=="93577"|	medcode=="23461"|	medcode=="37365"|	medcode=="26442"|	medcode=="31423"|	medcode=="63172"|	medcode=="54830"|	medcode=="49025"|	medcode=="55758"|	medcode=="62227"|	medcode=="47142"|	medcode=="64721"|	medcode=="63216"|	medcode=="47782"|	medcode=="70815"|	medcode=="104557"|	medcode=="9711"|	medcode=="3847"|	medcode=="41781"|	medcode=="59083"|	medcode=="66104"|	medcode=="45948"|	medcode=="33837"|	medcode=="56647"|	medcode=="41015"|	medcode=="66773"|	medcode=="50876"|	medcode=="47504"|	medcode=="54252"|	medcode=="46066"|	medcode=="43285"|	medcode=="18130"|	medcode=="69914"|	medcode=="22536"|	medcode=="50374"|	medcode=="44015"|	medcode=="53205"|	medcode=="43417"|	medcode=="30214"|	medcode=="38297"|	medcode=="46405"|	medcode=="26082"|	medcode=="7321"|	medcode=="61229"|	medcode=="7791"|	medcode=="31806"|	medcode=="61119"|	medcode=="27348"|	medcode=="68814"|	medcode=="6837"|	medcode=="94136"|	medcode=="6051"|	medcode=="103472"|	medcode=="103559"|	medcode=="28229"|	medcode=="22835"|	medcode=="54308"|	medcode=="61991"|	medcode=="33830"|	medcode=="15815"|	medcode=="64799"|	medcode=="94996"|	medcode=="58791"|	medcode=="54010"|	medcode=="42940"|	medcode=="3859"|	medcode=="47364"|	medcode=="31564"|	medcode=="96655"|	medcode=="63912"|	medcode=="22905"|	medcode=="54893"|	medcode=="22915"|	medcode=="31319"|	medcode=="106650"|	medcode=="20269"|	medcode=="558"|	medcode=="39706"|	medcode=="5293"|	medcode=="65000"|	medcode=="93880"|	medcode=="72221"|	medcode=="96754"|	medcode=="24848"|	medcode=="24466"|	medcode=="99158"|	medcode=="8317"|	medcode=="103785"|	medcode=="109815"|	medcode=="104915"|	medcode=="24814"|	medcode=="94946"|	medcode=="94486"|	medcode=="59188"|	medcode=="66058"|	medcode=="65733"|	medcode=="105939"|	medcode=="106515"|	medcode=="99232"|	medcode=="105628"|	medcode=="54706"|	medcode=="65060"|	medcode=="91912"|	medcode=="71906"|	medcode=="56427"|	medcode=="38298"|	medcode=="94925"|	medcode=="6883"|	medcode=="93098"|	medcode=="13563")

fwrite(ext4clinRESP, paste("P:/Comorbidities/ext4clinRESP.csv"))
ext4clinRESP <- fread("P:/Comorbidities/ext4clinRESP.csv")

#heart ext4
ext4clinHEART1<-subset(ext4clin, medcode=="11284"|	medcode=="19066"|	medcode=="51214"|	medcode=="250"|	medcode=="53626"|	medcode=="61073"|	medcode=="4438"|	medcode=="242"|	medcode=="72939"|	medcode=="58529"|	medcode=="107416"|	medcode=="70105"|	medcode=="93844"|	medcode=="69734"|	medcode=="41495"|	medcode=="22262"|	medcode=="16292"|	medcode=="50157"|	medcode=="95334"|	medcode=="72668"|	medcode=="103046"|	medcode=="52427"|	medcode=="61660"|	medcode=="52127"|	medcode=="105938"|	medcode=="31464"|	medcode=="61166"|	medcode=="62718"|	medcode=="16173"|	medcode=="240"|	medcode=="241"|	medcode=="12139"|	medcode=="5387"|	medcode=="40429"|	medcode=="17872"|	medcode=="14897"|	medcode=="8935"|	medcode=="29643"|	medcode=="23892"|	medcode=="14898"|	medcode=="63467"|	medcode=="3704"|	medcode=="9507"|	medcode=="10562"|	medcode=="1678"|	medcode=="30330"|	medcode=="32854"|	medcode=="29758"|	medcode=="12229"|	medcode=="34803"|	medcode=="28736"|	medcode=="62626"|	medcode=="41221"|	medcode=="46017"|	medcode=="14658"|	medcode=="27951"|	medcode=="36523"|	medcode=="61072"|	medcode=="7347"|	medcode=="17307"|	medcode=="34328"|	medcode=="18118"|	medcode=="11983"|	medcode=="54251"|	medcode=="39449"|	medcode=="9413"|	medcode=="9276"|	medcode=="68357"|	medcode=="39693"|	medcode=="21844"|	medcode=="27977"|	medcode=="4017"|	medcode=="1430"|	medcode=="20095"|	medcode=="18125"|	medcode=="29902"|	medcode=="25842"|	medcode=="66388"|	medcode=="54535"|	medcode=="7696"|	medcode=="1414"|	medcode=="32450"|	medcode=="9555"|	medcode=="26863"|	medcode=="12804"|	medcode=="28554"|	medcode=="28138"|	medcode=="5413"|	medcode=="3999"|	medcode=="5254"|	medcode=="36609"|	medcode=="7320"|	medcode=="29421"|	medcode=="34633"|	medcode=="24540"|	medcode=="23078"|	medcode=="35713"|	medcode=="15754"|	medcode=="18889"|	medcode=="18842"|	medcode=="45809"|	medcode=="38609"|	medcode=="72562"|	medcode=="46166"|	medcode=="32272"|	medcode=="46112"|	medcode=="46276"|	medcode=="106812"|	medcode=="41835"|	medcode=="68748"|	medcode=="105479"|	medcode=="1676"|	medcode=="2062"|	medcode=="398"|	medcode=="23707"|	medcode=="32671"|	medcode=="27884"|	medcode=="11424"|	medcode=="94870"|	medcode=="884"|	medcode=="5255"|	medcode=="27964"|	medcode=="101138"|	medcode=="104275"|	medcode=="4024"|	medcode=="8966"|	medcode=="107397"|	medcode=="52517"|	medcode=="39546"|	medcode=="68401"|	medcode=="47637"|	medcode=="96838"|	medcode=="109035"|	medcode=="99991"|	medcode=="31518"|	medcode=="4964"|	medcode=="72604"|	medcode=="45505"|	medcode=="66245"|	medcode=="94344"|	medcode=="2816"|	medcode=="69858"|	medcode=="1778"|	medcode=="23988"|	medcode=="102980"|	medcode=="40025"|	medcode=="65318"|	medcode=="63390"|	medcode=="62169"|	medcode=="73539"|	medcode=="4864"|	medcode=="38967"|	medcode=="51649"|	medcode=="63046"|	medcode=="19969"|	medcode=="246"|	medcode=="42132"|	medcode=="56575"|	medcode=="67657"|	medcode=="9011"|	medcode=="51897"|	medcode=="20153"|	medcode=="54772"|	medcode=="34067"|	medcode=="7474"|	medcode=="3255"|	medcode=="3625"|	medcode=="37816"|	medcode=="59144"|	medcode=="53088"|	medcode=="54243"|	medcode=="63340"|	medcode=="51053"|	medcode=="101393"|	medcode=="49702"|	medcode=="55535"|	medcode=="43049"|	medcode=="44896"|	medcode=="73816"|	medcode=="46117"|	medcode=="9361"|	medcode=="48205"|	medcode=="66401"|	medcode=="54196"|	medcode=="5621"|	medcode=="39992"|	medcode=="69940"|	medcode=="3862"|	medcode=="54488"|	medcode=="93561"|	medcode=="22778"|	medcode=="112420"|	medcode=="45452"|	medcode=="33919"|	medcode=="21851"|	medcode=="44478"|	medcode=="107150"|	medcode=="52607"|	medcode=="70880"|	medcode=="12752"|	medcode=="21272"|	medcode=="69169"|	medcode=="100065"|	medcode=="23709"|	medcode=="6886"|	medcode=="8636"|	medcode=="58734"|	medcode=="3300"|	medcode=="6843"|	medcode=="57091"|	medcode=="90551"|	medcode=="73592"|	medcode=="63069")
ext4clinHEART2<-subset(ext4clin, medcode=="100291"|	medcode=="61651"|	medcode=="20772"|	medcode=="89256"|	medcode=="108457"|	medcode=="46825"|	medcode=="50529"|	medcode=="24789"|	medcode=="16539"|	medcode=="34668"|	medcode=="9401"|	medcode=="99128"|	medcode=="32748"|	medcode=="104266"|	medcode=="97818"|	medcode=="25481"|	medcode=="71956"|	medcode=="62163"|	medcode=="103894"|	medcode=="31373"|	medcode=="49901"|	medcode=="103412"|	medcode=="53546"|	medcode=="24533"|	medcode=="68097"|	medcode=="52310"|	medcode=="102167"|	medcode=="70992"|	medcode=="71678"|	medcode=="3774"|	medcode=="72259"|	medcode=="72405"|	medcode=="50284"|	medcode=="103584"|	medcode=="92426"|	medcode=="52615"|	medcode=="98061"|	medcode=="24854"|	medcode=="93089"|	medcode=="68063"|	medcode=="34007"|	medcode=="49133"|	medcode=="50362"|	medcode=="68894"|	medcode=="108193"|	medcode=="37451"|	medcode=="23752"|	medcode=="95785"|	medcode=="111360"|	medcode=="98317"|	medcode=="24714"|	medcode=="247"|	medcode=="26626"|	medcode=="109236"|	medcode=="103432"|	medcode=="64778"|	medcode=="38968"|	medcode=="3863"|	medcode=="11982"|	medcode=="3301"|	medcode=="57932"|	medcode=="72295"|	medcode=="70853"|	medcode=="37323"|	medcode=="59907"|	medcode=="50220"|	medcode=="62230"|	medcode=="30725"|	medcode=="67286"|	medcode=="30949"|	medcode=="46530"|	medcode=="49731"|	medcode=="44334"|	medcode=="90486"|	medcode=="70691"|	medcode=="34176"|	medcode=="68198"|	medcode=="59298"|	medcode=="37515"|	medcode=="63768"|	medcode=="53964"|	medcode=="62376"|	medcode=="58076"|	medcode=="44781"|	medcode=="49474"|	medcode=="56200"|	medcode=="11945"|	medcode=="11127"|	medcode=="63187"|	medcode=="67928"|	medcode=="31112"|	medcode=="18982"|	medcode=="54487"|	medcode=="2670"|	medcode=="96225"|	medcode=="65029"|	medcode=="32508"|	medcode=="52411"|	medcode=="42127"|	medcode=="42684"|	medcode=="45291"|	medcode=="74890"|	medcode=="50886"|	medcode=="51941"|	medcode=="105037"|	medcode=="103039"|	medcode=="68784"|	medcode=="46176"|	medcode=="101307"|	medcode=="99649"|	medcode=="73663"|	medcode=="101520"|	medcode=="72655"|	medcode=="51675"|	medcode=="41197"|	medcode=="110026"|	medcode=="36606"|	medcode=="71874"|	medcode=="51911"|	medcode=="73554"|	medcode=="101322"|	medcode=="109008"|	medcode=="110047"|	medcode=="106644"|	medcode=="107639"|	medcode=="110418"|	medcode=="107496"|	medcode=="107710"|	medcode=="9384"|	medcode=="25089"|	medcode=="22383"|	medcode=="21966")

ext4clinHEART <- rbindlist(list(ext4clinHEART1, ext4clinHEART2), use.names = TRUE, fill = TRUE)

fwrite(ext4clinHEART, paste("P:/Comorbidities/ext4clinHEART.csv"))
ext4clinHEART <- fread("P:/Comorbidities/ext4clinHEART.csv")

#renal ext4
ext4clinRENAL<-subset(ext4clin, medcode=="12479"|	medcode=="12585"|	medcode=="95122"|	medcode=="95406"|	medcode=="95508"|	medcode=="95405"|	medcode=="2997"|	medcode=="55151"|	medcode=="11745"|	medcode=="24361"|	medcode=="89924"|	medcode=="96133"|	medcode=="109455"|	medcode=="105787"|	medcode=="70874"|	medcode=="5504"|	medcode=="31549"|	medcode=="20073"|	medcode=="2994"|	medcode=="2996"|	medcode=="71124"|	medcode=="88597"|	medcode=="30756"|	medcode=="64828"|	medcode=="48022"|	medcode=="64636"|	medcode=="56760"|	medcode=="8037"|	medcode=="23773"|	medcode=="104586"|	medcode=="59194"|	medcode=="83513"|	medcode=="30709"|	medcode=="107901"|	medcode=="65089"|	medcode=="102210"|	medcode=="30323"|	medcode=="26054"|	medcode=="26860"|	medcode=="109840"|	medcode=="2999"|	medcode=="9840"|	medcode=="1803"|	medcode=="99644"|	medcode=="29634"|	medcode=="23913"|	medcode=="22852"|	medcode=="19316"|	medcode=="21947"|	medcode=="50472"|	medcode=="21989"|	medcode=="56987"|	medcode=="17365"|	medcode=="63786"|	medcode=="72303"|	medcode=="108591"|	medcode=="110749"|	medcode=="111370"|	medcode=="108816"|	medcode=="47922"|	medcode=="2471"|	medcode=="99201"|	medcode=="58750"|	medcode=="94373"|	medcode=="27427"|	medcode=="65064"|	medcode=="512"|	medcode=="6712"|	medcode=="104963"|	medcode=="105151"|	medcode=="350"|	medcode=="105302"|	medcode=="61814"|	medcode=="71174"|	medcode=="97734"|	medcode=="41285"|	medcode=="58060"|	medcode=="109945"|	medcode=="50200"|	medcode=="62320"|	medcode=="8330"|	medcode=="100205"|	medcode=="61930"|	medcode=="11554"|	medcode=="5911"|	medcode=="53940"|	medcode=="108494")

fwrite(ext4clinRENAL, paste("P:/Comorbidities/ext4clinRENAL.csv"))
ext4clinRENAL <- fread("P:/Comorbidities/ext4clinRENAL.csv")

#liver ext4
ext4clinLIVER<-subset(ext4clin, medcode=="4405"|	medcode=="32025"|	medcode=="71422"|	medcode=="69194"|	medcode=="105506"|	medcode=="97157"|	medcode=="99250"|	medcode=="27319"|	medcode=="26367"|	medcode=="24813"|	medcode=="41096"|	medcode=="30586"|	medcode=="106642"|	medcode=="32277"|	medcode=="108343"|	medcode=="107896"|	medcode=="110454"|	medcode=="102922"|	medcode=="48211"|	medcode=="6863"|	medcode=="4743"|	medcode=="21713"|	medcode=="17330"|	medcode=="1754"|	medcode=="23578"|	medcode=="9029"|	medcode=="1755"|	medcode=="53480"|	medcode=="66534"|	medcode=="53877"|	medcode=="15489"|	medcode=="16725"|	medcode=="69204"|	medcode=="3450"|	medcode=="44676"|	medcode=="92909"|	medcode=="40567"|	medcode=="27438"|	medcode=="96664"|	medcode=="100253"|	medcode=="73482"|	medcode=="112044"|	medcode=="109540"|	medcode=="48928"|	medcode=="55454"|	medcode=="16455"|	medcode=="9494"|	medcode=="5638"|	medcode=="15424"|	medcode=="91591"|	medcode=="58630"|	medcode=="7602"|	medcode=="42843"|	medcode=="25383"|	medcode=="60104"|	medcode=="100592"|	medcode=="33597"|	medcode=="10539"|	medcode=="5129"|	medcode=="10636"|	medcode=="24901"|	medcode=="48102"|	medcode=="17219"|	medcode=="64750"|	medcode=="39351"|	medcode=="44120"|	medcode=="26405"|	medcode=="18652"|	medcode=="15425"|	medcode=="6015"|	medcode=="25597"|	medcode=="16417"|	medcode=="38389"|	medcode=="48269"|	medcode=="50400"|	medcode=="50444"|	medcode=="40029"|	medcode=="10721"|	medcode=="71422"|	medcode=="4405"|	medcode=="32025"|	medcode=="69194")

fwrite(ext4clinLIVER, paste("P:/Comorbidities/ext4clinLIVER.csv"))
ext4clinLIVER <- fread("P:/Comorbidities/ext4clinLIVER.csv")

#diabetes ext4
ext4clinDIABETES<-subset(ext4clin, medcode=="711"|	medcode=="43453"|	medcode=="36695"|	medcode=="1549"|	medcode=="47582"|	medcode=="47649"|	medcode=="42831"|	medcode=="47650"|	medcode=="43921"|	medcode=="18683"|	medcode=="69993"|	medcode=="18387"|	medcode=="35288"|	medcode=="40682"|	medcode=="69676"|	medcode=="68105"|	medcode=="46301"|	medcode=="10418"|	medcode=="39070"|	medcode=="49554"|	medcode=="93468"|	medcode=="18642"|	medcode=="54008"|	medcode=="30323"|	medcode=="30294"|	medcode=="10692"|	medcode=="40837"|	medcode=="22871"|	medcode=="55239"|	medcode=="95636"|	medcode=="758"|	medcode=="18777"|	medcode=="47321"|	medcode=="34268"|	medcode=="65267"|	medcode=="49074"|	medcode=="12736"|	medcode=="18496"|	medcode=="25627"|	medcode=="47954"|	medcode=="62674"|	medcode=="18425"|	medcode=="12640"|	medcode=="46917"|	medcode=="44982"|	medcode=="37806"|	medcode=="59253"|	medcode=="35385"|	medcode=="1407"|	medcode=="34450"|	medcode=="26054"|	medcode=="18390"|	medcode=="32627"|	medcode=="51756"|	medcode=="25591"|	medcode=="63690"|	medcode=="95539"|	medcode=="51697"|	medcode=="96506"|	medcode=="61122"|	medcode=="67212"|	medcode=="43857"|	medcode=="22487"|	medcode=="94383"|	medcode=="93380"|	medcode=="52212"|	medcode=="106927"|	medcode=="53200"|	medcode=="42567"|	medcode=="54856"|	medcode=="6791"|	medcode=="31310"|	medcode=="60499"|	medcode=="52104"|	medcode=="52283"|	medcode=="49276"|	medcode=="46963"|	medcode=="6509"|	medcode=="44443"|	medcode=="8403"|	medcode=="40401"|	medcode=="68843"|	medcode=="62146"|	medcode=="55842"|	medcode=="50429"|	medcode=="52303"|	medcode=="17262"|	medcode=="34912")

fwrite(ext4clinDIABETES, paste("P:/Comorbidities/ext4clinDIABETES.csv"))
ext4clinDIABETES <- fread("P:/Comorbidities/ext4clinDIABETES.csv")

#immunosuppression ext4
ext4clinIMMUNO1<-subset(ext4clin, medcode=="47106"|	medcode=="22307"|	medcode=="34310"|	medcode=="108246"|	medcode=="27514"|	medcode=="1393"|	medcode=="31041"|	medcode=="102966"|	medcode=="59784"|	medcode=="106015"|	medcode=="32133"|	medcode=="23770"|	medcode=="58857"|	medcode=="58859"|	medcode=="69766"|	medcode=="70869"|	medcode=="53636"|	medcode=="70528"|	medcode=="101836"|	medcode=="47632"|	medcode=="111979"|	medcode=="67575"|	medcode=="71450"|	medcode=="62891"|	medcode=="36294"|	medcode=="44303"|	medcode=="37006"|	medcode=="66368"|	medcode=="23951"|	medcode=="27641"|	medcode=="50076"|	medcode=="27853"|	medcode=="44617"|	medcode=="66367"|	medcode=="105324"|	medcode=="65117"|	medcode=="8281"|	medcode=="51708"|	medcode=="62854"|	medcode=="112030"|	medcode=="107807"|	medcode=="112031"|	medcode=="102117"|	medcode=="104134"|	medcode=="112032"|	medcode=="69767"|	medcode=="112034"|	medcode=="112035"|	medcode=="112036"|	medcode=="112037"|	medcode=="96751"|	medcode=="102252"|	medcode=="100769"|	medcode=="65460"|	medcode=="108667"|	medcode=="72224"|	medcode=="93778"|	medcode=="12323"|	medcode=="41369"|	medcode=="1481"|	medcode=="60242"|	medcode=="71031"|	medcode=="70374"|	medcode=="95058"|	medcode=="99240"|	medcode=="27416"|	medcode=="71625"|	medcode=="71238"|	medcode=="62380"|	medcode=="64670"|	medcode=="100352"|	medcode=="103245"|	medcode=="104790"|	medcode=="63723"|	medcode=="21402"|	medcode=="59115"|	medcode=="100006"|	medcode=="97577"|	medcode=="92380"|	medcode=="71304"|	medcode=="99887"|	medcode=="99951"|	medcode=="2462"|	medcode=="65489"|	medcode=="100423"|	medcode=="98840"|	medcode=="44196"|	medcode=="98909"|	medcode=="64036"|	medcode=="68039"|	medcode=="38939"|	medcode=="71142"|	medcode=="68330"|	medcode=="92245"|	medcode=="73532"|	medcode=="93951"|	medcode=="95338"|	medcode=="106911"|	medcode=="104743"|	medcode=="29876"|	medcode=="29178"|	medcode=="57225"|	medcode=="55303"|	medcode=="67506"|	medcode=="61149"|	medcode=="65483"|	medcode=="105472"|	medcode=="19140"|	medcode=="63054"|	medcode=="49605"|	medcode=="97863"|	medcode=="94407"|	medcode=="58684"|	medcode=="108886"|	medcode=="94005"|	medcode=="67703"|	medcode=="95049"|	medcode=="111942"|	medcode=="63625"|	medcode=="110563"|	medcode=="101715"|	medcode=="107032"|	medcode=="101530"|	medcode=="104895"|	medcode=="105841"|	medcode=="108775"|	medcode=="106597"|	medcode=="104484"|	medcode=="53397"|	medcode=="61662"|	medcode=="59778"|	medcode=="59755"|	medcode=="107804"|	medcode=="91900"|	medcode=="99012"|	medcode=="94279"|	medcode=="97746"|	medcode=="42461"|	medcode=="5179"|	medcode=="66327"|	medcode=="45264"|	medcode=="105203"|	medcode=="92068"|	medcode=="111766"|	medcode=="94995"|	medcode=="58082"|	medcode=="65701"|	medcode=="12006"|	medcode=="95949"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="38005"|	medcode=="35014"|	medcode=="100532"|	medcode=="27330"|	medcode=="65122"|	medcode=="65123"|	medcode=="73777"|	medcode=="34926"|	medcode=="102715"|	medcode=="102158"|	medcode=="54083"|	medcode=="47204"|	medcode=="15036"|	medcode=="103900"|	medcode=="100615"|	medcode=="31324"|	medcode=="89657"|	medcode=="3604"|	medcode=="28639"|	medcode=="70842"|	medcode=="49262"|	medcode=="50668"|	medcode=="108182"|	medcode=="50695"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="95715"|	medcode=="101114"|	medcode=="31576"|	medcode=="21549"|	medcode=="70509"|	medcode=="102594"|	medcode=="105966"|	medcode=="105038"|	medcode=="31794"|	medcode=="39798"|	medcode=="104152"|	medcode=="105889"|	medcode=="105095"|	medcode=="107166"|	medcode=="105020"|	medcode=="107973"|	medcode=="106969"|	medcode=="108719"|	medcode=="106063"|	medcode=="105792"|	medcode=="105335"|	medcode=="105559"|	medcode=="105955"|	medcode=="109780"|	medcode=="107949"|	medcode=="105709"|	medcode=="105925"|	medcode=="105375")
ext4clinIMMUNO2<-subset(ext4clin, medcode=="105636"|	medcode=="105286"|	medcode=="104934"|	medcode=="106884"|	medcode=="104386"|	medcode=="104620"|	medcode=="104412"|	medcode=="111682"|	medcode=="17887"|	medcode=="90201"|	medcode=="57737"|	medcode=="12464"|	medcode=="44318"|	medcode=="12335"|	medcode=="57427"|	medcode=="50696"|	medcode=="72725"|	medcode=="42579"|	medcode=="34089"|	medcode=="63105"|	medcode=="71262"|	medcode=="60092"|	medcode=="15504"|	medcode=="15027"|	medcode=="65434"|	medcode=="37182"|	medcode=="4944"|	medcode=="22158"|	medcode=="19028"|	medcode=="21329"|	medcode=="46042"|	medcode=="104418"|	medcode=="39187"|	medcode=="64567"|	medcode=="43450"|	medcode=="19372"|	medcode=="4251"|	medcode=="104325"|	medcode=="8625"|	medcode=="104328"|	medcode=="107052"|	medcode=="106924"|	medcode=="107163"|	medcode=="72774"|	medcode=="49725"|	medcode=="31586"|	medcode=="37461"|	medcode=="108656"|	medcode=="107643"|	medcode=="104939"|	medcode=="38331"|	medcode=="38914"|	medcode=="7176"|	medcode=="4413"|	medcode=="10726"|	medcode=="100786"|	medcode=="105957"|	medcode=="102783"|	medcode=="107236"|	medcode=="27520"|	medcode=="63475"|	medcode=="70724"|	medcode=="52327"|	medcode=="39629"|	medcode=="104788"|	medcode=="112440"|	medcode=="27664"|	medcode=="66089"|	medcode=="33344"|	medcode=="35875"|	medcode=="19974"|	medcode=="27458"|	medcode=="101606"|	medcode=="108424"|	medcode=="99015"|	medcode=="103645"|	medcode=="93342"|	medcode=="37272"|	medcode=="42539"|	medcode=="37468"|	medcode=="57671"|	medcode=="65721"|	medcode=="50858"|	medcode=="28276"|	medcode=="110838"|	medcode=="104273"|	medcode=="94174"|	medcode=="72197"|	medcode=="99413"|	medcode=="30632"|	medcode=="25191"|	medcode=="4072"|	medcode=="16416"|	medcode=="54793"|	medcode=="34692"|	medcode=="4250"|	medcode=="20440"|	medcode=="61500"|	medcode=="22050"|	medcode=="104475"|	medcode=="105069"|	medcode=="30646"|	medcode=="6115"|	medcode=="39336"|	medcode=="49301"|	medcode=="25493"|	medcode=="2481"|	medcode=="11950"|	medcode=="106993"|	medcode=="104740"|	medcode=="105915"|	medcode=="45285"|	medcode=="46444"|	medcode=="70935"|	medcode=="40740"|	medcode=="43415"|	medcode=="67518"|	medcode=="98596"|	medcode=="64336"|	medcode=="102688"|	medcode=="67029"|	medcode=="61693"|	medcode=="89762"|	medcode=="89329"|	medcode=="65165"|	medcode=="105025"|	medcode=="72500"|	medcode=="64515"|	medcode=="109714"|	medcode=="63375"|	medcode=="8649"|	medcode=="45143"|	medcode=="69545"|	medcode=="15883"|	medcode=="106381"|	medcode=="3451"|	medcode=="12306"|	medcode=="12386"|	medcode=="16527"|	medcode=="10411"|	medcode=="101350"|	medcode=="99067"|	medcode=="108102"|	medcode=="71994"|	medcode=="18486"|	medcode=="51041"|	medcode=="27934"|	medcode=="104554"|	medcode=="110183"|	medcode=="44147"|	medcode=="15137"|	medcode=="8548"|	medcode=="18701"|	medcode=="18700"|	medcode=="68440"|	medcode=="57161"|	medcode=="69373"|	medcode=="57322"|	medcode=="92569"|	medcode=="62598"|	medcode=="69184"|	medcode=="60026"|	medcode=="69854"|	medcode=="16295"|	medcode=="48307"|	medcode=="50665"|	medcode=="31322"|	medcode=="62236"|	medcode=="48293"|	medcode=="31541"|	medcode=="66073"|	medcode=="49542"|	medcode=="50526"|	medcode=="103977"|	medcode=="62328"|	medcode=="3129"|	medcode=="65617"|	medcode=="56108"|	medcode=="54203"|	medcode=="21975"|	medcode=="93892"|	medcode=="66857"|	medcode=="36408"|	medcode=="109671"|	medcode=="54904"|	medcode=="63204"|	medcode=="32141"|	medcode=="91911"|	medcode=="66049"|	medcode=="40950"|	medcode=="18781"| medcode=="38306"|	medcode=="39034"|	medcode=="34150"|	medcode=="5572"|	medcode=="2337"|	medcode=="41185"|	medcode=="73583"|	medcode=="12699"|	medcode=="5655"|	medcode=="66740"|	medcode=="27515"|	medcode=="51640"|	medcode=="32270"|	medcode=="57551"|	medcode=="95005"|	medcode=="39420"|	medcode=="61069"|	medcode=="56973"|	medcode=="47695"|	medcode=="65825")
ext4clinIMMUNO3<-subset(ext4clin, medcode=="63323"|	medcode=="53317"|	medcode=="20261"|	medcode=="11346"|	medcode=="100043"|	medcode=="52604"|	medcode=="57525"|	medcode=="40406"|	medcode=="70236"|	medcode=="62041"|	medcode=="22319"|	medcode=="101375"|	medcode=="101075"|	medcode=="4072"|	medcode=="4251"|	medcode=="19974"|	medcode=="4413"|	medcode=="50858"|	medcode=="27664"|	medcode=="37461"|	medcode=="52327"|	medcode=="100786"|	medcode=="16416"|	medcode=="8625"|	medcode=="27458"|	medcode=="10726"|	medcode=="27520"|	medcode=="22050"|	medcode=="102783"|	medcode=="50668"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="21549"|	medcode=="70842"|	medcode=="99067"|	medcode=="39629"|	medcode=="27330"|	medcode=="53397"|	medcode=="107804"|	medcode=="59755"|	medcode=="91900"|	medcode=="59778"|	medcode=="99012"|	medcode=="97746"|	medcode=="94279"|	medcode=="61662"|	medcode=="67703"|	medcode=="101530"|	medcode=="63625"|	medcode=="111942"|	medcode=="110563"|	medcode=="107032"|	medcode=="101715"|	medcode=="73532"|	medcode=="95338"|	medcode=="92245"|	medcode=="68330"|	medcode=="93951"|	medcode=="104743"|	medcode=="71142"|	medcode=="49605"|	medcode=="94005"|	medcode=="58684"|	medcode=="94407"|	medcode=="108886"|	medcode=="97863"|	medcode=="29178"|	medcode=="63054"|	medcode=="61149"|	medcode=="67506"|	medcode=="65483"|	medcode=="55303"|	medcode=="19140"|	medcode=="105472"|	medcode=="57225"|	medcode=="95049"|	medcode=="64036"|	medcode=="68039"|	medcode=="29876"|	medcode=="106911"|	medcode=="43450"|	medcode=="34926"|	medcode=="47204"|	medcode=="102158"|	medcode=="54083"|	medcode=="102715"|	medcode=="4250"|	medcode=="25191"|	medcode=="73777"|	medcode=="65123"|	medcode=="65122"|	medcode=="38939"|	medcode=="19372"|	medcode=="38914"|	medcode=="72197"|	medcode=="16527"|	medcode=="71994"|	medcode=="50695"|	medcode=="108182"|	medcode=="12335"|	medcode=="42579"|	medcode=="71262"|	medcode=="72725"|	medcode=="34089"|	medcode=="50696"|	medcode=="63105"|	medcode=="15504"|	medcode=="60092"|	medcode=="57427"|	medcode=="17887"|	medcode=="89657"|	medcode=="15036"|	medcode=="49301"|	medcode=="30646"|	medcode=="65434"|	medcode=="22158"|	medcode=="65721"|	medcode=="100615"|	medcode=="31324"|	medcode=="103900"|	medcode=="57671"|	medcode=="15883"|	medcode=="35875"|	medcode=="93342"|	medcode=="37182"|	medcode=="12006"|	medcode=="38005"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="95949"|	medcode=="7176"|	medcode=="33344"|	medcode=="70724"|	medcode=="4944"|	medcode=="20440"|	medcode=="25493"|	medcode=="65701"|	medcode=="92068"|	medcode=="105203"|	medcode=="111766"|	medcode=="45264"|	medcode=="94995"|	medcode=="58082"|	medcode=="66327"|	medcode=="3604"|	medcode=="94174"|	medcode=="99413"|	medcode=="64567"|	medcode=="34692"|	medcode=="49725"|	medcode=="38331"|	medcode=="99015"|	medcode=="103645"|	medcode=="112440"|	medcode=="66089"|	medcode=="3451"|	medcode=="37272"|	medcode=="30632"|	medcode=="31576"|	medcode=="12386"|	medcode=="2481"|	medcode=="31586"|	medcode=="35014"|	medcode=="100532"|	medcode=="54793"|	medcode=="72774"|	medcode=="101606"|	medcode=="63475"|	medcode=="104475"|	medcode=="10411"|	medcode=="5019"|	medcode=="102559"|	medcode=="59610"|	medcode=="105256"|	medcode=="31489"|	medcode=="10505")

ext4clinIMMUNO <- rbindlist(list(ext4clinIMMUNO1, ext4clinIMMUNO2, ext4clinIMMUNO3), use.names = TRUE, fill = TRUE)

fwrite(ext4clinIMMUNO, paste("P:/Comorbidities/ext4clinIMMUNO.csv"))
ext4clinIMMUNO <- fread("P:/Comorbidities/ext4clinIMMUNO.csv")

#csf leaks and cochear ext4
ext1clinCSF<-subset(ext1clin, medcode=="30525"|	medcode=="43643"|	medcode=="42441"|	medcode=="36513"|	medcode=="20641"|	medcode=="26158"|	medcode=="40348"|	medcode=="20488"|	medcode=="27295"|	medcode=="35762"|	medcode=="16172"|	medcode=="9300"|	medcode=="17957"|	medcode=="36424"|	medcode=="97074"|	medcode=="55931"|	medcode=="33396"|	medcode=="48851"|	medcode=="71772"|	medcode=="41393"|	medcode=="54342"|	medcode=="10708"|	medcode=="61980"|	medcode=="98472"|	medcode=="57642"|	medcode=="74897")

fwrite(ext4clinCSF, paste("P:/Comorbidities/ext4clinCSF.csv"))
ext4clinCSF <- fread("P:/Comorbidities/ext4clinCSF.csv")

#bind all
ext4clinALL <- rbindlist(list(ext4clinRESP, ext4clinHEART, ext4clinRENAL, ext4clinLIVER, ext4clinDIABETES, ext4clinIMMUNO, ext4clinCSF), use.names = TRUE, fill = TRUE)

fwrite(ext4clinALL, paste("P:/Comorbidities/ext4clinALL.csv"))
ext4clinALL <- fread("P:/Comorbidities/ext4clinALL.csv")


#ext5
ext5clin1 <- fread("P:/CPRD_mother_baby_GOLD/ext5/Clinical/ext5_Extract_Clinical_001.txt")
ext5clin2 <- fread("P:/CPRD_mother_baby_GOLD/ext5/Clinical/ext5_Extract_Clinical_002.txt")
ext5clin3 <- fread("P:/CPRD_mother_baby_GOLD/ext5/Clinical/ext5_Extract_Clinical_003.txt")
ext5clin4 <- fread("P:/CPRD_mother_baby_GOLD/ext5/Clinical/ext5_Extract_Clinical_004.txt")
ext5clin5 <- fread("P:/CPRD_mother_baby_GOLD/ext5/Clinical/ext5_Extract_Clinical_005.txt")

ext5clin <- rbindlist(list(ext5clin1, ext5clin2, ext5clin3, ext5clin4, ext5clin5), use.names = TRUE, fill = TRUE)

#resp ext5
ext5clinRESP<-subset(ext5clin, medcode=="10461"|	medcode=="96578"|	medcode=="93713"|	medcode=="73743"|	medcode=="38011"|	medcode=="15693"|	medcode=="65117"|	medcode=="100742"|	medcode=="33980"|	medcode=="58841"|	medcode=="93380"|	medcode=="29966"|	medcode=="6220"|	medcode=="65344"|	medcode=="69017"|	medcode=="18914"|	medcode=="18905"|	medcode=="100610"|	medcode=="103224"|	medcode=="110454"|	medcode=="102922"|	medcode=="106432"|	medcode=="73065"|	medcode=="49770"|	medcode=="1001"|	medcode=="148"|	medcode=="152"|	medcode=="3480"|	medcode=="3243"|	medcode=="25603"|	medcode=="15626"|	medcode=="61118"|	medcode=="11150"|	medcode=="40159"|	medcode=="37959"|	medcode=="61513"|	medcode=="27819"|	medcode=="5798"|	medcode=="14798"|	medcode=="1446"|	medcode=="26125"|	medcode=="44525"|	medcode=="24248"|	medcode=="66043"|	medcode=="45089"|	medcode=="68066"|	medcode=="15157"|	medcode=="794"|	medcode=="26306"|	medcode=="56860"|	medcode=="68662"|	medcode=="60188"|	medcode=="99536"|	medcode=="23492"|	medcode=="46578"|	medcode=="10980"|	medcode=="40788"|	medcode=="92955"|	medcode=="70787"|	medcode=="63479"|	medcode=="16410"|	medcode=="33450"|	medcode=="106805"|	medcode=="2195"|	medcode=="20364"|	medcode=="41491"|	medcode=="32679"|	medcode=="10863"|	medcode=="10802"|	medcode=="9876"|	medcode=="93568"|	medcode=="104608"|	medcode=="12166"|	medcode=="21061"|	medcode=="7884"|	medcode=="5710"|	medcode=="19492"|	medcode=="8303"|	medcode=="51410"|	medcode=="46460"|	medcode=="60805"|	medcode=="62233"|	medcode=="71853"|	medcode=="89206"|	medcode=="23446"|	medcode=="65376"|	medcode=="94894"|	medcode=="49194"|	medcode=="94575"|	medcode=="30235"|	medcode=="93577"|	medcode=="23461"|	medcode=="37365"|	medcode=="26442"|	medcode=="31423"|	medcode=="63172"|	medcode=="54830"|	medcode=="49025"|	medcode=="55758"|	medcode=="62227"|	medcode=="47142"|	medcode=="64721"|	medcode=="63216"|	medcode=="47782"|	medcode=="70815"|	medcode=="104557"|	medcode=="9711"|	medcode=="3847"|	medcode=="41781"|	medcode=="59083"|	medcode=="66104"|	medcode=="45948"|	medcode=="33837"|	medcode=="56647"|	medcode=="41015"|	medcode=="66773"|	medcode=="50876"|	medcode=="47504"|	medcode=="54252"|	medcode=="46066"|	medcode=="43285"|	medcode=="18130"|	medcode=="69914"|	medcode=="22536"|	medcode=="50374"|	medcode=="44015"|	medcode=="53205"|	medcode=="43417"|	medcode=="30214"|	medcode=="38297"|	medcode=="46405"|	medcode=="26082"|	medcode=="7321"|	medcode=="61229"|	medcode=="7791"|	medcode=="31806"|	medcode=="61119"|	medcode=="27348"|	medcode=="68814"|	medcode=="6837"|	medcode=="94136"|	medcode=="6051"|	medcode=="103472"|	medcode=="103559"|	medcode=="28229"|	medcode=="22835"|	medcode=="54308"|	medcode=="61991"|	medcode=="33830"|	medcode=="15815"|	medcode=="64799"|	medcode=="94996"|	medcode=="58791"|	medcode=="54010"|	medcode=="42940"|	medcode=="3859"|	medcode=="47364"|	medcode=="31564"|	medcode=="96655"|	medcode=="63912"|	medcode=="22905"|	medcode=="54893"|	medcode=="22915"|	medcode=="31319"|	medcode=="106650"|	medcode=="20269"|	medcode=="558"|	medcode=="39706"|	medcode=="5293"|	medcode=="65000"|	medcode=="93880"|	medcode=="72221"|	medcode=="96754"|	medcode=="24848"|	medcode=="24466"|	medcode=="99158"|	medcode=="8317"|	medcode=="103785"|	medcode=="109815"|	medcode=="104915"|	medcode=="24814"|	medcode=="94946"|	medcode=="94486"|	medcode=="59188"|	medcode=="66058"|	medcode=="65733"|	medcode=="105939"|	medcode=="106515"|	medcode=="99232"|	medcode=="105628"|	medcode=="54706"|	medcode=="65060"|	medcode=="91912"|	medcode=="71906"|	medcode=="56427"|	medcode=="38298"|	medcode=="94925"|	medcode=="6883"|	medcode=="93098"|	medcode=="13563")

fwrite(ext5clinRESP, paste("P:/Comorbidities/ext5clinRESP.csv"))
ext5clinRESP <- fread("P:/Comorbidities/ext5clinRESP.csv")

#heart ext5
ext5clinHEART1<-subset(ext5clin, medcode=="11284"|	medcode=="19066"|	medcode=="51214"|	medcode=="250"|	medcode=="53626"|	medcode=="61073"|	medcode=="4438"|	medcode=="242"|	medcode=="72939"|	medcode=="58529"|	medcode=="107416"|	medcode=="70105"|	medcode=="93844"|	medcode=="69734"|	medcode=="41495"|	medcode=="22262"|	medcode=="16292"|	medcode=="50157"|	medcode=="95334"|	medcode=="72668"|	medcode=="103046"|	medcode=="52427"|	medcode=="61660"|	medcode=="52127"|	medcode=="105938"|	medcode=="31464"|	medcode=="61166"|	medcode=="62718"|	medcode=="16173"|	medcode=="240"|	medcode=="241"|	medcode=="12139"|	medcode=="5387"|	medcode=="40429"|	medcode=="17872"|	medcode=="14897"|	medcode=="8935"|	medcode=="29643"|	medcode=="23892"|	medcode=="14898"|	medcode=="63467"|	medcode=="3704"|	medcode=="9507"|	medcode=="10562"|	medcode=="1678"|	medcode=="30330"|	medcode=="32854"|	medcode=="29758"|	medcode=="12229"|	medcode=="34803"|	medcode=="28736"|	medcode=="62626"|	medcode=="41221"|	medcode=="46017"|	medcode=="14658"|	medcode=="27951"|	medcode=="36523"|	medcode=="61072"|	medcode=="7347"|	medcode=="17307"|	medcode=="34328"|	medcode=="18118"|	medcode=="11983"|	medcode=="54251"|	medcode=="39449"|	medcode=="9413"|	medcode=="9276"|	medcode=="68357"|	medcode=="39693"|	medcode=="21844"|	medcode=="27977"|	medcode=="4017"|	medcode=="1430"|	medcode=="20095"|	medcode=="18125"|	medcode=="29902"|	medcode=="25842"|	medcode=="66388"|	medcode=="54535"|	medcode=="7696"|	medcode=="1414"|	medcode=="32450"|	medcode=="9555"|	medcode=="26863"|	medcode=="12804"|	medcode=="28554"|	medcode=="28138"|	medcode=="5413"|	medcode=="3999"|	medcode=="5254"|	medcode=="36609"|	medcode=="7320"|	medcode=="29421"|	medcode=="34633"|	medcode=="24540"|	medcode=="23078"|	medcode=="35713"|	medcode=="15754"|	medcode=="18889"|	medcode=="18842"|	medcode=="45809"|	medcode=="38609"|	medcode=="72562"|	medcode=="46166"|	medcode=="32272"|	medcode=="46112"|	medcode=="46276"|	medcode=="106812"|	medcode=="41835"|	medcode=="68748"|	medcode=="105479"|	medcode=="1676"|	medcode=="2062"|	medcode=="398"|	medcode=="23707"|	medcode=="32671"|	medcode=="27884"|	medcode=="11424"|	medcode=="94870"|	medcode=="884"|	medcode=="5255"|	medcode=="27964"|	medcode=="101138"|	medcode=="104275"|	medcode=="4024"|	medcode=="8966"|	medcode=="107397"|	medcode=="52517"|	medcode=="39546"|	medcode=="68401"|	medcode=="47637"|	medcode=="96838"|	medcode=="109035"|	medcode=="99991"|	medcode=="31518"|	medcode=="4964"|	medcode=="72604"|	medcode=="45505"|	medcode=="66245"|	medcode=="94344"|	medcode=="2816"|	medcode=="69858"|	medcode=="1778"|	medcode=="23988"|	medcode=="102980"|	medcode=="40025"|	medcode=="65318"|	medcode=="63390"|	medcode=="62169"|	medcode=="73539"|	medcode=="4864"|	medcode=="38967"|	medcode=="51649"|	medcode=="63046"|	medcode=="19969"|	medcode=="246"|	medcode=="42132"|	medcode=="56575"|	medcode=="67657"|	medcode=="9011"|	medcode=="51897"|	medcode=="20153"|	medcode=="54772"|	medcode=="34067"|	medcode=="7474"|	medcode=="3255"|	medcode=="3625"|	medcode=="37816"|	medcode=="59144"|	medcode=="53088"|	medcode=="54243"|	medcode=="63340"|	medcode=="51053"|	medcode=="101393"|	medcode=="49702"|	medcode=="55535"|	medcode=="43049"|	medcode=="44896"|	medcode=="73816"|	medcode=="46117"|	medcode=="9361"|	medcode=="48205"|	medcode=="66401"|	medcode=="54196"|	medcode=="5621"|	medcode=="39992"|	medcode=="69940"|	medcode=="3862"|	medcode=="54488"|	medcode=="93561"|	medcode=="22778"|	medcode=="112420"|	medcode=="45452"|	medcode=="33919"|	medcode=="21851"|	medcode=="44478"|	medcode=="107150"|	medcode=="52607"|	medcode=="70880"|	medcode=="12752"|	medcode=="21272"|	medcode=="69169"|	medcode=="100065"|	medcode=="23709"|	medcode=="6886"|	medcode=="8636"|	medcode=="58734"|	medcode=="3300"|	medcode=="6843"|	medcode=="57091"|	medcode=="90551"|	medcode=="73592"|	medcode=="63069")
ext5clinHEART2<-subset(ext5clin, medcode=="100291"|	medcode=="61651"|	medcode=="20772"|	medcode=="89256"|	medcode=="108457"|	medcode=="46825"|	medcode=="50529"|	medcode=="24789"|	medcode=="16539"|	medcode=="34668"|	medcode=="9401"|	medcode=="99128"|	medcode=="32748"|	medcode=="104266"|	medcode=="97818"|	medcode=="25481"|	medcode=="71956"|	medcode=="62163"|	medcode=="103894"|	medcode=="31373"|	medcode=="49901"|	medcode=="103412"|	medcode=="53546"|	medcode=="24533"|	medcode=="68097"|	medcode=="52310"|	medcode=="102167"|	medcode=="70992"|	medcode=="71678"|	medcode=="3774"|	medcode=="72259"|	medcode=="72405"|	medcode=="50284"|	medcode=="103584"|	medcode=="92426"|	medcode=="52615"|	medcode=="98061"|	medcode=="24854"|	medcode=="93089"|	medcode=="68063"|	medcode=="34007"|	medcode=="49133"|	medcode=="50362"|	medcode=="68894"|	medcode=="108193"|	medcode=="37451"|	medcode=="23752"|	medcode=="95785"|	medcode=="111360"|	medcode=="98317"|	medcode=="24714"|	medcode=="247"|	medcode=="26626"|	medcode=="109236"|	medcode=="103432"|	medcode=="64778"|	medcode=="38968"|	medcode=="3863"|	medcode=="11982"|	medcode=="3301"|	medcode=="57932"|	medcode=="72295"|	medcode=="70853"|	medcode=="37323"|	medcode=="59907"|	medcode=="50220"|	medcode=="62230"|	medcode=="30725"|	medcode=="67286"|	medcode=="30949"|	medcode=="46530"|	medcode=="49731"|	medcode=="44334"|	medcode=="90486"|	medcode=="70691"|	medcode=="34176"|	medcode=="68198"|	medcode=="59298"|	medcode=="37515"|	medcode=="63768"|	medcode=="53964"|	medcode=="62376"|	medcode=="58076"|	medcode=="44781"|	medcode=="49474"|	medcode=="56200"|	medcode=="11945"|	medcode=="11127"|	medcode=="63187"|	medcode=="67928"|	medcode=="31112"|	medcode=="18982"|	medcode=="54487"|	medcode=="2670"|	medcode=="96225"|	medcode=="65029"|	medcode=="32508"|	medcode=="52411"|	medcode=="42127"|	medcode=="42684"|	medcode=="45291"|	medcode=="74890"|	medcode=="50886"|	medcode=="51941"|	medcode=="105037"|	medcode=="103039"|	medcode=="68784"|	medcode=="46176"|	medcode=="101307"|	medcode=="99649"|	medcode=="73663"|	medcode=="101520"|	medcode=="72655"|	medcode=="51675"|	medcode=="41197"|	medcode=="110026"|	medcode=="36606"|	medcode=="71874"|	medcode=="51911"|	medcode=="73554"|	medcode=="101322"|	medcode=="109008"|	medcode=="110047"|	medcode=="106644"|	medcode=="107639"|	medcode=="110418"|	medcode=="107496"|	medcode=="107710"|	medcode=="9384"|	medcode=="25089"|	medcode=="22383"|	medcode=="21966")

ext5clinHEART <- rbindlist(list(ext5clinHEART1, ext5clinHEART2), use.names = TRUE, fill = TRUE)

fwrite(ext5clinHEART, paste("P:/Comorbidities/ext5clinHEART.csv"))
ext5clinHEART <- fread("P:/Comorbidities/ext5clinHEART.csv")

#renal ext5
ext5clinRENAL<-subset(ext5clin, medcode=="12479"|	medcode=="12585"|	medcode=="95122"|	medcode=="95406"|	medcode=="95508"|	medcode=="95405"|	medcode=="2997"|	medcode=="55151"|	medcode=="11745"|	medcode=="24361"|	medcode=="89924"|	medcode=="96133"|	medcode=="109455"|	medcode=="105787"|	medcode=="70874"|	medcode=="5504"|	medcode=="31549"|	medcode=="20073"|	medcode=="2994"|	medcode=="2996"|	medcode=="71124"|	medcode=="88597"|	medcode=="30756"|	medcode=="64828"|	medcode=="48022"|	medcode=="64636"|	medcode=="56760"|	medcode=="8037"|	medcode=="23773"|	medcode=="104586"|	medcode=="59194"|	medcode=="83513"|	medcode=="30709"|	medcode=="107901"|	medcode=="65089"|	medcode=="102210"|	medcode=="30323"|	medcode=="26054"|	medcode=="26860"|	medcode=="109840"|	medcode=="2999"|	medcode=="9840"|	medcode=="1803"|	medcode=="99644"|	medcode=="29634"|	medcode=="23913"|	medcode=="22852"|	medcode=="19316"|	medcode=="21947"|	medcode=="50472"|	medcode=="21989"|	medcode=="56987"|	medcode=="17365"|	medcode=="63786"|	medcode=="72303"|	medcode=="108591"|	medcode=="110749"|	medcode=="111370"|	medcode=="108816"|	medcode=="47922"|	medcode=="2471"|	medcode=="99201"|	medcode=="58750"|	medcode=="94373"|	medcode=="27427"|	medcode=="65064"|	medcode=="512"|	medcode=="6712"|	medcode=="104963"|	medcode=="105151"|	medcode=="350"|	medcode=="105302"|	medcode=="61814"|	medcode=="71174"|	medcode=="97734"|	medcode=="41285"|	medcode=="58060"|	medcode=="109945"|	medcode=="50200"|	medcode=="62320"|	medcode=="8330"|	medcode=="100205"|	medcode=="61930"|	medcode=="11554"|	medcode=="5911"|	medcode=="53940"|	medcode=="108494")

fwrite(ext5clinRENAL, paste("P:/Comorbidities/ext5clinRENAL.csv"))
ext5clinRENAL <- fread("P:/Comorbidities/ext5clinRENAL.csv")

#liver ext5
ext5clinLIVER<-subset(ext5clin, medcode=="4405"|	medcode=="32025"|	medcode=="71422"|	medcode=="69194"|	medcode=="105506"|	medcode=="97157"|	medcode=="99250"|	medcode=="27319"|	medcode=="26367"|	medcode=="24813"|	medcode=="41096"|	medcode=="30586"|	medcode=="106642"|	medcode=="32277"|	medcode=="108343"|	medcode=="107896"|	medcode=="110454"|	medcode=="102922"|	medcode=="48211"|	medcode=="6863"|	medcode=="4743"|	medcode=="21713"|	medcode=="17330"|	medcode=="1754"|	medcode=="23578"|	medcode=="9029"|	medcode=="1755"|	medcode=="53480"|	medcode=="66534"|	medcode=="53877"|	medcode=="15489"|	medcode=="16725"|	medcode=="69204"|	medcode=="3450"|	medcode=="44676"|	medcode=="92909"|	medcode=="40567"|	medcode=="27438"|	medcode=="96664"|	medcode=="100253"|	medcode=="73482"|	medcode=="112044"|	medcode=="109540"|	medcode=="48928"|	medcode=="55454"|	medcode=="16455"|	medcode=="9494"|	medcode=="5638"|	medcode=="15424"|	medcode=="91591"|	medcode=="58630"|	medcode=="7602"|	medcode=="42843"|	medcode=="25383"|	medcode=="60104"|	medcode=="100592"|	medcode=="33597"|	medcode=="10539"|	medcode=="5129"|	medcode=="10636"|	medcode=="24901"|	medcode=="48102"|	medcode=="17219"|	medcode=="64750"|	medcode=="39351"|	medcode=="44120"|	medcode=="26405"|	medcode=="18652"|	medcode=="15425"|	medcode=="6015"|	medcode=="25597"|	medcode=="16417"|	medcode=="38389"|	medcode=="48269"|	medcode=="50400"|	medcode=="50444"|	medcode=="40029"|	medcode=="10721"|	medcode=="71422"|	medcode=="4405"|	medcode=="32025"|	medcode=="69194")

fwrite(ext5clinLIVER, paste("P:/Comorbidities/ext5clinLIVER.csv"))
ext5clinLIVER <- fread("P:/Comorbidities/ext5clinLIVER.csv")

#diabetes ext5
ext5clinDIABETES<-subset(ext5clin, medcode=="711"|	medcode=="43453"|	medcode=="36695"|	medcode=="1549"|	medcode=="47582"|	medcode=="47649"|	medcode=="42831"|	medcode=="47650"|	medcode=="43921"|	medcode=="18683"|	medcode=="69993"|	medcode=="18387"|	medcode=="35288"|	medcode=="40682"|	medcode=="69676"|	medcode=="68105"|	medcode=="46301"|	medcode=="10418"|	medcode=="39070"|	medcode=="49554"|	medcode=="93468"|	medcode=="18642"|	medcode=="54008"|	medcode=="30323"|	medcode=="30294"|	medcode=="10692"|	medcode=="40837"|	medcode=="22871"|	medcode=="55239"|	medcode=="95636"|	medcode=="758"|	medcode=="18777"|	medcode=="47321"|	medcode=="34268"|	medcode=="65267"|	medcode=="49074"|	medcode=="12736"|	medcode=="18496"|	medcode=="25627"|	medcode=="47954"|	medcode=="62674"|	medcode=="18425"|	medcode=="12640"|	medcode=="46917"|	medcode=="44982"|	medcode=="37806"|	medcode=="59253"|	medcode=="35385"|	medcode=="1407"|	medcode=="34450"|	medcode=="26054"|	medcode=="18390"|	medcode=="32627"|	medcode=="51756"|	medcode=="25591"|	medcode=="63690"|	medcode=="95539"|	medcode=="51697"|	medcode=="96506"|	medcode=="61122"|	medcode=="67212"|	medcode=="43857"|	medcode=="22487"|	medcode=="94383"|	medcode=="93380"|	medcode=="52212"|	medcode=="106927"|	medcode=="53200"|	medcode=="42567"|	medcode=="54856"|	medcode=="6791"|	medcode=="31310"|	medcode=="60499"|	medcode=="52104"|	medcode=="52283"|	medcode=="49276"|	medcode=="46963"|	medcode=="6509"|	medcode=="44443"|	medcode=="8403"|	medcode=="40401"|	medcode=="68843"|	medcode=="62146"|	medcode=="55842"|	medcode=="50429"|	medcode=="52303"|	medcode=="17262"|	medcode=="34912")

fwrite(ext5clinDIABETES, paste("P:/Comorbidities/ext5clinDIABETES.csv"))
ext5clinDIABETES <- fread("P:/Comorbidities/ext5clinDIABETES.csv")

#immunosuppression ext5
ext5clinIMMUNO1<-subset(ext5clin, medcode=="47106"|	medcode=="22307"|	medcode=="34310"|	medcode=="108246"|	medcode=="27514"|	medcode=="1393"|	medcode=="31041"|	medcode=="102966"|	medcode=="59784"|	medcode=="106015"|	medcode=="32133"|	medcode=="23770"|	medcode=="58857"|	medcode=="58859"|	medcode=="69766"|	medcode=="70869"|	medcode=="53636"|	medcode=="70528"|	medcode=="101836"|	medcode=="47632"|	medcode=="111979"|	medcode=="67575"|	medcode=="71450"|	medcode=="62891"|	medcode=="36294"|	medcode=="44303"|	medcode=="37006"|	medcode=="66368"|	medcode=="23951"|	medcode=="27641"|	medcode=="50076"|	medcode=="27853"|	medcode=="44617"|	medcode=="66367"|	medcode=="105324"|	medcode=="65117"|	medcode=="8281"|	medcode=="51708"|	medcode=="62854"|	medcode=="112030"|	medcode=="107807"|	medcode=="112031"|	medcode=="102117"|	medcode=="104134"|	medcode=="112032"|	medcode=="69767"|	medcode=="112034"|	medcode=="112035"|	medcode=="112036"|	medcode=="112037"|	medcode=="96751"|	medcode=="102252"|	medcode=="100769"|	medcode=="65460"|	medcode=="108667"|	medcode=="72224"|	medcode=="93778"|	medcode=="12323"|	medcode=="41369"|	medcode=="1481"|	medcode=="60242"|	medcode=="71031"|	medcode=="70374"|	medcode=="95058"|	medcode=="99240"|	medcode=="27416"|	medcode=="71625"|	medcode=="71238"|	medcode=="62380"|	medcode=="64670"|	medcode=="100352"|	medcode=="103245"|	medcode=="104790"|	medcode=="63723"|	medcode=="21402"|	medcode=="59115"|	medcode=="100006"|	medcode=="97577"|	medcode=="92380"|	medcode=="71304"|	medcode=="99887"|	medcode=="99951"|	medcode=="2462"|	medcode=="65489"|	medcode=="100423"|	medcode=="98840"|	medcode=="44196"|	medcode=="98909"|	medcode=="64036"|	medcode=="68039"|	medcode=="38939"|	medcode=="71142"|	medcode=="68330"|	medcode=="92245"|	medcode=="73532"|	medcode=="93951"|	medcode=="95338"|	medcode=="106911"|	medcode=="104743"|	medcode=="29876"|	medcode=="29178"|	medcode=="57225"|	medcode=="55303"|	medcode=="67506"|	medcode=="61149"|	medcode=="65483"|	medcode=="105472"|	medcode=="19140"|	medcode=="63054"|	medcode=="49605"|	medcode=="97863"|	medcode=="94407"|	medcode=="58684"|	medcode=="108886"|	medcode=="94005"|	medcode=="67703"|	medcode=="95049"|	medcode=="111942"|	medcode=="63625"|	medcode=="110563"|	medcode=="101715"|	medcode=="107032"|	medcode=="101530"|	medcode=="104895"|	medcode=="105841"|	medcode=="108775"|	medcode=="106597"|	medcode=="104484"|	medcode=="53397"|	medcode=="61662"|	medcode=="59778"|	medcode=="59755"|	medcode=="107804"|	medcode=="91900"|	medcode=="99012"|	medcode=="94279"|	medcode=="97746"|	medcode=="42461"|	medcode=="5179"|	medcode=="66327"|	medcode=="45264"|	medcode=="105203"|	medcode=="92068"|	medcode=="111766"|	medcode=="94995"|	medcode=="58082"|	medcode=="65701"|	medcode=="12006"|	medcode=="95949"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="38005"|	medcode=="35014"|	medcode=="100532"|	medcode=="27330"|	medcode=="65122"|	medcode=="65123"|	medcode=="73777"|	medcode=="34926"|	medcode=="102715"|	medcode=="102158"|	medcode=="54083"|	medcode=="47204"|	medcode=="15036"|	medcode=="103900"|	medcode=="100615"|	medcode=="31324"|	medcode=="89657"|	medcode=="3604"|	medcode=="28639"|	medcode=="70842"|	medcode=="49262"|	medcode=="50668"|	medcode=="108182"|	medcode=="50695"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="95715"|	medcode=="101114"|	medcode=="31576"|	medcode=="21549"|	medcode=="70509"|	medcode=="102594"|	medcode=="105966"|	medcode=="105038"|	medcode=="31794"|	medcode=="39798"|	medcode=="104152"|	medcode=="105889"|	medcode=="105095"|	medcode=="107166"|	medcode=="105020"|	medcode=="107973"|	medcode=="106969"|	medcode=="108719"|	medcode=="106063"|	medcode=="105792"|	medcode=="105335"|	medcode=="105559"|	medcode=="105955"|	medcode=="109780"|	medcode=="107949"|	medcode=="105709"|	medcode=="105925"|	medcode=="105375")
ext5clinIMMUNO2<-subset(ext5clin, medcode=="105636"|	medcode=="105286"|	medcode=="104934"|	medcode=="106884"|	medcode=="104386"|	medcode=="104620"|	medcode=="104412"|	medcode=="111682"|	medcode=="17887"|	medcode=="90201"|	medcode=="57737"|	medcode=="12464"|	medcode=="44318"|	medcode=="12335"|	medcode=="57427"|	medcode=="50696"|	medcode=="72725"|	medcode=="42579"|	medcode=="34089"|	medcode=="63105"|	medcode=="71262"|	medcode=="60092"|	medcode=="15504"|	medcode=="15027"|	medcode=="65434"|	medcode=="37182"|	medcode=="4944"|	medcode=="22158"|	medcode=="19028"|	medcode=="21329"|	medcode=="46042"|	medcode=="104418"|	medcode=="39187"|	medcode=="64567"|	medcode=="43450"|	medcode=="19372"|	medcode=="4251"|	medcode=="104325"|	medcode=="8625"|	medcode=="104328"|	medcode=="107052"|	medcode=="106924"|	medcode=="107163"|	medcode=="72774"|	medcode=="49725"|	medcode=="31586"|	medcode=="37461"|	medcode=="108656"|	medcode=="107643"|	medcode=="104939"|	medcode=="38331"|	medcode=="38914"|	medcode=="7176"|	medcode=="4413"|	medcode=="10726"|	medcode=="100786"|	medcode=="105957"|	medcode=="102783"|	medcode=="107236"|	medcode=="27520"|	medcode=="63475"|	medcode=="70724"|	medcode=="52327"|	medcode=="39629"|	medcode=="104788"|	medcode=="112440"|	medcode=="27664"|	medcode=="66089"|	medcode=="33344"|	medcode=="35875"|	medcode=="19974"|	medcode=="27458"|	medcode=="101606"|	medcode=="108424"|	medcode=="99015"|	medcode=="103645"|	medcode=="93342"|	medcode=="37272"|	medcode=="42539"|	medcode=="37468"|	medcode=="57671"|	medcode=="65721"|	medcode=="50858"|	medcode=="28276"|	medcode=="110838"|	medcode=="104273"|	medcode=="94174"|	medcode=="72197"|	medcode=="99413"|	medcode=="30632"|	medcode=="25191"|	medcode=="4072"|	medcode=="16416"|	medcode=="54793"|	medcode=="34692"|	medcode=="4250"|	medcode=="20440"|	medcode=="61500"|	medcode=="22050"|	medcode=="104475"|	medcode=="105069"|	medcode=="30646"|	medcode=="6115"|	medcode=="39336"|	medcode=="49301"|	medcode=="25493"|	medcode=="2481"|	medcode=="11950"|	medcode=="106993"|	medcode=="104740"|	medcode=="105915"|	medcode=="45285"|	medcode=="46444"|	medcode=="70935"|	medcode=="40740"|	medcode=="43415"|	medcode=="67518"|	medcode=="98596"|	medcode=="64336"|	medcode=="102688"|	medcode=="67029"|	medcode=="61693"|	medcode=="89762"|	medcode=="89329"|	medcode=="65165"|	medcode=="105025"|	medcode=="72500"|	medcode=="64515"|	medcode=="109714"|	medcode=="63375"|	medcode=="8649"|	medcode=="45143"|	medcode=="69545"|	medcode=="15883"|	medcode=="106381"|	medcode=="3451"|	medcode=="12306"|	medcode=="12386"|	medcode=="16527"|	medcode=="10411"|	medcode=="101350"|	medcode=="99067"|	medcode=="108102"|	medcode=="71994"|	medcode=="18486"|	medcode=="51041"|	medcode=="27934"|	medcode=="104554"|	medcode=="110183"|	medcode=="44147"|	medcode=="15137"|	medcode=="8548"|	medcode=="18701"|	medcode=="18700"|	medcode=="68440"|	medcode=="57161"|	medcode=="69373"|	medcode=="57322"|	medcode=="92569"|	medcode=="62598"|	medcode=="69184"|	medcode=="60026"|	medcode=="69854"|	medcode=="16295"|	medcode=="48307"|	medcode=="50665"|	medcode=="31322"|	medcode=="62236"|	medcode=="48293"|	medcode=="31541"|	medcode=="66073"|	medcode=="49542"|	medcode=="50526"|	medcode=="103977"|	medcode=="62328"|	medcode=="3129"|	medcode=="65617"|	medcode=="56108"|	medcode=="54203"|	medcode=="21975"|	medcode=="93892"|	medcode=="66857"|	medcode=="36408"|	medcode=="109671"|	medcode=="54904"|	medcode=="63204"|	medcode=="32141"|	medcode=="91911"|	medcode=="66049"|	medcode=="40950"|	medcode=="18781"| medcode=="38306"|	medcode=="39034"|	medcode=="34150"|	medcode=="5572"|	medcode=="2337"|	medcode=="41185"|	medcode=="73583"|	medcode=="12699"|	medcode=="5655"|	medcode=="66740"|	medcode=="27515"|	medcode=="51640"|	medcode=="32270"|	medcode=="57551"|	medcode=="95005"|	medcode=="39420"|	medcode=="61069"|	medcode=="56973"|	medcode=="47695"|	medcode=="65825")
ext5clinIMMUNO3<-subset(ext5clin, medcode=="63323"|	medcode=="53317"|	medcode=="20261"|	medcode=="11346"|	medcode=="100043"|	medcode=="52604"|	medcode=="57525"|	medcode=="40406"|	medcode=="70236"|	medcode=="62041"|	medcode=="22319"|	medcode=="101375"|	medcode=="101075"|	medcode=="4072"|	medcode=="4251"|	medcode=="19974"|	medcode=="4413"|	medcode=="50858"|	medcode=="27664"|	medcode=="37461"|	medcode=="52327"|	medcode=="100786"|	medcode=="16416"|	medcode=="8625"|	medcode=="27458"|	medcode=="10726"|	medcode=="27520"|	medcode=="22050"|	medcode=="102783"|	medcode=="50668"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="21549"|	medcode=="70842"|	medcode=="99067"|	medcode=="39629"|	medcode=="27330"|	medcode=="53397"|	medcode=="107804"|	medcode=="59755"|	medcode=="91900"|	medcode=="59778"|	medcode=="99012"|	medcode=="97746"|	medcode=="94279"|	medcode=="61662"|	medcode=="67703"|	medcode=="101530"|	medcode=="63625"|	medcode=="111942"|	medcode=="110563"|	medcode=="107032"|	medcode=="101715"|	medcode=="73532"|	medcode=="95338"|	medcode=="92245"|	medcode=="68330"|	medcode=="93951"|	medcode=="104743"|	medcode=="71142"|	medcode=="49605"|	medcode=="94005"|	medcode=="58684"|	medcode=="94407"|	medcode=="108886"|	medcode=="97863"|	medcode=="29178"|	medcode=="63054"|	medcode=="61149"|	medcode=="67506"|	medcode=="65483"|	medcode=="55303"|	medcode=="19140"|	medcode=="105472"|	medcode=="57225"|	medcode=="95049"|	medcode=="64036"|	medcode=="68039"|	medcode=="29876"|	medcode=="106911"|	medcode=="43450"|	medcode=="34926"|	medcode=="47204"|	medcode=="102158"|	medcode=="54083"|	medcode=="102715"|	medcode=="4250"|	medcode=="25191"|	medcode=="73777"|	medcode=="65123"|	medcode=="65122"|	medcode=="38939"|	medcode=="19372"|	medcode=="38914"|	medcode=="72197"|	medcode=="16527"|	medcode=="71994"|	medcode=="50695"|	medcode=="108182"|	medcode=="12335"|	medcode=="42579"|	medcode=="71262"|	medcode=="72725"|	medcode=="34089"|	medcode=="50696"|	medcode=="63105"|	medcode=="15504"|	medcode=="60092"|	medcode=="57427"|	medcode=="17887"|	medcode=="89657"|	medcode=="15036"|	medcode=="49301"|	medcode=="30646"|	medcode=="65434"|	medcode=="22158"|	medcode=="65721"|	medcode=="100615"|	medcode=="31324"|	medcode=="103900"|	medcode=="57671"|	medcode=="15883"|	medcode=="35875"|	medcode=="93342"|	medcode=="37182"|	medcode=="12006"|	medcode=="38005"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="95949"|	medcode=="7176"|	medcode=="33344"|	medcode=="70724"|	medcode=="4944"|	medcode=="20440"|	medcode=="25493"|	medcode=="65701"|	medcode=="92068"|	medcode=="105203"|	medcode=="111766"|	medcode=="45264"|	medcode=="94995"|	medcode=="58082"|	medcode=="66327"|	medcode=="3604"|	medcode=="94174"|	medcode=="99413"|	medcode=="64567"|	medcode=="34692"|	medcode=="49725"|	medcode=="38331"|	medcode=="99015"|	medcode=="103645"|	medcode=="112440"|	medcode=="66089"|	medcode=="3451"|	medcode=="37272"|	medcode=="30632"|	medcode=="31576"|	medcode=="12386"|	medcode=="2481"|	medcode=="31586"|	medcode=="35014"|	medcode=="100532"|	medcode=="54793"|	medcode=="72774"|	medcode=="101606"|	medcode=="63475"|	medcode=="104475"|	medcode=="10411"|	medcode=="5019"|	medcode=="102559"|	medcode=="59610"|	medcode=="105256"|	medcode=="31489"|	medcode=="10505")

ext5clinIMMUNO <- rbindlist(list(ext5clinIMMUNO1, ext5clinIMMUNO2, ext5clinIMMUNO3), use.names = TRUE, fill = TRUE)

fwrite(ext5clinIMMUNO, paste("P:/Comorbidities/ext5clinIMMUNO.csv"))
ext5clinIMMUNO <- fread("P:/Comorbidities/ext5clinIMMUNO.csv")

#csf leaks and cochear ext5
ext5clinCSF<-subset(ext5clin, medcode=="30525"|	medcode=="43643"|	medcode=="42441"|	medcode=="36513"|	medcode=="20641"|	medcode=="26158"|	medcode=="40348"|	medcode=="20488"|	medcode=="27295"|	medcode=="35762"|	medcode=="16172"|	medcode=="9300"|	medcode=="17957"|	medcode=="36424"|	medcode=="97074"|	medcode=="55931"|	medcode=="33396"|	medcode=="48851"|	medcode=="71772"|	medcode=="41393"|	medcode=="54342"|	medcode=="10708"|	medcode=="61980"|	medcode=="98472"|	medcode=="57642"|	medcode=="74897")

fwrite(ext5clinCSF, paste("P:/Comorbidities/ext5clinCSF.csv"))
ext5clinCSF <- fread("P:/Comorbidities/ext5clinCSF.csv")

#bind all
ext5clinALL <- rbindlist(list(ext5clinRESP, ext5clinHEART, ext5clinRENAL, ext5clinLIVER, ext5clinDIABETES, ext5clinIMMUNO, ext5clinCSF), use.names = TRUE, fill = TRUE)

fwrite(ext5clinALL, paste("P:/Comorbidities/ext5clinALL.csv"))
ext5clinALL <- fread("P:/Comorbidities/ext5clinALL.csv")


#bind all resp
ALLextRESP <- rbindlist(list(ext1clinRESP, ext2clinRESP, ext3clinRESP, ext4clinRESP, ext5clinRESP), use.names = TRUE, fill = TRUE)

fwrite(ALLextRESP, paste("P:/Comorbidities/ALLextRESP.csv"))
ALLextRESP <- fread("P:/Comorbidities/ALLextRESP.csv")

#bind all heart
ALLextHEART <- rbindlist(list(ext1clinHEART, ext2clinHEART, ext3clinHEART, ext4clinHEART, ext5clinHEART), use.names = TRUE, fill = TRUE)

fwrite(ALLextHEART, paste("P:/Comorbidities/ALLextHEART.csv"))
ALLextHEART <- fread("P:/Comorbidities/ALLextHEART.csv")

#bind all renal
ALLextRENAL <- rbindlist(list(ext1clinRENAL, ext2clinRENAL, ext3clinRENAL, ext4clinRENAL, ext5clinRENAL), use.names = TRUE, fill = TRUE)

fwrite(ALLextRENAL, paste("P:/Comorbidities/ALLextRENAL.csv"))
ALLextRENAL <- fread("P:/Comorbidities/ALLextRENAL.csv")

#bind all liver
ALLextLIVER <- rbindlist(list(ext1clinLIVER, ext2clinLIVER, ext3clinLIVER, ext4clinLIVER, ext5clinLIVER), use.names = TRUE, fill = TRUE)

fwrite(ALLextLIVER, paste("P:/Comorbidities/ALLextLIVER.csv"))
ALLextLIVER <- fread("P:/Comorbidities/ALLextLIVER.csv")

#bind all diabetes
ALLextDIABETES <- rbindlist(list(ext1clinDIABETES, ext2clinDIABETES, ext3clinDIABETES, ext4clinDIABETES, ext5clinDIABETES), use.names = TRUE, fill = TRUE)

fwrite(ALLextDIABETES, paste("P:/Comorbidities/ALLextDIABETES.csv"))
ALLextDIABETES <- fread("P:/Comorbidities/ALLextDIABETES.csv")

#bind all immuno
ALLextIMMUNO <- rbindlist(list(ext1clinIMMUNO, ext2clinIMMUNO, ext3clinIMMUNO, ext4clinIMMUNO, ext5clinIMMUNO), use.names = TRUE, fill = TRUE)

fwrite(ALLextIMMUNO, paste("P:/Comorbidities/ALLextIMMUNO.csv"))
ALLextIMMUNO <- fread("P:/Comorbidities/ALLextIMMUNO.csv")

#bind all csf
ALLextCSF <- rbindlist(list(ext1clinCSF, ext2clinCSF, ext3clinCSF, ext4clinCSF, ext5clinCSF), use.names = TRUE, fill = TRUE)

fwrite(ALLextCSF, paste("P:/Comorbidities/ALLextCSF.csv"))
ALLextCSF <- fread("P:/Comorbidities/ALLextCSF.csv")


#extraction referral
ext1ref <- fread("P:/CPRD_mother_baby_GOLD/ext1/Referral/ext1_Extract_Referral_001.txt")
ext2ref <- fread("P:/CPRD_mother_baby_GOLD/ext2/Referral/ext2_Extract_Referral_001.txt")
ext3ref <- fread("P:/CPRD_mother_baby_GOLD/ext3/Referral/ext3_Extract_Referral_001.txt")
ext4ref <- fread("P:/CPRD_mother_baby_GOLD/ext4/Referral/ext4_Extract_Referral_001.txt")
ext5ref <- fread("P:/CPRD_mother_baby_GOLD/ext5/Referral/ext5_Extract_Referral_001.txt")


#ext1 ref resp
ext1refRESP<-subset(ext1ref, medcode=="10461"|	medcode=="96578"|	medcode=="93713"|	medcode=="73743"|	medcode=="38011"|	medcode=="15693"|	medcode=="65117"|	medcode=="100742"|	medcode=="33980"|	medcode=="58841"|	medcode=="93380"|	medcode=="29966"|	medcode=="6220"|	medcode=="65344"|	medcode=="69017"|	medcode=="18914"|	medcode=="18905"|	medcode=="100610"|	medcode=="103224"|	medcode=="110454"|	medcode=="102922"|	medcode=="106432"|	medcode=="73065"|	medcode=="49770"|	medcode=="1001"|	medcode=="148"|	medcode=="152"|	medcode=="3480"|	medcode=="3243"|	medcode=="25603"|	medcode=="15626"|	medcode=="61118"|	medcode=="11150"|	medcode=="40159"|	medcode=="37959"|	medcode=="61513"|	medcode=="27819"|	medcode=="5798"|	medcode=="14798"|	medcode=="1446"|	medcode=="26125"|	medcode=="44525"|	medcode=="24248"|	medcode=="66043"|	medcode=="45089"|	medcode=="68066"|	medcode=="15157"|	medcode=="794"|	medcode=="26306"|	medcode=="56860"|	medcode=="68662"|	medcode=="60188"|	medcode=="99536"|	medcode=="23492"|	medcode=="46578"|	medcode=="10980"|	medcode=="40788"|	medcode=="92955"|	medcode=="70787"|	medcode=="63479"|	medcode=="16410"|	medcode=="33450"|	medcode=="106805"|	medcode=="2195"|	medcode=="20364"|	medcode=="41491"|	medcode=="32679"|	medcode=="10863"|	medcode=="10802"|	medcode=="9876"|	medcode=="93568"|	medcode=="104608"|	medcode=="12166"|	medcode=="21061"|	medcode=="7884"|	medcode=="5710"|	medcode=="19492"|	medcode=="8303"|	medcode=="51410"|	medcode=="46460"|	medcode=="60805"|	medcode=="62233"|	medcode=="71853"|	medcode=="89206"|	medcode=="23446"|	medcode=="65376"|	medcode=="94894"|	medcode=="49194"|	medcode=="94575"|	medcode=="30235"|	medcode=="93577"|	medcode=="23461"|	medcode=="37365"|	medcode=="26442"|	medcode=="31423"|	medcode=="63172"|	medcode=="54830"|	medcode=="49025"|	medcode=="55758"|	medcode=="62227"|	medcode=="47142"|	medcode=="64721"|	medcode=="63216"|	medcode=="47782"|	medcode=="70815"|	medcode=="104557"|	medcode=="9711"|	medcode=="3847"|	medcode=="41781"|	medcode=="59083"|	medcode=="66104"|	medcode=="45948"|	medcode=="33837"|	medcode=="56647"|	medcode=="41015"|	medcode=="66773"|	medcode=="50876"|	medcode=="47504"|	medcode=="54252"|	medcode=="46066"|	medcode=="43285"|	medcode=="18130"|	medcode=="69914"|	medcode=="22536"|	medcode=="50374"|	medcode=="44015"|	medcode=="53205"|	medcode=="43417"|	medcode=="30214"|	medcode=="38297"|	medcode=="46405"|	medcode=="26082"|	medcode=="7321"|	medcode=="61229"|	medcode=="7791"|	medcode=="31806"|	medcode=="61119"|	medcode=="27348"|	medcode=="68814"|	medcode=="6837"|	medcode=="94136"|	medcode=="6051"|	medcode=="103472"|	medcode=="103559"|	medcode=="28229"|	medcode=="22835"|	medcode=="54308"|	medcode=="61991"|	medcode=="33830"|	medcode=="15815"|	medcode=="64799"|	medcode=="94996"|	medcode=="58791"|	medcode=="54010"|	medcode=="42940"|	medcode=="3859"|	medcode=="47364"|	medcode=="31564"|	medcode=="96655"|	medcode=="63912"|	medcode=="22905"|	medcode=="54893"|	medcode=="22915"|	medcode=="31319"|	medcode=="106650"|	medcode=="20269"|	medcode=="558"|	medcode=="39706"|	medcode=="5293"|	medcode=="65000"|	medcode=="93880"|	medcode=="72221"|	medcode=="96754"|	medcode=="24848"|	medcode=="24466"|	medcode=="99158"|	medcode=="8317"|	medcode=="103785"|	medcode=="109815"|	medcode=="104915"|	medcode=="24814"|	medcode=="94946"|	medcode=="94486"|	medcode=="59188"|	medcode=="66058"|	medcode=="65733"|	medcode=="105939"|	medcode=="106515"|	medcode=="99232"|	medcode=="105628"|	medcode=="54706"|	medcode=="65060"|	medcode=="91912"|	medcode=="71906"|	medcode=="56427"|	medcode=="38298"|	medcode=="94925"|	medcode=="6883"|	medcode=="93098"|	medcode=="13563")

fwrite(ext1refRESP, paste("P:/Comorbidities/ext1refRESP.csv"))
ext1refRESP <- fread("P:/Comorbidities/ext1refRESP.csv")

#ext1 heart ref
ext1refHEART1<-subset(ext1ref, medcode=="11284"|	medcode=="19066"|	medcode=="51214"|	medcode=="250"|	medcode=="53626"|	medcode=="61073"|	medcode=="4438"|	medcode=="242"|	medcode=="72939"|	medcode=="58529"|	medcode=="107416"|	medcode=="70105"|	medcode=="93844"|	medcode=="69734"|	medcode=="41495"|	medcode=="22262"|	medcode=="16292"|	medcode=="50157"|	medcode=="95334"|	medcode=="72668"|	medcode=="103046"|	medcode=="52427"|	medcode=="61660"|	medcode=="52127"|	medcode=="105938"|	medcode=="31464"|	medcode=="61166"|	medcode=="62718"|	medcode=="16173"|	medcode=="240"|	medcode=="241"|	medcode=="12139"|	medcode=="5387"|	medcode=="40429"|	medcode=="17872"|	medcode=="14897"|	medcode=="8935"|	medcode=="29643"|	medcode=="23892"|	medcode=="14898"|	medcode=="63467"|	medcode=="3704"|	medcode=="9507"|	medcode=="10562"|	medcode=="1678"|	medcode=="30330"|	medcode=="32854"|	medcode=="29758"|	medcode=="12229"|	medcode=="34803"|	medcode=="28736"|	medcode=="62626"|	medcode=="41221"|	medcode=="46017"|	medcode=="14658"|	medcode=="27951"|	medcode=="36523"|	medcode=="61072"|	medcode=="7347"|	medcode=="17307"|	medcode=="34328"|	medcode=="18118"|	medcode=="11983"|	medcode=="54251"|	medcode=="39449"|	medcode=="9413"|	medcode=="9276"|	medcode=="68357"|	medcode=="39693"|	medcode=="21844"|	medcode=="27977"|	medcode=="4017"|	medcode=="1430"|	medcode=="20095"|	medcode=="18125"|	medcode=="29902"|	medcode=="25842"|	medcode=="66388"|	medcode=="54535"|	medcode=="7696"|	medcode=="1414"|	medcode=="32450"|	medcode=="9555"|	medcode=="26863"|	medcode=="12804"|	medcode=="28554"|	medcode=="28138"|	medcode=="5413"|	medcode=="3999"|	medcode=="5254"|	medcode=="36609"|	medcode=="7320"|	medcode=="29421"|	medcode=="34633"|	medcode=="24540"|	medcode=="23078"|	medcode=="35713"|	medcode=="15754"|	medcode=="18889"|	medcode=="18842"|	medcode=="45809"|	medcode=="38609"|	medcode=="72562"|	medcode=="46166"|	medcode=="32272"|	medcode=="46112"|	medcode=="46276"|	medcode=="106812"|	medcode=="41835"|	medcode=="68748"|	medcode=="105479"|	medcode=="1676"|	medcode=="2062"|	medcode=="398"|	medcode=="23707"|	medcode=="32671"|	medcode=="27884"|	medcode=="11424"|	medcode=="94870"|	medcode=="884"|	medcode=="5255"|	medcode=="27964"|	medcode=="101138"|	medcode=="104275"|	medcode=="4024"|	medcode=="8966"|	medcode=="107397"|	medcode=="52517"|	medcode=="39546"|	medcode=="68401"|	medcode=="47637"|	medcode=="96838"|	medcode=="109035"|	medcode=="99991"|	medcode=="31518"|	medcode=="4964"|	medcode=="72604"|	medcode=="45505"|	medcode=="66245"|	medcode=="94344"|	medcode=="2816"|	medcode=="69858"|	medcode=="1778"|	medcode=="23988"|	medcode=="102980"|	medcode=="40025"|	medcode=="65318"|	medcode=="63390"|	medcode=="62169"|	medcode=="73539"|	medcode=="4864"|	medcode=="38967"|	medcode=="51649"|	medcode=="63046"|	medcode=="19969"|	medcode=="246"|	medcode=="42132"|	medcode=="56575"|	medcode=="67657"|	medcode=="9011"|	medcode=="51897"|	medcode=="20153"|	medcode=="54772"|	medcode=="34067"|	medcode=="7474"|	medcode=="3255"|	medcode=="3625"|	medcode=="37816"|	medcode=="59144"|	medcode=="53088"|	medcode=="54243"|	medcode=="63340"|	medcode=="51053"|	medcode=="101393"|	medcode=="49702"|	medcode=="55535"|	medcode=="43049"|	medcode=="44896"|	medcode=="73816"|	medcode=="46117"|	medcode=="9361"|	medcode=="48205"|	medcode=="66401"|	medcode=="54196"|	medcode=="5621"|	medcode=="39992"|	medcode=="69940"|	medcode=="3862"|	medcode=="54488"|	medcode=="93561"|	medcode=="22778"|	medcode=="112420"|	medcode=="45452"|	medcode=="33919"|	medcode=="21851"|	medcode=="44478"|	medcode=="107150"|	medcode=="52607"|	medcode=="70880"|	medcode=="12752"|	medcode=="21272"|	medcode=="69169"|	medcode=="100065"|	medcode=="23709"|	medcode=="6886"|	medcode=="8636"|	medcode=="58734"|	medcode=="3300"|	medcode=="6843"|	medcode=="57091"|	medcode=="90551"|	medcode=="73592"|	medcode=="63069")
ext1refHEART2<-subset(ext1ref, medcode=="100291"|	medcode=="61651"|	medcode=="20772"|	medcode=="89256"|	medcode=="108457"|	medcode=="46825"|	medcode=="50529"|	medcode=="24789"|	medcode=="16539"|	medcode=="34668"|	medcode=="9401"|	medcode=="99128"|	medcode=="32748"|	medcode=="104266"|	medcode=="97818"|	medcode=="25481"|	medcode=="71956"|	medcode=="62163"|	medcode=="103894"|	medcode=="31373"|	medcode=="49901"|	medcode=="103412"|	medcode=="53546"|	medcode=="24533"|	medcode=="68097"|	medcode=="52310"|	medcode=="102167"|	medcode=="70992"|	medcode=="71678"|	medcode=="3774"|	medcode=="72259"|	medcode=="72405"|	medcode=="50284"|	medcode=="103584"|	medcode=="92426"|	medcode=="52615"|	medcode=="98061"|	medcode=="24854"|	medcode=="93089"|	medcode=="68063"|	medcode=="34007"|	medcode=="49133"|	medcode=="50362"|	medcode=="68894"|	medcode=="108193"|	medcode=="37451"|	medcode=="23752"|	medcode=="95785"|	medcode=="111360"|	medcode=="98317"|	medcode=="24714"|	medcode=="247"|	medcode=="26626"|	medcode=="109236"|	medcode=="103432"|	medcode=="64778"|	medcode=="38968"|	medcode=="3863"|	medcode=="11982"|	medcode=="3301"|	medcode=="57932"|	medcode=="72295"|	medcode=="70853"|	medcode=="37323"|	medcode=="59907"|	medcode=="50220"|	medcode=="62230"|	medcode=="30725"|	medcode=="67286"|	medcode=="30949"|	medcode=="46530"|	medcode=="49731"|	medcode=="44334"|	medcode=="90486"|	medcode=="70691"|	medcode=="34176"|	medcode=="68198"|	medcode=="59298"|	medcode=="37515"|	medcode=="63768"|	medcode=="53964"|	medcode=="62376"|	medcode=="58076"|	medcode=="44781"|	medcode=="49474"|	medcode=="56200"|	medcode=="11945"|	medcode=="11127"|	medcode=="63187"|	medcode=="67928"|	medcode=="31112"|	medcode=="18982"|	medcode=="54487"|	medcode=="2670"|	medcode=="96225"|	medcode=="65029"|	medcode=="32508"|	medcode=="52411"|	medcode=="42127"|	medcode=="42684"|	medcode=="45291"|	medcode=="74890"|	medcode=="50886"|	medcode=="51941"|	medcode=="105037"|	medcode=="103039"|	medcode=="68784"|	medcode=="46176"|	medcode=="101307"|	medcode=="99649"|	medcode=="73663"|	medcode=="101520"|	medcode=="72655"|	medcode=="51675"|	medcode=="41197"|	medcode=="110026"|	medcode=="36606"|	medcode=="71874"|	medcode=="51911"|	medcode=="73554"|	medcode=="101322"|	medcode=="109008"|	medcode=="110047"|	medcode=="106644"|	medcode=="107639"|	medcode=="110418"|	medcode=="107496"|	medcode=="107710"|	medcode=="9384"|	medcode=="25089"|	medcode=="22383"|	medcode=="21966")

ext1refHEART <- rbindlist(list(ext1refHEART1, ext1refHEART2), use.names = TRUE, fill = TRUE)

fwrite(ext1refHEART, paste("P:/Comorbidities/ext1refHEART.csv"))
ext1refHEART <- fread("P:/Comorbidities/ext1refHEART.csv")

#ext1 renal ref
ext1refRENAL<-subset(ext1ref, medcode=="12479"|	medcode=="12585"|	medcode=="95122"|	medcode=="95406"|	medcode=="95508"|	medcode=="95405"|	medcode=="2997"|	medcode=="55151"|	medcode=="11745"|	medcode=="24361"|	medcode=="89924"|	medcode=="96133"|	medcode=="109455"|	medcode=="105787"|	medcode=="70874"|	medcode=="5504"|	medcode=="31549"|	medcode=="20073"|	medcode=="2994"|	medcode=="2996"|	medcode=="71124"|	medcode=="88597"|	medcode=="30756"|	medcode=="64828"|	medcode=="48022"|	medcode=="64636"|	medcode=="56760"|	medcode=="8037"|	medcode=="23773"|	medcode=="104586"|	medcode=="59194"|	medcode=="83513"|	medcode=="30709"|	medcode=="107901"|	medcode=="65089"|	medcode=="102210"|	medcode=="30323"|	medcode=="26054"|	medcode=="26860"|	medcode=="109840"|	medcode=="2999"|	medcode=="9840"|	medcode=="1803"|	medcode=="99644"|	medcode=="29634"|	medcode=="23913"|	medcode=="22852"|	medcode=="19316"|	medcode=="21947"|	medcode=="50472"|	medcode=="21989"|	medcode=="56987"|	medcode=="17365"|	medcode=="63786"|	medcode=="72303"|	medcode=="108591"|	medcode=="110749"|	medcode=="111370"|	medcode=="108816"|	medcode=="47922"|	medcode=="2471"|	medcode=="99201"|	medcode=="58750"|	medcode=="94373"|	medcode=="27427"|	medcode=="65064"|	medcode=="512"|	medcode=="6712"|	medcode=="104963"|	medcode=="105151"|	medcode=="350"|	medcode=="105302"|	medcode=="61814"|	medcode=="71174"|	medcode=="97734"|	medcode=="41285"|	medcode=="58060"|	medcode=="109945"|	medcode=="50200"|	medcode=="62320"|	medcode=="8330"|	medcode=="100205"|	medcode=="61930"|	medcode=="11554"|	medcode=="5911"|	medcode=="53940"|	medcode=="108494")

fwrite(ext1refRENAL, paste("P:/Comorbidities/ext1refRENAL.csv"))
ext1refRENAL <- fread("P:/Comorbidities/ext1refRENAL.csv")

#ext1 liver ref
ext1refLIVER<-subset(ext1ref, medcode=="4405"|	medcode=="32025"|	medcode=="71422"|	medcode=="69194"|	medcode=="105506"|	medcode=="97157"|	medcode=="99250"|	medcode=="27319"|	medcode=="26367"|	medcode=="24813"|	medcode=="41096"|	medcode=="30586"|	medcode=="106642"|	medcode=="32277"|	medcode=="108343"|	medcode=="107896"|	medcode=="110454"|	medcode=="102922"|	medcode=="48211"|	medcode=="6863"|	medcode=="4743"|	medcode=="21713"|	medcode=="17330"|	medcode=="1754"|	medcode=="23578"|	medcode=="9029"|	medcode=="1755"|	medcode=="53480"|	medcode=="66534"|	medcode=="53877"|	medcode=="15489"|	medcode=="16725"|	medcode=="69204"|	medcode=="3450"|	medcode=="44676"|	medcode=="92909"|	medcode=="40567"|	medcode=="27438"|	medcode=="96664"|	medcode=="100253"|	medcode=="73482"|	medcode=="112044"|	medcode=="109540"|	medcode=="48928"|	medcode=="55454"|	medcode=="16455"|	medcode=="9494"|	medcode=="5638"|	medcode=="15424"|	medcode=="91591"|	medcode=="58630"|	medcode=="7602"|	medcode=="42843"|	medcode=="25383"|	medcode=="60104"|	medcode=="100592"|	medcode=="33597"|	medcode=="10539"|	medcode=="5129"|	medcode=="10636"|	medcode=="24901"|	medcode=="48102"|	medcode=="17219"|	medcode=="64750"|	medcode=="39351"|	medcode=="44120"|	medcode=="26405"|	medcode=="18652"|	medcode=="15425"|	medcode=="6015"|	medcode=="25597"|	medcode=="16417"|	medcode=="38389"|	medcode=="48269"|	medcode=="50400"|	medcode=="50444"|	medcode=="40029"|	medcode=="10721"|	medcode=="71422"|	medcode=="4405"|	medcode=="32025"|	medcode=="69194")

fwrite(ext1refLIVER, paste("P:/Comorbidities/ext1refLIVER.csv"))
ext1refLIVER <- fread("P:/Comorbidities/ext1refLIVER.csv")

#ext1 diabetes ref
ext1refDIABETES<-subset(ext1ref, medcode=="711"|	medcode=="43453"|	medcode=="36695"|	medcode=="1549"|	medcode=="47582"|	medcode=="47649"|	medcode=="42831"|	medcode=="47650"|	medcode=="43921"|	medcode=="18683"|	medcode=="69993"|	medcode=="18387"|	medcode=="35288"|	medcode=="40682"|	medcode=="69676"|	medcode=="68105"|	medcode=="46301"|	medcode=="10418"|	medcode=="39070"|	medcode=="49554"|	medcode=="93468"|	medcode=="18642"|	medcode=="54008"|	medcode=="30323"|	medcode=="30294"|	medcode=="10692"|	medcode=="40837"|	medcode=="22871"|	medcode=="55239"|	medcode=="95636"|	medcode=="758"|	medcode=="18777"|	medcode=="47321"|	medcode=="34268"|	medcode=="65267"|	medcode=="49074"|	medcode=="12736"|	medcode=="18496"|	medcode=="25627"|	medcode=="47954"|	medcode=="62674"|	medcode=="18425"|	medcode=="12640"|	medcode=="46917"|	medcode=="44982"|	medcode=="37806"|	medcode=="59253"|	medcode=="35385"|	medcode=="1407"|	medcode=="34450"|	medcode=="26054"|	medcode=="18390"|	medcode=="32627"|	medcode=="51756"|	medcode=="25591"|	medcode=="63690"|	medcode=="95539"|	medcode=="51697"|	medcode=="96506"|	medcode=="61122"|	medcode=="67212"|	medcode=="43857"|	medcode=="22487"|	medcode=="94383"|	medcode=="93380"|	medcode=="52212"|	medcode=="106927"|	medcode=="53200"|	medcode=="42567"|	medcode=="54856"|	medcode=="6791"|	medcode=="31310"|	medcode=="60499"|	medcode=="52104"|	medcode=="52283"|	medcode=="49276"|	medcode=="46963"|	medcode=="6509"|	medcode=="44443"|	medcode=="8403"|	medcode=="40401"|	medcode=="68843"|	medcode=="62146"|	medcode=="55842"|	medcode=="50429"|	medcode=="52303"|	medcode=="17262"|	medcode=="34912")

fwrite(ext1refDIABETES, paste("P:/Comorbidities/ext1refDIABETES.csv"))
ext1refDIABETES <- fread("P:/Comorbidities/ext1refDIABETES.csv")

#ext1 immuno ref
ext1refIMMUNO1<-subset(ext1ref, medcode=="47106"|	medcode=="22307"|	medcode=="34310"|	medcode=="108246"|	medcode=="27514"|	medcode=="1393"|	medcode=="31041"|	medcode=="102966"|	medcode=="59784"|	medcode=="106015"|	medcode=="32133"|	medcode=="23770"|	medcode=="58857"|	medcode=="58859"|	medcode=="69766"|	medcode=="70869"|	medcode=="53636"|	medcode=="70528"|	medcode=="101836"|	medcode=="47632"|	medcode=="111979"|	medcode=="67575"|	medcode=="71450"|	medcode=="62891"|	medcode=="36294"|	medcode=="44303"|	medcode=="37006"|	medcode=="66368"|	medcode=="23951"|	medcode=="27641"|	medcode=="50076"|	medcode=="27853"|	medcode=="44617"|	medcode=="66367"|	medcode=="105324"|	medcode=="65117"|	medcode=="8281"|	medcode=="51708"|	medcode=="62854"|	medcode=="112030"|	medcode=="107807"|	medcode=="112031"|	medcode=="102117"|	medcode=="104134"|	medcode=="112032"|	medcode=="69767"|	medcode=="112034"|	medcode=="112035"|	medcode=="112036"|	medcode=="112037"|	medcode=="96751"|	medcode=="102252"|	medcode=="100769"|	medcode=="65460"|	medcode=="108667"|	medcode=="72224"|	medcode=="93778"|	medcode=="12323"|	medcode=="41369"|	medcode=="1481"|	medcode=="60242"|	medcode=="71031"|	medcode=="70374"|	medcode=="95058"|	medcode=="99240"|	medcode=="27416"|	medcode=="71625"|	medcode=="71238"|	medcode=="62380"|	medcode=="64670"|	medcode=="100352"|	medcode=="103245"|	medcode=="104790"|	medcode=="63723"|	medcode=="21402"|	medcode=="59115"|	medcode=="100006"|	medcode=="97577"|	medcode=="92380"|	medcode=="71304"|	medcode=="99887"|	medcode=="99951"|	medcode=="2462"|	medcode=="65489"|	medcode=="100423"|	medcode=="98840"|	medcode=="44196"|	medcode=="98909"|	medcode=="64036"|	medcode=="68039"|	medcode=="38939"|	medcode=="71142"|	medcode=="68330"|	medcode=="92245"|	medcode=="73532"|	medcode=="93951"|	medcode=="95338"|	medcode=="106911"|	medcode=="104743"|	medcode=="29876"|	medcode=="29178"|	medcode=="57225"|	medcode=="55303"|	medcode=="67506"|	medcode=="61149"|	medcode=="65483"|	medcode=="105472"|	medcode=="19140"|	medcode=="63054"|	medcode=="49605"|	medcode=="97863"|	medcode=="94407"|	medcode=="58684"|	medcode=="108886"|	medcode=="94005"|	medcode=="67703"|	medcode=="95049"|	medcode=="111942"|	medcode=="63625"|	medcode=="110563"|	medcode=="101715"|	medcode=="107032"|	medcode=="101530"|	medcode=="104895"|	medcode=="105841"|	medcode=="108775"|	medcode=="106597"|	medcode=="104484"|	medcode=="53397"|	medcode=="61662"|	medcode=="59778"|	medcode=="59755"|	medcode=="107804"|	medcode=="91900"|	medcode=="99012"|	medcode=="94279"|	medcode=="97746"|	medcode=="42461"|	medcode=="5179"|	medcode=="66327"|	medcode=="45264"|	medcode=="105203"|	medcode=="92068"|	medcode=="111766"|	medcode=="94995"|	medcode=="58082"|	medcode=="65701"|	medcode=="12006"|	medcode=="95949"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="38005"|	medcode=="35014"|	medcode=="100532"|	medcode=="27330"|	medcode=="65122"|	medcode=="65123"|	medcode=="73777"|	medcode=="34926"|	medcode=="102715"|	medcode=="102158"|	medcode=="54083"|	medcode=="47204"|	medcode=="15036"|	medcode=="103900"|	medcode=="100615"|	medcode=="31324"|	medcode=="89657"|	medcode=="3604"|	medcode=="28639"|	medcode=="70842"|	medcode=="49262"|	medcode=="50668"|	medcode=="108182"|	medcode=="50695"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="95715"|	medcode=="101114"|	medcode=="31576"|	medcode=="21549"|	medcode=="70509"|	medcode=="102594"|	medcode=="105966"|	medcode=="105038"|	medcode=="31794"|	medcode=="39798"|	medcode=="104152"|	medcode=="105889"|	medcode=="105095"|	medcode=="107166"|	medcode=="105020"|	medcode=="107973"|	medcode=="106969"|	medcode=="108719"|	medcode=="106063"|	medcode=="105792"|	medcode=="105335"|	medcode=="105559"|	medcode=="105955"|	medcode=="109780"|	medcode=="107949"|	medcode=="105709"|	medcode=="105925"|	medcode=="105375")
ext1refIMMUNO2<-subset(ext1ref, medcode=="105636"|	medcode=="105286"|	medcode=="104934"|	medcode=="106884"|	medcode=="104386"|	medcode=="104620"|	medcode=="104412"|	medcode=="111682"|	medcode=="17887"|	medcode=="90201"|	medcode=="57737"|	medcode=="12464"|	medcode=="44318"|	medcode=="12335"|	medcode=="57427"|	medcode=="50696"|	medcode=="72725"|	medcode=="42579"|	medcode=="34089"|	medcode=="63105"|	medcode=="71262"|	medcode=="60092"|	medcode=="15504"|	medcode=="15027"|	medcode=="65434"|	medcode=="37182"|	medcode=="4944"|	medcode=="22158"|	medcode=="19028"|	medcode=="21329"|	medcode=="46042"|	medcode=="104418"|	medcode=="39187"|	medcode=="64567"|	medcode=="43450"|	medcode=="19372"|	medcode=="4251"|	medcode=="104325"|	medcode=="8625"|	medcode=="104328"|	medcode=="107052"|	medcode=="106924"|	medcode=="107163"|	medcode=="72774"|	medcode=="49725"|	medcode=="31586"|	medcode=="37461"|	medcode=="108656"|	medcode=="107643"|	medcode=="104939"|	medcode=="38331"|	medcode=="38914"|	medcode=="7176"|	medcode=="4413"|	medcode=="10726"|	medcode=="100786"|	medcode=="105957"|	medcode=="102783"|	medcode=="107236"|	medcode=="27520"|	medcode=="63475"|	medcode=="70724"|	medcode=="52327"|	medcode=="39629"|	medcode=="104788"|	medcode=="112440"|	medcode=="27664"|	medcode=="66089"|	medcode=="33344"|	medcode=="35875"|	medcode=="19974"|	medcode=="27458"|	medcode=="101606"|	medcode=="108424"|	medcode=="99015"|	medcode=="103645"|	medcode=="93342"|	medcode=="37272"|	medcode=="42539"|	medcode=="37468"|	medcode=="57671"|	medcode=="65721"|	medcode=="50858"|	medcode=="28276"|	medcode=="110838"|	medcode=="104273"|	medcode=="94174"|	medcode=="72197"|	medcode=="99413"|	medcode=="30632"|	medcode=="25191"|	medcode=="4072"|	medcode=="16416"|	medcode=="54793"|	medcode=="34692"|	medcode=="4250"|	medcode=="20440"|	medcode=="61500"|	medcode=="22050"|	medcode=="104475"|	medcode=="105069"|	medcode=="30646"|	medcode=="6115"|	medcode=="39336"|	medcode=="49301"|	medcode=="25493"|	medcode=="2481"|	medcode=="11950"|	medcode=="106993"|	medcode=="104740"|	medcode=="105915"|	medcode=="45285"|	medcode=="46444"|	medcode=="70935"|	medcode=="40740"|	medcode=="43415"|	medcode=="67518"|	medcode=="98596"|	medcode=="64336"|	medcode=="102688"|	medcode=="67029"|	medcode=="61693"|	medcode=="89762"|	medcode=="89329"|	medcode=="65165"|	medcode=="105025"|	medcode=="72500"|	medcode=="64515"|	medcode=="109714"|	medcode=="63375"|	medcode=="8649"|	medcode=="45143"|	medcode=="69545"|	medcode=="15883"|	medcode=="106381"|	medcode=="3451"|	medcode=="12306"|	medcode=="12386"|	medcode=="16527"|	medcode=="10411"|	medcode=="101350"|	medcode=="99067"|	medcode=="108102"|	medcode=="71994"|	medcode=="18486"|	medcode=="51041"|	medcode=="27934"|	medcode=="104554"|	medcode=="110183"|	medcode=="44147"|	medcode=="15137"|	medcode=="8548"|	medcode=="18701"|	medcode=="18700"|	medcode=="68440"|	medcode=="57161"|	medcode=="69373"|	medcode=="57322"|	medcode=="92569"|	medcode=="62598"|	medcode=="69184"|	medcode=="60026"|	medcode=="69854"|	medcode=="16295"|	medcode=="48307"|	medcode=="50665"|	medcode=="31322"|	medcode=="62236"|	medcode=="48293"|	medcode=="31541"|	medcode=="66073"|	medcode=="49542"|	medcode=="50526"|	medcode=="103977"|	medcode=="62328"|	medcode=="3129"|	medcode=="65617"|	medcode=="56108"|	medcode=="54203"|	medcode=="21975"|	medcode=="93892"|	medcode=="66857"|	medcode=="36408"|	medcode=="109671"|	medcode=="54904"|	medcode=="63204"|	medcode=="32141"|	medcode=="91911"|	medcode=="66049"|	medcode=="40950"|	medcode=="18781"| medcode=="38306"|	medcode=="39034"|	medcode=="34150"|	medcode=="5572"|	medcode=="2337"|	medcode=="41185"|	medcode=="73583"|	medcode=="12699"|	medcode=="5655"|	medcode=="66740"|	medcode=="27515"|	medcode=="51640"|	medcode=="32270"|	medcode=="57551"|	medcode=="95005"|	medcode=="39420"|	medcode=="61069"|	medcode=="56973"|	medcode=="47695"|	medcode=="65825")
ext1refIMMUNO3<-subset(ext1ref, medcode=="63323"|	medcode=="53317"|	medcode=="20261"|	medcode=="11346"|	medcode=="100043"|	medcode=="52604"|	medcode=="57525"|	medcode=="40406"|	medcode=="70236"|	medcode=="62041"|	medcode=="22319"|	medcode=="101375"|	medcode=="101075"|	medcode=="4072"|	medcode=="4251"|	medcode=="19974"|	medcode=="4413"|	medcode=="50858"|	medcode=="27664"|	medcode=="37461"|	medcode=="52327"|	medcode=="100786"|	medcode=="16416"|	medcode=="8625"|	medcode=="27458"|	medcode=="10726"|	medcode=="27520"|	medcode=="22050"|	medcode=="102783"|	medcode=="50668"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="21549"|	medcode=="70842"|	medcode=="99067"|	medcode=="39629"|	medcode=="27330"|	medcode=="53397"|	medcode=="107804"|	medcode=="59755"|	medcode=="91900"|	medcode=="59778"|	medcode=="99012"|	medcode=="97746"|	medcode=="94279"|	medcode=="61662"|	medcode=="67703"|	medcode=="101530"|	medcode=="63625"|	medcode=="111942"|	medcode=="110563"|	medcode=="107032"|	medcode=="101715"|	medcode=="73532"|	medcode=="95338"|	medcode=="92245"|	medcode=="68330"|	medcode=="93951"|	medcode=="104743"|	medcode=="71142"|	medcode=="49605"|	medcode=="94005"|	medcode=="58684"|	medcode=="94407"|	medcode=="108886"|	medcode=="97863"|	medcode=="29178"|	medcode=="63054"|	medcode=="61149"|	medcode=="67506"|	medcode=="65483"|	medcode=="55303"|	medcode=="19140"|	medcode=="105472"|	medcode=="57225"|	medcode=="95049"|	medcode=="64036"|	medcode=="68039"|	medcode=="29876"|	medcode=="106911"|	medcode=="43450"|	medcode=="34926"|	medcode=="47204"|	medcode=="102158"|	medcode=="54083"|	medcode=="102715"|	medcode=="4250"|	medcode=="25191"|	medcode=="73777"|	medcode=="65123"|	medcode=="65122"|	medcode=="38939"|	medcode=="19372"|	medcode=="38914"|	medcode=="72197"|	medcode=="16527"|	medcode=="71994"|	medcode=="50695"|	medcode=="108182"|	medcode=="12335"|	medcode=="42579"|	medcode=="71262"|	medcode=="72725"|	medcode=="34089"|	medcode=="50696"|	medcode=="63105"|	medcode=="15504"|	medcode=="60092"|	medcode=="57427"|	medcode=="17887"|	medcode=="89657"|	medcode=="15036"|	medcode=="49301"|	medcode=="30646"|	medcode=="65434"|	medcode=="22158"|	medcode=="65721"|	medcode=="100615"|	medcode=="31324"|	medcode=="103900"|	medcode=="57671"|	medcode=="15883"|	medcode=="35875"|	medcode=="93342"|	medcode=="37182"|	medcode=="12006"|	medcode=="38005"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="95949"|	medcode=="7176"|	medcode=="33344"|	medcode=="70724"|	medcode=="4944"|	medcode=="20440"|	medcode=="25493"|	medcode=="65701"|	medcode=="92068"|	medcode=="105203"|	medcode=="111766"|	medcode=="45264"|	medcode=="94995"|	medcode=="58082"|	medcode=="66327"|	medcode=="3604"|	medcode=="94174"|	medcode=="99413"|	medcode=="64567"|	medcode=="34692"|	medcode=="49725"|	medcode=="38331"|	medcode=="99015"|	medcode=="103645"|	medcode=="112440"|	medcode=="66089"|	medcode=="3451"|	medcode=="37272"|	medcode=="30632"|	medcode=="31576"|	medcode=="12386"|	medcode=="2481"|	medcode=="31586"|	medcode=="35014"|	medcode=="100532"|	medcode=="54793"|	medcode=="72774"|	medcode=="101606"|	medcode=="63475"|	medcode=="104475"|	medcode=="10411"|	medcode=="5019"|	medcode=="102559"|	medcode=="59610"|	medcode=="105256"|	medcode=="31489"|	medcode=="10505")

ext1refIMMUNO <- rbindlist(list(ext1refIMMUNO1, ext1refIMMUNO2, ext1refIMMUNO3), use.names = TRUE, fill = TRUE)

fwrite(ext1refIMMUNO, paste("P:/Comorbidities/ext1refIMMUNO.csv"))
ext1refIMMUNO <- fread("P:/Comorbidities/ext1refIMMUNO.csv")

#ext1 csf and cochlear ref
ext1refCSF<-subset(ext1ref, medcode=="30525"|	medcode=="43643"|	medcode=="42441"|	medcode=="36513"|	medcode=="20641"|	medcode=="26158"|	medcode=="40348"|	medcode=="20488"|	medcode=="27295"|	medcode=="35762"|	medcode=="16172"|	medcode=="9300"|	medcode=="17957"|	medcode=="36424"|	medcode=="97074"|	medcode=="55931"|	medcode=="33396"|	medcode=="48851"|	medcode=="71772"|	medcode=="41393"|	medcode=="54342"|	medcode=="10708"|	medcode=="61980"|	medcode=="98472"|	medcode=="57642"|	medcode=="74897")

fwrite(ext1refCSF, paste("P:/Comorbidities/ext1refCSF.csv"))
ext1refCSF <- fread("P:/Comorbidities/ext1refCSF.csv")

#bind all
ext1refALL <- rbindlist(list(ext1refRESP, ext1refHEART, ext1refRENAL, ext1refLIVER, ext1refDIABETES, ext1refIMMUNO, ext1refCSF), use.names = TRUE, fill = TRUE)

fwrite(ext1refALL, paste("P:/Comorbidities/ext1refALL.csv"))
ext1refALL <- fread("P:/Comorbidities/ext1refALL.csv")


#ext2 ref resp
ext2refRESP<-subset(ext2ref, medcode=="10461"|	medcode=="96578"|	medcode=="93713"|	medcode=="73743"|	medcode=="38011"|	medcode=="15693"|	medcode=="65117"|	medcode=="100742"|	medcode=="33980"|	medcode=="58841"|	medcode=="93380"|	medcode=="29966"|	medcode=="6220"|	medcode=="65344"|	medcode=="69017"|	medcode=="18914"|	medcode=="18905"|	medcode=="100610"|	medcode=="103224"|	medcode=="110454"|	medcode=="102922"|	medcode=="106432"|	medcode=="73065"|	medcode=="49770"|	medcode=="1001"|	medcode=="148"|	medcode=="152"|	medcode=="3480"|	medcode=="3243"|	medcode=="25603"|	medcode=="15626"|	medcode=="61118"|	medcode=="11150"|	medcode=="40159"|	medcode=="37959"|	medcode=="61513"|	medcode=="27819"|	medcode=="5798"|	medcode=="14798"|	medcode=="1446"|	medcode=="26125"|	medcode=="44525"|	medcode=="24248"|	medcode=="66043"|	medcode=="45089"|	medcode=="68066"|	medcode=="15157"|	medcode=="794"|	medcode=="26306"|	medcode=="56860"|	medcode=="68662"|	medcode=="60188"|	medcode=="99536"|	medcode=="23492"|	medcode=="46578"|	medcode=="10980"|	medcode=="40788"|	medcode=="92955"|	medcode=="70787"|	medcode=="63479"|	medcode=="16410"|	medcode=="33450"|	medcode=="106805"|	medcode=="2195"|	medcode=="20364"|	medcode=="41491"|	medcode=="32679"|	medcode=="10863"|	medcode=="10802"|	medcode=="9876"|	medcode=="93568"|	medcode=="104608"|	medcode=="12166"|	medcode=="21061"|	medcode=="7884"|	medcode=="5710"|	medcode=="19492"|	medcode=="8303"|	medcode=="51410"|	medcode=="46460"|	medcode=="60805"|	medcode=="62233"|	medcode=="71853"|	medcode=="89206"|	medcode=="23446"|	medcode=="65376"|	medcode=="94894"|	medcode=="49194"|	medcode=="94575"|	medcode=="30235"|	medcode=="93577"|	medcode=="23461"|	medcode=="37365"|	medcode=="26442"|	medcode=="31423"|	medcode=="63172"|	medcode=="54830"|	medcode=="49025"|	medcode=="55758"|	medcode=="62227"|	medcode=="47142"|	medcode=="64721"|	medcode=="63216"|	medcode=="47782"|	medcode=="70815"|	medcode=="104557"|	medcode=="9711"|	medcode=="3847"|	medcode=="41781"|	medcode=="59083"|	medcode=="66104"|	medcode=="45948"|	medcode=="33837"|	medcode=="56647"|	medcode=="41015"|	medcode=="66773"|	medcode=="50876"|	medcode=="47504"|	medcode=="54252"|	medcode=="46066"|	medcode=="43285"|	medcode=="18130"|	medcode=="69914"|	medcode=="22536"|	medcode=="50374"|	medcode=="44015"|	medcode=="53205"|	medcode=="43417"|	medcode=="30214"|	medcode=="38297"|	medcode=="46405"|	medcode=="26082"|	medcode=="7321"|	medcode=="61229"|	medcode=="7791"|	medcode=="31806"|	medcode=="61119"|	medcode=="27348"|	medcode=="68814"|	medcode=="6837"|	medcode=="94136"|	medcode=="6051"|	medcode=="103472"|	medcode=="103559"|	medcode=="28229"|	medcode=="22835"|	medcode=="54308"|	medcode=="61991"|	medcode=="33830"|	medcode=="15815"|	medcode=="64799"|	medcode=="94996"|	medcode=="58791"|	medcode=="54010"|	medcode=="42940"|	medcode=="3859"|	medcode=="47364"|	medcode=="31564"|	medcode=="96655"|	medcode=="63912"|	medcode=="22905"|	medcode=="54893"|	medcode=="22915"|	medcode=="31319"|	medcode=="106650"|	medcode=="20269"|	medcode=="558"|	medcode=="39706"|	medcode=="5293"|	medcode=="65000"|	medcode=="93880"|	medcode=="72221"|	medcode=="96754"|	medcode=="24848"|	medcode=="24466"|	medcode=="99158"|	medcode=="8317"|	medcode=="103785"|	medcode=="109815"|	medcode=="104915"|	medcode=="24814"|	medcode=="94946"|	medcode=="94486"|	medcode=="59188"|	medcode=="66058"|	medcode=="65733"|	medcode=="105939"|	medcode=="106515"|	medcode=="99232"|	medcode=="105628"|	medcode=="54706"|	medcode=="65060"|	medcode=="91912"|	medcode=="71906"|	medcode=="56427"|	medcode=="38298"|	medcode=="94925"|	medcode=="6883"|	medcode=="93098"|	medcode=="13563")

fwrite(ext2refRESP, paste("P:/Comorbidities/ext2refRESP.csv"))
ext2refRESP <- fread("P:/Comorbidities/ext2refRESP.csv")

#ext2 heart ref
ext2refHEART1<-subset(ext2ref, medcode=="11284"|	medcode=="19066"|	medcode=="51214"|	medcode=="250"|	medcode=="53626"|	medcode=="61073"|	medcode=="4438"|	medcode=="242"|	medcode=="72939"|	medcode=="58529"|	medcode=="107416"|	medcode=="70105"|	medcode=="93844"|	medcode=="69734"|	medcode=="41495"|	medcode=="22262"|	medcode=="16292"|	medcode=="50157"|	medcode=="95334"|	medcode=="72668"|	medcode=="103046"|	medcode=="52427"|	medcode=="61660"|	medcode=="52127"|	medcode=="105938"|	medcode=="31464"|	medcode=="61166"|	medcode=="62718"|	medcode=="16173"|	medcode=="240"|	medcode=="241"|	medcode=="12139"|	medcode=="5387"|	medcode=="40429"|	medcode=="17872"|	medcode=="14897"|	medcode=="8935"|	medcode=="29643"|	medcode=="23892"|	medcode=="14898"|	medcode=="63467"|	medcode=="3704"|	medcode=="9507"|	medcode=="10562"|	medcode=="1678"|	medcode=="30330"|	medcode=="32854"|	medcode=="29758"|	medcode=="12229"|	medcode=="34803"|	medcode=="28736"|	medcode=="62626"|	medcode=="41221"|	medcode=="46017"|	medcode=="14658"|	medcode=="27951"|	medcode=="36523"|	medcode=="61072"|	medcode=="7347"|	medcode=="17307"|	medcode=="34328"|	medcode=="18118"|	medcode=="11983"|	medcode=="54251"|	medcode=="39449"|	medcode=="9413"|	medcode=="9276"|	medcode=="68357"|	medcode=="39693"|	medcode=="21844"|	medcode=="27977"|	medcode=="4017"|	medcode=="1430"|	medcode=="20095"|	medcode=="18125"|	medcode=="29902"|	medcode=="25842"|	medcode=="66388"|	medcode=="54535"|	medcode=="7696"|	medcode=="1414"|	medcode=="32450"|	medcode=="9555"|	medcode=="26863"|	medcode=="12804"|	medcode=="28554"|	medcode=="28138"|	medcode=="5413"|	medcode=="3999"|	medcode=="5254"|	medcode=="36609"|	medcode=="7320"|	medcode=="29421"|	medcode=="34633"|	medcode=="24540"|	medcode=="23078"|	medcode=="35713"|	medcode=="15754"|	medcode=="18889"|	medcode=="18842"|	medcode=="45809"|	medcode=="38609"|	medcode=="72562"|	medcode=="46166"|	medcode=="32272"|	medcode=="46112"|	medcode=="46276"|	medcode=="106812"|	medcode=="41835"|	medcode=="68748"|	medcode=="105479"|	medcode=="1676"|	medcode=="2062"|	medcode=="398"|	medcode=="23707"|	medcode=="32671"|	medcode=="27884"|	medcode=="11424"|	medcode=="94870"|	medcode=="884"|	medcode=="5255"|	medcode=="27964"|	medcode=="101138"|	medcode=="104275"|	medcode=="4024"|	medcode=="8966"|	medcode=="107397"|	medcode=="52517"|	medcode=="39546"|	medcode=="68401"|	medcode=="47637"|	medcode=="96838"|	medcode=="109035"|	medcode=="99991"|	medcode=="31518"|	medcode=="4964"|	medcode=="72604"|	medcode=="45505"|	medcode=="66245"|	medcode=="94344"|	medcode=="2816"|	medcode=="69858"|	medcode=="1778"|	medcode=="23988"|	medcode=="102980"|	medcode=="40025"|	medcode=="65318"|	medcode=="63390"|	medcode=="62169"|	medcode=="73539"|	medcode=="4864"|	medcode=="38967"|	medcode=="51649"|	medcode=="63046"|	medcode=="19969"|	medcode=="246"|	medcode=="42132"|	medcode=="56575"|	medcode=="67657"|	medcode=="9011"|	medcode=="51897"|	medcode=="20153"|	medcode=="54772"|	medcode=="34067"|	medcode=="7474"|	medcode=="3255"|	medcode=="3625"|	medcode=="37816"|	medcode=="59144"|	medcode=="53088"|	medcode=="54243"|	medcode=="63340"|	medcode=="51053"|	medcode=="101393"|	medcode=="49702"|	medcode=="55535"|	medcode=="43049"|	medcode=="44896"|	medcode=="73816"|	medcode=="46117"|	medcode=="9361"|	medcode=="48205"|	medcode=="66401"|	medcode=="54196"|	medcode=="5621"|	medcode=="39992"|	medcode=="69940"|	medcode=="3862"|	medcode=="54488"|	medcode=="93561"|	medcode=="22778"|	medcode=="112420"|	medcode=="45452"|	medcode=="33919"|	medcode=="21851"|	medcode=="44478"|	medcode=="107150"|	medcode=="52607"|	medcode=="70880"|	medcode=="12752"|	medcode=="21272"|	medcode=="69169"|	medcode=="100065"|	medcode=="23709"|	medcode=="6886"|	medcode=="8636"|	medcode=="58734"|	medcode=="3300"|	medcode=="6843"|	medcode=="57091"|	medcode=="90551"|	medcode=="73592"|	medcode=="63069")
ext2refHEART2<-subset(ext2ref, medcode=="100291"|	medcode=="61651"|	medcode=="20772"|	medcode=="89256"|	medcode=="108457"|	medcode=="46825"|	medcode=="50529"|	medcode=="24789"|	medcode=="16539"|	medcode=="34668"|	medcode=="9401"|	medcode=="99128"|	medcode=="32748"|	medcode=="104266"|	medcode=="97818"|	medcode=="25481"|	medcode=="71956"|	medcode=="62163"|	medcode=="103894"|	medcode=="31373"|	medcode=="49901"|	medcode=="103412"|	medcode=="53546"|	medcode=="24533"|	medcode=="68097"|	medcode=="52310"|	medcode=="102167"|	medcode=="70992"|	medcode=="71678"|	medcode=="3774"|	medcode=="72259"|	medcode=="72405"|	medcode=="50284"|	medcode=="103584"|	medcode=="92426"|	medcode=="52615"|	medcode=="98061"|	medcode=="24854"|	medcode=="93089"|	medcode=="68063"|	medcode=="34007"|	medcode=="49133"|	medcode=="50362"|	medcode=="68894"|	medcode=="108193"|	medcode=="37451"|	medcode=="23752"|	medcode=="95785"|	medcode=="111360"|	medcode=="98317"|	medcode=="24714"|	medcode=="247"|	medcode=="26626"|	medcode=="109236"|	medcode=="103432"|	medcode=="64778"|	medcode=="38968"|	medcode=="3863"|	medcode=="11982"|	medcode=="3301"|	medcode=="57932"|	medcode=="72295"|	medcode=="70853"|	medcode=="37323"|	medcode=="59907"|	medcode=="50220"|	medcode=="62230"|	medcode=="30725"|	medcode=="67286"|	medcode=="30949"|	medcode=="46530"|	medcode=="49731"|	medcode=="44334"|	medcode=="90486"|	medcode=="70691"|	medcode=="34176"|	medcode=="68198"|	medcode=="59298"|	medcode=="37515"|	medcode=="63768"|	medcode=="53964"|	medcode=="62376"|	medcode=="58076"|	medcode=="44781"|	medcode=="49474"|	medcode=="56200"|	medcode=="11945"|	medcode=="11127"|	medcode=="63187"|	medcode=="67928"|	medcode=="31112"|	medcode=="18982"|	medcode=="54487"|	medcode=="2670"|	medcode=="96225"|	medcode=="65029"|	medcode=="32508"|	medcode=="52411"|	medcode=="42127"|	medcode=="42684"|	medcode=="45291"|	medcode=="74890"|	medcode=="50886"|	medcode=="51941"|	medcode=="105037"|	medcode=="103039"|	medcode=="68784"|	medcode=="46176"|	medcode=="101307"|	medcode=="99649"|	medcode=="73663"|	medcode=="101520"|	medcode=="72655"|	medcode=="51675"|	medcode=="41197"|	medcode=="110026"|	medcode=="36606"|	medcode=="71874"|	medcode=="51911"|	medcode=="73554"|	medcode=="101322"|	medcode=="109008"|	medcode=="110047"|	medcode=="106644"|	medcode=="107639"|	medcode=="110418"|	medcode=="107496"|	medcode=="107710"|	medcode=="9384"|	medcode=="25089"|	medcode=="22383"|	medcode=="21966")

ext2refHEART <- rbindlist(list(ext2refHEART1, ext2refHEART2), use.names = TRUE, fill = TRUE)

fwrite(ext2refHEART, paste("P:/Comorbidities/ext2refHEART.csv"))
ext2refHEART <- fread("P:/Comorbidities/ext2refHEART.csv")

#ext2 renal ref
ext2refRENAL<-subset(ext2ref, medcode=="12479"|	medcode=="12585"|	medcode=="95122"|	medcode=="95406"|	medcode=="95508"|	medcode=="95405"|	medcode=="2997"|	medcode=="55151"|	medcode=="11745"|	medcode=="24361"|	medcode=="89924"|	medcode=="96133"|	medcode=="109455"|	medcode=="105787"|	medcode=="70874"|	medcode=="5504"|	medcode=="31549"|	medcode=="20073"|	medcode=="2994"|	medcode=="2996"|	medcode=="71124"|	medcode=="88597"|	medcode=="30756"|	medcode=="64828"|	medcode=="48022"|	medcode=="64636"|	medcode=="56760"|	medcode=="8037"|	medcode=="23773"|	medcode=="104586"|	medcode=="59194"|	medcode=="83513"|	medcode=="30709"|	medcode=="107901"|	medcode=="65089"|	medcode=="102210"|	medcode=="30323"|	medcode=="26054"|	medcode=="26860"|	medcode=="109840"|	medcode=="2999"|	medcode=="9840"|	medcode=="1803"|	medcode=="99644"|	medcode=="29634"|	medcode=="23913"|	medcode=="22852"|	medcode=="19316"|	medcode=="21947"|	medcode=="50472"|	medcode=="21989"|	medcode=="56987"|	medcode=="17365"|	medcode=="63786"|	medcode=="72303"|	medcode=="108591"|	medcode=="110749"|	medcode=="111370"|	medcode=="108816"|	medcode=="47922"|	medcode=="2471"|	medcode=="99201"|	medcode=="58750"|	medcode=="94373"|	medcode=="27427"|	medcode=="65064"|	medcode=="512"|	medcode=="6712"|	medcode=="104963"|	medcode=="105151"|	medcode=="350"|	medcode=="105302"|	medcode=="61814"|	medcode=="71174"|	medcode=="97734"|	medcode=="41285"|	medcode=="58060"|	medcode=="109945"|	medcode=="50200"|	medcode=="62320"|	medcode=="8330"|	medcode=="100205"|	medcode=="61930"|	medcode=="11554"|	medcode=="5911"|	medcode=="53940"|	medcode=="108494")

fwrite(ext2refRENAL, paste("P:/Comorbidities/ext2refRENAL.csv"))
ext2refRENAL <- fread("P:/Comorbidities/ext2refRENAL.csv")

#ext2 liver ref
ext2refLIVER<-subset(ext2ref, medcode=="4405"|	medcode=="32025"|	medcode=="71422"|	medcode=="69194"|	medcode=="105506"|	medcode=="97157"|	medcode=="99250"|	medcode=="27319"|	medcode=="26367"|	medcode=="24813"|	medcode=="41096"|	medcode=="30586"|	medcode=="106642"|	medcode=="32277"|	medcode=="108343"|	medcode=="107896"|	medcode=="110454"|	medcode=="102922"|	medcode=="48211"|	medcode=="6863"|	medcode=="4743"|	medcode=="21713"|	medcode=="17330"|	medcode=="1754"|	medcode=="23578"|	medcode=="9029"|	medcode=="1755"|	medcode=="53480"|	medcode=="66534"|	medcode=="53877"|	medcode=="15489"|	medcode=="16725"|	medcode=="69204"|	medcode=="3450"|	medcode=="44676"|	medcode=="92909"|	medcode=="40567"|	medcode=="27438"|	medcode=="96664"|	medcode=="100253"|	medcode=="73482"|	medcode=="112044"|	medcode=="109540"|	medcode=="48928"|	medcode=="55454"|	medcode=="16455"|	medcode=="9494"|	medcode=="5638"|	medcode=="15424"|	medcode=="91591"|	medcode=="58630"|	medcode=="7602"|	medcode=="42843"|	medcode=="25383"|	medcode=="60104"|	medcode=="100592"|	medcode=="33597"|	medcode=="10539"|	medcode=="5129"|	medcode=="10636"|	medcode=="24901"|	medcode=="48102"|	medcode=="17219"|	medcode=="64750"|	medcode=="39351"|	medcode=="44120"|	medcode=="26405"|	medcode=="18652"|	medcode=="15425"|	medcode=="6015"|	medcode=="25597"|	medcode=="16417"|	medcode=="38389"|	medcode=="48269"|	medcode=="50400"|	medcode=="50444"|	medcode=="40029"|	medcode=="10721"|	medcode=="71422"|	medcode=="4405"|	medcode=="32025"|	medcode=="69194")

fwrite(ext2refLIVER, paste("P:/Comorbidities/ext2refLIVER.csv"))
ext2refLIVER <- fread("P:/Comorbidities/ext2refLIVER.csv")

#ext2 diabetes ref
ext2refDIABETES<-subset(ext2ref, medcode=="711"|	medcode=="43453"|	medcode=="36695"|	medcode=="1549"|	medcode=="47582"|	medcode=="47649"|	medcode=="42831"|	medcode=="47650"|	medcode=="43921"|	medcode=="18683"|	medcode=="69993"|	medcode=="18387"|	medcode=="35288"|	medcode=="40682"|	medcode=="69676"|	medcode=="68105"|	medcode=="46301"|	medcode=="10418"|	medcode=="39070"|	medcode=="49554"|	medcode=="93468"|	medcode=="18642"|	medcode=="54008"|	medcode=="30323"|	medcode=="30294"|	medcode=="10692"|	medcode=="40837"|	medcode=="22871"|	medcode=="55239"|	medcode=="95636"|	medcode=="758"|	medcode=="18777"|	medcode=="47321"|	medcode=="34268"|	medcode=="65267"|	medcode=="49074"|	medcode=="12736"|	medcode=="18496"|	medcode=="25627"|	medcode=="47954"|	medcode=="62674"|	medcode=="18425"|	medcode=="12640"|	medcode=="46917"|	medcode=="44982"|	medcode=="37806"|	medcode=="59253"|	medcode=="35385"|	medcode=="1407"|	medcode=="34450"|	medcode=="26054"|	medcode=="18390"|	medcode=="32627"|	medcode=="51756"|	medcode=="25591"|	medcode=="63690"|	medcode=="95539"|	medcode=="51697"|	medcode=="96506"|	medcode=="61122"|	medcode=="67212"|	medcode=="43857"|	medcode=="22487"|	medcode=="94383"|	medcode=="93380"|	medcode=="52212"|	medcode=="106927"|	medcode=="53200"|	medcode=="42567"|	medcode=="54856"|	medcode=="6791"|	medcode=="31310"|	medcode=="60499"|	medcode=="52104"|	medcode=="52283"|	medcode=="49276"|	medcode=="46963"|	medcode=="6509"|	medcode=="44443"|	medcode=="8403"|	medcode=="40401"|	medcode=="68843"|	medcode=="62146"|	medcode=="55842"|	medcode=="50429"|	medcode=="52303"|	medcode=="17262"|	medcode=="34912")

fwrite(ext2refDIABETES, paste("P:/Comorbidities/ext2refDIABETES.csv"))
ext2refDIABETES <- fread("P:/Comorbidities/ext1refDIABETES.csv")

#ext2 immuno ref
ext2refIMMUNO1<-subset(ext2ref, medcode=="47106"|	medcode=="22307"|	medcode=="34310"|	medcode=="108246"|	medcode=="27514"|	medcode=="1393"|	medcode=="31041"|	medcode=="102966"|	medcode=="59784"|	medcode=="106015"|	medcode=="32133"|	medcode=="23770"|	medcode=="58857"|	medcode=="58859"|	medcode=="69766"|	medcode=="70869"|	medcode=="53636"|	medcode=="70528"|	medcode=="101836"|	medcode=="47632"|	medcode=="111979"|	medcode=="67575"|	medcode=="71450"|	medcode=="62891"|	medcode=="36294"|	medcode=="44303"|	medcode=="37006"|	medcode=="66368"|	medcode=="23951"|	medcode=="27641"|	medcode=="50076"|	medcode=="27853"|	medcode=="44617"|	medcode=="66367"|	medcode=="105324"|	medcode=="65117"|	medcode=="8281"|	medcode=="51708"|	medcode=="62854"|	medcode=="112030"|	medcode=="107807"|	medcode=="112031"|	medcode=="102117"|	medcode=="104134"|	medcode=="112032"|	medcode=="69767"|	medcode=="112034"|	medcode=="112035"|	medcode=="112036"|	medcode=="112037"|	medcode=="96751"|	medcode=="102252"|	medcode=="100769"|	medcode=="65460"|	medcode=="108667"|	medcode=="72224"|	medcode=="93778"|	medcode=="12323"|	medcode=="41369"|	medcode=="1481"|	medcode=="60242"|	medcode=="71031"|	medcode=="70374"|	medcode=="95058"|	medcode=="99240"|	medcode=="27416"|	medcode=="71625"|	medcode=="71238"|	medcode=="62380"|	medcode=="64670"|	medcode=="100352"|	medcode=="103245"|	medcode=="104790"|	medcode=="63723"|	medcode=="21402"|	medcode=="59115"|	medcode=="100006"|	medcode=="97577"|	medcode=="92380"|	medcode=="71304"|	medcode=="99887"|	medcode=="99951"|	medcode=="2462"|	medcode=="65489"|	medcode=="100423"|	medcode=="98840"|	medcode=="44196"|	medcode=="98909"|	medcode=="64036"|	medcode=="68039"|	medcode=="38939"|	medcode=="71142"|	medcode=="68330"|	medcode=="92245"|	medcode=="73532"|	medcode=="93951"|	medcode=="95338"|	medcode=="106911"|	medcode=="104743"|	medcode=="29876"|	medcode=="29178"|	medcode=="57225"|	medcode=="55303"|	medcode=="67506"|	medcode=="61149"|	medcode=="65483"|	medcode=="105472"|	medcode=="19140"|	medcode=="63054"|	medcode=="49605"|	medcode=="97863"|	medcode=="94407"|	medcode=="58684"|	medcode=="108886"|	medcode=="94005"|	medcode=="67703"|	medcode=="95049"|	medcode=="111942"|	medcode=="63625"|	medcode=="110563"|	medcode=="101715"|	medcode=="107032"|	medcode=="101530"|	medcode=="104895"|	medcode=="105841"|	medcode=="108775"|	medcode=="106597"|	medcode=="104484"|	medcode=="53397"|	medcode=="61662"|	medcode=="59778"|	medcode=="59755"|	medcode=="107804"|	medcode=="91900"|	medcode=="99012"|	medcode=="94279"|	medcode=="97746"|	medcode=="42461"|	medcode=="5179"|	medcode=="66327"|	medcode=="45264"|	medcode=="105203"|	medcode=="92068"|	medcode=="111766"|	medcode=="94995"|	medcode=="58082"|	medcode=="65701"|	medcode=="12006"|	medcode=="95949"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="38005"|	medcode=="35014"|	medcode=="100532"|	medcode=="27330"|	medcode=="65122"|	medcode=="65123"|	medcode=="73777"|	medcode=="34926"|	medcode=="102715"|	medcode=="102158"|	medcode=="54083"|	medcode=="47204"|	medcode=="15036"|	medcode=="103900"|	medcode=="100615"|	medcode=="31324"|	medcode=="89657"|	medcode=="3604"|	medcode=="28639"|	medcode=="70842"|	medcode=="49262"|	medcode=="50668"|	medcode=="108182"|	medcode=="50695"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="95715"|	medcode=="101114"|	medcode=="31576"|	medcode=="21549"|	medcode=="70509"|	medcode=="102594"|	medcode=="105966"|	medcode=="105038"|	medcode=="31794"|	medcode=="39798"|	medcode=="104152"|	medcode=="105889"|	medcode=="105095"|	medcode=="107166"|	medcode=="105020"|	medcode=="107973"|	medcode=="106969"|	medcode=="108719"|	medcode=="106063"|	medcode=="105792"|	medcode=="105335"|	medcode=="105559"|	medcode=="105955"|	medcode=="109780"|	medcode=="107949"|	medcode=="105709"|	medcode=="105925"|	medcode=="105375")
ext2refIMMUNO2<-subset(ext2ref, medcode=="105636"|	medcode=="105286"|	medcode=="104934"|	medcode=="106884"|	medcode=="104386"|	medcode=="104620"|	medcode=="104412"|	medcode=="111682"|	medcode=="17887"|	medcode=="90201"|	medcode=="57737"|	medcode=="12464"|	medcode=="44318"|	medcode=="12335"|	medcode=="57427"|	medcode=="50696"|	medcode=="72725"|	medcode=="42579"|	medcode=="34089"|	medcode=="63105"|	medcode=="71262"|	medcode=="60092"|	medcode=="15504"|	medcode=="15027"|	medcode=="65434"|	medcode=="37182"|	medcode=="4944"|	medcode=="22158"|	medcode=="19028"|	medcode=="21329"|	medcode=="46042"|	medcode=="104418"|	medcode=="39187"|	medcode=="64567"|	medcode=="43450"|	medcode=="19372"|	medcode=="4251"|	medcode=="104325"|	medcode=="8625"|	medcode=="104328"|	medcode=="107052"|	medcode=="106924"|	medcode=="107163"|	medcode=="72774"|	medcode=="49725"|	medcode=="31586"|	medcode=="37461"|	medcode=="108656"|	medcode=="107643"|	medcode=="104939"|	medcode=="38331"|	medcode=="38914"|	medcode=="7176"|	medcode=="4413"|	medcode=="10726"|	medcode=="100786"|	medcode=="105957"|	medcode=="102783"|	medcode=="107236"|	medcode=="27520"|	medcode=="63475"|	medcode=="70724"|	medcode=="52327"|	medcode=="39629"|	medcode=="104788"|	medcode=="112440"|	medcode=="27664"|	medcode=="66089"|	medcode=="33344"|	medcode=="35875"|	medcode=="19974"|	medcode=="27458"|	medcode=="101606"|	medcode=="108424"|	medcode=="99015"|	medcode=="103645"|	medcode=="93342"|	medcode=="37272"|	medcode=="42539"|	medcode=="37468"|	medcode=="57671"|	medcode=="65721"|	medcode=="50858"|	medcode=="28276"|	medcode=="110838"|	medcode=="104273"|	medcode=="94174"|	medcode=="72197"|	medcode=="99413"|	medcode=="30632"|	medcode=="25191"|	medcode=="4072"|	medcode=="16416"|	medcode=="54793"|	medcode=="34692"|	medcode=="4250"|	medcode=="20440"|	medcode=="61500"|	medcode=="22050"|	medcode=="104475"|	medcode=="105069"|	medcode=="30646"|	medcode=="6115"|	medcode=="39336"|	medcode=="49301"|	medcode=="25493"|	medcode=="2481"|	medcode=="11950"|	medcode=="106993"|	medcode=="104740"|	medcode=="105915"|	medcode=="45285"|	medcode=="46444"|	medcode=="70935"|	medcode=="40740"|	medcode=="43415"|	medcode=="67518"|	medcode=="98596"|	medcode=="64336"|	medcode=="102688"|	medcode=="67029"|	medcode=="61693"|	medcode=="89762"|	medcode=="89329"|	medcode=="65165"|	medcode=="105025"|	medcode=="72500"|	medcode=="64515"|	medcode=="109714"|	medcode=="63375"|	medcode=="8649"|	medcode=="45143"|	medcode=="69545"|	medcode=="15883"|	medcode=="106381"|	medcode=="3451"|	medcode=="12306"|	medcode=="12386"|	medcode=="16527"|	medcode=="10411"|	medcode=="101350"|	medcode=="99067"|	medcode=="108102"|	medcode=="71994"|	medcode=="18486"|	medcode=="51041"|	medcode=="27934"|	medcode=="104554"|	medcode=="110183"|	medcode=="44147"|	medcode=="15137"|	medcode=="8548"|	medcode=="18701"|	medcode=="18700"|	medcode=="68440"|	medcode=="57161"|	medcode=="69373"|	medcode=="57322"|	medcode=="92569"|	medcode=="62598"|	medcode=="69184"|	medcode=="60026"|	medcode=="69854"|	medcode=="16295"|	medcode=="48307"|	medcode=="50665"|	medcode=="31322"|	medcode=="62236"|	medcode=="48293"|	medcode=="31541"|	medcode=="66073"|	medcode=="49542"|	medcode=="50526"|	medcode=="103977"|	medcode=="62328"|	medcode=="3129"|	medcode=="65617"|	medcode=="56108"|	medcode=="54203"|	medcode=="21975"|	medcode=="93892"|	medcode=="66857"|	medcode=="36408"|	medcode=="109671"|	medcode=="54904"|	medcode=="63204"|	medcode=="32141"|	medcode=="91911"|	medcode=="66049"|	medcode=="40950"|	medcode=="18781"| medcode=="38306"|	medcode=="39034"|	medcode=="34150"|	medcode=="5572"|	medcode=="2337"|	medcode=="41185"|	medcode=="73583"|	medcode=="12699"|	medcode=="5655"|	medcode=="66740"|	medcode=="27515"|	medcode=="51640"|	medcode=="32270"|	medcode=="57551"|	medcode=="95005"|	medcode=="39420"|	medcode=="61069"|	medcode=="56973"|	medcode=="47695"|	medcode=="65825")
ext2refIMMUNO3<-subset(ext2ref, medcode=="63323"|	medcode=="53317"|	medcode=="20261"|	medcode=="11346"|	medcode=="100043"|	medcode=="52604"|	medcode=="57525"|	medcode=="40406"|	medcode=="70236"|	medcode=="62041"|	medcode=="22319"|	medcode=="101375"|	medcode=="101075"|	medcode=="4072"|	medcode=="4251"|	medcode=="19974"|	medcode=="4413"|	medcode=="50858"|	medcode=="27664"|	medcode=="37461"|	medcode=="52327"|	medcode=="100786"|	medcode=="16416"|	medcode=="8625"|	medcode=="27458"|	medcode=="10726"|	medcode=="27520"|	medcode=="22050"|	medcode=="102783"|	medcode=="50668"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="21549"|	medcode=="70842"|	medcode=="99067"|	medcode=="39629"|	medcode=="27330"|	medcode=="53397"|	medcode=="107804"|	medcode=="59755"|	medcode=="91900"|	medcode=="59778"|	medcode=="99012"|	medcode=="97746"|	medcode=="94279"|	medcode=="61662"|	medcode=="67703"|	medcode=="101530"|	medcode=="63625"|	medcode=="111942"|	medcode=="110563"|	medcode=="107032"|	medcode=="101715"|	medcode=="73532"|	medcode=="95338"|	medcode=="92245"|	medcode=="68330"|	medcode=="93951"|	medcode=="104743"|	medcode=="71142"|	medcode=="49605"|	medcode=="94005"|	medcode=="58684"|	medcode=="94407"|	medcode=="108886"|	medcode=="97863"|	medcode=="29178"|	medcode=="63054"|	medcode=="61149"|	medcode=="67506"|	medcode=="65483"|	medcode=="55303"|	medcode=="19140"|	medcode=="105472"|	medcode=="57225"|	medcode=="95049"|	medcode=="64036"|	medcode=="68039"|	medcode=="29876"|	medcode=="106911"|	medcode=="43450"|	medcode=="34926"|	medcode=="47204"|	medcode=="102158"|	medcode=="54083"|	medcode=="102715"|	medcode=="4250"|	medcode=="25191"|	medcode=="73777"|	medcode=="65123"|	medcode=="65122"|	medcode=="38939"|	medcode=="19372"|	medcode=="38914"|	medcode=="72197"|	medcode=="16527"|	medcode=="71994"|	medcode=="50695"|	medcode=="108182"|	medcode=="12335"|	medcode=="42579"|	medcode=="71262"|	medcode=="72725"|	medcode=="34089"|	medcode=="50696"|	medcode=="63105"|	medcode=="15504"|	medcode=="60092"|	medcode=="57427"|	medcode=="17887"|	medcode=="89657"|	medcode=="15036"|	medcode=="49301"|	medcode=="30646"|	medcode=="65434"|	medcode=="22158"|	medcode=="65721"|	medcode=="100615"|	medcode=="31324"|	medcode=="103900"|	medcode=="57671"|	medcode=="15883"|	medcode=="35875"|	medcode=="93342"|	medcode=="37182"|	medcode=="12006"|	medcode=="38005"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="95949"|	medcode=="7176"|	medcode=="33344"|	medcode=="70724"|	medcode=="4944"|	medcode=="20440"|	medcode=="25493"|	medcode=="65701"|	medcode=="92068"|	medcode=="105203"|	medcode=="111766"|	medcode=="45264"|	medcode=="94995"|	medcode=="58082"|	medcode=="66327"|	medcode=="3604"|	medcode=="94174"|	medcode=="99413"|	medcode=="64567"|	medcode=="34692"|	medcode=="49725"|	medcode=="38331"|	medcode=="99015"|	medcode=="103645"|	medcode=="112440"|	medcode=="66089"|	medcode=="3451"|	medcode=="37272"|	medcode=="30632"|	medcode=="31576"|	medcode=="12386"|	medcode=="2481"|	medcode=="31586"|	medcode=="35014"|	medcode=="100532"|	medcode=="54793"|	medcode=="72774"|	medcode=="101606"|	medcode=="63475"|	medcode=="104475"|	medcode=="10411"|	medcode=="5019"|	medcode=="102559"|	medcode=="59610"|	medcode=="105256"|	medcode=="31489"|	medcode=="10505")

ext2refIMMUNO <- rbindlist(list(ext2refIMMUNO1, ext2refIMMUNO2, ext2refIMMUNO3), use.names = TRUE, fill = TRUE)

fwrite(ext2refIMMUNO, paste("P:/Comorbidities/ext2refIMMUNO.csv"))
ext2refIMMUNO <- fread("P:/Comorbidities/ext2refIMMUNO.csv")

#ext2 csf and cochlear ref
ext2refCSF<-subset(ext2ref, medcode=="30525"|	medcode=="43643"|	medcode=="42441"|	medcode=="36513"|	medcode=="20641"|	medcode=="26158"|	medcode=="40348"|	medcode=="20488"|	medcode=="27295"|	medcode=="35762"|	medcode=="16172"|	medcode=="9300"|	medcode=="17957"|	medcode=="36424"|	medcode=="97074"|	medcode=="55931"|	medcode=="33396"|	medcode=="48851"|	medcode=="71772"|	medcode=="41393"|	medcode=="54342"|	medcode=="10708"|	medcode=="61980"|	medcode=="98472"|	medcode=="57642"|	medcode=="74897")

fwrite(ext2refCSF, paste("P:/Comorbidities/ext2refCSF.csv"))
ext2refCSF <- fread("P:/Comorbidities/ext2refCSF.csv")

#bind all
ext2refALL <- rbindlist(list(ext2refRESP, ext2refHEART, ext2refRENAL, ext2refLIVER, ext2refDIABETES, ext2refIMMUNO, ext2refCSF), use.names = TRUE, fill = TRUE)

fwrite(ext2refALL, paste("P:/Comorbidities/ext2refALL.csv"))
ext2refALL <- fread("P:/Comorbidities/ext2refALL.csv")


#ext3 ref resp
ext3refRESP<-subset(ext3ref, medcode=="10461"|	medcode=="96578"|	medcode=="93713"|	medcode=="73743"|	medcode=="38011"|	medcode=="15693"|	medcode=="65117"|	medcode=="100742"|	medcode=="33980"|	medcode=="58841"|	medcode=="93380"|	medcode=="29966"|	medcode=="6220"|	medcode=="65344"|	medcode=="69017"|	medcode=="18914"|	medcode=="18905"|	medcode=="100610"|	medcode=="103224"|	medcode=="110454"|	medcode=="102922"|	medcode=="106432"|	medcode=="73065"|	medcode=="49770"|	medcode=="1001"|	medcode=="148"|	medcode=="152"|	medcode=="3480"|	medcode=="3243"|	medcode=="25603"|	medcode=="15626"|	medcode=="61118"|	medcode=="11150"|	medcode=="40159"|	medcode=="37959"|	medcode=="61513"|	medcode=="27819"|	medcode=="5798"|	medcode=="14798"|	medcode=="1446"|	medcode=="26125"|	medcode=="44525"|	medcode=="24248"|	medcode=="66043"|	medcode=="45089"|	medcode=="68066"|	medcode=="15157"|	medcode=="794"|	medcode=="26306"|	medcode=="56860"|	medcode=="68662"|	medcode=="60188"|	medcode=="99536"|	medcode=="23492"|	medcode=="46578"|	medcode=="10980"|	medcode=="40788"|	medcode=="92955"|	medcode=="70787"|	medcode=="63479"|	medcode=="16410"|	medcode=="33450"|	medcode=="106805"|	medcode=="2195"|	medcode=="20364"|	medcode=="41491"|	medcode=="32679"|	medcode=="10863"|	medcode=="10802"|	medcode=="9876"|	medcode=="93568"|	medcode=="104608"|	medcode=="12166"|	medcode=="21061"|	medcode=="7884"|	medcode=="5710"|	medcode=="19492"|	medcode=="8303"|	medcode=="51410"|	medcode=="46460"|	medcode=="60805"|	medcode=="62233"|	medcode=="71853"|	medcode=="89206"|	medcode=="23446"|	medcode=="65376"|	medcode=="94894"|	medcode=="49194"|	medcode=="94575"|	medcode=="30235"|	medcode=="93577"|	medcode=="23461"|	medcode=="37365"|	medcode=="26442"|	medcode=="31423"|	medcode=="63172"|	medcode=="54830"|	medcode=="49025"|	medcode=="55758"|	medcode=="62227"|	medcode=="47142"|	medcode=="64721"|	medcode=="63216"|	medcode=="47782"|	medcode=="70815"|	medcode=="104557"|	medcode=="9711"|	medcode=="3847"|	medcode=="41781"|	medcode=="59083"|	medcode=="66104"|	medcode=="45948"|	medcode=="33837"|	medcode=="56647"|	medcode=="41015"|	medcode=="66773"|	medcode=="50876"|	medcode=="47504"|	medcode=="54252"|	medcode=="46066"|	medcode=="43285"|	medcode=="18130"|	medcode=="69914"|	medcode=="22536"|	medcode=="50374"|	medcode=="44015"|	medcode=="53205"|	medcode=="43417"|	medcode=="30214"|	medcode=="38297"|	medcode=="46405"|	medcode=="26082"|	medcode=="7321"|	medcode=="61229"|	medcode=="7791"|	medcode=="31806"|	medcode=="61119"|	medcode=="27348"|	medcode=="68814"|	medcode=="6837"|	medcode=="94136"|	medcode=="6051"|	medcode=="103472"|	medcode=="103559"|	medcode=="28229"|	medcode=="22835"|	medcode=="54308"|	medcode=="61991"|	medcode=="33830"|	medcode=="15815"|	medcode=="64799"|	medcode=="94996"|	medcode=="58791"|	medcode=="54010"|	medcode=="42940"|	medcode=="3859"|	medcode=="47364"|	medcode=="31564"|	medcode=="96655"|	medcode=="63912"|	medcode=="22905"|	medcode=="54893"|	medcode=="22915"|	medcode=="31319"|	medcode=="106650"|	medcode=="20269"|	medcode=="558"|	medcode=="39706"|	medcode=="5293"|	medcode=="65000"|	medcode=="93880"|	medcode=="72221"|	medcode=="96754"|	medcode=="24848"|	medcode=="24466"|	medcode=="99158"|	medcode=="8317"|	medcode=="103785"|	medcode=="109815"|	medcode=="104915"|	medcode=="24814"|	medcode=="94946"|	medcode=="94486"|	medcode=="59188"|	medcode=="66058"|	medcode=="65733"|	medcode=="105939"|	medcode=="106515"|	medcode=="99232"|	medcode=="105628"|	medcode=="54706"|	medcode=="65060"|	medcode=="91912"|	medcode=="71906"|	medcode=="56427"|	medcode=="38298"|	medcode=="94925"|	medcode=="6883"|	medcode=="93098"|	medcode=="13563")

fwrite(ext3refRESP, paste("P:/Comorbidities/ext3refRESP.csv"))
ext3refRESP <- fread("P:/Comorbidities/ext3refRESP.csv")

#ext3 heart ref
ext3refHEART1<-subset(ext3ref, medcode=="11284"|	medcode=="19066"|	medcode=="51214"|	medcode=="250"|	medcode=="53626"|	medcode=="61073"|	medcode=="4438"|	medcode=="242"|	medcode=="72939"|	medcode=="58529"|	medcode=="107416"|	medcode=="70105"|	medcode=="93844"|	medcode=="69734"|	medcode=="41495"|	medcode=="22262"|	medcode=="16292"|	medcode=="50157"|	medcode=="95334"|	medcode=="72668"|	medcode=="103046"|	medcode=="52427"|	medcode=="61660"|	medcode=="52127"|	medcode=="105938"|	medcode=="31464"|	medcode=="61166"|	medcode=="62718"|	medcode=="16173"|	medcode=="240"|	medcode=="241"|	medcode=="12139"|	medcode=="5387"|	medcode=="40429"|	medcode=="17872"|	medcode=="14897"|	medcode=="8935"|	medcode=="29643"|	medcode=="23892"|	medcode=="14898"|	medcode=="63467"|	medcode=="3704"|	medcode=="9507"|	medcode=="10562"|	medcode=="1678"|	medcode=="30330"|	medcode=="32854"|	medcode=="29758"|	medcode=="12229"|	medcode=="34803"|	medcode=="28736"|	medcode=="62626"|	medcode=="41221"|	medcode=="46017"|	medcode=="14658"|	medcode=="27951"|	medcode=="36523"|	medcode=="61072"|	medcode=="7347"|	medcode=="17307"|	medcode=="34328"|	medcode=="18118"|	medcode=="11983"|	medcode=="54251"|	medcode=="39449"|	medcode=="9413"|	medcode=="9276"|	medcode=="68357"|	medcode=="39693"|	medcode=="21844"|	medcode=="27977"|	medcode=="4017"|	medcode=="1430"|	medcode=="20095"|	medcode=="18125"|	medcode=="29902"|	medcode=="25842"|	medcode=="66388"|	medcode=="54535"|	medcode=="7696"|	medcode=="1414"|	medcode=="32450"|	medcode=="9555"|	medcode=="26863"|	medcode=="12804"|	medcode=="28554"|	medcode=="28138"|	medcode=="5413"|	medcode=="3999"|	medcode=="5254"|	medcode=="36609"|	medcode=="7320"|	medcode=="29421"|	medcode=="34633"|	medcode=="24540"|	medcode=="23078"|	medcode=="35713"|	medcode=="15754"|	medcode=="18889"|	medcode=="18842"|	medcode=="45809"|	medcode=="38609"|	medcode=="72562"|	medcode=="46166"|	medcode=="32272"|	medcode=="46112"|	medcode=="46276"|	medcode=="106812"|	medcode=="41835"|	medcode=="68748"|	medcode=="105479"|	medcode=="1676"|	medcode=="2062"|	medcode=="398"|	medcode=="23707"|	medcode=="32671"|	medcode=="27884"|	medcode=="11424"|	medcode=="94870"|	medcode=="884"|	medcode=="5255"|	medcode=="27964"|	medcode=="101138"|	medcode=="104275"|	medcode=="4024"|	medcode=="8966"|	medcode=="107397"|	medcode=="52517"|	medcode=="39546"|	medcode=="68401"|	medcode=="47637"|	medcode=="96838"|	medcode=="109035"|	medcode=="99991"|	medcode=="31518"|	medcode=="4964"|	medcode=="72604"|	medcode=="45505"|	medcode=="66245"|	medcode=="94344"|	medcode=="2816"|	medcode=="69858"|	medcode=="1778"|	medcode=="23988"|	medcode=="102980"|	medcode=="40025"|	medcode=="65318"|	medcode=="63390"|	medcode=="62169"|	medcode=="73539"|	medcode=="4864"|	medcode=="38967"|	medcode=="51649"|	medcode=="63046"|	medcode=="19969"|	medcode=="246"|	medcode=="42132"|	medcode=="56575"|	medcode=="67657"|	medcode=="9011"|	medcode=="51897"|	medcode=="20153"|	medcode=="54772"|	medcode=="34067"|	medcode=="7474"|	medcode=="3255"|	medcode=="3625"|	medcode=="37816"|	medcode=="59144"|	medcode=="53088"|	medcode=="54243"|	medcode=="63340"|	medcode=="51053"|	medcode=="101393"|	medcode=="49702"|	medcode=="55535"|	medcode=="43049"|	medcode=="44896"|	medcode=="73816"|	medcode=="46117"|	medcode=="9361"|	medcode=="48205"|	medcode=="66401"|	medcode=="54196"|	medcode=="5621"|	medcode=="39992"|	medcode=="69940"|	medcode=="3862"|	medcode=="54488"|	medcode=="93561"|	medcode=="22778"|	medcode=="112420"|	medcode=="45452"|	medcode=="33919"|	medcode=="21851"|	medcode=="44478"|	medcode=="107150"|	medcode=="52607"|	medcode=="70880"|	medcode=="12752"|	medcode=="21272"|	medcode=="69169"|	medcode=="100065"|	medcode=="23709"|	medcode=="6886"|	medcode=="8636"|	medcode=="58734"|	medcode=="3300"|	medcode=="6843"|	medcode=="57091"|	medcode=="90551"|	medcode=="73592"|	medcode=="63069")
ext3refHEART2<-subset(ext3ref, medcode=="100291"|	medcode=="61651"|	medcode=="20772"|	medcode=="89256"|	medcode=="108457"|	medcode=="46825"|	medcode=="50529"|	medcode=="24789"|	medcode=="16539"|	medcode=="34668"|	medcode=="9401"|	medcode=="99128"|	medcode=="32748"|	medcode=="104266"|	medcode=="97818"|	medcode=="25481"|	medcode=="71956"|	medcode=="62163"|	medcode=="103894"|	medcode=="31373"|	medcode=="49901"|	medcode=="103412"|	medcode=="53546"|	medcode=="24533"|	medcode=="68097"|	medcode=="52310"|	medcode=="102167"|	medcode=="70992"|	medcode=="71678"|	medcode=="3774"|	medcode=="72259"|	medcode=="72405"|	medcode=="50284"|	medcode=="103584"|	medcode=="92426"|	medcode=="52615"|	medcode=="98061"|	medcode=="24854"|	medcode=="93089"|	medcode=="68063"|	medcode=="34007"|	medcode=="49133"|	medcode=="50362"|	medcode=="68894"|	medcode=="108193"|	medcode=="37451"|	medcode=="23752"|	medcode=="95785"|	medcode=="111360"|	medcode=="98317"|	medcode=="24714"|	medcode=="247"|	medcode=="26626"|	medcode=="109236"|	medcode=="103432"|	medcode=="64778"|	medcode=="38968"|	medcode=="3863"|	medcode=="11982"|	medcode=="3301"|	medcode=="57932"|	medcode=="72295"|	medcode=="70853"|	medcode=="37323"|	medcode=="59907"|	medcode=="50220"|	medcode=="62230"|	medcode=="30725"|	medcode=="67286"|	medcode=="30949"|	medcode=="46530"|	medcode=="49731"|	medcode=="44334"|	medcode=="90486"|	medcode=="70691"|	medcode=="34176"|	medcode=="68198"|	medcode=="59298"|	medcode=="37515"|	medcode=="63768"|	medcode=="53964"|	medcode=="62376"|	medcode=="58076"|	medcode=="44781"|	medcode=="49474"|	medcode=="56200"|	medcode=="11945"|	medcode=="11127"|	medcode=="63187"|	medcode=="67928"|	medcode=="31112"|	medcode=="18982"|	medcode=="54487"|	medcode=="2670"|	medcode=="96225"|	medcode=="65029"|	medcode=="32508"|	medcode=="52411"|	medcode=="42127"|	medcode=="42684"|	medcode=="45291"|	medcode=="74890"|	medcode=="50886"|	medcode=="51941"|	medcode=="105037"|	medcode=="103039"|	medcode=="68784"|	medcode=="46176"|	medcode=="101307"|	medcode=="99649"|	medcode=="73663"|	medcode=="101520"|	medcode=="72655"|	medcode=="51675"|	medcode=="41197"|	medcode=="110026"|	medcode=="36606"|	medcode=="71874"|	medcode=="51911"|	medcode=="73554"|	medcode=="101322"|	medcode=="109008"|	medcode=="110047"|	medcode=="106644"|	medcode=="107639"|	medcode=="110418"|	medcode=="107496"|	medcode=="107710"|	medcode=="9384"|	medcode=="25089"|	medcode=="22383"|	medcode=="21966")

ext3refHEART <- rbindlist(list(ext3refHEART1, ext3refHEART2), use.names = TRUE, fill = TRUE)

fwrite(ext3refHEART, paste("P:/Comorbidities/ext3refHEART.csv"))
ext3refHEART <- fread("P:/Comorbidities/ext3refHEART.csv")

#ext3 renal ref
ext3refRENAL<-subset(ext3ref, medcode=="12479"|	medcode=="12585"|	medcode=="95122"|	medcode=="95406"|	medcode=="95508"|	medcode=="95405"|	medcode=="2997"|	medcode=="55151"|	medcode=="11745"|	medcode=="24361"|	medcode=="89924"|	medcode=="96133"|	medcode=="109455"|	medcode=="105787"|	medcode=="70874"|	medcode=="5504"|	medcode=="31549"|	medcode=="20073"|	medcode=="2994"|	medcode=="2996"|	medcode=="71124"|	medcode=="88597"|	medcode=="30756"|	medcode=="64828"|	medcode=="48022"|	medcode=="64636"|	medcode=="56760"|	medcode=="8037"|	medcode=="23773"|	medcode=="104586"|	medcode=="59194"|	medcode=="83513"|	medcode=="30709"|	medcode=="107901"|	medcode=="65089"|	medcode=="102210"|	medcode=="30323"|	medcode=="26054"|	medcode=="26860"|	medcode=="109840"|	medcode=="2999"|	medcode=="9840"|	medcode=="1803"|	medcode=="99644"|	medcode=="29634"|	medcode=="23913"|	medcode=="22852"|	medcode=="19316"|	medcode=="21947"|	medcode=="50472"|	medcode=="21989"|	medcode=="56987"|	medcode=="17365"|	medcode=="63786"|	medcode=="72303"|	medcode=="108591"|	medcode=="110749"|	medcode=="111370"|	medcode=="108816"|	medcode=="47922"|	medcode=="2471"|	medcode=="99201"|	medcode=="58750"|	medcode=="94373"|	medcode=="27427"|	medcode=="65064"|	medcode=="512"|	medcode=="6712"|	medcode=="104963"|	medcode=="105151"|	medcode=="350"|	medcode=="105302"|	medcode=="61814"|	medcode=="71174"|	medcode=="97734"|	medcode=="41285"|	medcode=="58060"|	medcode=="109945"|	medcode=="50200"|	medcode=="62320"|	medcode=="8330"|	medcode=="100205"|	medcode=="61930"|	medcode=="11554"|	medcode=="5911"|	medcode=="53940"|	medcode=="108494")

fwrite(ext3refRENAL, paste("P:/Comorbidities/ext3refRENAL.csv"))
ext3refRENAL <- fread("P:/Comorbidities/ext3refRENAL.csv")

#ext3 liver ref
ext3refLIVER<-subset(ext3ref, medcode=="4405"|	medcode=="32025"|	medcode=="71422"|	medcode=="69194"|	medcode=="105506"|	medcode=="97157"|	medcode=="99250"|	medcode=="27319"|	medcode=="26367"|	medcode=="24813"|	medcode=="41096"|	medcode=="30586"|	medcode=="106642"|	medcode=="32277"|	medcode=="108343"|	medcode=="107896"|	medcode=="110454"|	medcode=="102922"|	medcode=="48211"|	medcode=="6863"|	medcode=="4743"|	medcode=="21713"|	medcode=="17330"|	medcode=="1754"|	medcode=="23578"|	medcode=="9029"|	medcode=="1755"|	medcode=="53480"|	medcode=="66534"|	medcode=="53877"|	medcode=="15489"|	medcode=="16725"|	medcode=="69204"|	medcode=="3450"|	medcode=="44676"|	medcode=="92909"|	medcode=="40567"|	medcode=="27438"|	medcode=="96664"|	medcode=="100253"|	medcode=="73482"|	medcode=="112044"|	medcode=="109540"|	medcode=="48928"|	medcode=="55454"|	medcode=="16455"|	medcode=="9494"|	medcode=="5638"|	medcode=="15424"|	medcode=="91591"|	medcode=="58630"|	medcode=="7602"|	medcode=="42843"|	medcode=="25383"|	medcode=="60104"|	medcode=="100592"|	medcode=="33597"|	medcode=="10539"|	medcode=="5129"|	medcode=="10636"|	medcode=="24901"|	medcode=="48102"|	medcode=="17219"|	medcode=="64750"|	medcode=="39351"|	medcode=="44120"|	medcode=="26405"|	medcode=="18652"|	medcode=="15425"|	medcode=="6015"|	medcode=="25597"|	medcode=="16417"|	medcode=="38389"|	medcode=="48269"|	medcode=="50400"|	medcode=="50444"|	medcode=="40029"|	medcode=="10721"|	medcode=="71422"|	medcode=="4405"|	medcode=="32025"|	medcode=="69194")

fwrite(ext3refLIVER, paste("P:/Comorbidities/ext3refLIVER.csv"))
ext3refLIVER <- fread("P:/Comorbidities/ext3refLIVER.csv")

#ext3 diabetes ref
ext3refDIABETES<-subset(ext3ref, medcode=="711"|	medcode=="43453"|	medcode=="36695"|	medcode=="1549"|	medcode=="47582"|	medcode=="47649"|	medcode=="42831"|	medcode=="47650"|	medcode=="43921"|	medcode=="18683"|	medcode=="69993"|	medcode=="18387"|	medcode=="35288"|	medcode=="40682"|	medcode=="69676"|	medcode=="68105"|	medcode=="46301"|	medcode=="10418"|	medcode=="39070"|	medcode=="49554"|	medcode=="93468"|	medcode=="18642"|	medcode=="54008"|	medcode=="30323"|	medcode=="30294"|	medcode=="10692"|	medcode=="40837"|	medcode=="22871"|	medcode=="55239"|	medcode=="95636"|	medcode=="758"|	medcode=="18777"|	medcode=="47321"|	medcode=="34268"|	medcode=="65267"|	medcode=="49074"|	medcode=="12736"|	medcode=="18496"|	medcode=="25627"|	medcode=="47954"|	medcode=="62674"|	medcode=="18425"|	medcode=="12640"|	medcode=="46917"|	medcode=="44982"|	medcode=="37806"|	medcode=="59253"|	medcode=="35385"|	medcode=="1407"|	medcode=="34450"|	medcode=="26054"|	medcode=="18390"|	medcode=="32627"|	medcode=="51756"|	medcode=="25591"|	medcode=="63690"|	medcode=="95539"|	medcode=="51697"|	medcode=="96506"|	medcode=="61122"|	medcode=="67212"|	medcode=="43857"|	medcode=="22487"|	medcode=="94383"|	medcode=="93380"|	medcode=="52212"|	medcode=="106927"|	medcode=="53200"|	medcode=="42567"|	medcode=="54856"|	medcode=="6791"|	medcode=="31310"|	medcode=="60499"|	medcode=="52104"|	medcode=="52283"|	medcode=="49276"|	medcode=="46963"|	medcode=="6509"|	medcode=="44443"|	medcode=="8403"|	medcode=="40401"|	medcode=="68843"|	medcode=="62146"|	medcode=="55842"|	medcode=="50429"|	medcode=="52303"|	medcode=="17262"|	medcode=="34912")

fwrite(ext3refDIABETES, paste("P:/Comorbidities/ext3refDIABETES.csv"))
ext3refDIABETES <- fread("P:/Comorbidities/ext3refDIABETES.csv")

#ext3 immuno ref
ext3refIMMUNO1<-subset(ext3ref, medcode=="47106"|	medcode=="22307"|	medcode=="34310"|	medcode=="108246"|	medcode=="27514"|	medcode=="1393"|	medcode=="31041"|	medcode=="102966"|	medcode=="59784"|	medcode=="106015"|	medcode=="32133"|	medcode=="23770"|	medcode=="58857"|	medcode=="58859"|	medcode=="69766"|	medcode=="70869"|	medcode=="53636"|	medcode=="70528"|	medcode=="101836"|	medcode=="47632"|	medcode=="111979"|	medcode=="67575"|	medcode=="71450"|	medcode=="62891"|	medcode=="36294"|	medcode=="44303"|	medcode=="37006"|	medcode=="66368"|	medcode=="23951"|	medcode=="27641"|	medcode=="50076"|	medcode=="27853"|	medcode=="44617"|	medcode=="66367"|	medcode=="105324"|	medcode=="65117"|	medcode=="8281"|	medcode=="51708"|	medcode=="62854"|	medcode=="112030"|	medcode=="107807"|	medcode=="112031"|	medcode=="102117"|	medcode=="104134"|	medcode=="112032"|	medcode=="69767"|	medcode=="112034"|	medcode=="112035"|	medcode=="112036"|	medcode=="112037"|	medcode=="96751"|	medcode=="102252"|	medcode=="100769"|	medcode=="65460"|	medcode=="108667"|	medcode=="72224"|	medcode=="93778"|	medcode=="12323"|	medcode=="41369"|	medcode=="1481"|	medcode=="60242"|	medcode=="71031"|	medcode=="70374"|	medcode=="95058"|	medcode=="99240"|	medcode=="27416"|	medcode=="71625"|	medcode=="71238"|	medcode=="62380"|	medcode=="64670"|	medcode=="100352"|	medcode=="103245"|	medcode=="104790"|	medcode=="63723"|	medcode=="21402"|	medcode=="59115"|	medcode=="100006"|	medcode=="97577"|	medcode=="92380"|	medcode=="71304"|	medcode=="99887"|	medcode=="99951"|	medcode=="2462"|	medcode=="65489"|	medcode=="100423"|	medcode=="98840"|	medcode=="44196"|	medcode=="98909"|	medcode=="64036"|	medcode=="68039"|	medcode=="38939"|	medcode=="71142"|	medcode=="68330"|	medcode=="92245"|	medcode=="73532"|	medcode=="93951"|	medcode=="95338"|	medcode=="106911"|	medcode=="104743"|	medcode=="29876"|	medcode=="29178"|	medcode=="57225"|	medcode=="55303"|	medcode=="67506"|	medcode=="61149"|	medcode=="65483"|	medcode=="105472"|	medcode=="19140"|	medcode=="63054"|	medcode=="49605"|	medcode=="97863"|	medcode=="94407"|	medcode=="58684"|	medcode=="108886"|	medcode=="94005"|	medcode=="67703"|	medcode=="95049"|	medcode=="111942"|	medcode=="63625"|	medcode=="110563"|	medcode=="101715"|	medcode=="107032"|	medcode=="101530"|	medcode=="104895"|	medcode=="105841"|	medcode=="108775"|	medcode=="106597"|	medcode=="104484"|	medcode=="53397"|	medcode=="61662"|	medcode=="59778"|	medcode=="59755"|	medcode=="107804"|	medcode=="91900"|	medcode=="99012"|	medcode=="94279"|	medcode=="97746"|	medcode=="42461"|	medcode=="5179"|	medcode=="66327"|	medcode=="45264"|	medcode=="105203"|	medcode=="92068"|	medcode=="111766"|	medcode=="94995"|	medcode=="58082"|	medcode=="65701"|	medcode=="12006"|	medcode=="95949"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="38005"|	medcode=="35014"|	medcode=="100532"|	medcode=="27330"|	medcode=="65122"|	medcode=="65123"|	medcode=="73777"|	medcode=="34926"|	medcode=="102715"|	medcode=="102158"|	medcode=="54083"|	medcode=="47204"|	medcode=="15036"|	medcode=="103900"|	medcode=="100615"|	medcode=="31324"|	medcode=="89657"|	medcode=="3604"|	medcode=="28639"|	medcode=="70842"|	medcode=="49262"|	medcode=="50668"|	medcode=="108182"|	medcode=="50695"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="95715"|	medcode=="101114"|	medcode=="31576"|	medcode=="21549"|	medcode=="70509"|	medcode=="102594"|	medcode=="105966"|	medcode=="105038"|	medcode=="31794"|	medcode=="39798"|	medcode=="104152"|	medcode=="105889"|	medcode=="105095"|	medcode=="107166"|	medcode=="105020"|	medcode=="107973"|	medcode=="106969"|	medcode=="108719"|	medcode=="106063"|	medcode=="105792"|	medcode=="105335"|	medcode=="105559"|	medcode=="105955"|	medcode=="109780"|	medcode=="107949"|	medcode=="105709"|	medcode=="105925"|	medcode=="105375")
ext3refIMMUNO2<-subset(ext3ref, medcode=="105636"|	medcode=="105286"|	medcode=="104934"|	medcode=="106884"|	medcode=="104386"|	medcode=="104620"|	medcode=="104412"|	medcode=="111682"|	medcode=="17887"|	medcode=="90201"|	medcode=="57737"|	medcode=="12464"|	medcode=="44318"|	medcode=="12335"|	medcode=="57427"|	medcode=="50696"|	medcode=="72725"|	medcode=="42579"|	medcode=="34089"|	medcode=="63105"|	medcode=="71262"|	medcode=="60092"|	medcode=="15504"|	medcode=="15027"|	medcode=="65434"|	medcode=="37182"|	medcode=="4944"|	medcode=="22158"|	medcode=="19028"|	medcode=="21329"|	medcode=="46042"|	medcode=="104418"|	medcode=="39187"|	medcode=="64567"|	medcode=="43450"|	medcode=="19372"|	medcode=="4251"|	medcode=="104325"|	medcode=="8625"|	medcode=="104328"|	medcode=="107052"|	medcode=="106924"|	medcode=="107163"|	medcode=="72774"|	medcode=="49725"|	medcode=="31586"|	medcode=="37461"|	medcode=="108656"|	medcode=="107643"|	medcode=="104939"|	medcode=="38331"|	medcode=="38914"|	medcode=="7176"|	medcode=="4413"|	medcode=="10726"|	medcode=="100786"|	medcode=="105957"|	medcode=="102783"|	medcode=="107236"|	medcode=="27520"|	medcode=="63475"|	medcode=="70724"|	medcode=="52327"|	medcode=="39629"|	medcode=="104788"|	medcode=="112440"|	medcode=="27664"|	medcode=="66089"|	medcode=="33344"|	medcode=="35875"|	medcode=="19974"|	medcode=="27458"|	medcode=="101606"|	medcode=="108424"|	medcode=="99015"|	medcode=="103645"|	medcode=="93342"|	medcode=="37272"|	medcode=="42539"|	medcode=="37468"|	medcode=="57671"|	medcode=="65721"|	medcode=="50858"|	medcode=="28276"|	medcode=="110838"|	medcode=="104273"|	medcode=="94174"|	medcode=="72197"|	medcode=="99413"|	medcode=="30632"|	medcode=="25191"|	medcode=="4072"|	medcode=="16416"|	medcode=="54793"|	medcode=="34692"|	medcode=="4250"|	medcode=="20440"|	medcode=="61500"|	medcode=="22050"|	medcode=="104475"|	medcode=="105069"|	medcode=="30646"|	medcode=="6115"|	medcode=="39336"|	medcode=="49301"|	medcode=="25493"|	medcode=="2481"|	medcode=="11950"|	medcode=="106993"|	medcode=="104740"|	medcode=="105915"|	medcode=="45285"|	medcode=="46444"|	medcode=="70935"|	medcode=="40740"|	medcode=="43415"|	medcode=="67518"|	medcode=="98596"|	medcode=="64336"|	medcode=="102688"|	medcode=="67029"|	medcode=="61693"|	medcode=="89762"|	medcode=="89329"|	medcode=="65165"|	medcode=="105025"|	medcode=="72500"|	medcode=="64515"|	medcode=="109714"|	medcode=="63375"|	medcode=="8649"|	medcode=="45143"|	medcode=="69545"|	medcode=="15883"|	medcode=="106381"|	medcode=="3451"|	medcode=="12306"|	medcode=="12386"|	medcode=="16527"|	medcode=="10411"|	medcode=="101350"|	medcode=="99067"|	medcode=="108102"|	medcode=="71994"|	medcode=="18486"|	medcode=="51041"|	medcode=="27934"|	medcode=="104554"|	medcode=="110183"|	medcode=="44147"|	medcode=="15137"|	medcode=="8548"|	medcode=="18701"|	medcode=="18700"|	medcode=="68440"|	medcode=="57161"|	medcode=="69373"|	medcode=="57322"|	medcode=="92569"|	medcode=="62598"|	medcode=="69184"|	medcode=="60026"|	medcode=="69854"|	medcode=="16295"|	medcode=="48307"|	medcode=="50665"|	medcode=="31322"|	medcode=="62236"|	medcode=="48293"|	medcode=="31541"|	medcode=="66073"|	medcode=="49542"|	medcode=="50526"|	medcode=="103977"|	medcode=="62328"|	medcode=="3129"|	medcode=="65617"|	medcode=="56108"|	medcode=="54203"|	medcode=="21975"|	medcode=="93892"|	medcode=="66857"|	medcode=="36408"|	medcode=="109671"|	medcode=="54904"|	medcode=="63204"|	medcode=="32141"|	medcode=="91911"|	medcode=="66049"|	medcode=="40950"|	medcode=="18781"| medcode=="38306"|	medcode=="39034"|	medcode=="34150"|	medcode=="5572"|	medcode=="2337"|	medcode=="41185"|	medcode=="73583"|	medcode=="12699"|	medcode=="5655"|	medcode=="66740"|	medcode=="27515"|	medcode=="51640"|	medcode=="32270"|	medcode=="57551"|	medcode=="95005"|	medcode=="39420"|	medcode=="61069"|	medcode=="56973"|	medcode=="47695"|	medcode=="65825")
ext3refIMMUNO3<-subset(ext3ref, medcode=="63323"|	medcode=="53317"|	medcode=="20261"|	medcode=="11346"|	medcode=="100043"|	medcode=="52604"|	medcode=="57525"|	medcode=="40406"|	medcode=="70236"|	medcode=="62041"|	medcode=="22319"|	medcode=="101375"|	medcode=="101075"|	medcode=="4072"|	medcode=="4251"|	medcode=="19974"|	medcode=="4413"|	medcode=="50858"|	medcode=="27664"|	medcode=="37461"|	medcode=="52327"|	medcode=="100786"|	medcode=="16416"|	medcode=="8625"|	medcode=="27458"|	medcode=="10726"|	medcode=="27520"|	medcode=="22050"|	medcode=="102783"|	medcode=="50668"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="21549"|	medcode=="70842"|	medcode=="99067"|	medcode=="39629"|	medcode=="27330"|	medcode=="53397"|	medcode=="107804"|	medcode=="59755"|	medcode=="91900"|	medcode=="59778"|	medcode=="99012"|	medcode=="97746"|	medcode=="94279"|	medcode=="61662"|	medcode=="67703"|	medcode=="101530"|	medcode=="63625"|	medcode=="111942"|	medcode=="110563"|	medcode=="107032"|	medcode=="101715"|	medcode=="73532"|	medcode=="95338"|	medcode=="92245"|	medcode=="68330"|	medcode=="93951"|	medcode=="104743"|	medcode=="71142"|	medcode=="49605"|	medcode=="94005"|	medcode=="58684"|	medcode=="94407"|	medcode=="108886"|	medcode=="97863"|	medcode=="29178"|	medcode=="63054"|	medcode=="61149"|	medcode=="67506"|	medcode=="65483"|	medcode=="55303"|	medcode=="19140"|	medcode=="105472"|	medcode=="57225"|	medcode=="95049"|	medcode=="64036"|	medcode=="68039"|	medcode=="29876"|	medcode=="106911"|	medcode=="43450"|	medcode=="34926"|	medcode=="47204"|	medcode=="102158"|	medcode=="54083"|	medcode=="102715"|	medcode=="4250"|	medcode=="25191"|	medcode=="73777"|	medcode=="65123"|	medcode=="65122"|	medcode=="38939"|	medcode=="19372"|	medcode=="38914"|	medcode=="72197"|	medcode=="16527"|	medcode=="71994"|	medcode=="50695"|	medcode=="108182"|	medcode=="12335"|	medcode=="42579"|	medcode=="71262"|	medcode=="72725"|	medcode=="34089"|	medcode=="50696"|	medcode=="63105"|	medcode=="15504"|	medcode=="60092"|	medcode=="57427"|	medcode=="17887"|	medcode=="89657"|	medcode=="15036"|	medcode=="49301"|	medcode=="30646"|	medcode=="65434"|	medcode=="22158"|	medcode=="65721"|	medcode=="100615"|	medcode=="31324"|	medcode=="103900"|	medcode=="57671"|	medcode=="15883"|	medcode=="35875"|	medcode=="93342"|	medcode=="37182"|	medcode=="12006"|	medcode=="38005"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="95949"|	medcode=="7176"|	medcode=="33344"|	medcode=="70724"|	medcode=="4944"|	medcode=="20440"|	medcode=="25493"|	medcode=="65701"|	medcode=="92068"|	medcode=="105203"|	medcode=="111766"|	medcode=="45264"|	medcode=="94995"|	medcode=="58082"|	medcode=="66327"|	medcode=="3604"|	medcode=="94174"|	medcode=="99413"|	medcode=="64567"|	medcode=="34692"|	medcode=="49725"|	medcode=="38331"|	medcode=="99015"|	medcode=="103645"|	medcode=="112440"|	medcode=="66089"|	medcode=="3451"|	medcode=="37272"|	medcode=="30632"|	medcode=="31576"|	medcode=="12386"|	medcode=="2481"|	medcode=="31586"|	medcode=="35014"|	medcode=="100532"|	medcode=="54793"|	medcode=="72774"|	medcode=="101606"|	medcode=="63475"|	medcode=="104475"|	medcode=="10411"|	medcode=="5019"|	medcode=="102559"|	medcode=="59610"|	medcode=="105256"|	medcode=="31489"|	medcode=="10505")

ext3refIMMUNO <- rbindlist(list(ext3refIMMUNO1, ext3refIMMUNO2, ext3refIMMUNO3), use.names = TRUE, fill = TRUE)

fwrite(ext3refIMMUNO, paste("P:/Comorbidities/ext3refIMMUNO.csv"))
ext3refIMMUNO <- fread("P:/Comorbidities/ext3refIMMUNO.csv")

#ext3 csf and cochlear ref
ext3refCSF<-subset(ext3ref, medcode=="30525"|	medcode=="43643"|	medcode=="42441"|	medcode=="36513"|	medcode=="20641"|	medcode=="26158"|	medcode=="40348"|	medcode=="20488"|	medcode=="27295"|	medcode=="35762"|	medcode=="16172"|	medcode=="9300"|	medcode=="17957"|	medcode=="36424"|	medcode=="97074"|	medcode=="55931"|	medcode=="33396"|	medcode=="48851"|	medcode=="71772"|	medcode=="41393"|	medcode=="54342"|	medcode=="10708"|	medcode=="61980"|	medcode=="98472"|	medcode=="57642"|	medcode=="74897")

fwrite(ext3refCSF, paste("P:/Comorbidities/ext3refCSF.csv"))
ext3refCSF <- fread("P:/Comorbidities/ext3refCSF.csv")

#bind all
ext3refALL <- rbindlist(list(ext3refRESP, ext3refHEART, ext3refRENAL, ext3refLIVER, ext3refDIABETES, ext3refIMMUNO, ext3refCSF), use.names = TRUE, fill = TRUE)

fwrite(ext3refALL, paste("P:/Comorbidities/ext3refALL.csv"))
ext3refALL <- fread("P:/Comorbidities/ext3refALL.csv")

#ext4 ref resp
ext4refRESP<-subset(ext4ref, medcode=="10461"|	medcode=="96578"|	medcode=="93713"|	medcode=="73743"|	medcode=="38011"|	medcode=="15693"|	medcode=="65117"|	medcode=="100742"|	medcode=="33980"|	medcode=="58841"|	medcode=="93380"|	medcode=="29966"|	medcode=="6220"|	medcode=="65344"|	medcode=="69017"|	medcode=="18914"|	medcode=="18905"|	medcode=="100610"|	medcode=="103224"|	medcode=="110454"|	medcode=="102922"|	medcode=="106432"|	medcode=="73065"|	medcode=="49770"|	medcode=="1001"|	medcode=="148"|	medcode=="152"|	medcode=="3480"|	medcode=="3243"|	medcode=="25603"|	medcode=="15626"|	medcode=="61118"|	medcode=="11150"|	medcode=="40159"|	medcode=="37959"|	medcode=="61513"|	medcode=="27819"|	medcode=="5798"|	medcode=="14798"|	medcode=="1446"|	medcode=="26125"|	medcode=="44525"|	medcode=="24248"|	medcode=="66043"|	medcode=="45089"|	medcode=="68066"|	medcode=="15157"|	medcode=="794"|	medcode=="26306"|	medcode=="56860"|	medcode=="68662"|	medcode=="60188"|	medcode=="99536"|	medcode=="23492"|	medcode=="46578"|	medcode=="10980"|	medcode=="40788"|	medcode=="92955"|	medcode=="70787"|	medcode=="63479"|	medcode=="16410"|	medcode=="33450"|	medcode=="106805"|	medcode=="2195"|	medcode=="20364"|	medcode=="41491"|	medcode=="32679"|	medcode=="10863"|	medcode=="10802"|	medcode=="9876"|	medcode=="93568"|	medcode=="104608"|	medcode=="12166"|	medcode=="21061"|	medcode=="7884"|	medcode=="5710"|	medcode=="19492"|	medcode=="8303"|	medcode=="51410"|	medcode=="46460"|	medcode=="60805"|	medcode=="62233"|	medcode=="71853"|	medcode=="89206"|	medcode=="23446"|	medcode=="65376"|	medcode=="94894"|	medcode=="49194"|	medcode=="94575"|	medcode=="30235"|	medcode=="93577"|	medcode=="23461"|	medcode=="37365"|	medcode=="26442"|	medcode=="31423"|	medcode=="63172"|	medcode=="54830"|	medcode=="49025"|	medcode=="55758"|	medcode=="62227"|	medcode=="47142"|	medcode=="64721"|	medcode=="63216"|	medcode=="47782"|	medcode=="70815"|	medcode=="104557"|	medcode=="9711"|	medcode=="3847"|	medcode=="41781"|	medcode=="59083"|	medcode=="66104"|	medcode=="45948"|	medcode=="33837"|	medcode=="56647"|	medcode=="41015"|	medcode=="66773"|	medcode=="50876"|	medcode=="47504"|	medcode=="54252"|	medcode=="46066"|	medcode=="43285"|	medcode=="18130"|	medcode=="69914"|	medcode=="22536"|	medcode=="50374"|	medcode=="44015"|	medcode=="53205"|	medcode=="43417"|	medcode=="30214"|	medcode=="38297"|	medcode=="46405"|	medcode=="26082"|	medcode=="7321"|	medcode=="61229"|	medcode=="7791"|	medcode=="31806"|	medcode=="61119"|	medcode=="27348"|	medcode=="68814"|	medcode=="6837"|	medcode=="94136"|	medcode=="6051"|	medcode=="103472"|	medcode=="103559"|	medcode=="28229"|	medcode=="22835"|	medcode=="54308"|	medcode=="61991"|	medcode=="33830"|	medcode=="15815"|	medcode=="64799"|	medcode=="94996"|	medcode=="58791"|	medcode=="54010"|	medcode=="42940"|	medcode=="3859"|	medcode=="47364"|	medcode=="31564"|	medcode=="96655"|	medcode=="63912"|	medcode=="22905"|	medcode=="54893"|	medcode=="22915"|	medcode=="31319"|	medcode=="106650"|	medcode=="20269"|	medcode=="558"|	medcode=="39706"|	medcode=="5293"|	medcode=="65000"|	medcode=="93880"|	medcode=="72221"|	medcode=="96754"|	medcode=="24848"|	medcode=="24466"|	medcode=="99158"|	medcode=="8317"|	medcode=="103785"|	medcode=="109815"|	medcode=="104915"|	medcode=="24814"|	medcode=="94946"|	medcode=="94486"|	medcode=="59188"|	medcode=="66058"|	medcode=="65733"|	medcode=="105939"|	medcode=="106515"|	medcode=="99232"|	medcode=="105628"|	medcode=="54706"|	medcode=="65060"|	medcode=="91912"|	medcode=="71906"|	medcode=="56427"|	medcode=="38298"|	medcode=="94925"|	medcode=="6883"|	medcode=="93098"|	medcode=="13563")

fwrite(ext4refRESP, paste("P:/Comorbidities/ext4refRESP.csv"))
ext4refRESP <- fread("P:/Comorbidities/ext4refRESP.csv")

#ext4 heart ref
ext4refHEART1<-subset(ext4ref, medcode=="11284"|	medcode=="19066"|	medcode=="51214"|	medcode=="250"|	medcode=="53626"|	medcode=="61073"|	medcode=="4438"|	medcode=="242"|	medcode=="72939"|	medcode=="58529"|	medcode=="107416"|	medcode=="70105"|	medcode=="93844"|	medcode=="69734"|	medcode=="41495"|	medcode=="22262"|	medcode=="16292"|	medcode=="50157"|	medcode=="95334"|	medcode=="72668"|	medcode=="103046"|	medcode=="52427"|	medcode=="61660"|	medcode=="52127"|	medcode=="105938"|	medcode=="31464"|	medcode=="61166"|	medcode=="62718"|	medcode=="16173"|	medcode=="240"|	medcode=="241"|	medcode=="12139"|	medcode=="5387"|	medcode=="40429"|	medcode=="17872"|	medcode=="14897"|	medcode=="8935"|	medcode=="29643"|	medcode=="23892"|	medcode=="14898"|	medcode=="63467"|	medcode=="3704"|	medcode=="9507"|	medcode=="10562"|	medcode=="1678"|	medcode=="30330"|	medcode=="32854"|	medcode=="29758"|	medcode=="12229"|	medcode=="34803"|	medcode=="28736"|	medcode=="62626"|	medcode=="41221"|	medcode=="46017"|	medcode=="14658"|	medcode=="27951"|	medcode=="36523"|	medcode=="61072"|	medcode=="7347"|	medcode=="17307"|	medcode=="34328"|	medcode=="18118"|	medcode=="11983"|	medcode=="54251"|	medcode=="39449"|	medcode=="9413"|	medcode=="9276"|	medcode=="68357"|	medcode=="39693"|	medcode=="21844"|	medcode=="27977"|	medcode=="4017"|	medcode=="1430"|	medcode=="20095"|	medcode=="18125"|	medcode=="29902"|	medcode=="25842"|	medcode=="66388"|	medcode=="54535"|	medcode=="7696"|	medcode=="1414"|	medcode=="32450"|	medcode=="9555"|	medcode=="26863"|	medcode=="12804"|	medcode=="28554"|	medcode=="28138"|	medcode=="5413"|	medcode=="3999"|	medcode=="5254"|	medcode=="36609"|	medcode=="7320"|	medcode=="29421"|	medcode=="34633"|	medcode=="24540"|	medcode=="23078"|	medcode=="35713"|	medcode=="15754"|	medcode=="18889"|	medcode=="18842"|	medcode=="45809"|	medcode=="38609"|	medcode=="72562"|	medcode=="46166"|	medcode=="32272"|	medcode=="46112"|	medcode=="46276"|	medcode=="106812"|	medcode=="41835"|	medcode=="68748"|	medcode=="105479"|	medcode=="1676"|	medcode=="2062"|	medcode=="398"|	medcode=="23707"|	medcode=="32671"|	medcode=="27884"|	medcode=="11424"|	medcode=="94870"|	medcode=="884"|	medcode=="5255"|	medcode=="27964"|	medcode=="101138"|	medcode=="104275"|	medcode=="4024"|	medcode=="8966"|	medcode=="107397"|	medcode=="52517"|	medcode=="39546"|	medcode=="68401"|	medcode=="47637"|	medcode=="96838"|	medcode=="109035"|	medcode=="99991"|	medcode=="31518"|	medcode=="4964"|	medcode=="72604"|	medcode=="45505"|	medcode=="66245"|	medcode=="94344"|	medcode=="2816"|	medcode=="69858"|	medcode=="1778"|	medcode=="23988"|	medcode=="102980"|	medcode=="40025"|	medcode=="65318"|	medcode=="63390"|	medcode=="62169"|	medcode=="73539"|	medcode=="4864"|	medcode=="38967"|	medcode=="51649"|	medcode=="63046"|	medcode=="19969"|	medcode=="246"|	medcode=="42132"|	medcode=="56575"|	medcode=="67657"|	medcode=="9011"|	medcode=="51897"|	medcode=="20153"|	medcode=="54772"|	medcode=="34067"|	medcode=="7474"|	medcode=="3255"|	medcode=="3625"|	medcode=="37816"|	medcode=="59144"|	medcode=="53088"|	medcode=="54243"|	medcode=="63340"|	medcode=="51053"|	medcode=="101393"|	medcode=="49702"|	medcode=="55535"|	medcode=="43049"|	medcode=="44896"|	medcode=="73816"|	medcode=="46117"|	medcode=="9361"|	medcode=="48205"|	medcode=="66401"|	medcode=="54196"|	medcode=="5621"|	medcode=="39992"|	medcode=="69940"|	medcode=="3862"|	medcode=="54488"|	medcode=="93561"|	medcode=="22778"|	medcode=="112420"|	medcode=="45452"|	medcode=="33919"|	medcode=="21851"|	medcode=="44478"|	medcode=="107150"|	medcode=="52607"|	medcode=="70880"|	medcode=="12752"|	medcode=="21272"|	medcode=="69169"|	medcode=="100065"|	medcode=="23709"|	medcode=="6886"|	medcode=="8636"|	medcode=="58734"|	medcode=="3300"|	medcode=="6843"|	medcode=="57091"|	medcode=="90551"|	medcode=="73592"|	medcode=="63069")
ext4refHEART2<-subset(ext4ref, medcode=="100291"|	medcode=="61651"|	medcode=="20772"|	medcode=="89256"|	medcode=="108457"|	medcode=="46825"|	medcode=="50529"|	medcode=="24789"|	medcode=="16539"|	medcode=="34668"|	medcode=="9401"|	medcode=="99128"|	medcode=="32748"|	medcode=="104266"|	medcode=="97818"|	medcode=="25481"|	medcode=="71956"|	medcode=="62163"|	medcode=="103894"|	medcode=="31373"|	medcode=="49901"|	medcode=="103412"|	medcode=="53546"|	medcode=="24533"|	medcode=="68097"|	medcode=="52310"|	medcode=="102167"|	medcode=="70992"|	medcode=="71678"|	medcode=="3774"|	medcode=="72259"|	medcode=="72405"|	medcode=="50284"|	medcode=="103584"|	medcode=="92426"|	medcode=="52615"|	medcode=="98061"|	medcode=="24854"|	medcode=="93089"|	medcode=="68063"|	medcode=="34007"|	medcode=="49133"|	medcode=="50362"|	medcode=="68894"|	medcode=="108193"|	medcode=="37451"|	medcode=="23752"|	medcode=="95785"|	medcode=="111360"|	medcode=="98317"|	medcode=="24714"|	medcode=="247"|	medcode=="26626"|	medcode=="109236"|	medcode=="103432"|	medcode=="64778"|	medcode=="38968"|	medcode=="3863"|	medcode=="11982"|	medcode=="3301"|	medcode=="57932"|	medcode=="72295"|	medcode=="70853"|	medcode=="37323"|	medcode=="59907"|	medcode=="50220"|	medcode=="62230"|	medcode=="30725"|	medcode=="67286"|	medcode=="30949"|	medcode=="46530"|	medcode=="49731"|	medcode=="44334"|	medcode=="90486"|	medcode=="70691"|	medcode=="34176"|	medcode=="68198"|	medcode=="59298"|	medcode=="37515"|	medcode=="63768"|	medcode=="53964"|	medcode=="62376"|	medcode=="58076"|	medcode=="44781"|	medcode=="49474"|	medcode=="56200"|	medcode=="11945"|	medcode=="11127"|	medcode=="63187"|	medcode=="67928"|	medcode=="31112"|	medcode=="18982"|	medcode=="54487"|	medcode=="2670"|	medcode=="96225"|	medcode=="65029"|	medcode=="32508"|	medcode=="52411"|	medcode=="42127"|	medcode=="42684"|	medcode=="45291"|	medcode=="74890"|	medcode=="50886"|	medcode=="51941"|	medcode=="105037"|	medcode=="103039"|	medcode=="68784"|	medcode=="46176"|	medcode=="101307"|	medcode=="99649"|	medcode=="73663"|	medcode=="101520"|	medcode=="72655"|	medcode=="51675"|	medcode=="41197"|	medcode=="110026"|	medcode=="36606"|	medcode=="71874"|	medcode=="51911"|	medcode=="73554"|	medcode=="101322"|	medcode=="109008"|	medcode=="110047"|	medcode=="106644"|	medcode=="107639"|	medcode=="110418"|	medcode=="107496"|	medcode=="107710"|	medcode=="9384"|	medcode=="25089"|	medcode=="22383"|	medcode=="21966")

ext4refHEART <- rbindlist(list(ext4refHEART1, ext4refHEART2), use.names = TRUE, fill = TRUE)

fwrite(ext4refHEART, paste("P:/Comorbidities/ext4refHEART.csv"))
ext4refHEART <- fread("P:/Comorbidities/ext4refHEART.csv")

#ext4 renal ref
ext4refRENAL<-subset(ext4ref, medcode=="12479"|	medcode=="12585"|	medcode=="95122"|	medcode=="95406"|	medcode=="95508"|	medcode=="95405"|	medcode=="2997"|	medcode=="55151"|	medcode=="11745"|	medcode=="24361"|	medcode=="89924"|	medcode=="96133"|	medcode=="109455"|	medcode=="105787"|	medcode=="70874"|	medcode=="5504"|	medcode=="31549"|	medcode=="20073"|	medcode=="2994"|	medcode=="2996"|	medcode=="71124"|	medcode=="88597"|	medcode=="30756"|	medcode=="64828"|	medcode=="48022"|	medcode=="64636"|	medcode=="56760"|	medcode=="8037"|	medcode=="23773"|	medcode=="104586"|	medcode=="59194"|	medcode=="83513"|	medcode=="30709"|	medcode=="107901"|	medcode=="65089"|	medcode=="102210"|	medcode=="30323"|	medcode=="26054"|	medcode=="26860"|	medcode=="109840"|	medcode=="2999"|	medcode=="9840"|	medcode=="1803"|	medcode=="99644"|	medcode=="29634"|	medcode=="23913"|	medcode=="22852"|	medcode=="19316"|	medcode=="21947"|	medcode=="50472"|	medcode=="21989"|	medcode=="56987"|	medcode=="17365"|	medcode=="63786"|	medcode=="72303"|	medcode=="108591"|	medcode=="110749"|	medcode=="111370"|	medcode=="108816"|	medcode=="47922"|	medcode=="2471"|	medcode=="99201"|	medcode=="58750"|	medcode=="94373"|	medcode=="27427"|	medcode=="65064"|	medcode=="512"|	medcode=="6712"|	medcode=="104963"|	medcode=="105151"|	medcode=="350"|	medcode=="105302"|	medcode=="61814"|	medcode=="71174"|	medcode=="97734"|	medcode=="41285"|	medcode=="58060"|	medcode=="109945"|	medcode=="50200"|	medcode=="62320"|	medcode=="8330"|	medcode=="100205"|	medcode=="61930"|	medcode=="11554"|	medcode=="5911"|	medcode=="53940"|	medcode=="108494")

fwrite(ext4refRENAL, paste("P:/Comorbidities/ext4refRENAL.csv"))
ext4refRENAL <- fread("P:/Comorbidities/ext4refRENAL.csv")

#ext4 liver ref
ext4refLIVER<-subset(ext4ref, medcode=="4405"|	medcode=="32025"|	medcode=="71422"|	medcode=="69194"|	medcode=="105506"|	medcode=="97157"|	medcode=="99250"|	medcode=="27319"|	medcode=="26367"|	medcode=="24813"|	medcode=="41096"|	medcode=="30586"|	medcode=="106642"|	medcode=="32277"|	medcode=="108343"|	medcode=="107896"|	medcode=="110454"|	medcode=="102922"|	medcode=="48211"|	medcode=="6863"|	medcode=="4743"|	medcode=="21713"|	medcode=="17330"|	medcode=="1754"|	medcode=="23578"|	medcode=="9029"|	medcode=="1755"|	medcode=="53480"|	medcode=="66534"|	medcode=="53877"|	medcode=="15489"|	medcode=="16725"|	medcode=="69204"|	medcode=="3450"|	medcode=="44676"|	medcode=="92909"|	medcode=="40567"|	medcode=="27438"|	medcode=="96664"|	medcode=="100253"|	medcode=="73482"|	medcode=="112044"|	medcode=="109540"|	medcode=="48928"|	medcode=="55454"|	medcode=="16455"|	medcode=="9494"|	medcode=="5638"|	medcode=="15424"|	medcode=="91591"|	medcode=="58630"|	medcode=="7602"|	medcode=="42843"|	medcode=="25383"|	medcode=="60104"|	medcode=="100592"|	medcode=="33597"|	medcode=="10539"|	medcode=="5129"|	medcode=="10636"|	medcode=="24901"|	medcode=="48102"|	medcode=="17219"|	medcode=="64750"|	medcode=="39351"|	medcode=="44120"|	medcode=="26405"|	medcode=="18652"|	medcode=="15425"|	medcode=="6015"|	medcode=="25597"|	medcode=="16417"|	medcode=="38389"|	medcode=="48269"|	medcode=="50400"|	medcode=="50444"|	medcode=="40029"|	medcode=="10721"|	medcode=="71422"|	medcode=="4405"|	medcode=="32025"|	medcode=="69194")

fwrite(ext4refLIVER, paste("P:/Comorbidities/ext4refLIVER.csv"))
ext4refLIVER <- fread("P:/Comorbidities/ext4refLIVER.csv")

#ext4 diabetes ref
ext4refDIABETES<-subset(ext4ref, medcode=="711"|	medcode=="43453"|	medcode=="36695"|	medcode=="1549"|	medcode=="47582"|	medcode=="47649"|	medcode=="42831"|	medcode=="47650"|	medcode=="43921"|	medcode=="18683"|	medcode=="69993"|	medcode=="18387"|	medcode=="35288"|	medcode=="40682"|	medcode=="69676"|	medcode=="68105"|	medcode=="46301"|	medcode=="10418"|	medcode=="39070"|	medcode=="49554"|	medcode=="93468"|	medcode=="18642"|	medcode=="54008"|	medcode=="30323"|	medcode=="30294"|	medcode=="10692"|	medcode=="40837"|	medcode=="22871"|	medcode=="55239"|	medcode=="95636"|	medcode=="758"|	medcode=="18777"|	medcode=="47321"|	medcode=="34268"|	medcode=="65267"|	medcode=="49074"|	medcode=="12736"|	medcode=="18496"|	medcode=="25627"|	medcode=="47954"|	medcode=="62674"|	medcode=="18425"|	medcode=="12640"|	medcode=="46917"|	medcode=="44982"|	medcode=="37806"|	medcode=="59253"|	medcode=="35385"|	medcode=="1407"|	medcode=="34450"|	medcode=="26054"|	medcode=="18390"|	medcode=="32627"|	medcode=="51756"|	medcode=="25591"|	medcode=="63690"|	medcode=="95539"|	medcode=="51697"|	medcode=="96506"|	medcode=="61122"|	medcode=="67212"|	medcode=="43857"|	medcode=="22487"|	medcode=="94383"|	medcode=="93380"|	medcode=="52212"|	medcode=="106927"|	medcode=="53200"|	medcode=="42567"|	medcode=="54856"|	medcode=="6791"|	medcode=="31310"|	medcode=="60499"|	medcode=="52104"|	medcode=="52283"|	medcode=="49276"|	medcode=="46963"|	medcode=="6509"|	medcode=="44443"|	medcode=="8403"|	medcode=="40401"|	medcode=="68843"|	medcode=="62146"|	medcode=="55842"|	medcode=="50429"|	medcode=="52303"|	medcode=="17262"|	medcode=="34912")

fwrite(ext4refDIABETES, paste("P:/Comorbidities/ext4refDIABETES.csv"))
ext4refDIABETES <- fread("P:/Comorbidities/ext4refDIABETES.csv")

#ext4 immuno ref
ext4refIMMUNO1<-subset(ext4ref, medcode=="47106"|	medcode=="22307"|	medcode=="34310"|	medcode=="108246"|	medcode=="27514"|	medcode=="1393"|	medcode=="31041"|	medcode=="102966"|	medcode=="59784"|	medcode=="106015"|	medcode=="32133"|	medcode=="23770"|	medcode=="58857"|	medcode=="58859"|	medcode=="69766"|	medcode=="70869"|	medcode=="53636"|	medcode=="70528"|	medcode=="101836"|	medcode=="47632"|	medcode=="111979"|	medcode=="67575"|	medcode=="71450"|	medcode=="62891"|	medcode=="36294"|	medcode=="44303"|	medcode=="37006"|	medcode=="66368"|	medcode=="23951"|	medcode=="27641"|	medcode=="50076"|	medcode=="27853"|	medcode=="44617"|	medcode=="66367"|	medcode=="105324"|	medcode=="65117"|	medcode=="8281"|	medcode=="51708"|	medcode=="62854"|	medcode=="112030"|	medcode=="107807"|	medcode=="112031"|	medcode=="102117"|	medcode=="104134"|	medcode=="112032"|	medcode=="69767"|	medcode=="112034"|	medcode=="112035"|	medcode=="112036"|	medcode=="112037"|	medcode=="96751"|	medcode=="102252"|	medcode=="100769"|	medcode=="65460"|	medcode=="108667"|	medcode=="72224"|	medcode=="93778"|	medcode=="12323"|	medcode=="41369"|	medcode=="1481"|	medcode=="60242"|	medcode=="71031"|	medcode=="70374"|	medcode=="95058"|	medcode=="99240"|	medcode=="27416"|	medcode=="71625"|	medcode=="71238"|	medcode=="62380"|	medcode=="64670"|	medcode=="100352"|	medcode=="103245"|	medcode=="104790"|	medcode=="63723"|	medcode=="21402"|	medcode=="59115"|	medcode=="100006"|	medcode=="97577"|	medcode=="92380"|	medcode=="71304"|	medcode=="99887"|	medcode=="99951"|	medcode=="2462"|	medcode=="65489"|	medcode=="100423"|	medcode=="98840"|	medcode=="44196"|	medcode=="98909"|	medcode=="64036"|	medcode=="68039"|	medcode=="38939"|	medcode=="71142"|	medcode=="68330"|	medcode=="92245"|	medcode=="73532"|	medcode=="93951"|	medcode=="95338"|	medcode=="106911"|	medcode=="104743"|	medcode=="29876"|	medcode=="29178"|	medcode=="57225"|	medcode=="55303"|	medcode=="67506"|	medcode=="61149"|	medcode=="65483"|	medcode=="105472"|	medcode=="19140"|	medcode=="63054"|	medcode=="49605"|	medcode=="97863"|	medcode=="94407"|	medcode=="58684"|	medcode=="108886"|	medcode=="94005"|	medcode=="67703"|	medcode=="95049"|	medcode=="111942"|	medcode=="63625"|	medcode=="110563"|	medcode=="101715"|	medcode=="107032"|	medcode=="101530"|	medcode=="104895"|	medcode=="105841"|	medcode=="108775"|	medcode=="106597"|	medcode=="104484"|	medcode=="53397"|	medcode=="61662"|	medcode=="59778"|	medcode=="59755"|	medcode=="107804"|	medcode=="91900"|	medcode=="99012"|	medcode=="94279"|	medcode=="97746"|	medcode=="42461"|	medcode=="5179"|	medcode=="66327"|	medcode=="45264"|	medcode=="105203"|	medcode=="92068"|	medcode=="111766"|	medcode=="94995"|	medcode=="58082"|	medcode=="65701"|	medcode=="12006"|	medcode=="95949"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="38005"|	medcode=="35014"|	medcode=="100532"|	medcode=="27330"|	medcode=="65122"|	medcode=="65123"|	medcode=="73777"|	medcode=="34926"|	medcode=="102715"|	medcode=="102158"|	medcode=="54083"|	medcode=="47204"|	medcode=="15036"|	medcode=="103900"|	medcode=="100615"|	medcode=="31324"|	medcode=="89657"|	medcode=="3604"|	medcode=="28639"|	medcode=="70842"|	medcode=="49262"|	medcode=="50668"|	medcode=="108182"|	medcode=="50695"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="95715"|	medcode=="101114"|	medcode=="31576"|	medcode=="21549"|	medcode=="70509"|	medcode=="102594"|	medcode=="105966"|	medcode=="105038"|	medcode=="31794"|	medcode=="39798"|	medcode=="104152"|	medcode=="105889"|	medcode=="105095"|	medcode=="107166"|	medcode=="105020"|	medcode=="107973"|	medcode=="106969"|	medcode=="108719"|	medcode=="106063"|	medcode=="105792"|	medcode=="105335"|	medcode=="105559"|	medcode=="105955"|	medcode=="109780"|	medcode=="107949"|	medcode=="105709"|	medcode=="105925"|	medcode=="105375")
ext4refIMMUNO2<-subset(ext4ref, medcode=="105636"|	medcode=="105286"|	medcode=="104934"|	medcode=="106884"|	medcode=="104386"|	medcode=="104620"|	medcode=="104412"|	medcode=="111682"|	medcode=="17887"|	medcode=="90201"|	medcode=="57737"|	medcode=="12464"|	medcode=="44318"|	medcode=="12335"|	medcode=="57427"|	medcode=="50696"|	medcode=="72725"|	medcode=="42579"|	medcode=="34089"|	medcode=="63105"|	medcode=="71262"|	medcode=="60092"|	medcode=="15504"|	medcode=="15027"|	medcode=="65434"|	medcode=="37182"|	medcode=="4944"|	medcode=="22158"|	medcode=="19028"|	medcode=="21329"|	medcode=="46042"|	medcode=="104418"|	medcode=="39187"|	medcode=="64567"|	medcode=="43450"|	medcode=="19372"|	medcode=="4251"|	medcode=="104325"|	medcode=="8625"|	medcode=="104328"|	medcode=="107052"|	medcode=="106924"|	medcode=="107163"|	medcode=="72774"|	medcode=="49725"|	medcode=="31586"|	medcode=="37461"|	medcode=="108656"|	medcode=="107643"|	medcode=="104939"|	medcode=="38331"|	medcode=="38914"|	medcode=="7176"|	medcode=="4413"|	medcode=="10726"|	medcode=="100786"|	medcode=="105957"|	medcode=="102783"|	medcode=="107236"|	medcode=="27520"|	medcode=="63475"|	medcode=="70724"|	medcode=="52327"|	medcode=="39629"|	medcode=="104788"|	medcode=="112440"|	medcode=="27664"|	medcode=="66089"|	medcode=="33344"|	medcode=="35875"|	medcode=="19974"|	medcode=="27458"|	medcode=="101606"|	medcode=="108424"|	medcode=="99015"|	medcode=="103645"|	medcode=="93342"|	medcode=="37272"|	medcode=="42539"|	medcode=="37468"|	medcode=="57671"|	medcode=="65721"|	medcode=="50858"|	medcode=="28276"|	medcode=="110838"|	medcode=="104273"|	medcode=="94174"|	medcode=="72197"|	medcode=="99413"|	medcode=="30632"|	medcode=="25191"|	medcode=="4072"|	medcode=="16416"|	medcode=="54793"|	medcode=="34692"|	medcode=="4250"|	medcode=="20440"|	medcode=="61500"|	medcode=="22050"|	medcode=="104475"|	medcode=="105069"|	medcode=="30646"|	medcode=="6115"|	medcode=="39336"|	medcode=="49301"|	medcode=="25493"|	medcode=="2481"|	medcode=="11950"|	medcode=="106993"|	medcode=="104740"|	medcode=="105915"|	medcode=="45285"|	medcode=="46444"|	medcode=="70935"|	medcode=="40740"|	medcode=="43415"|	medcode=="67518"|	medcode=="98596"|	medcode=="64336"|	medcode=="102688"|	medcode=="67029"|	medcode=="61693"|	medcode=="89762"|	medcode=="89329"|	medcode=="65165"|	medcode=="105025"|	medcode=="72500"|	medcode=="64515"|	medcode=="109714"|	medcode=="63375"|	medcode=="8649"|	medcode=="45143"|	medcode=="69545"|	medcode=="15883"|	medcode=="106381"|	medcode=="3451"|	medcode=="12306"|	medcode=="12386"|	medcode=="16527"|	medcode=="10411"|	medcode=="101350"|	medcode=="99067"|	medcode=="108102"|	medcode=="71994"|	medcode=="18486"|	medcode=="51041"|	medcode=="27934"|	medcode=="104554"|	medcode=="110183"|	medcode=="44147"|	medcode=="15137"|	medcode=="8548"|	medcode=="18701"|	medcode=="18700"|	medcode=="68440"|	medcode=="57161"|	medcode=="69373"|	medcode=="57322"|	medcode=="92569"|	medcode=="62598"|	medcode=="69184"|	medcode=="60026"|	medcode=="69854"|	medcode=="16295"|	medcode=="48307"|	medcode=="50665"|	medcode=="31322"|	medcode=="62236"|	medcode=="48293"|	medcode=="31541"|	medcode=="66073"|	medcode=="49542"|	medcode=="50526"|	medcode=="103977"|	medcode=="62328"|	medcode=="3129"|	medcode=="65617"|	medcode=="56108"|	medcode=="54203"|	medcode=="21975"|	medcode=="93892"|	medcode=="66857"|	medcode=="36408"|	medcode=="109671"|	medcode=="54904"|	medcode=="63204"|	medcode=="32141"|	medcode=="91911"|	medcode=="66049"|	medcode=="40950"|	medcode=="18781"| medcode=="38306"|	medcode=="39034"|	medcode=="34150"|	medcode=="5572"|	medcode=="2337"|	medcode=="41185"|	medcode=="73583"|	medcode=="12699"|	medcode=="5655"|	medcode=="66740"|	medcode=="27515"|	medcode=="51640"|	medcode=="32270"|	medcode=="57551"|	medcode=="95005"|	medcode=="39420"|	medcode=="61069"|	medcode=="56973"|	medcode=="47695"|	medcode=="65825")
ext4refIMMUNO3<-subset(ext4ref, medcode=="63323"|	medcode=="53317"|	medcode=="20261"|	medcode=="11346"|	medcode=="100043"|	medcode=="52604"|	medcode=="57525"|	medcode=="40406"|	medcode=="70236"|	medcode=="62041"|	medcode=="22319"|	medcode=="101375"|	medcode=="101075"|	medcode=="4072"|	medcode=="4251"|	medcode=="19974"|	medcode=="4413"|	medcode=="50858"|	medcode=="27664"|	medcode=="37461"|	medcode=="52327"|	medcode=="100786"|	medcode=="16416"|	medcode=="8625"|	medcode=="27458"|	medcode=="10726"|	medcode=="27520"|	medcode=="22050"|	medcode=="102783"|	medcode=="50668"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="21549"|	medcode=="70842"|	medcode=="99067"|	medcode=="39629"|	medcode=="27330"|	medcode=="53397"|	medcode=="107804"|	medcode=="59755"|	medcode=="91900"|	medcode=="59778"|	medcode=="99012"|	medcode=="97746"|	medcode=="94279"|	medcode=="61662"|	medcode=="67703"|	medcode=="101530"|	medcode=="63625"|	medcode=="111942"|	medcode=="110563"|	medcode=="107032"|	medcode=="101715"|	medcode=="73532"|	medcode=="95338"|	medcode=="92245"|	medcode=="68330"|	medcode=="93951"|	medcode=="104743"|	medcode=="71142"|	medcode=="49605"|	medcode=="94005"|	medcode=="58684"|	medcode=="94407"|	medcode=="108886"|	medcode=="97863"|	medcode=="29178"|	medcode=="63054"|	medcode=="61149"|	medcode=="67506"|	medcode=="65483"|	medcode=="55303"|	medcode=="19140"|	medcode=="105472"|	medcode=="57225"|	medcode=="95049"|	medcode=="64036"|	medcode=="68039"|	medcode=="29876"|	medcode=="106911"|	medcode=="43450"|	medcode=="34926"|	medcode=="47204"|	medcode=="102158"|	medcode=="54083"|	medcode=="102715"|	medcode=="4250"|	medcode=="25191"|	medcode=="73777"|	medcode=="65123"|	medcode=="65122"|	medcode=="38939"|	medcode=="19372"|	medcode=="38914"|	medcode=="72197"|	medcode=="16527"|	medcode=="71994"|	medcode=="50695"|	medcode=="108182"|	medcode=="12335"|	medcode=="42579"|	medcode=="71262"|	medcode=="72725"|	medcode=="34089"|	medcode=="50696"|	medcode=="63105"|	medcode=="15504"|	medcode=="60092"|	medcode=="57427"|	medcode=="17887"|	medcode=="89657"|	medcode=="15036"|	medcode=="49301"|	medcode=="30646"|	medcode=="65434"|	medcode=="22158"|	medcode=="65721"|	medcode=="100615"|	medcode=="31324"|	medcode=="103900"|	medcode=="57671"|	medcode=="15883"|	medcode=="35875"|	medcode=="93342"|	medcode=="37182"|	medcode=="12006"|	medcode=="38005"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="95949"|	medcode=="7176"|	medcode=="33344"|	medcode=="70724"|	medcode=="4944"|	medcode=="20440"|	medcode=="25493"|	medcode=="65701"|	medcode=="92068"|	medcode=="105203"|	medcode=="111766"|	medcode=="45264"|	medcode=="94995"|	medcode=="58082"|	medcode=="66327"|	medcode=="3604"|	medcode=="94174"|	medcode=="99413"|	medcode=="64567"|	medcode=="34692"|	medcode=="49725"|	medcode=="38331"|	medcode=="99015"|	medcode=="103645"|	medcode=="112440"|	medcode=="66089"|	medcode=="3451"|	medcode=="37272"|	medcode=="30632"|	medcode=="31576"|	medcode=="12386"|	medcode=="2481"|	medcode=="31586"|	medcode=="35014"|	medcode=="100532"|	medcode=="54793"|	medcode=="72774"|	medcode=="101606"|	medcode=="63475"|	medcode=="104475"|	medcode=="10411"|	medcode=="5019"|	medcode=="102559"|	medcode=="59610"|	medcode=="105256"|	medcode=="31489"|	medcode=="10505")

ext4refIMMUNO <- rbindlist(list(ext4refIMMUNO1, ext4refIMMUNO2, ext4refIMMUNO3), use.names = TRUE, fill = TRUE)

fwrite(ext4refIMMUNO, paste("P:/Comorbidities/ext4refIMMUNO.csv"))
ext4refIMMUNO <- fread("P:/Comorbidities/ext4refIMMUNO.csv")

#ext4 csf and cochlear ref
ext4refCSF<-subset(ext4ref, medcode=="30525"|	medcode=="43643"|	medcode=="42441"|	medcode=="36513"|	medcode=="20641"|	medcode=="26158"|	medcode=="40348"|	medcode=="20488"|	medcode=="27295"|	medcode=="35762"|	medcode=="16172"|	medcode=="9300"|	medcode=="17957"|	medcode=="36424"|	medcode=="97074"|	medcode=="55931"|	medcode=="33396"|	medcode=="48851"|	medcode=="71772"|	medcode=="41393"|	medcode=="54342"|	medcode=="10708"|	medcode=="61980"|	medcode=="98472"|	medcode=="57642"|	medcode=="74897")

fwrite(ext4refCSF, paste("P:/Comorbidities/ext4refCSF.csv"))
ext4refCSF <- fread("P:/Comorbidities/ext4refCSF.csv")

#bind all
ext4refALL <- rbindlist(list(ext4refRESP, ext4refHEART, ext4refRENAL, ext4refLIVER, ext4refDIABETES, ext4refIMMUNO, ext4refCSF), use.names = TRUE, fill = TRUE)

fwrite(ext4refALL, paste("P:/Comorbidities/ext4refALL.csv"))
ext4refALL <- fread("P:/Comorbidities/ext4refALL.csv")

#ext5 ref resp
ext5refRESP<-subset(ext5ref, medcode=="10461"|	medcode=="96578"|	medcode=="93713"|	medcode=="73743"|	medcode=="38011"|	medcode=="15693"|	medcode=="65117"|	medcode=="100742"|	medcode=="33980"|	medcode=="58841"|	medcode=="93380"|	medcode=="29966"|	medcode=="6220"|	medcode=="65344"|	medcode=="69017"|	medcode=="18914"|	medcode=="18905"|	medcode=="100610"|	medcode=="103224"|	medcode=="110454"|	medcode=="102922"|	medcode=="106432"|	medcode=="73065"|	medcode=="49770"|	medcode=="1001"|	medcode=="148"|	medcode=="152"|	medcode=="3480"|	medcode=="3243"|	medcode=="25603"|	medcode=="15626"|	medcode=="61118"|	medcode=="11150"|	medcode=="40159"|	medcode=="37959"|	medcode=="61513"|	medcode=="27819"|	medcode=="5798"|	medcode=="14798"|	medcode=="1446"|	medcode=="26125"|	medcode=="44525"|	medcode=="24248"|	medcode=="66043"|	medcode=="45089"|	medcode=="68066"|	medcode=="15157"|	medcode=="794"|	medcode=="26306"|	medcode=="56860"|	medcode=="68662"|	medcode=="60188"|	medcode=="99536"|	medcode=="23492"|	medcode=="46578"|	medcode=="10980"|	medcode=="40788"|	medcode=="92955"|	medcode=="70787"|	medcode=="63479"|	medcode=="16410"|	medcode=="33450"|	medcode=="106805"|	medcode=="2195"|	medcode=="20364"|	medcode=="41491"|	medcode=="32679"|	medcode=="10863"|	medcode=="10802"|	medcode=="9876"|	medcode=="93568"|	medcode=="104608"|	medcode=="12166"|	medcode=="21061"|	medcode=="7884"|	medcode=="5710"|	medcode=="19492"|	medcode=="8303"|	medcode=="51410"|	medcode=="46460"|	medcode=="60805"|	medcode=="62233"|	medcode=="71853"|	medcode=="89206"|	medcode=="23446"|	medcode=="65376"|	medcode=="94894"|	medcode=="49194"|	medcode=="94575"|	medcode=="30235"|	medcode=="93577"|	medcode=="23461"|	medcode=="37365"|	medcode=="26442"|	medcode=="31423"|	medcode=="63172"|	medcode=="54830"|	medcode=="49025"|	medcode=="55758"|	medcode=="62227"|	medcode=="47142"|	medcode=="64721"|	medcode=="63216"|	medcode=="47782"|	medcode=="70815"|	medcode=="104557"|	medcode=="9711"|	medcode=="3847"|	medcode=="41781"|	medcode=="59083"|	medcode=="66104"|	medcode=="45948"|	medcode=="33837"|	medcode=="56647"|	medcode=="41015"|	medcode=="66773"|	medcode=="50876"|	medcode=="47504"|	medcode=="54252"|	medcode=="46066"|	medcode=="43285"|	medcode=="18130"|	medcode=="69914"|	medcode=="22536"|	medcode=="50374"|	medcode=="44015"|	medcode=="53205"|	medcode=="43417"|	medcode=="30214"|	medcode=="38297"|	medcode=="46405"|	medcode=="26082"|	medcode=="7321"|	medcode=="61229"|	medcode=="7791"|	medcode=="31806"|	medcode=="61119"|	medcode=="27348"|	medcode=="68814"|	medcode=="6837"|	medcode=="94136"|	medcode=="6051"|	medcode=="103472"|	medcode=="103559"|	medcode=="28229"|	medcode=="22835"|	medcode=="54308"|	medcode=="61991"|	medcode=="33830"|	medcode=="15815"|	medcode=="64799"|	medcode=="94996"|	medcode=="58791"|	medcode=="54010"|	medcode=="42940"|	medcode=="3859"|	medcode=="47364"|	medcode=="31564"|	medcode=="96655"|	medcode=="63912"|	medcode=="22905"|	medcode=="54893"|	medcode=="22915"|	medcode=="31319"|	medcode=="106650"|	medcode=="20269"|	medcode=="558"|	medcode=="39706"|	medcode=="5293"|	medcode=="65000"|	medcode=="93880"|	medcode=="72221"|	medcode=="96754"|	medcode=="24848"|	medcode=="24466"|	medcode=="99158"|	medcode=="8317"|	medcode=="103785"|	medcode=="109815"|	medcode=="104915"|	medcode=="24814"|	medcode=="94946"|	medcode=="94486"|	medcode=="59188"|	medcode=="66058"|	medcode=="65733"|	medcode=="105939"|	medcode=="106515"|	medcode=="99232"|	medcode=="105628"|	medcode=="54706"|	medcode=="65060"|	medcode=="91912"|	medcode=="71906"|	medcode=="56427"|	medcode=="38298"|	medcode=="94925"|	medcode=="6883"|	medcode=="93098"|	medcode=="13563")

fwrite(ext5refRESP, paste("P:/Comorbidities/ext5refRESP.csv"))
ext5refRESP <- fread("P:/Comorbidities/ext5refRESP.csv")

#ext5 heart ref
ext5refHEART1<-subset(ext5ref, medcode=="11284"|	medcode=="19066"|	medcode=="51214"|	medcode=="250"|	medcode=="53626"|	medcode=="61073"|	medcode=="4438"|	medcode=="242"|	medcode=="72939"|	medcode=="58529"|	medcode=="107416"|	medcode=="70105"|	medcode=="93844"|	medcode=="69734"|	medcode=="41495"|	medcode=="22262"|	medcode=="16292"|	medcode=="50157"|	medcode=="95334"|	medcode=="72668"|	medcode=="103046"|	medcode=="52427"|	medcode=="61660"|	medcode=="52127"|	medcode=="105938"|	medcode=="31464"|	medcode=="61166"|	medcode=="62718"|	medcode=="16173"|	medcode=="240"|	medcode=="241"|	medcode=="12139"|	medcode=="5387"|	medcode=="40429"|	medcode=="17872"|	medcode=="14897"|	medcode=="8935"|	medcode=="29643"|	medcode=="23892"|	medcode=="14898"|	medcode=="63467"|	medcode=="3704"|	medcode=="9507"|	medcode=="10562"|	medcode=="1678"|	medcode=="30330"|	medcode=="32854"|	medcode=="29758"|	medcode=="12229"|	medcode=="34803"|	medcode=="28736"|	medcode=="62626"|	medcode=="41221"|	medcode=="46017"|	medcode=="14658"|	medcode=="27951"|	medcode=="36523"|	medcode=="61072"|	medcode=="7347"|	medcode=="17307"|	medcode=="34328"|	medcode=="18118"|	medcode=="11983"|	medcode=="54251"|	medcode=="39449"|	medcode=="9413"|	medcode=="9276"|	medcode=="68357"|	medcode=="39693"|	medcode=="21844"|	medcode=="27977"|	medcode=="4017"|	medcode=="1430"|	medcode=="20095"|	medcode=="18125"|	medcode=="29902"|	medcode=="25842"|	medcode=="66388"|	medcode=="54535"|	medcode=="7696"|	medcode=="1414"|	medcode=="32450"|	medcode=="9555"|	medcode=="26863"|	medcode=="12804"|	medcode=="28554"|	medcode=="28138"|	medcode=="5413"|	medcode=="3999"|	medcode=="5254"|	medcode=="36609"|	medcode=="7320"|	medcode=="29421"|	medcode=="34633"|	medcode=="24540"|	medcode=="23078"|	medcode=="35713"|	medcode=="15754"|	medcode=="18889"|	medcode=="18842"|	medcode=="45809"|	medcode=="38609"|	medcode=="72562"|	medcode=="46166"|	medcode=="32272"|	medcode=="46112"|	medcode=="46276"|	medcode=="106812"|	medcode=="41835"|	medcode=="68748"|	medcode=="105479"|	medcode=="1676"|	medcode=="2062"|	medcode=="398"|	medcode=="23707"|	medcode=="32671"|	medcode=="27884"|	medcode=="11424"|	medcode=="94870"|	medcode=="884"|	medcode=="5255"|	medcode=="27964"|	medcode=="101138"|	medcode=="104275"|	medcode=="4024"|	medcode=="8966"|	medcode=="107397"|	medcode=="52517"|	medcode=="39546"|	medcode=="68401"|	medcode=="47637"|	medcode=="96838"|	medcode=="109035"|	medcode=="99991"|	medcode=="31518"|	medcode=="4964"|	medcode=="72604"|	medcode=="45505"|	medcode=="66245"|	medcode=="94344"|	medcode=="2816"|	medcode=="69858"|	medcode=="1778"|	medcode=="23988"|	medcode=="102980"|	medcode=="40025"|	medcode=="65318"|	medcode=="63390"|	medcode=="62169"|	medcode=="73539"|	medcode=="4864"|	medcode=="38967"|	medcode=="51649"|	medcode=="63046"|	medcode=="19969"|	medcode=="246"|	medcode=="42132"|	medcode=="56575"|	medcode=="67657"|	medcode=="9011"|	medcode=="51897"|	medcode=="20153"|	medcode=="54772"|	medcode=="34067"|	medcode=="7474"|	medcode=="3255"|	medcode=="3625"|	medcode=="37816"|	medcode=="59144"|	medcode=="53088"|	medcode=="54243"|	medcode=="63340"|	medcode=="51053"|	medcode=="101393"|	medcode=="49702"|	medcode=="55535"|	medcode=="43049"|	medcode=="44896"|	medcode=="73816"|	medcode=="46117"|	medcode=="9361"|	medcode=="48205"|	medcode=="66401"|	medcode=="54196"|	medcode=="5621"|	medcode=="39992"|	medcode=="69940"|	medcode=="3862"|	medcode=="54488"|	medcode=="93561"|	medcode=="22778"|	medcode=="112420"|	medcode=="45452"|	medcode=="33919"|	medcode=="21851"|	medcode=="44478"|	medcode=="107150"|	medcode=="52607"|	medcode=="70880"|	medcode=="12752"|	medcode=="21272"|	medcode=="69169"|	medcode=="100065"|	medcode=="23709"|	medcode=="6886"|	medcode=="8636"|	medcode=="58734"|	medcode=="3300"|	medcode=="6843"|	medcode=="57091"|	medcode=="90551"|	medcode=="73592"|	medcode=="63069")
ext5refHEART2<-subset(ext5ref, medcode=="100291"|	medcode=="61651"|	medcode=="20772"|	medcode=="89256"|	medcode=="108457"|	medcode=="46825"|	medcode=="50529"|	medcode=="24789"|	medcode=="16539"|	medcode=="34668"|	medcode=="9401"|	medcode=="99128"|	medcode=="32748"|	medcode=="104266"|	medcode=="97818"|	medcode=="25481"|	medcode=="71956"|	medcode=="62163"|	medcode=="103894"|	medcode=="31373"|	medcode=="49901"|	medcode=="103412"|	medcode=="53546"|	medcode=="24533"|	medcode=="68097"|	medcode=="52310"|	medcode=="102167"|	medcode=="70992"|	medcode=="71678"|	medcode=="3774"|	medcode=="72259"|	medcode=="72405"|	medcode=="50284"|	medcode=="103584"|	medcode=="92426"|	medcode=="52615"|	medcode=="98061"|	medcode=="24854"|	medcode=="93089"|	medcode=="68063"|	medcode=="34007"|	medcode=="49133"|	medcode=="50362"|	medcode=="68894"|	medcode=="108193"|	medcode=="37451"|	medcode=="23752"|	medcode=="95785"|	medcode=="111360"|	medcode=="98317"|	medcode=="24714"|	medcode=="247"|	medcode=="26626"|	medcode=="109236"|	medcode=="103432"|	medcode=="64778"|	medcode=="38968"|	medcode=="3863"|	medcode=="11982"|	medcode=="3301"|	medcode=="57932"|	medcode=="72295"|	medcode=="70853"|	medcode=="37323"|	medcode=="59907"|	medcode=="50220"|	medcode=="62230"|	medcode=="30725"|	medcode=="67286"|	medcode=="30949"|	medcode=="46530"|	medcode=="49731"|	medcode=="44334"|	medcode=="90486"|	medcode=="70691"|	medcode=="34176"|	medcode=="68198"|	medcode=="59298"|	medcode=="37515"|	medcode=="63768"|	medcode=="53964"|	medcode=="62376"|	medcode=="58076"|	medcode=="44781"|	medcode=="49474"|	medcode=="56200"|	medcode=="11945"|	medcode=="11127"|	medcode=="63187"|	medcode=="67928"|	medcode=="31112"|	medcode=="18982"|	medcode=="54487"|	medcode=="2670"|	medcode=="96225"|	medcode=="65029"|	medcode=="32508"|	medcode=="52411"|	medcode=="42127"|	medcode=="42684"|	medcode=="45291"|	medcode=="74890"|	medcode=="50886"|	medcode=="51941"|	medcode=="105037"|	medcode=="103039"|	medcode=="68784"|	medcode=="46176"|	medcode=="101307"|	medcode=="99649"|	medcode=="73663"|	medcode=="101520"|	medcode=="72655"|	medcode=="51675"|	medcode=="41197"|	medcode=="110026"|	medcode=="36606"|	medcode=="71874"|	medcode=="51911"|	medcode=="73554"|	medcode=="101322"|	medcode=="109008"|	medcode=="110047"|	medcode=="106644"|	medcode=="107639"|	medcode=="110418"|	medcode=="107496"|	medcode=="107710"|	medcode=="9384"|	medcode=="25089"|	medcode=="22383"|	medcode=="21966")

ext5refHEART <- rbindlist(list(ext5refHEART1, ext5refHEART2), use.names = TRUE, fill = TRUE)

fwrite(ext5refHEART, paste("P:/Comorbidities/ext5refHEART.csv"))
ext5refHEART <- fread("P:/Comorbidities/ext5refHEART.csv")

#ext5 renal ref
ext5refRENAL<-subset(ext5ref, medcode=="12479"|	medcode=="12585"|	medcode=="95122"|	medcode=="95406"|	medcode=="95508"|	medcode=="95405"|	medcode=="2997"|	medcode=="55151"|	medcode=="11745"|	medcode=="24361"|	medcode=="89924"|	medcode=="96133"|	medcode=="109455"|	medcode=="105787"|	medcode=="70874"|	medcode=="5504"|	medcode=="31549"|	medcode=="20073"|	medcode=="2994"|	medcode=="2996"|	medcode=="71124"|	medcode=="88597"|	medcode=="30756"|	medcode=="64828"|	medcode=="48022"|	medcode=="64636"|	medcode=="56760"|	medcode=="8037"|	medcode=="23773"|	medcode=="104586"|	medcode=="59194"|	medcode=="83513"|	medcode=="30709"|	medcode=="107901"|	medcode=="65089"|	medcode=="102210"|	medcode=="30323"|	medcode=="26054"|	medcode=="26860"|	medcode=="109840"|	medcode=="2999"|	medcode=="9840"|	medcode=="1803"|	medcode=="99644"|	medcode=="29634"|	medcode=="23913"|	medcode=="22852"|	medcode=="19316"|	medcode=="21947"|	medcode=="50472"|	medcode=="21989"|	medcode=="56987"|	medcode=="17365"|	medcode=="63786"|	medcode=="72303"|	medcode=="108591"|	medcode=="110749"|	medcode=="111370"|	medcode=="108816"|	medcode=="47922"|	medcode=="2471"|	medcode=="99201"|	medcode=="58750"|	medcode=="94373"|	medcode=="27427"|	medcode=="65064"|	medcode=="512"|	medcode=="6712"|	medcode=="104963"|	medcode=="105151"|	medcode=="350"|	medcode=="105302"|	medcode=="61814"|	medcode=="71174"|	medcode=="97734"|	medcode=="41285"|	medcode=="58060"|	medcode=="109945"|	medcode=="50200"|	medcode=="62320"|	medcode=="8330"|	medcode=="100205"|	medcode=="61930"|	medcode=="11554"|	medcode=="5911"|	medcode=="53940"|	medcode=="108494")

fwrite(ext5refRENAL, paste("P:/Comorbidities/ext5refRENAL.csv"))
ext5refRENAL <- fread("P:/Comorbidities/ext5refRENAL.csv")

#ext5 liver ref
ext5refLIVER<-subset(ext5ref, medcode=="4405"|	medcode=="32025"|	medcode=="71422"|	medcode=="69194"|	medcode=="105506"|	medcode=="97157"|	medcode=="99250"|	medcode=="27319"|	medcode=="26367"|	medcode=="24813"|	medcode=="41096"|	medcode=="30586"|	medcode=="106642"|	medcode=="32277"|	medcode=="108343"|	medcode=="107896"|	medcode=="110454"|	medcode=="102922"|	medcode=="48211"|	medcode=="6863"|	medcode=="4743"|	medcode=="21713"|	medcode=="17330"|	medcode=="1754"|	medcode=="23578"|	medcode=="9029"|	medcode=="1755"|	medcode=="53480"|	medcode=="66534"|	medcode=="53877"|	medcode=="15489"|	medcode=="16725"|	medcode=="69204"|	medcode=="3450"|	medcode=="44676"|	medcode=="92909"|	medcode=="40567"|	medcode=="27438"|	medcode=="96664"|	medcode=="100253"|	medcode=="73482"|	medcode=="112044"|	medcode=="109540"|	medcode=="48928"|	medcode=="55454"|	medcode=="16455"|	medcode=="9494"|	medcode=="5638"|	medcode=="15424"|	medcode=="91591"|	medcode=="58630"|	medcode=="7602"|	medcode=="42843"|	medcode=="25383"|	medcode=="60104"|	medcode=="100592"|	medcode=="33597"|	medcode=="10539"|	medcode=="5129"|	medcode=="10636"|	medcode=="24901"|	medcode=="48102"|	medcode=="17219"|	medcode=="64750"|	medcode=="39351"|	medcode=="44120"|	medcode=="26405"|	medcode=="18652"|	medcode=="15425"|	medcode=="6015"|	medcode=="25597"|	medcode=="16417"|	medcode=="38389"|	medcode=="48269"|	medcode=="50400"|	medcode=="50444"|	medcode=="40029"|	medcode=="10721"|	medcode=="71422"|	medcode=="4405"|	medcode=="32025"|	medcode=="69194")

fwrite(ext5refLIVER, paste("P:/Comorbidities/ext5refLIVER.csv"))
ext5refLIVER <- fread("P:/Comorbidities/ext5refLIVER.csv")


#ext5 diabetes ref
ext5refDIABETES<-subset(ext5ref, medcode=="711"|	medcode=="43453"|	medcode=="36695"|	medcode=="1549"|	medcode=="47582"|	medcode=="47649"|	medcode=="42831"|	medcode=="47650"|	medcode=="43921"|	medcode=="18683"|	medcode=="69993"|	medcode=="18387"|	medcode=="35288"|	medcode=="40682"|	medcode=="69676"|	medcode=="68105"|	medcode=="46301"|	medcode=="10418"|	medcode=="39070"|	medcode=="49554"|	medcode=="93468"|	medcode=="18642"|	medcode=="54008"|	medcode=="30323"|	medcode=="30294"|	medcode=="10692"|	medcode=="40837"|	medcode=="22871"|	medcode=="55239"|	medcode=="95636"|	medcode=="758"|	medcode=="18777"|	medcode=="47321"|	medcode=="34268"|	medcode=="65267"|	medcode=="49074"|	medcode=="12736"|	medcode=="18496"|	medcode=="25627"|	medcode=="47954"|	medcode=="62674"|	medcode=="18425"|	medcode=="12640"|	medcode=="46917"|	medcode=="44982"|	medcode=="37806"|	medcode=="59253"|	medcode=="35385"|	medcode=="1407"|	medcode=="34450"|	medcode=="26054"|	medcode=="18390"|	medcode=="32627"|	medcode=="51756"|	medcode=="25591"|	medcode=="63690"|	medcode=="95539"|	medcode=="51697"|	medcode=="96506"|	medcode=="61122"|	medcode=="67212"|	medcode=="43857"|	medcode=="22487"|	medcode=="94383"|	medcode=="93380"|	medcode=="52212"|	medcode=="106927"|	medcode=="53200"|	medcode=="42567"|	medcode=="54856"|	medcode=="6791"|	medcode=="31310"|	medcode=="60499"|	medcode=="52104"|	medcode=="52283"|	medcode=="49276"|	medcode=="46963"|	medcode=="6509"|	medcode=="44443"|	medcode=="8403"|	medcode=="40401"|	medcode=="68843"|	medcode=="62146"|	medcode=="55842"|	medcode=="50429"|	medcode=="52303"|	medcode=="17262"|	medcode=="34912")

fwrite(ext5refDIABETES, paste("P:/Comorbidities/ext5refDIABETES.csv"))
ext5refDIABETES <- fread("P:/Comorbidities/ext5refDIABETES.csv")


#ext5 immuno ref
ext5refIMMUNO1<-subset(ext5ref, medcode=="47106"|	medcode=="22307"|	medcode=="34310"|	medcode=="108246"|	medcode=="27514"|	medcode=="1393"|	medcode=="31041"|	medcode=="102966"|	medcode=="59784"|	medcode=="106015"|	medcode=="32133"|	medcode=="23770"|	medcode=="58857"|	medcode=="58859"|	medcode=="69766"|	medcode=="70869"|	medcode=="53636"|	medcode=="70528"|	medcode=="101836"|	medcode=="47632"|	medcode=="111979"|	medcode=="67575"|	medcode=="71450"|	medcode=="62891"|	medcode=="36294"|	medcode=="44303"|	medcode=="37006"|	medcode=="66368"|	medcode=="23951"|	medcode=="27641"|	medcode=="50076"|	medcode=="27853"|	medcode=="44617"|	medcode=="66367"|	medcode=="105324"|	medcode=="65117"|	medcode=="8281"|	medcode=="51708"|	medcode=="62854"|	medcode=="112030"|	medcode=="107807"|	medcode=="112031"|	medcode=="102117"|	medcode=="104134"|	medcode=="112032"|	medcode=="69767"|	medcode=="112034"|	medcode=="112035"|	medcode=="112036"|	medcode=="112037"|	medcode=="96751"|	medcode=="102252"|	medcode=="100769"|	medcode=="65460"|	medcode=="108667"|	medcode=="72224"|	medcode=="93778"|	medcode=="12323"|	medcode=="41369"|	medcode=="1481"|	medcode=="60242"|	medcode=="71031"|	medcode=="70374"|	medcode=="95058"|	medcode=="99240"|	medcode=="27416"|	medcode=="71625"|	medcode=="71238"|	medcode=="62380"|	medcode=="64670"|	medcode=="100352"|	medcode=="103245"|	medcode=="104790"|	medcode=="63723"|	medcode=="21402"|	medcode=="59115"|	medcode=="100006"|	medcode=="97577"|	medcode=="92380"|	medcode=="71304"|	medcode=="99887"|	medcode=="99951"|	medcode=="2462"|	medcode=="65489"|	medcode=="100423"|	medcode=="98840"|	medcode=="44196"|	medcode=="98909"|	medcode=="64036"|	medcode=="68039"|	medcode=="38939"|	medcode=="71142"|	medcode=="68330"|	medcode=="92245"|	medcode=="73532"|	medcode=="93951"|	medcode=="95338"|	medcode=="106911"|	medcode=="104743"|	medcode=="29876"|	medcode=="29178"|	medcode=="57225"|	medcode=="55303"|	medcode=="67506"|	medcode=="61149"|	medcode=="65483"|	medcode=="105472"|	medcode=="19140"|	medcode=="63054"|	medcode=="49605"|	medcode=="97863"|	medcode=="94407"|	medcode=="58684"|	medcode=="108886"|	medcode=="94005"|	medcode=="67703"|	medcode=="95049"|	medcode=="111942"|	medcode=="63625"|	medcode=="110563"|	medcode=="101715"|	medcode=="107032"|	medcode=="101530"|	medcode=="104895"|	medcode=="105841"|	medcode=="108775"|	medcode=="106597"|	medcode=="104484"|	medcode=="53397"|	medcode=="61662"|	medcode=="59778"|	medcode=="59755"|	medcode=="107804"|	medcode=="91900"|	medcode=="99012"|	medcode=="94279"|	medcode=="97746"|	medcode=="42461"|	medcode=="5179"|	medcode=="66327"|	medcode=="45264"|	medcode=="105203"|	medcode=="92068"|	medcode=="111766"|	medcode=="94995"|	medcode=="58082"|	medcode=="65701"|	medcode=="12006"|	medcode=="95949"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="38005"|	medcode=="35014"|	medcode=="100532"|	medcode=="27330"|	medcode=="65122"|	medcode=="65123"|	medcode=="73777"|	medcode=="34926"|	medcode=="102715"|	medcode=="102158"|	medcode=="54083"|	medcode=="47204"|	medcode=="15036"|	medcode=="103900"|	medcode=="100615"|	medcode=="31324"|	medcode=="89657"|	medcode=="3604"|	medcode=="28639"|	medcode=="70842"|	medcode=="49262"|	medcode=="50668"|	medcode=="108182"|	medcode=="50695"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="95715"|	medcode=="101114"|	medcode=="31576"|	medcode=="21549"|	medcode=="70509"|	medcode=="102594"|	medcode=="105966"|	medcode=="105038"|	medcode=="31794"|	medcode=="39798"|	medcode=="104152"|	medcode=="105889"|	medcode=="105095"|	medcode=="107166"|	medcode=="105020"|	medcode=="107973"|	medcode=="106969"|	medcode=="108719"|	medcode=="106063"|	medcode=="105792"|	medcode=="105335"|	medcode=="105559"|	medcode=="105955"|	medcode=="109780"|	medcode=="107949"|	medcode=="105709"|	medcode=="105925"|	medcode=="105375")
ext5refIMMUNO2<-subset(ext5ref, medcode=="105636"|	medcode=="105286"|	medcode=="104934"|	medcode=="106884"|	medcode=="104386"|	medcode=="104620"|	medcode=="104412"|	medcode=="111682"|	medcode=="17887"|	medcode=="90201"|	medcode=="57737"|	medcode=="12464"|	medcode=="44318"|	medcode=="12335"|	medcode=="57427"|	medcode=="50696"|	medcode=="72725"|	medcode=="42579"|	medcode=="34089"|	medcode=="63105"|	medcode=="71262"|	medcode=="60092"|	medcode=="15504"|	medcode=="15027"|	medcode=="65434"|	medcode=="37182"|	medcode=="4944"|	medcode=="22158"|	medcode=="19028"|	medcode=="21329"|	medcode=="46042"|	medcode=="104418"|	medcode=="39187"|	medcode=="64567"|	medcode=="43450"|	medcode=="19372"|	medcode=="4251"|	medcode=="104325"|	medcode=="8625"|	medcode=="104328"|	medcode=="107052"|	medcode=="106924"|	medcode=="107163"|	medcode=="72774"|	medcode=="49725"|	medcode=="31586"|	medcode=="37461"|	medcode=="108656"|	medcode=="107643"|	medcode=="104939"|	medcode=="38331"|	medcode=="38914"|	medcode=="7176"|	medcode=="4413"|	medcode=="10726"|	medcode=="100786"|	medcode=="105957"|	medcode=="102783"|	medcode=="107236"|	medcode=="27520"|	medcode=="63475"|	medcode=="70724"|	medcode=="52327"|	medcode=="39629"|	medcode=="104788"|	medcode=="112440"|	medcode=="27664"|	medcode=="66089"|	medcode=="33344"|	medcode=="35875"|	medcode=="19974"|	medcode=="27458"|	medcode=="101606"|	medcode=="108424"|	medcode=="99015"|	medcode=="103645"|	medcode=="93342"|	medcode=="37272"|	medcode=="42539"|	medcode=="37468"|	medcode=="57671"|	medcode=="65721"|	medcode=="50858"|	medcode=="28276"|	medcode=="110838"|	medcode=="104273"|	medcode=="94174"|	medcode=="72197"|	medcode=="99413"|	medcode=="30632"|	medcode=="25191"|	medcode=="4072"|	medcode=="16416"|	medcode=="54793"|	medcode=="34692"|	medcode=="4250"|	medcode=="20440"|	medcode=="61500"|	medcode=="22050"|	medcode=="104475"|	medcode=="105069"|	medcode=="30646"|	medcode=="6115"|	medcode=="39336"|	medcode=="49301"|	medcode=="25493"|	medcode=="2481"|	medcode=="11950"|	medcode=="106993"|	medcode=="104740"|	medcode=="105915"|	medcode=="45285"|	medcode=="46444"|	medcode=="70935"|	medcode=="40740"|	medcode=="43415"|	medcode=="67518"|	medcode=="98596"|	medcode=="64336"|	medcode=="102688"|	medcode=="67029"|	medcode=="61693"|	medcode=="89762"|	medcode=="89329"|	medcode=="65165"|	medcode=="105025"|	medcode=="72500"|	medcode=="64515"|	medcode=="109714"|	medcode=="63375"|	medcode=="8649"|	medcode=="45143"|	medcode=="69545"|	medcode=="15883"|	medcode=="106381"|	medcode=="3451"|	medcode=="12306"|	medcode=="12386"|	medcode=="16527"|	medcode=="10411"|	medcode=="101350"|	medcode=="99067"|	medcode=="108102"|	medcode=="71994"|	medcode=="18486"|	medcode=="51041"|	medcode=="27934"|	medcode=="104554"|	medcode=="110183"|	medcode=="44147"|	medcode=="15137"|	medcode=="8548"|	medcode=="18701"|	medcode=="18700"|	medcode=="68440"|	medcode=="57161"|	medcode=="69373"|	medcode=="57322"|	medcode=="92569"|	medcode=="62598"|	medcode=="69184"|	medcode=="60026"|	medcode=="69854"|	medcode=="16295"|	medcode=="48307"|	medcode=="50665"|	medcode=="31322"|	medcode=="62236"|	medcode=="48293"|	medcode=="31541"|	medcode=="66073"|	medcode=="49542"|	medcode=="50526"|	medcode=="103977"|	medcode=="62328"|	medcode=="3129"|	medcode=="65617"|	medcode=="56108"|	medcode=="54203"|	medcode=="21975"|	medcode=="93892"|	medcode=="66857"|	medcode=="36408"|	medcode=="109671"|	medcode=="54904"|	medcode=="63204"|	medcode=="32141"|	medcode=="91911"|	medcode=="66049"|	medcode=="40950"|	medcode=="18781"| medcode=="38306"|	medcode=="39034"|	medcode=="34150"|	medcode=="5572"|	medcode=="2337"|	medcode=="41185"|	medcode=="73583"|	medcode=="12699"|	medcode=="5655"|	medcode=="66740"|	medcode=="27515"|	medcode=="51640"|	medcode=="32270"|	medcode=="57551"|	medcode=="95005"|	medcode=="39420"|	medcode=="61069"|	medcode=="56973"|	medcode=="47695"|	medcode=="65825")
ext5refIMMUNO3<-subset(ext5ref, medcode=="63323"|	medcode=="53317"|	medcode=="20261"|	medcode=="11346"|	medcode=="100043"|	medcode=="52604"|	medcode=="57525"|	medcode=="40406"|	medcode=="70236"|	medcode=="62041"|	medcode=="22319"|	medcode=="101375"|	medcode=="101075"|	medcode=="4072"|	medcode=="4251"|	medcode=="19974"|	medcode=="4413"|	medcode=="50858"|	medcode=="27664"|	medcode=="37461"|	medcode=="52327"|	medcode=="100786"|	medcode=="16416"|	medcode=="8625"|	medcode=="27458"|	medcode=="10726"|	medcode=="27520"|	medcode=="22050"|	medcode=="102783"|	medcode=="50668"|	medcode=="53551"|	medcode=="17460"|	medcode=="65180"|	medcode=="21549"|	medcode=="70842"|	medcode=="99067"|	medcode=="39629"|	medcode=="27330"|	medcode=="53397"|	medcode=="107804"|	medcode=="59755"|	medcode=="91900"|	medcode=="59778"|	medcode=="99012"|	medcode=="97746"|	medcode=="94279"|	medcode=="61662"|	medcode=="67703"|	medcode=="101530"|	medcode=="63625"|	medcode=="111942"|	medcode=="110563"|	medcode=="107032"|	medcode=="101715"|	medcode=="73532"|	medcode=="95338"|	medcode=="92245"|	medcode=="68330"|	medcode=="93951"|	medcode=="104743"|	medcode=="71142"|	medcode=="49605"|	medcode=="94005"|	medcode=="58684"|	medcode=="94407"|	medcode=="108886"|	medcode=="97863"|	medcode=="29178"|	medcode=="63054"|	medcode=="61149"|	medcode=="67506"|	medcode=="65483"|	medcode=="55303"|	medcode=="19140"|	medcode=="105472"|	medcode=="57225"|	medcode=="95049"|	medcode=="64036"|	medcode=="68039"|	medcode=="29876"|	medcode=="106911"|	medcode=="43450"|	medcode=="34926"|	medcode=="47204"|	medcode=="102158"|	medcode=="54083"|	medcode=="102715"|	medcode=="4250"|	medcode=="25191"|	medcode=="73777"|	medcode=="65123"|	medcode=="65122"|	medcode=="38939"|	medcode=="19372"|	medcode=="38914"|	medcode=="72197"|	medcode=="16527"|	medcode=="71994"|	medcode=="50695"|	medcode=="108182"|	medcode=="12335"|	medcode=="42579"|	medcode=="71262"|	medcode=="72725"|	medcode=="34089"|	medcode=="50696"|	medcode=="63105"|	medcode=="15504"|	medcode=="60092"|	medcode=="57427"|	medcode=="17887"|	medcode=="89657"|	medcode=="15036"|	medcode=="49301"|	medcode=="30646"|	medcode=="65434"|	medcode=="22158"|	medcode=="65721"|	medcode=="100615"|	medcode=="31324"|	medcode=="103900"|	medcode=="57671"|	medcode=="15883"|	medcode=="35875"|	medcode=="93342"|	medcode=="37182"|	medcode=="12006"|	medcode=="38005"|	medcode=="91674"|	medcode=="96379"|	medcode=="72714"|	medcode=="95012"|	medcode=="95949"|	medcode=="7176"|	medcode=="33344"|	medcode=="70724"|	medcode=="4944"|	medcode=="20440"|	medcode=="25493"|	medcode=="65701"|	medcode=="92068"|	medcode=="105203"|	medcode=="111766"|	medcode=="45264"|	medcode=="94995"|	medcode=="58082"|	medcode=="66327"|	medcode=="3604"|	medcode=="94174"|	medcode=="99413"|	medcode=="64567"|	medcode=="34692"|	medcode=="49725"|	medcode=="38331"|	medcode=="99015"|	medcode=="103645"|	medcode=="112440"|	medcode=="66089"|	medcode=="3451"|	medcode=="37272"|	medcode=="30632"|	medcode=="31576"|	medcode=="12386"|	medcode=="2481"|	medcode=="31586"|	medcode=="35014"|	medcode=="100532"|	medcode=="54793"|	medcode=="72774"|	medcode=="101606"|	medcode=="63475"|	medcode=="104475"|	medcode=="10411"|	medcode=="5019"|	medcode=="102559"|	medcode=="59610"|	medcode=="105256"|	medcode=="31489"|	medcode=="10505")

ext5refIMMUNO <- rbindlist(list(ext5refIMMUNO1, ext5refIMMUNO2, ext5refIMMUNO3), use.names = TRUE, fill = TRUE)

fwrite(ext5refIMMUNO, paste("P:/Comorbidities/ext5refIMMUNO.csv"))
ext5refIMMUNO <- fread("P:/Comorbidities/ext5refIMMUNO.csv")

#ext5 csf and cochlear ref
ext5refCSF<-subset(ext5ref, medcode=="30525"|	medcode=="43643"|	medcode=="42441"|	medcode=="36513"|	medcode=="20641"|	medcode=="26158"|	medcode=="40348"|	medcode=="20488"|	medcode=="27295"|	medcode=="35762"|	medcode=="16172"|	medcode=="9300"|	medcode=="17957"|	medcode=="36424"|	medcode=="97074"|	medcode=="55931"|	medcode=="33396"|	medcode=="48851"|	medcode=="71772"|	medcode=="41393"|	medcode=="54342"|	medcode=="10708"|	medcode=="61980"|	medcode=="98472"|	medcode=="57642"|	medcode=="74897")

fwrite(ext5refCSF, paste("P:/Comorbidities/ext5refCSF.csv"))
ext5refCSF <- fread("P:/Comorbidities/ext5refCSF.csv")

#bind all
ext5refALL <- rbindlist(list(ext5refRESP, ext5refHEART, ext5refRENAL, ext5refLIVER, ext5refDIABETES, ext5refIMMUNO, ext5refCSF), use.names = TRUE, fill = TRUE)

fwrite(ext5refALL, paste("P:/Comorbidities/ext5refALL.csv"))
ext5refALL <- fread("P:/Comorbidities/ext5refALL.csv")


#bind all resp ref
ALLextrefRESP <- rbindlist(list(ext1refRESP, ext2refRESP, ext3refRESP, ext4refRESP, ext5refRESP), use.names = TRUE, fill = TRUE)

fwrite(ALLextrefRESP, paste("P:/Comorbidities/ALLextrefRESP.csv"))
ALLextrefRESP <- fread("P:/Comorbidities/ALLextrefRESP.csv")

#bind all heart ref
ALLextrefHEART <- rbindlist(list(ext1refHEART, ext2refHEART, ext3refHEART, ext4refHEART, ext5refHEART), use.names = TRUE, fill = TRUE)

fwrite(ALLextrefHEART, paste("P:/Comorbidities/ALLextrefHEART.csv"))
ALLextrefHEART <- fread("P:/Comorbidities/ALLextrefHEART.csv")

#bind all renal ref
ALLextrefRENAL <- rbindlist(list(ext1refRENAL, ext2refRENAL, ext3refRENAL, ext4refRENAL, ext5refRENAL), use.names = TRUE, fill = TRUE)

fwrite(ALLextrefRENAL, paste("P:/Comorbidities/ALLextrefRENAL.csv"))
ALLextrefRENAL <- fread("P:/Comorbidities/ALLextrefRENAL.csv")

#bind all liver ref
ALLextrefLIVER <- rbindlist(list(ext1refLIVER, ext2refLIVER, ext3refLIVER, ext4refLIVER, ext5refLIVER), use.names = TRUE, fill = TRUE)

fwrite(ALLextrefLIVER, paste("P:/Comorbidities/ALLextrefLIVER.csv"))
ALLextrefLIVER <- fread("P:/Comorbidities/ALLextrefLIVER.csv")

#bind all diabetes ref
ALLextrefDIABETES <- rbindlist(list(ext1refDIABETES, ext2refDIABETES, ext3refDIABETES, ext4refDIABETES, ext5refDIABETES), use.names = TRUE, fill = TRUE)

fwrite(ALLextrefDIABETES, paste("P:/Comorbidities/ALLextrefDIABETES.csv"))
ALLextrefDIABETES <- fread("P:/Comorbidities/ALLextrefDIABETES.csv")

#bind all immuno ref
ALLextrefIMMUNO <- rbindlist(list(ext1refIMMUNO, ext2refIMMUNO, ext3refIMMUNO, ext4refIMMUNO, ext5refIMMUNO), use.names = TRUE, fill = TRUE)

fwrite(ALLextrefIMMUNO, paste("P:/Comorbidities/ALLextrefIMMUNO.csv"))
ALLextrefIMMUNO <- fread("P:/Comorbidities/ALLextrefIMMUNO.csv")

#bind all csf ref
ALLextrefCSF <- rbindlist(list(ext1refCSF, ext2refCSF, ext3refCSF, ext4refCSF, ext5refCSF), use.names = TRUE, fill = TRUE)

fwrite(ALLextrefCSF, paste("P:/Comorbidities/ALLextrefCSF.csv"))
ALLextrefCSF <- fread("P:/Comorbidities/ALLextrefCSF.csv")


#bind all resp
RESP <- rbindlist(list(ALLextRESP, ALLextrefRESP), use.names = TRUE, fill = TRUE)

fwrite(RESP, paste("P:/Comorbidities/RESP.csv"))
RESP <- fread("P:/Comorbidities/RESP.csv")

#bind all heart
HEART <- rbindlist(list(ALLextHEART, ALLextrefHEART), use.names = TRUE, fill = TRUE)

fwrite(HEART, paste("P:/Comorbidities/HEART.csv"))
HEART <- fread("P:/Comorbidities/HEART.csv")

#bind all renal
RENAL <- rbindlist(list(ALLextRENAL, ALLextrefRENAL), use.names = TRUE, fill = TRUE)

fwrite(RENAL, paste("P:/Comorbidities/RENAL.csv"))
RENAL <- fread("P:/Comorbidities/RENAL.csv")

#bind all liver
LIVER <- rbindlist(list(ALLextLIVER, ALLextrefLIVER), use.names = TRUE, fill = TRUE)

fwrite(LIVER, paste("P:/Comorbidities/LIVER.csv"))
LIVER <- fread("P:/Comorbidities/LIVER.csv")

#bind all diabetes
DIABETES <- rbindlist(list(ALLextDIABETES, ALLextrefDIABETES), use.names = TRUE, fill = TRUE)

fwrite(DIABETES, paste("P:/Comorbidities/DIABETES.csv"))
DIABETES <- fread("P:/Comorbidities/DIABETES.csv")

#bind all immuno
IMMUNO <- rbindlist(list(ALLextIMMUNO, ALLextrefIMMUNO), use.names = TRUE, fill = TRUE)

fwrite(IMMUNO, paste("P:/Comorbidities/IMMUNO.csv"))
IMMUNO <- fread("P:/Comorbidities/IMMUNO.csv")

#bind all csf
CSF <- rbindlist(list(ALLextCSF, ALLextrefCSF), use.names = TRUE, fill = TRUE)

fwrite(CSF, paste("P:/Comorbidities/CSF.csv"))
CSF <- fread("P:/Comorbidities/CSF.csv")


#create fields within comorbidity frames that is a binary in order to track after merge
RESP$RESP <- 1
HEART$HEART <- 1
RENAL$RENAL <- 1
LIVER$LIVER <- 1
DIABETES$DIABETES <-1
IMMUNO$IMMUNO <- 1
CSF$CSF <- 1


#bring patids back into BabyHESmerge
BabyHESmerge5 <- BabyHESmerge4 %>%
  left_join(BabyHESmerge %>%
              select(patid.babypatid, patid.patid) %>%
              distinct(patid.babypatid, .keep_all = TRUE),
            by = "patid.babypatid")


#bind all comorbidities into one data frame
Comorbidities <- rbindlist (list(RESP, HEART, RENAL, LIVER, DIABETES, IMMUNO, CSF), use.names = TRUE, fill = TRUE)


#charlson index
Comorbidities_charlson <- comorbidity(
  Comorbidities,
  id = "patid",              
  code = "medcode",          
  map = "charlson_icd10_quan", 
  assign0 = FALSE
)

str(Comorbidities_charlson)

# Calculate the Charlson Comorbidity Index score for each patient
Comorbidities_charlson <- Comorbidities_charlson %>%
  rowwise() %>%
  mutate(charlson_index = sum(c_across(mi:aids), na.rm = TRUE)) %>%
  ungroup()

# View unique codes in your Comorbidities data
unique(Comorbidities$medcode)  # Assuming 'medcode' contains ICD codes



#merge resp with BabyHESmerge
RESP_wide <- RESP %>%
  group_by(patid, medcode) %>%                         # Group by `patid` and `medcode`
  summarize(has_comorbidity = as.integer(any(RESP == 1)), .groups = "drop") %>%  # Create indicator for each `medcode`
  pivot_wider(names_from = medcode, values_from = has_comorbidity, names_prefix = "medcode_") %>%
  ungroup()

RESP_wide <- RESP_wide %>%
  mutate(RESPsum = rowSums(across(2:113), na.rm = TRUE))

BabyHESmergeRESP <- BabyHESmerge5 %>%
  left_join(RESP_wide %>% select(patid, RESPsum) %>% distinct(patid, .keep_all = TRUE), 
            by = c("patid.patid" = "patid"))


#merge heart with BabyHESmerge
HEART_wide <- HEART %>%
  group_by(patid, medcode) %>%                         # Group by `patid` and `medcode`
  summarize(has_comorbidity = as.integer(any(HEART == 1)), .groups = "drop") %>%  # Indicator for each `medcode`
  pivot_wider(names_from = medcode, values_from = has_comorbidity, names_prefix = "medcode_") %>%
  ungroup()

HEART_wide <- HEART_wide %>%
  mutate(HEARTsum = rowSums(across(2:222), na.rm = TRUE))

BabyHESmergeHEART <- BabyHESmergeRESP %>%
  left_join(HEART_wide %>% select(patid, HEARTsum) %>% distinct(patid, .keep_all = TRUE), 
            by = c("patid.patid" = "patid"))


#merge renal with BabyHESmerge
RENAL_wide <- RENAL %>%
  group_by(patid, medcode) %>%                           # Group by `patid` and `medcode`
  summarize(has_comorbidity = as.integer(any(RENAL == 1)), .groups = "drop") %>%  # Create indicator for each `medcode`
  pivot_wider(names_from = medcode, values_from = has_comorbidity, names_prefix = "medcode_") %>%
  ungroup()

RENAL_wide <- RENAL_wide %>%
  mutate(RENALsum = rowSums(across(2:58), na.rm = TRUE))

BabyHESmergeRENAL <- BabyHESmergeHEART %>%
  left_join(RENAL_wide %>% select(patid, RENALsum) %>% distinct(patid, .keep_all = TRUE), 
            by = c("patid.patid" = "patid"))


#merge liver with BabyHESmerge
LIVER_wide <- LIVER %>%
  group_by(patid, medcode) %>%  # Group by `patid` and `medcode`
  summarize(has_comorbidity = as.integer(any(LIVER == 1)), .groups = "drop") %>%  # Create indicator for each `medcode`
  pivot_wider(names_from = medcode, values_from = has_comorbidity, names_prefix = "medcode_") %>%
  ungroup()

LIVER_wide <- LIVER_wide %>%
  mutate(LIVERsum = rowSums(across(2:44), na.rm = TRUE))

BabyHESmergeLIVER <- BabyHESmergeRENAL %>%
  left_join(LIVER_wide %>% select(patid, LIVERsum) %>% distinct(patid, .keep_all = TRUE), 
            by = c("patid.patid" = "patid"))


#merge diabetes with BabyHESmerge
DIABETES_wide <- DIABETES %>%
  group_by(patid, medcode) %>%  # Group by `patid` and `medcode`
  summarize(has_comorbidity = as.integer(any(DIABETES == 1)), .groups = "drop") %>%  # Indicator for each `medcode`
  pivot_wider(names_from = medcode, values_from = has_comorbidity, names_prefix = "medcode_") %>%
  ungroup()

DIABETES_wide <- DIABETES_wide %>%
  mutate(DIABETESsum = rowSums(across(2:58), na.rm = TRUE))

BabyHESmergeDIABETES <- BabyHESmergeLIVER %>%
  left_join(DIABETES_wide %>% select(patid, DIABETESsum) %>% distinct(patid, .keep_all = TRUE), 
            by = c("patid.patid" = "patid"))


#merge immuno with BabyHESmerge
IMMUNO_wide <- IMMUNO %>%
  group_by(patid, medcode) %>%  # Group by `patid` and `medcode`
  summarize(has_comorbidity = as.integer(any(IMMUNO == 1)), .groups = "drop") %>%  # Create indicator for each `medcode`
  pivot_wider(names_from = medcode, values_from = has_comorbidity, names_prefix = "medcode_") %>%
  ungroup()

IMMUNO_wide <- IMMUNO_wide %>%
  mutate(IMMUNOsum = rowSums(across(2:188), na.rm = TRUE))

BabyHESmergeIMMUNO <- BabyHESmergeDIABETES %>%
  left_join(IMMUNO_wide %>% select(patid, IMMUNOsum) %>% distinct(patid, .keep_all = TRUE), 
            by = c("patid.patid" = "patid"))


#merge csf with BabyHESmerge
CSF_wide <- CSF %>%
  group_by(patid, medcode) %>%  # Group by `patid` and `medcode`
  summarize(has_comorbidity = as.integer(any(CSF == 1)), .groups = "drop") %>%  # Create indicator for each `medcode`
  pivot_wider(names_from = medcode, values_from = has_comorbidity, names_prefix = "medcode_") %>%
  ungroup()

CSF_wide <- CSF_wide %>%
  mutate(CSFsum = rowSums(across(2:25), na.rm = TRUE))

BabyHESmerge6 <- BabyHESmergeIMMUNO %>%
  left_join(CSF_wide %>% select(patid, CSFsum) %>% distinct(patid, .keep_all = TRUE), 
            by = c("patid.patid" = "patid"))


# Create a new column in BabyHESmerge6 for binary
BabyHESmerge6$Comorbid <- ifelse(rowSums(BabyHESmerge6[, 60:66], na.rm = TRUE) > 0, 1, 0)


# Create a new column in BabyHESmerge6 that sums values across columns 60 to 66
BabyHESmerge6$TotalNumCom <- rowSums(BabyHESmerge6[, 60:66], na.rm = TRUE)


#save file
fwrite(BabyHESmerge6, paste("P:/BabyHESmerge6.csv"))
#read back in
BabyHESmerge6 <- fread("P:/BabyHESmerge6.csv")

#date conversions
BabyHESmerge6$babyDOB <- as.Date(BabyHESmerge6$babyDOB)
BabyHESmerge6$SixMonthsPost <- as.Date(BabyHESmerge6$SixMonthsPost)
BabyHESmerge6$patid.pregstart <- as.Date(BabyHESmerge6$patid.pregstart)
BabyHESmerge6$SecTri <- as.Date(BabyHESmerge6$SecTri)
BabyHESmerge6$ThirdTri <- as.Date(BabyHESmerge6$ThirdTri)
BabyHESmerge6$patid.pregend <- as.Date(BabyHESmerge6$patid.pregend)
BabyHESmerge6$AdmitDate <- as.Date(BabyHESmerge6$AdmitDate)
BabyHESmerge6$CensorDate4 <- as.Date(BabyHESmerge6$CensorDate4)

BabyHESmerge6$BabyHESPost2 <- factor(BabyHESmerge6$BabyHESPost2, levels = c("Yes", "No"))

BabyHESmerge6$IMD <- as.factor(BabyHESmerge6$IMD)

BabyHESmerge6$Comorbid <- as.factor(BabyHESmerge6$Comorbid)


###########survival plots################################################


#KM curve for vax status
KM_fit<-survfit(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(had_flu_vax_during_preg3), data = BabyHESmerge6)
summary(KM_fit)
ggsurvtable(KM_fit, data = BabyHESmerge6)


#plot
plot(KM_fit, xlab = "Days", ylab = "Survival Probability", main = "Kaplan-Meier Survival Curve for Babies (vax status)", col = "red")
autoplot(KM_fit)


survfit2(Surv(PersonTime, as.integer(BabyHESPost)) ~ 1, data = BabyHESmerge6) %>% 
  ggsurvfit() +
  labs(
    x = "Days",
    y = "Overall survival probability"
  )

survfit2(Surv(PersonTime, as.integer(BabyHESPost)) ~ 1, data = BabyHESmerge6) %>% 
  ggsurvfit() +
  labs(
    x = "Days",
    y = "Overall survival probability"
  ) + 
  add_confidence_interval()


ggsurvplot(
  KM_fit,
  data = BabyHESmerge6,
  xlab = "Days",
  ylab = "Survival Probability",
  title = "Kaplan-Meier Survival Curve for Babies (vax status)",
  risk.table = TRUE,       # Add risk table
  pval = TRUE,             # Add p-value
  conf.int = TRUE,         # Add confidence intervals
  ylim = c(0.97, 1),       # start y-axis at 97%
  ggtheme = theme_minimal(), # Use a minimal theme
  palette = "viridis"
)

ggsurvplot(
  fit = KM_fit, 
  data = BabyHESmerge6,
  title = "Univariate Kaplan-Meier Survival Curve for Babies by Maternal Influenza Vaccine Status",
  xlab = "Days",
  ylab = "Proportion without HES Admission",
  risk.table = TRUE,         # Show the risk table
  pval = TRUE,               # Display p-value for the primary variable
  conf.int = TRUE,           # Ensure confidence intervals are displayed
  ylim = c(0.97, 1),         # Limit y-axis to start at 0.97
  palette = "viridis",       # Use viridis color palette
  ggtheme = theme_minimal()   # Minimal theme for a cleaner look
)

library(survminer)

ggsurvplot(
  fit = KM_fit, 
  data = BabyHESmerge6,
  title = "Univariate Kaplan-Meier Survival Curve for Babies by Maternal Influenza Vaccine Status",
  xlab = "Days",
  ylab = "Proportion Without HES Admission",
  risk.table = TRUE,                      # Show the risk table
  risk.table.fontsize = 4,                # Adjust risk table font size
  risk.table.height = 0.2,                # Control risk table height
  pval = TRUE,                            # Display p-value
  conf.int = TRUE,                        # Add confidence intervals
  conf.int.alpha = 0.3,                   # Lighten confidence intervals
  ylim = c(0.97, 1),                      # Adjust y-axis range
  palette = "viridis",      # Use a custom color palette
  legend.labs = c("No and Eligible", "Yes"), # Simplify legend labels
  ggtheme = theme_minimal() # Use a classic theme
)



#cox proportional hazards
mfit1<-coxph(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(had_flu_vax_during_preg3), data = BabyHESmerge6)
summary(mfit1)

#coxph(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(had_flu_vax_during_preg3), data = BabyHESmerge4) %>% 
 # tbl_regression(exp = TRUE) 

regression_table1 <- mfit1 %>% 
  tbl_regression(exp = TRUE)
print(regression_table1)

cox.zph(mfit1)
ggcoxzph((cox.zph(mfit1)))



#KM curve for sex of the baby
KM_fit2<-survfit(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(SexBaby2), data = BabyHESmerge6)

plot(KM_fit2, xlab = "Days", ylab = "Survival Probability", main = "Kaplan-Meier Survival Curve for Babies (sex of baby)", col = "red")
autoplot(KM_fit2)


ggsurvplot(
  KM_fit2,
  data = BabyHESmerge6,
  xlab = "Days",
  ylab = "Survival Probability",
  title = "Kaplan-Meier Survival Curve for Babies (sex of baby)",
  risk.table = TRUE,       # Add risk table
  pval = TRUE,             # Add p-value
  conf.int = TRUE,         # Add confidence intervals
  ylim = c(0.95, 1),       # start y-axis at 95%
  ggtheme = theme_minimal(), # Use a minimal theme
  palette = "viridis"
)

ggsurvplot(
  KM_fit2,
  data = BabyHESmerge6,
  xlab = "Days",
  ylab = "Survival Probability",
  title = "Kaplan-Meier Survival Curve for Babies (sex of baby)",
  risk.table = TRUE,       # Add risk table
  pval = TRUE,             # Add p-value
  conf.int = TRUE,         # Add confidence intervals
  ylim = c(0.95, 1),       # Start y-axis at 95%
  palette = "viridis",
  ggtheme = theme_minimal() # Minimal theme for a cleaner look
)



#cox proportional hazards
mfit2<-coxph(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(SexBaby2), data = BabyHESmerge6)
summary(mfit2)

#coxph(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(SexBaby2, data = BabyHESmerge4) %>% 
  #tbl_regression(exp = TRUE) 

regression_table2 <- mfit2 %>% 
  tbl_regression(exp = TRUE)
print(regression_table2)

cox.zph(mfit2)
ggcoxzph((cox.zph(mfit2)))




#KM curve for urban rural
KM_fit3<-survfit(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(UrbanRural), data = BabyHESmerge6)
plot(KM_fit3, xlab = "Days", ylab = "Survival Probability", main = "Kaplan-Meier Survival Curve for Babies (urban rural)", col = "red")
autoplot(KM_fit3)

ggsurvplot(
  KM_fit3,
  data = BabyHESmerge6,
  xlab = "Days",
  ylab = "Survival Probability",
  title = "Kaplan-Meier Survival Curve for Babies (urban rural)",
  risk.table = TRUE,       # Add risk table
  pval = TRUE,             # Add p-value
  conf.int = TRUE,         # Add confidence intervals
  ylim = c(0.95, 1),       # start y-axis at 95%
  ggtheme = theme_minimal(), # Use a minimal theme
  palette = "viridis"
)

#cox proportional hazards
mfit3<-coxph(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(UrbanRural), data = BabyHESmerge6)
summary(mfit3)

#coxph(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(UrbanRural), data = BabyHESmerge4) %>% 
#tbl_regression(exp = TRUE) 

regression_table3 <- mfit3 %>% 
  tbl_regression(exp = TRUE)
print(regression_table3)

cox.zph(mfit3)
ggcoxzph((cox.zph(mfit3)))



#KM curve for parity
KM_fit4<-survfit(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(totalpregs), data = BabyHESmerge6)
plot(KM_fit4, xlab = "Days", ylab = "Survival Probability", main = "Kaplan-Meier Survival Curve for Babies (parity)", col = "red")
#autoplot(KM_fit4) #error


ggsurvplot(
  KM_fit4,
  data = BabyHESmerge6,
  xlab = "Days",
  ylab = "Survival Probability",
  title = "Kaplan-Meier Survival Curve for Babies (parity)",
  risk.table = TRUE,       # Add risk table
  pval = TRUE,             # Add p-value
  conf.int = TRUE,         # Add confidence 
  ylim = c(0.95, 1),       # start y-axis at 95%
  ggtheme = theme_minimal(), # Use a minimal theme
  palette = "viridis"
)

ggsurvplot(
  KM_fit4,
  data = BabyHESmerge6,
  xlab = "Days",
  ylab = "Survival Probability",
  title = "Kaplan-Meier Survival Curve for Babies (parity)",
  risk.table = TRUE,           # Add risk table
  pval = TRUE,                 # Add p-value
  conf.int = TRUE,             # Add confidence intervals
  ylim = c(0.95, 1),           # Start y-axis at 95%
  ggtheme = theme_minimal(),   # Use a minimal theme
  surv.size = 0.6,             # Reduce line thickness
  palette = "viridis",         # Use the viridis color palette
  legend.labs = c("1", "2", "3", "4", "5+")  # Set custom labels
)




#cox proportional hazards
mfit4<-coxph(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(totalpregs), data = BabyHESmerge6)
summary(mfit4)

#coxph(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.integer(patid.totalpregs), data = BabyHESmerge4) %>% 
#tbl_regression(exp = TRUE) 

regression_table4 <- mfit4 %>% 
  tbl_regression(exp = TRUE)
print(regression_table4)

cox.zph(mfit4)
ggcoxzph((cox.zph(mfit4)))


#KM curve for IMD
KM_fit5<-survfit(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(IMD), data = BabyHESmerge6)
plot(KM_fit5, xlab = "Days", ylab = "Survival Probability", main = "Kaplan-Meier Survival Curve for Babies (IMD quintiles)", col = "red")
#autoplot(KM_fit4) #error


ggsurvplot(
  KM_fit5,
  data = BabyHESmerge6,
  xlab = "Days",
  ylab = "Survival Probability",
  title = "Kaplan-Meier Survival Curve for Babies (IMD quintiles)",
  risk.table = TRUE,       # Add risk table
  pval = TRUE,             # Add p-value
  conf.int = TRUE,         # Add confidence 
  ylim = c(0.95, 1),       # start y-axis at 85%
  ggtheme = theme_minimal(), # Use a minimal theme
  palette = "viridis"
)

ggsurvplot(
  KM_fit5,
  data = BabyHESmerge6,
  xlab = "Days",
  ylab = "Survival Probability",
  title = "Kaplan-Meier Survival Curve for Babies (IMD quintiles)",
  risk.table = TRUE,           # Add risk table
  pval = TRUE,                 # Add p-value
  conf.int = TRUE,             # Add confidence intervals
  ylim = c(0.95, 1),           # Start y-axis at 95%
  ggtheme = theme_minimal(),   # Use a minimal theme
  surv.size = 0.6,             # Reduce line thickness
  palette = "viridis",         # Use the viridis color palette
  legend.labs = c("1", "2", "3", "4", "5")  # Set custom labels
)



#cox proportional hazards
mfit5<-coxph(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(IMD), data = BabyHESmerge6)
summary(mfit5)

#coxph(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.integer(patid.totalpregs), data = BabyHESmerge4) %>% 
#tbl_regression(exp = TRUE) 

regression_table5 <- mfit5 %>% 
  tbl_regression(exp = TRUE)
print(regression_table5)

cox.zph(mfit5)
ggcoxzph((cox.zph(mfit5)))


#KM curve for comorbidites
BabyHESmerge6$Comorbid2 <- NA
BabyHESmerge6$Comorbid2[BabyHESmerge6$Comorbid=="0"] <- "No"
BabyHESmerge6$Comorbid2[BabyHESmerge6$Comorbid=="1"] <- "Yes"
BabyHESmerge6$Comorbid2 <- factor(BabyHESmerge6$Comorbid2, levels = c("Yes", "No"))



KM_fit7<-survfit(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(Comorbid2), data = BabyHESmerge6)
plot(KM_fit7, xlab = "Days", ylab = "Survival Probability", main = "Kaplan-Meier Survival Curve for Babies (urban rural)", col = "red")
autoplot(KM_fit7)

ggsurvplot(
  KM_fit7,
  data = BabyHESmerge6,
  xlab = "Days",
  ylab = "Survival Probability",
  title = "Kaplan-Meier Survival Curve for Babies (maternal comorbidities)",
  risk.table = TRUE,       # Add risk table
  pval = TRUE,             # Add p-value
  conf.int = TRUE,         # Add confidence intervals
  ylim = c(0.95, 1),       # start y-axis at 95%
  ggtheme = theme_minimal(), # Use a minimal theme
  palette = "viridis"
)

#cox proportional hazards
mfit7<-coxph(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(Comorbid), data = BabyHESmerge6)
summary(mfit7)

#coxph(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(UrbanRural), data = BabyHESmerge4) %>% 
#tbl_regression(exp = TRUE) 

regression_table3 <- mfit3 %>% 
  tbl_regression(exp = TRUE)
print(regression_table3)

cox.zph(mfit3)
ggcoxzph((cox.zph(mfit3)))





#adjust for all covariates
mfit6<-coxph(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(had_flu_vax_during_preg3) + as.factor(Comorbid) + as.factor(SexBaby2) + as.factor(UrbanRural) + as.factor(totalpregs) + as.factor(IMD), data = BabyHESmerge6)
summary(mfit6)


cox.zph(mfit6)
ggcoxzph((cox.zph(mfit6)))


plot(cox.zph(mfit6), var='had_flu_vax_during_preg3')


#adjusted km plot
KM_fit_adj <- coxph(
  Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(had_flu_vax_during_preg3) + 
    Comorbid + SexBaby2 + IMD + UrbanRural + totalpregs,
  data = BabyHESmerge6
)

ggadjustedcurves(
  fit = KM_fit_adj, 
  variable = "had_flu_vax_during_preg3",
  data = BabyHESmerge6,
  method = "average",
  title = "Adjusted Kaplan-Meier Survival Curve for Babies (Vax Status)",
  xlab = "Days",
  ylab = "Survival Probability",
  risk.table = TRUE,       # Show the risk table
  pval = TRUE,             # Display p-value for the primary variable
  conf.int = TRUE,         # Add confidence intervals
  ylim = c(0.95, 1),       # Limit y-axis to start at 0.95
  palette = "viridis",
  ggtheme = theme_minimal() # Minimal theme for a cleaner look
)

ggadjustedcurves(
  fit = KM_fit_adj, 
  variable = "had_flu_vax_during_preg3",
  data = BabyHESmerge6,
  method = "average",
  title = "Adjusted Kaplan-Meier Survival Curve for Babies (Vax Status)",
  xlab = "Days",
  ylab = "Survival Probability",
  risk.table = TRUE,       # Show the risk table
  pval = TRUE,             # Display p-value for the primary variable
  conf.int = TRUE,         # Add confidence intervals
  ylim = c(0.97, 1),       # Limit y-axis to start at 0.97
  palette = "viridis",
  ggtheme = theme_minimal() # Minimal theme for a cleaner look
)

ggadjustedcurves(
  fit = KM_fit_adj, 
  variable = "had_flu_vax_during_preg3",
  data = BabyHESmerge6,
  method = "average",
  title = "Adjusted Kaplan-Meier Survival Curve for Babies by Maternal Influenza Vaccine Status",
  xlab = "Days",
  ylab = "Proportion without HES Admission",
  risk.table = TRUE,         # Show the risk table
  pval = TRUE,               # Display p-value for the primary variable
  conf.int = TRUE,           # Ensure confidence intervals are displayed
  ylim = c(0.97, 1),         # Limit y-axis to start at 0.97
  palette = "viridis",       # Use viridis color palette
  ggtheme = theme_minimal()   # Minimal theme for a cleaner look
)


summary(KM_fit_adj)







BabyHESmerge6$IMD <- as.factor(BabyHESmerge6$IMD)

#mode_IMD <- names(sort(table(BabyHESmerge6$IMD), decreasing = TRUE))[1]

# Create new data frame for adjusted survival curve plotting
##new_data_for_plot <- data.frame(
  #had_flu_vax_during_preg3 = factor(c("No and Eligible", "Yes"), 
   #                                 levels = levels(BabyHESmerge6$had_flu_vax_during_preg3)),
  #Comorbid = median(BabyHESmerge6$Comorbid, na.rm = TRUE),   # Replace with suitable values
  #SexBaby2 = factor("Male", levels = levels(BabyHESmerge6$SexBaby2)),
  #IMD = factor(mode_IMD, levels = levels(BabyHESmerge6$IMD)), # Set IMD as factor using mode
  #UrbanRural = factor("Urban", levels = levels(BabyHESmerge6$UrbanRural)),
  #totalpregs = median(BabyHESmerge6$totalpregs, na.rm = TRUE)
)

#KM_fit_adj_surv <- survfit(KM_fit_adj, newdata = new_data_for_plot)

# Plot the survival curves with ggsurvplot
#ggsurvplot(
 # KM_fit_adj,
  #data = BabyHESmerge6,
  #xlab = "Days",
  #ylab = "Proportion without HES Admission",
  #title = "Adjusted Kaplan-Meier Survival Curve for Babies by Maternal Influenza Vaccine Status",
  #risk.table = TRUE,         # Show the risk table
  #pval = TRUE,               # Display p-value for the primary variable
  #conf.int = TRUE,           # Enable confidence intervals in survival curves
  #ylim = c(0.97, 1),         # Limit y-axis to start at 0.97
  #palette = "viridis",       # Use viridis color palette
  #ggtheme = theme_minimal()   # Minimal theme for a cleaner look
#)


#subset test preterm
PretermBabies <- BabyHESmerge4[BabyHESmerge4$Preterm == "Preterm"]
TermBabies <- BabyHESmerge4[BabyHESmerge4$Preterm == "No evidence of preterm"]


KM_fit_Preterm<-survfit(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(had_flu_vax_during_preg3), data = PretermBabies)

plot(KM_fit, xlab = "Days", ylab = "Survival Probability", main = "Kaplan-Meier Survival Curve for Babies", col = "red")
autoplot(KM_fit_Preterm)

KM_fit_Term<-survfit(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(had_flu_vax_during_preg3), data = TermBabies)



#subset test by sex
MaleBabies <- BabyHESmerge4[BabyHESmerge4$SexBaby2 == "Male"]
FemaleBabies <- BabyHESmerge4[BabyHESmerge4$SexBaby2 == "Female"]

KM_fit_Male<-survfit(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(had_flu_vax_during_preg3), data = MaleBabies)

plot(KM_fit, xlab = "Days", ylab = "Survival Probability", main = "Kaplan-Meier Survival Curve for Babies", col = "red")
autoplot(KM_fit_Male)

KM_fit_Female<-survfit(Surv(PersonTime, as.integer(BabyHESPost)) ~ as.factor(had_flu_vax_during_preg3), data = FemaleBabies)

plot(KM_fit, xlab = "Days", ylab = "Survival Probability", main = "Kaplan-Meier Survival Curve for Babies", col = "red")
autoplot(KM_fit_Female)





##########################poisson model#####################################

# Fit a multivariate Poisson regression model for BabyHESmerge6
##poisson_model <- glm(
  #BabyHESPost ~ as.factor(had_flu_vax_during_preg3) + 
   # as.factor(SexBaby2) + 
    #as.factor(UrbanRural) + 
    #as.factor(totalpregs) + 
    #IMD,
  #family = poisson(link = "log"),  # Poisson family with log link
  #data = BabyHESmerge6
#)

# Summary of the model
#summary(poisson_model)

# Calculate exponentiated coefficients for interpretation as rate ratios
#exp(coef(poisson_model))

# Confidence intervals for rate ratios
#exp(confint(poisson_model))

# Calculate robust standard errors
#robust_se <- sqrt(diag(vcovHC(poisson_model, type = "HC0")))

# Now you can summarize the model with the robust standard errors
#coeftest(poisson_model, vcov = vcovHC(poisson_model, type = "HC0"))


# Convert NA values in categorical variables to 'missing' (or another placeholder)
DescrHESmerge2$IMD[is.na(DescrHESmerge2$IMD)] <- "Missing"
DescrHESmerge2$UrbanRural[is.na(DescrHESmerge2$UrbanRural)] <- "Missing"
DescrHESmerge2$Ethnicity[is.na(DescrHESmerge2$Ethnicity)] <- "Missing"

DescrHESmerge2$PregOutcome <- factor(DescrHESmerge2$PregOutcome)
DescrHESmerge2$IMD <- factor(DescrHESmerge2$IMD)
DescrHESmerge2$UrbanRural <- factor(DescrHESmerge2$UrbanRural)
DescrHESmerge2$Preterm <- factor(DescrHESmerge2$Preterm)
DescrHESmerge2$Postterm <- factor(DescrHESmerge2$Postterm)
DescrHESmerge2$Multiple <- factor(DescrHESmerge2$Multiple)
DescrHESmerge2$Ethnicity <- factor(DescrHESmerge2$Ethnicity)

DescrHESmerge2$had_flu_vax_during_preg4 <- DescrHESmerge2$had_flu_vax_during_preg3
DescrHESmerge2$had_flu_vax_during_preg4 <- as.character(DescrHESmerge2$had_flu_vax_during_preg4)
DescrHESmerge2$had_flu_vax_during_preg4[DescrHESmerge2$had_flu_vax_during_preg3=="Yes"] <- "1"
DescrHESmerge2$had_flu_vax_during_preg4[DescrHESmerge2$had_flu_vax_during_preg3=="No and Eligible"] <- "0"
DescrHESmerge2$had_flu_vax_during_preg4 <- as.factor(DescrHESmerge2$had_flu_vax_during_preg4)



# Poisson regression model with flu vaccine status (Yes = 1, No = 0) for DescrHESmerge2
#poisson_model2 <- glm(
 # had_flu_vax_during_preg4 ~ 
  #  MumAge + 
   # NumOfPregs + 
    #GestDays + 
    #PregOutcome + 
    #IMD + 
    #UrbanRural + 
    #Preterm + 
    #Postterm + 
    #Multiple + 
    #Ethnicity,
  #family = poisson(link = "log"),   # Poisson regression model with log link
  #data = DescrHESmerge2       # Replace 'data' with your actual data frame name
#)

# Summary of the model
#summary(poisson_model2)

# Calculate exponentiated coefficients for interpretation as rate ratios
#exp(coef(poisson_model2))

# Confidence intervals for rate ratios
#exp(confint(poisson_model2))

# Calculate robust standard errors
#robust_se <- sqrt(diag(vcovHC(poisson_model2, type = "HC0")))

# Now you can summarize the model with the robust standard errors
#coeftest(poisson_model2, vcov = vcovHC(poisson_model2, type = "HC0"))


#logistic regression for vax status predictors

logregmodel <- glm(
  had_flu_vax_during_preg4 ~ 
    MumAge + 
    NumOfPregs + 
    GestDays + 
    PregOutcome2 + 
    IMD2 + 
    UrbanRural + 
    Preterm + 
    Postterm + 
    Multiple + 
    Ethnicity,
    family = "binomial",
    data = DescrHESmerge2
)

summary(logregmodel)
confint(logregmodel)
confint.default(logregmodel)


logregmodel2 <- glm(
  had_flu_vax_during_preg4 ~ 
    MumAge + 
    NumOfPregs + 
    GestDays + 
    PregOutcome + 
    IMD + 
    UrbanRural + 
    Preterm + 
    Postterm + 
    Multiple + 
    Ethnicity,
  family = "binomial",
  data = DescrHESmerge2
)

summary(logregmodel2)
confint(logregmodel2)
confint.default(logregmodel2)




#forest plots

# Extract the model coefficients and tidy the output
#tidy_model <- broom::tidy(poisson_model2, conf.int = TRUE, exp = TRUE)

# Create a forest plot for rate ratios with confidence intervals
#ggplot(tidy_model, aes(x = estimate, y = term, xmin = conf.low, xmax = conf.high)) +
 # geom_point() + 
  #geom_errorbarh(height = 0.2) + 
  #theme_minimal() +
  #labs(title = "Forest Plot of Rate Ratios for Poisson Regression Model",
   #    x = "Rate Ratio (Exp(Estimate))",
    #   y = "Predictor Variables") +
  #theme(axis.text.y = element_text(size = 8))  # Adjust text size for readability






#create dummy data set for what I want my final dataset to look like
#dummypatids <- 1111111 + 1:10

#set.seed(123)
#dummyspno <- sample(10000:99999, 10, replace = T)
#dummyepikey <- sample (10000000000:99999999999, 10, replace = T)


#dummyadmit <- c("2012-05-08", "2015-01-18", "2015-10-22", "2016-08-29", "2013-01-11", "2018-04-27", "2019-02-22", "2017-09-30", "2019-05-24", "2014-09-23")
#dummydischarge <- c("2012-05-10", "2015-01-25", "2015-10-23", "2016-09-01", "2013-01-16", "2018-04-29", "2019-02-28", "2017-10-03", "2019-05-25", "2014-09-25")
#dummyepistart <- c("2012-05-08", "2015-01-18", "2015-10-22", "2016-08-29", "2013-01-11", "2018-04-27", "2019-02-22", "2017-09-30", "2019-05-24", "2014-09-23")
#dummyepiend <- c("2012-05-10", "2015-01-25", "2015-10-23", "2016-09-01", "2013-01-16", "2018-04-29", "2019-02-28", "2017-10-03", "2019-05-25", "2014-09-25")

#dummyICD <- c("J18", "J18", "J18.1", "J22", "J10.1", "J18", "J22", "J18", "J20.9", "J18.9")

#dummydur <- c("3", "7", "1", "3", "5", "2", "6", "4", "1", "2")

#dummycritcare <- c("0", "1", "0", "0", "1", "0", "1", "1", "0", "0")

#dummydataset <- data.frame(dummypatids, dummyspno, dummyepikey, dummyadmit, dummydischarge, dummyepistart, dummyepiend, dummyICD, dummydur, dummycritcare)


#dummydescrpatids <- 1111111 + 1:20

#dummypregstart <- as.Date(sample(seq(as.Date('2012-04-01'), as.Date('2020-03-30'), by="day"), 20, replace = T))
#dummygestdays <- sample(180:270, 20, replace = T)
#dummypregend <- dummypregstart + dummygestdays

#dummydescrdataset <- data.frame(dummydescrpatids, dummypregstart, dummygestdays, dummypregend)






#merge HES with descriptives and keep all info
#HESdata3$patid <- as.character(HESdata3$patid)
#TestmergeDescrHES <- merge(Descr_Stats8, HESdata3, by.x = "patid.patid", by.y = "patid", all = T)








#want to know if admitted and how severe


#events only within study period (including 6 month follow up post delivery - 6 months after March 2020)
#HESEvents2 <- HESEvents[HESEvents$HESEventdate >= "2011-04-01" & HESEvents$HESEventdate <= "2020-09-30"]




#make columns for pregnancy start year and end year
#Descr_Stats7$patid.pregend<-as.character(Descr_Stats7$patid.pregend)
#Descr_Stats7$patid.pregend2<-dmy(Descr_Stats7$patid.pregend)
#Descr_Stats7$PregStartYear <- substr(Descr_Stats7$patid.pregstart2, 1, 4)
#Descr_Stats7$PregEndYear <- substr(Descr_Stats7$patid.pregend, 1, 4)


#######look at only women who reached second trimester##################

# Subset the data to include only rows with a non-NA SecondTri
ReachedSecTrim <- subset(DescrHESmerge2, !is.na(SecTri))
summary(ReachedSecTrim$had_flu_vax_during_preg3)


###############################read back in trimester vax data##########################

TrimVaxData2 <- fread("P:/TrimVaxData2.csv")

# Create the VaxPriorPreg column
TrimVaxData2$VaxPriorPreg <- ifelse(TrimeVaxData2$VaxDate < TrimVaxData2$patid.pregstart, 1, 0)





#######################################tables to use##############################


table1(~MumAge + NumOfPregs + GestDays + PregOutcome2 + IMD2 + UrbanRural + Preterm + Postterm + Multiple + Ethnicity, data = DescrHESmerge2)

table1(~MumAge + NumOfPregs + GestDays + PregOutcome2 + IMD2 + UrbanRural + Preterm + Postterm + Multiple + Ethnicity | had_flu_vax_during_preg3, data = DescrHESmerge2)

table1(~MumAge + NumOfPregs + GestDays + PregOutcome2 + IMD2 + UrbanRural + Preterm + Postterm + Multiple + Ethnicity | had_flu_vax_during_preg3, data = ReachedSecTrim)

hist(DescrHESmerge2$MumAge, main = "Maternal Age", xlab = "Maternal Age (Years)")
hist(DescrHESmerge2$GestDays, main = "Gestation Days", xlab = "Gestation Days")




#pie chart vax uptake
# Step 1: Calculate the frequency of each category
vax_counts <- table(DescrHESmerge2$had_flu_vax_during_preg3)

# Step 2: Create the pie chart
pie(vax_counts, 
    main = "Influenza Vaccination Status During Pregnancy", 
    col = rainbow(length(vax_counts)),  # Use rainbow colors for distinction
    labels = paste(names(vax_counts), "(", round(100 * vax_counts / sum(vax_counts), 1), "%)", sep = ""))





#tables from BabyHESmerge6
table1(~BabyHESPost2, data = BabyHESmerge6)
table1(~BabyHESPost2 | had_flu_vax_during_preg3, data = BabyHESmerge6)
table1(~ epidur + CritCare | had_flu_vax_during_preg3, OnlyBabiesWithEpi3)

table1(~ GestDays + SexBaby2 + IMD + UrbanRural + NeoCare + WellBaby + BirthWeight + BabyHESPost2 | had_flu_vax_during_preg3, data = BabyHESmerge6)
















###tables

#table1(~had_flu_vax_during_preg3, data = Descr_Stats4)

#table1(~had_flu_vax_during_preg3, data = Descr_Stats5)

table1(~had_flu_vax_during_preg3, data = Descr_Stats9)
pie(table(Descr_Stats9$had_flu_vax_during_preg3), main = "Had Influenza Vaccine During Pregnancy")


# Assuming Descr_Stats$had_flu_vax_during_preg3 is a factor or character variable
freq_table <- table(Descr_Stats9$had_flu_vax_during_preg3)
percentages <- prop.table(freq_table) * 100

# Plotting the pie chart with percentages as labels
pie(freq_table, main = "Pie Chart of had_flu_vax_during_preg3", labels = paste(names(freq_table), "\n", round(percentages, 1), "%"))


#table1(~MumAge + NumOfPregs + GestDays + PregOutcome + IMD + UrbanRural + Preterm + Postterm + Multiple | had_flu_vax_during_preg3 , data = Descr_Stats4)

#table1(~MumAge + NumOfPregs + GestDays + PregOutcome + IMD + UrbanRural + Preterm + Postterm + Multiple | had_flu_vax_during_preg3, data = Descr_Stats5)

hist(Descr_Stats9$MumAge, main = "Maternal Age", xlab = "Maternal Age (Years)")
hist(Descr_Stats9$GestDays, main = "Gestation Days", xlab = "Gestation Days")

table1(~MumAge + NumOfPregs + GestDays + PregOutcome + IMD + UrbanRural + Preterm + Postterm + Multiple + Ethnicity | had_flu_vax_during_preg3, data = Descr_Stats9)

resultstab1 <- table1(~MumAge + NumOfPregs + GestDays + PregOutcome + IMD + UrbanRural + Preterm + Postterm + Multiple + Ethnicity | had_flu_vax_during_preg3, data = Descr_Stats9)

write.csv(resultstab1, "P:/table1CPRD.csv", row.names = FALSE)

#table1(~Tri_of_vax, data = TrimVaxData)

table1(~Tri_of_vax, data = Descr_Stats9)
table1(~Tri_of_vax, data = TrimVaxData2)

#table1(~Season | had_flu_vax_during_preg3, data = Descr_Stats4)

#table1(~Season | had_flu_vax_during_preg3, data = Descr_Stats5)

table1(~Season | had_flu_vax_during_preg3, data = Descr_Stats8)


#table1(~Descr_Stats4$Multiple | Descr_Stats4$PregOutcome, data = Descr_Stats4)
table1(~Descr_Stats7$Multiple | Descr_Stats7$PregOutcome, data = Descr_Stats8)


#########################################stats########################################################
require(tableone)

#demographics vs. had flu vax during pregnancy
summary(~MumAge + NumOfPregs + GestDays + PregOutcome + IMD + UrbanRural + Preterm + Postterm + Multiple + Ethnicity | had_flu_vax_during_preg3, data = DescrHESmerge2, method = "reverse", test = T)

myvarstable1<-c("MumAge", "NumOfPregs", "GestDays", "PregOutcome", "IMD", "UrbanRural", "Preterm", "Postterm", "Multiple", "Ethnicity")
catvarstable1<-c("PregOutcome", "IMD", "UrbanRural", "Preterm", "Postterm", "Multiple", "Ethnicity")
exactvarstable1<-c("PregOutcome", "IMD", "UrbanRural", "Preterm", "Postterm", "Multiple", "Ethnicity")

table1CPRD<-CreateTableOne(vars = myvarstable1, data = DescrHESmerge2, strata = "had_flu_vax_during_preg3")
print(table1CPRD, exact = exactvarstable1, quote = TRUE)

fisher.test(table(DescrHESmerge2$Ethnicity, DescrHESmerge2$had_flu_vax_during_preg3))

fisher.test(table(DescrHESmerge2$Ethnicity, DescrHESmerge2$had_flu_vax_during_preg3), workspace = 2e8)

# Perform a t-test on epidur
t.test(epidur ~ had_flu_vax_during_preg3, data = OnlyEpiDuringPreg3)

#logistic regression for critical care
critcare_log_model <- glm(CritCare ~ had_flu_vax_during_preg3, data = OnlyEpiDuringPreg3, family = "binomial")

summary(critcare_log_model)
confint(critcare_log_model)

#logistic regression for critical care
multiepi_log_model <- glm(MultiEpi ~ had_flu_vax_during_preg3, data = OnlyEpiDuringPreg3, family = "binomial")

summary(multiepi_log_model)
confint(multiepi_log_model)

# Create the contingency table for critcare
table_critcare_vax <- table(OnlyEpiDuringPreg3$CritCare, OnlyEpiDuringPreg3$had_flu_vax_during_preg3)

# Run the Chi-Square Test for critcare
chi_sq_result <- chisq.test(table_critcare_vax)

# View the result
chi_sq_result

# Create the contingency table for multiepi
table_multiepi_vax <- table(OnlyEpiDuringPreg3$MultiEpi, OnlyEpiDuringPreg3$had_flu_vax_during_preg3)

# Run the Chi-Square Test for multiepi
chi_sq_result2 <- chisq.test(table_multiepi_vax)

# View the result
chi_sq_result2

# Perform a t-test on number of episodes
t.test(NumEpi ~ had_flu_vax_during_preg3, data = OnlyEpiDuringPreg3)

# Create the contingency table for HES admissions
table_HES_vax <- table(DescrHESmerge2$HESduringPreg2, DescrHESmerge2$had_flu_vax_during_preg3)

# Run the Chi-Square Test for HES admissions
chi_sq_result3 <- chisq.test(table_HES_vax)

# View the result
chi_sq_result3


#stats for demo table
t.test(MumAge ~ had_flu_vax_during_preg3, data = DescrHESmerge2)
t.test(NumOfPregs ~ had_flu_vax_during_preg3, data = DescrHESmerge2)
t.test(GestDays ~ had_flu_vax_during_preg3, data = DescrHESmerge2)

table_PregOutcome_vax <- table(DescrHESmerge2$PregOutcome, DescrHESmerge2$had_flu_vax_during_preg3)
chi_sq_result4 <- chisq.test(table_PregOutcome_vax)
chi_sq_result4
fisher_result <- fisher.test(table_PregOutcome_vax, simulate.p.value = TRUE, B = 10000)
fisher_result


table_IMD_vax <- table(DescrHESmerge2$IMD, DescrHESmerge2$had_flu_vax_during_preg3)
chi_sq_result5 <- chisq.test(table_IMD_vax)
chi_sq_result5

table_UrbanRural_vax <- table(DescrHESmerge2$UrbanRural, DescrHESmerge2$had_flu_vax_during_preg3)
chi_sq_result6 <- chisq.test(table_UrbanRural_vax)
chi_sq_result6

table_Preterm_vax <- table(DescrHESmerge2$Preterm, DescrHESmerge2$had_flu_vax_during_preg3)
chi_sq_result7 <- chisq.test(table_Preterm_vax)
chi_sq_result7

table_Postterm_vax <- table(DescrHESmerge2$Postterm, DescrHESmerge2$had_flu_vax_during_preg3)
chi_sq_result8 <- chisq.test(table_Postterm_vax)
chi_sq_result8

table_Multiple_vax <- table(DescrHESmerge2$Multiple, DescrHESmerge2$had_flu_vax_during_preg3)
chi_sq_result9<- chisq.test(table_Multiple_vax)
chi_sq_result9

table_Ethnicity_vax <- table(DescrHESmerge2$Ethnicity, DescrHESmerge2$had_flu_vax_during_preg3)
chi_sq_result10 <- chisq.test(table_Ethnicity_vax)
chi_sq_result10
fisher_result2 <- fisher.test(table_Ethnicity_vax, simulate.p.value = TRUE, B = 10000)
fisher_result2




########################test
table1(~MumAge + NumOfPregs + GestDays + PregOutcome + IMD + UrbanRural + Preterm + Postterm + Multiple | had_flu_vax_during_preg2 , data = subset(Descr_Stats4, !is.na(IMD)))

Descr_Stats$patid.outcome <- as.factor(Descr_Stats$patid.outcome)
table1(~patid.matage + patid.totalpregs + patid.gestdays + patid.outcome , data = Descr_Stats)













